<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/1.714e789c58edc4d97d4f.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.0.31"/><style data-styled="deuHhw dVlzdf FSiJo kfPuqG hyXYOK itGeow bcUvSD iWIxoV kGCCTl fGSVd gGIelI gzoEET deWstv iqsYhj btQvUm bzCfLs kBTHbK kFkvdw kZiJlH" data-styled-version="4.3.1">
/* sc-component-id: sc-global-3325714496 */
@import url("https://fonts.googleapis.com/css?family=Roboto:400,700"); html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} *,*:before,*:after{box-sizing:inherit;} html{font-size:62.5%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box;} body{background:#f9fafc;font-family:'Open Sans',sans-serif;line-height:1.5;padding:50px 0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;} img{max-width:100%;} .gatsby-highlight{border-bottom:1px solid #e0e6ed;border-top:1px solid #e0e6ed;margin:15px -100px;padding:0;} .gatsby-highlight pre[class*="language-"]{margin:0;padding:25px 100px;} pre[class*="language-"]{background:rgba(245,245,245,1);color:rgb(65,76,94);} @media only screen and (max-width:870px){.gatsby-highlight{margin:15px -15px;}.gatsby-highlight pre[class*="language-"]{padding:25px;}}
/* sc-component-id: sc-bdVaJa */
.deuHhw{margin:0 auto;max-width:1080px;}
/* sc-component-id: sc-htpNat */
.itGeow{margin-top:15px;text-align:center;}
/* sc-component-id: sc-bxivhb */
.bcUvSD{border:1px solid #bfc8d2;border-radius:15px;color:#3e465b;display:inline-block;margin:5px;padding:5px 10px;-webkit-text-decoration:none;text-decoration:none;} .bcUvSD svg{display:inline-block;height:20px;margin-right:5px;stroke:#6e849c;vertical-align:middle;width:20px;} .bcUvSD:hover{border-color:#3e465b;}
/* sc-component-id: sc-ifAKCX */
.FSiJo{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;}
/* sc-component-id: sc-bZQynM */
.hyXYOK{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;margin:0;}
/* sc-component-id: sc-gzVnrw */
.kfPuqG{color:#3498db;-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: sc-htoDjs */
.dVlzdf{margin:0 auto;max-width:650px;padding:0 50px 50px;text-align:center;}
/* sc-component-id: sc-dnqmqq */
.iWIxoV{background:#fff;border:1px solid #e0e6ed;box-shadow:0 1px 5px rgba(0,0,0,0.05);margin-bottom:30px;padding:75px 100px;} @media only screen and (max-width:870px){.iWIxoV{border-left:none;border-right:none;padding:75px 15px;}}
/* sc-component-id: sc-iwsKbI */
.gzoEET{margin-top:50px;text-align:center;}
/* sc-component-id: sc-gZMcBi */
.deWstv{border:1px solid #bfc8d2;border-radius:25px;color:#3e465b;display:inline-block;font-size:10px;font-weight:700;margin:0 10px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;text-transform:uppercase;} .deWstv:hover{border-color:#000;}
/* sc-component-id: sc-VigVT */
.kGCCTl{text-align:center;}
/* sc-component-id: sc-jTzLTM */
.fGSVd{color:#3e465b;-webkit-text-decoration:none;text-decoration:none;} .fGSVd:hover{color:#3498db;}
/* sc-component-id: sc-fjdhpX */
.gGIelI{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;}
/* sc-component-id: sc-jzJRlG */
.btQvUm{color:#65738c;font-size:16px;} .btQvUm a{color:#3498db;font-weight:700;-webkit-text-decoration:none;text-decoration:none;} .btQvUm a:hover{-webkit-text-decoration:underline;text-decoration:underline;} .btQvUm h1{color:#3e465b;font-size:30px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .btQvUm h2{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .btQvUm h3{color:#3e465b;font-size:17px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .btQvUm h4{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .btQvUm h5,.btQvUm h6{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .btQvUm p{line-height:1.7;margin:15px 50px;} .btQvUm blockquote{border-left:5px solid #e0e6ed;line-height:1.7;margin:15px 50px 15px 75px;padding:10px 10px 10px 15px;} .btQvUm blockquote p{margin:0;} .btQvUm ul,.btQvUm ol{line-height:1.7;margin:15px 0;padding:0 50px 0 100px;} .btQvUm ul p,.btQvUm ol p,.btQvUm ul ul,.btQvUm ol ul,.btQvUm ul ol,.btQvUm ol ol{margin:0;} .btQvUm ul ul,.btQvUm ol ul,.btQvUm ul ol,.btQvUm ol ol{padding:0 0 0 30px;} .btQvUm img{margin:15px 0;}
/* sc-component-id: sc-cSHVUG */
.iqsYhj h1{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;} .iqsYhj p{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;} .iqsYhj span{background:#9c9da3;display:block;margin:50px auto;height:1px;width:150px;}
/* sc-component-id: sc-kAzzGY */
.kZiJlH{margin-top:50px;text-align:center;}
/* sc-component-id: sc-chPdSV */
.kBTHbK{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;}
/* sc-component-id: sc-kgoBCf */
.bzCfLs{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kGXeez */
.kFkvdw{border:1px solid #bfc8d2;border-radius:15px;display:inline-block;margin:5px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;} .kFkvdw svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .kFkvdw:hover{border-color:#3e465b;}</style><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#3498db"/><title data-react-helmet="true">Build a native image with GraalVM | Arek Jurasz</title><meta data-react-helmet="true" name="description" content="Dev Blog | Software Engineer"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-9f31e34a1dce47c5b897.js"/><link as="script" rel="preload" href="/app-b478122f533294b82ffc.js"/><link as="script" rel="preload" href="/8-1aa58b92cd772f99dba9.js"/><link as="script" rel="preload" href="/1-c677f621e98a330e7e29.js"/><link as="script" rel="preload" href="/0-4bb96b712f2494825956.js"/><link as="script" rel="preload" href="/webpack-runtime-7144b1b7e5b27c48a2af.js"/><link rel="preload" href="/static/d/431/path---2019-06-08-build-native-imge-with-graalvm-cba-a13-CHJ6QYplAUjqJW8FbjAY7agkcAs.json" as="fetch" crossOrigin="use-credentials"/><link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAADbmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmjX/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uaNf/bmTP/2pUq/9uZM//bmjT/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25o1/9ybN//alSv/25o1/+KtXP/bmDL/2pYt/9qVK//cmzb/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25o0/9qVK//YjyD/36RJ/+W1bf/25s//3J07/+CoUv/irFv/2JAh/9mUKP/bmTT/25kz/9uZM//bmTP/25k0/9qVLP/hqVT/8tq3///////pwob/8tq1/+OvYf/ksmb///////Xjyf/jsWX/2pYt/9uZM//bmTP/3Js2/9mTJ//uz6H///////DUq//eo0j/1owZ/+7Nnf/tzJr/140b/9ydPP/syJP///////ThxP/aliz/25o0/9uaNf/alSv/57t5//nv4P/25s//68eR/9ybOP/ltGv/896//9qWL//pwIP/9eLG//nw4//rx5H/2pYu/9uaNP/bmTP/25o0/9mTKP/blzH/57t4//rx5f/ty5n/3Js3//Xjyf/pwYX/+/Tq/+rDif/cnDn/2ZIl/9uZNP/bmTP/25kz/9uZM//bmjX/25kz/9iRJP/ZlCr/3Z9A/9mUKf/z38D/5bRs/9iRJf/YkST/25gx/9yaNv/bmTP/25kz/9uZM//bmTP/25kz/9uZM//cmjb/25o0/9uYMP/bmDH/3Z4//9ybOf/bmDH/3Js3/9uZNP/bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uYMP/bmDH/25k0/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><section class="sc-bdVaJa deuHhw"><header class="sc-htoDjs dVlzdf"><h1 class="sc-ifAKCX FSiJo"><a class="sc-gzVnrw kfPuqG" href="/">Arek Jurasz</a></h1><p class="sc-EHOje sc-bZQynM hyXYOK">Software Engineer</p><div class="sc-htpNat itGeow"><a href="https://twitter.com/arekjurasz" target="_blank" rel="noopener" class="sc-bxivhb bcUvSD"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>Twitter</a><a href="https://github.com/ajurasz" target="_blank" rel="noopener" class="sc-bxivhb bcUvSD"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>Github</a><a href="https://www.linkedin.com/in/arkadiusz-jurasz/" target="_blank" rel="noopener" class="sc-bxivhb bcUvSD"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>LinkedIn</a></div></header></section><section class="sc-bdVaJa deuHhw"><div class="sc-dnqmqq iWIxoV"><div class="sc-cSHVUG iqsYhj"><h1>Build a native image with GraalVM</h1><p>June 08, 2019</p><span></span></div><article class="sc-jzJRlG btQvUm"><div><p>Last month first production-ready version of <code class="language-text">GraalVM</code> with number <code class="language-text">19.0</code> was released. <code class="language-text">GraalVM</code> is a virtual machine capable to run application written in <code class="language-text">JavaScript</code>, <code class="language-text">Python</code>, <code class="language-text">Ruby</code>, <code class="language-text">R</code>, LLVM-based languages like <code class="language-text">C</code>, <code class="language-text">C++</code> and of course our beloved JVM-based languages like <code class="language-text">Java</code>, <code class="language-text">Scala</code>, <code class="language-text">Kotlin</code>, <code class="language-text">Groovy</code> and <code class="language-text">Clojure</code>. Some of the main goals for this new virtual machine are:</p>
<ul>
<li>improve the performance of applications build with JVM-based languages</li>
<li>reduce startup time by usage of AOT (ahead-of-time) compilation</li>
<li>write polyglot applications</li>
<li>compile JVM-based code to a standalone executable a.k.a. native image.</li>
</ul>
<!-- end -->
<p>With this post, I would like to focus on the last goal and build a native image. The assumption is very simple, take <a href="https://github.com/json-path/JsonPath">JsonPath</a> library, write some <code class="language-text">Java</code> code to interact with this library and then from terminal quickly test any <a href="https://github.com/json-path/JsonPath">JsonPath</a> expression you can think of, like</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> -s https://api.github.com/users/ajurasz <span class="token operator">|</span> json_path <span class="token string">"$.created_at"</span></code></pre></div>
<h2>Native image?</h2>
<p>As already mentioned one of the main goals of <code class="language-text">GraalVM</code> is the possibility to produce native images which are executables that do not require JRE (java runtime environment) to be present on the system. At first, when I heard about this feature I thought that the code instead to be compiled to bytecode will be directly compiled to machine code but I was wrong. During the process of creating a native image, all classes of our application and their dependencies are statically analyses to know which part of that code is reachable during runtime. These static analyses take JDK code under consideration as well. When we know all classes and methods used in the runtime then <code class="language-text">GraalVM</code> compiles it ahead-of-time. To make this AOT compiled code to run we still need some runtime on which our program can be run. The produced native image includes something called <code class="language-text">Substrate VM</code> which is an embeddable virtual machine containing components like memory management, thread scheduling, de-optimizer or even garbage collector. Having an initial idea about what native image is let’s install <code class="language-text">GraalVM</code>, <code class="language-text">native-image</code> utility and write some code.</p>
<h2>Installation</h2>
<p>First, let’s install <code class="language-text">GraalVM</code> through <code class="language-text">sdkman</code></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> apt update
<span class="token function">sudo</span> apt <span class="token function">install</span> unzip <span class="token function">zip</span>
<span class="token function">curl</span> -s <span class="token string">"https://get.sdkman.io"</span> <span class="token operator">|</span> <span class="token function">bash</span>
<span class="token function">source</span> <span class="token string">"/home/ubuntu/.sdkman/bin/sdkman-init.sh"</span>
sdk <span class="token function">install</span> java 19.0.0-grl</code></pre></div>
<p>To use <code class="language-text">native-image</code> command beside native image utility there are some <a href="https://www.graalvm.org/docs/reference-manual/aot-compilation/#prerequisites">prerequisites</a></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">gu <span class="token function">install</span> native-image
<span class="token function">sudo</span> apt <span class="token function">install</span> build-essential
<span class="token function">sudo</span> apt <span class="token function">install</span> libz-dev</code></pre></div>
<h2>Code</h2>
<p>As shown above, we want to pipe output from <code class="language-text">curl</code> command to our application as input. To get access to this input from application level we need to read it from <code class="language-text">System.in</code>. <a href="https://github.com/json-path/JsonPath">JsonPath</a> expression will be simply passed as an argument. In the end, we just need to evaluate the expression on json. </p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>BufferedReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>InputStreamReader<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>Collectors<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>jayway<span class="token punctuation">.</span>jsonpath<span class="token punctuation">.</span>JsonPath<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String expression <span class="token operator">=</span> <span class="token function">extractExpression</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String json <span class="token operator">=</span> <span class="token function">readInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">evaluate</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> expression<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">extractExpression</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Single JsonPath expression is required."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">readInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">evaluate</span><span class="token punctuation">(</span>String json<span class="token punctuation">,</span> String expression<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JsonPath jsonPath <span class="token operator">=</span> JsonPath<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jsonPath<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Compilation</h2>
<p>First, we need to compile our java code with <code class="language-text">javac</code> command</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">javac -cp <span class="token string">"libs/*"</span> Application.java</code></pre></div>
<p><code class="language-text">libs</code> directory contains all 3rd party dependencies required for this application to run</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">tree
<span class="token keyword">.</span>
├── Application.java
└── libs
    ├── accessors-smart-1.2.jar
    ├── asm-5.0.4.jar
    ├── json-path-2.4.0.jar
    ├── json-smart-2.3.jar
    ├── slf4j-api-1.7.25.jar
    └── slf4j-jdk14-1.7.25.jar

1 directory, 8 files</code></pre></div>
<p>After successful ran of compile command <code class="language-text">Application.class</code> should be produced.</p>
<h2>Build native image</h2>
<p>Command to build native image is very similar to compiling java file, it requires only java class and <code class="language-text">-cp</code> parameter in case if we use external dependencies which we do.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">native-image -cp <span class="token string">".:libs/*"</span> -H:Name<span class="token operator">=</span>json_path  Application </code></pre></div>
<p><code class="language-text">-H:Name</code> is used just to give a name to produced executable. But running above command will fail with the following message</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">Warning: Aborting stand-alone image build. com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.defineClass<span class="token punctuation">(</span>String, byte<span class="token punctuation">[</span><span class="token punctuation">]</span>, int, int<span class="token punctuation">)</span> is reachable: The declaring class of this element has been substituted, but this element is not present <span class="token keyword">in</span> the substitution class
To diagnose the issue, you can add the option --report-unsupported-elements-at-runtime. The unsupported element is <span class="token keyword">then</span> reported at run <span class="token function">time</span> when it is accessed the first time.
Detailed message:
Trace:
        at parsing net.minidev.asm.DynamicClassLoader.defineClass<span class="token punctuation">(</span>DynamicClassLoader.java:86<span class="token punctuation">)</span>
Call path from entry point to net.minidev.asm.DynamicClassLoader.defineClass<span class="token punctuation">(</span>String, byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>:
        at net.minidev.asm.DynamicClassLoader.defineClass<span class="token punctuation">(</span>DynamicClassLoader.java:81<span class="token punctuation">)</span>
        at net.minidev.asm.BeansAccessBuilder.bulid<span class="token punctuation">(</span>BeansAccessBuilder.java:313<span class="token punctuation">)</span>
        at net.minidev.asm.BeansAccess.get<span class="token punctuation">(</span>BeansAccess.java:111<span class="token punctuation">)</span>
        at net.minidev.json.reader.BeansWriterASM.writeJSONString<span class="token punctuation">(</span>BeansWriterASM.java:17<span class="token punctuation">)</span>
        at net.minidev.json.JSONValue.writeJSONString<span class="token punctuation">(</span>JSONValue.java:586<span class="token punctuation">)</span>
        at net.minidev.json.reader.JsonWriter<span class="token variable">$5</span>.writeJSONString<span class="token punctuation">(</span>JsonWriter.java:113<span class="token punctuation">)</span>
        at net.minidev.json.reader.JsonWriter<span class="token variable">$5</span>.writeJSONString<span class="token punctuation">(</span>JsonWriter.java:1<span class="token punctuation">)</span>
        at net.minidev.json.JSONArray.writeJSONString<span class="token punctuation">(</span>JSONArray.java:75<span class="token punctuation">)</span>
        at net.minidev.json.JSONArray.toJSONString<span class="token punctuation">(</span>JSONArray.java:52<span class="token punctuation">)</span>
        at net.minidev.json.JSONArray.toJSONString<span class="token punctuation">(</span>JSONArray.java:102<span class="token punctuation">)</span>
        at net.minidev.json.JSONArray.toString<span class="token punctuation">(</span>JSONArray.java:113<span class="token punctuation">)</span>
        at java.lang.String.valueOf<span class="token punctuation">(</span>String.java:2994<span class="token punctuation">)</span>
        at java.lang.StringBuilder.append<span class="token punctuation">(</span>StringBuilder.java:131<span class="token punctuation">)</span>
        at com.oracle.svm.core.amd64.AMD64CPUFeatureAccess.verifyHostSupportsArchitecture<span class="token punctuation">(</span>AMD64CPUFeatureAccess.java:179<span class="token punctuation">)</span>
        at com.oracle.svm.core.JavaMainWrapper.run<span class="token punctuation">(</span>JavaMainWrapper.java:131<span class="token punctuation">)</span>
        at com.oracle.svm.core.code.IsolateEnterStub.JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b<span class="token punctuation">(</span>generated:0<span class="token punctuation">)</span></code></pre></div>
<p>Native images don’t support dynamic class loading and this is understandable due to the nature of AOT compilation where all classes and bytecodes that are ever reachable needs to be known at compile time. To see the full list of native image limitation see <a href="https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md">https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md</a>. But we still can take advantage of the suggested solution and postpone any errors resulting from dynamic class loading to runtime by using <code class="language-text">--report-unsupported-elements-at-runtime</code> option. Let’s make the second attempt to build a native image</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"> native-image -cp <span class="token string">".:libs/*"</span> -H:Name<span class="token operator">=</span>json_path --report-unsupported-elements-at-runtime  Application</code></pre></div>
<p> This time it worked and <code class="language-text">json_path</code> executable was created. To make our life easier let’s register this executable to be accessible globally in our system</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">ln</span> -s /home/ubuntu/app/json_path /usr/local/bin/json_path</code></pre></div>
<p>and let’s give it a try</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> -s https://api.github.com/users/ajurasz <span class="token operator">|</span> json_path <span class="token string">"$.created_at"</span>
2013-03-23T12:56:53Z</code></pre></div>
<p>Works like a charm but what about some more complex expressions</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> -s https://www.anapioficeandfire.com/api/books/1 <span class="token operator">|</span> json_path <span class="token string">"$.characters.length()"</span>

Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> com.jayway.jsonpath.InvalidPathException: Function of name: length cannot be created
        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction<span class="token punctuation">(</span>PathFunctionFactory.java:75<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.FunctionPathToken.evaluate<span class="token punctuation">(</span>FunctionPathToken.java:38<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.PathToken.handleObjectProperty<span class="token punctuation">(</span>PathToken.java:81<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.PropertyPathToken.evaluate<span class="token punctuation">(</span>PropertyPathToken.java:79<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.RootPathToken.evaluate<span class="token punctuation">(</span>RootPathToken.java:62<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate<span class="token punctuation">(</span>CompiledPath.java:53<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate<span class="token punctuation">(</span>CompiledPath.java:61<span class="token punctuation">)</span>
        at com.jayway.jsonpath.JsonPath.read<span class="token punctuation">(</span>JsonPath.java:181<span class="token punctuation">)</span>
        at com.jayway.jsonpath.JsonPath.read<span class="token punctuation">(</span>JsonPath.java:345<span class="token punctuation">)</span>
        at com.jayway.jsonpath.JsonPath.read<span class="token punctuation">(</span>JsonPath.java:329<span class="token punctuation">)</span>
        at Application.evaluate<span class="token punctuation">(</span>Application.java:30<span class="token punctuation">)</span>
        at Application.main<span class="token punctuation">(</span>Application.java:12<span class="token punctuation">)</span>
Caused by: java.lang.InstantiationException: Type <span class="token variable"><span class="token variable">`</span>com.jayway.jsonpath.internal.function.text.Length<span class="token variable">`</span></span> can not be instantiated reflectively as it does not have a no-parameter constructor or the no-parameter constructor has not been added explicitly to the native image.
        at java.lang.Class.newInstance<span class="token punctuation">(</span>DynamicHub.java:740<span class="token punctuation">)</span>
        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction<span class="token punctuation">(</span>PathFunctionFactory.java:73<span class="token punctuation">)</span>
        <span class="token punctuation">..</span>. 11 <span class="token function">more</span></code></pre></div>
<p>So a new instance of <code class="language-text">Length</code> type cannot be created. Quick sneak peek on failing part (<code class="language-text">PathFunctionFactory.java:75</code>)</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> PathFunction <span class="token function">newFunction</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> InvalidPathException <span class="token punctuation">{</span>
    Class <span class="token class-name">functionClazz</span> <span class="token operator">=</span> FUNCTIONS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>functionClazz <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidPathException</span><span class="token punctuation">(</span><span class="token string">"Function with name: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" does not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>PathFunction<span class="token punctuation">)</span>functionClazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidPathException</span><span class="token punctuation">(</span><span class="token string">"Function of name: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" cannot be created"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>That’s true, it looks like there is a set of predefined function which then are dynamically created. Fortunately, this can be fixed by introducing reflection configuration file. This file is used to inform <code class="language-text">Substrate VM</code> about reflectively accessed program elements. To know more see <a href="https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md">https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md</a>. To solve above issue we need to put one entry in <code class="language-text">graal.json</code></p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"com.jayway.jsonpath.internal.function.text.Length"</span><span class="token punctuation">,</span>
    <span class="token property">"methods"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token property">"parameterTypes"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre></div>
<p>After the rebuild of <code class="language-text">json_path</code> executable, previous commands started to work</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> -s https://www.anapioficeandfire.com/api/books/1 <span class="token operator">|</span> json_path <span class="token string">"$.characters.length()"</span>
434
        
<span class="token function">curl</span> -s https://www.anapioficeandfire.com/api/books <span class="token operator">|</span> json_path <span class="token string">"$.[?(@.name == 'A Game of Thrones')].characters.length()"</span>
<span class="token punctuation">[</span>434<span class="token punctuation">]</span></code></pre></div>
<h2>Conclusion</h2>
<p>I see the big potential is these native images one of them is light and fast docker images <a href="https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b">https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b</a> as pointed out by Adam Warski. What he also mention is that in Scala reflection is almost unused. For me compiling a very simple program to the native image was a few hours of research and at this point, I don’t see how I could do the same with small <code class="language-text">Spring</code> application which in contrast to Scala use reflection heavily.</p></div></article><div class="sc-kgoBCf bzCfLs"><h2 class="sc-chPdSV kBTHbK">Share This Post</h2><a href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank" aria-label="Share on Facebook" rel="noopener" class="sc-kGXeez kFkvdw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a><a href="https://twitter.com/intent/tweet?text=Build%20a%20native%20image%20with%20GraalVM&amp;url=" target="_blank" aria-label="Share on Twitter" rel="noopener" class="sc-kGXeez kFkvdw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=&amp;title=Build%20a%20native%20image%20with%20GraalVM" target="_blank" aria-label="Share on LinkedIn" rel="noopener" class="sc-kGXeez kFkvdw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="mailto:?subject=Build%20a%20native%20image%20with%20GraalVM&amp;body=" aria-label="Share by Email" rel="noopener" class="sc-kGXeez kFkvdw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></div></div><div class="sc-kAzzGY kZiJlH"><a rel="prev" class="sc-gZMcBi deWstv" href="/2019-06-02-verify-your-json/">← <!-- -->Verify your JSON</a></div></section></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-70225806-1', 'auto', {});
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2019-06-08-build-native-imge-with-graalvm-cba","path":"/2019-06-08-build-native-imge-with-graalvm/"};window.dataPath="431/path---2019-06-08-build-native-imge-with-graalvm-cba-a13-CHJ6QYplAUjqJW8FbjAY7agkcAs";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-b478122f533294b82ffc.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-70fa0028ee7496e8897a.js"],"component---src-templates-index-js":["/component---src-templates-index-js-c29281ac444d3e6f6506.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-9f31e34a1dce47c5b897.js"],"component---src-pages-404-js":["/component---src-pages-404-js-138edb35d80723b438f9.js"]};/*]]>*/</script><script src="/webpack-runtime-7144b1b7e5b27c48a2af.js" async=""></script><script src="/0-4bb96b712f2494825956.js" async=""></script><script src="/1-c677f621e98a330e7e29.js" async=""></script><script src="/8-1aa58b92cd772f99dba9.js" async=""></script><script src="/app-b478122f533294b82ffc.js" async=""></script><script src="/component---src-templates-blog-post-js-9f31e34a1dce47c5b897.js" async=""></script></body></html>