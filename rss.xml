<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Dev Blog]]></title><description><![CDATA[Software Engineer]]></description><link>https://ajurasz.github.io</link><generator>GatsbyJS</generator><lastBuildDate>Sun, 22 Nov 2020 23:12:54 GMT</lastBuildDate><item><title><![CDATA[AWS Lambda custom runtime]]></title><description><![CDATA[AWS Lambda support many build in runtimes. But we also have a possibility to create custom runtimes to run functions in a language that is…]]></description><link>https://ajurasz.github.io/2020-11-23-aws-lambda-custom-runtime/</link><guid isPermaLink="false">https://ajurasz.github.io/2020-11-23-aws-lambda-custom-runtime/</guid><pubDate>Mon, 23 Nov 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;AWS Lambda support many &lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html&quot;&gt;build in runtimes&lt;/a&gt;. But we also have a possibility to create custom runtimes to run functions in a language that is not yet supported by Lambda service or when we need to do some extra optimization (i.e. reduce startup time or memory footprint of functions build for JVM). Today we will learn how to build a very simple runtime focusing mainly on steps required to do so.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Custom runtime&lt;/h2&gt;
&lt;p&gt;Every runtime is executed on Amazon Linux or Amazon Linux 2 operating system. In case of JVM, functions need at least a Java Runtime Environment (JRE) to run a &lt;code class=&quot;language-text&quot;&gt;jar&lt;/code&gt; but it won’t be available out of the box on mentioned systems. Thankfully starting from Java 9 a &lt;code class=&quot;language-text&quot;&gt;jlink&lt;/code&gt; tool was introduced which creates a customized JRE that contains only these modules that are required by your own module - this way JRE can be part of the deployment package.&lt;/p&gt;
&lt;p&gt;To create a runtime we need a &lt;code class=&quot;language-text&quot;&gt;bootstrap&lt;/code&gt; file to be present in the root of a deployment package. This file is an entry point for the custom runtime and will be called by Lambda as part of &lt;code class=&quot;language-text&quot;&gt;init&lt;/code&gt; phase.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/f60c089ea1f585cd0857a47ec3dbe386/29007/lambda-execution-environment-lifecycle.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 18.857142857142858%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQI1x2Ku04DMRRE9///BdGGiFRQ0CAR0YAikrAgwq7j+HFt34fXNg6jU5wZzTAHmDwoi8ZDDFNKltBSOl/pQoGSIuxVs5CPcrakIE7gXUrD3fh+fxgft3H3cdSH26SfG77SvOq0uG10XPQ6/q6re2gN9z+yeZo2u/Hm7eXTm8EIGmZlGEIsrEr2dYHgvju1e0EKJ2e+CuvWCnKdLzgqfQKHWYZFck+IAYk5V5I+VOuj9YmlsCwQSVugq2f5f+qLSQlZ5A8imOChMNa4bwAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Lambda execution environment lifecycle&quot;
        title=&quot;&quot;
        src=&quot;/static/f60c089ea1f585cd0857a47ec3dbe386/8c557/lambda-execution-environment-lifecycle.png&quot;
        srcset=&quot;/static/f60c089ea1f585cd0857a47ec3dbe386/4edbd/lambda-execution-environment-lifecycle.png 175w,
/static/f60c089ea1f585cd0857a47ec3dbe386/13ae7/lambda-execution-environment-lifecycle.png 350w,
/static/f60c089ea1f585cd0857a47ec3dbe386/8c557/lambda-execution-environment-lifecycle.png 700w,
/static/f60c089ea1f585cd0857a47ec3dbe386/e996b/lambda-execution-environment-lifecycle.png 1050w,
/static/f60c089ea1f585cd0857a47ec3dbe386/2cefc/lambda-execution-environment-lifecycle.png 1400w,
/static/f60c089ea1f585cd0857a47ec3dbe386/29007/lambda-execution-environment-lifecycle.png 1600w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Source: &lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/runtimes-context.html&quot;&gt;https://docs.aws.amazon.com/lambda/latest/dg/runtimes-context.html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;Deployment package&lt;/h2&gt;
&lt;p&gt;So far we know that custom runtime will require a &lt;code class=&quot;language-text&quot;&gt;bootstrap&lt;/code&gt; file and custom JRE. Since we will be working with (&lt;a href=&quot;https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html&quot;&gt;SAM CLI&lt;/a&gt;) we can use the possibility to customize &lt;code class=&quot;language-text&quot;&gt;build&lt;/code&gt; command. This can be done by providing &lt;code class=&quot;language-text&quot;&gt;Metadata&lt;/code&gt; resource attribute with a &lt;code class=&quot;language-text&quot;&gt;BuildMethod: makefile&lt;/code&gt; entry&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;Resources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;NaiveJavaRuntimeFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;CodeUri&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; NaiveJavaRuntime
      &lt;span class=&quot;token key atrule&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; do.not.apply
      &lt;span class=&quot;token key atrule&quot;&gt;Runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; provided
      &lt;span class=&quot;token key atrule&quot;&gt;MemorySize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;128&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Metadata&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;BuildMethod&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; makefile&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By convention &lt;code class=&quot;language-text&quot;&gt;sam build&lt;/code&gt; will look for &lt;code class=&quot;language-text&quot;&gt;build-NaiveJavaRuntimeFunction&lt;/code&gt; target in a &lt;code class=&quot;language-text&quot;&gt;Makefile&lt;/code&gt;. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;build-NaiveJavaRuntimeFunction:
  @ mvn clean package
  @ chmod +x ./target/classes/bootstrap
  @ cp -rf ./target/classes/bootstrap $(ARTIFACTS_DIR)
  @ jlink --module-path ./target/naive-java-runtime.jar:$(JAVA_HOME)/jmods \
         --add-modules  naive.java.runtime \
         --output ./target/dist \
         --launcher executable=naive.java.runtime/io.github.ajurasz.naivejavaruntime.Bootstrap \
         --compress 2 --no-header-files --no-man-pages --strip-debug
  @ cp -rf ./target/dist $(ARTIFACTS_DIR)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here’s what is happening:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Build package using maven&lt;/li&gt;
&lt;li&gt;Change &lt;code class=&quot;language-text&quot;&gt;bootstrap&lt;/code&gt; file permission&lt;/li&gt;
&lt;li&gt;Copy &lt;code class=&quot;language-text&quot;&gt;bootstrap&lt;/code&gt; file (which is part of project resources) to &lt;code class=&quot;language-text&quot;&gt;ARTIFACTS_DIR&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Build custom JRE. Notice &lt;code class=&quot;language-text&quot;&gt;--launcher&lt;/code&gt; option which will create an executable file (&lt;code class=&quot;language-text&quot;&gt;dist/bin/executable&lt;/code&gt;) which when called will run the main method&lt;/li&gt;
&lt;li&gt;Copy output created by &lt;code class=&quot;language-text&quot;&gt;jlink&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;ARTIFACTS_DIR&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;At the end &lt;code class=&quot;language-text&quot;&gt;ARTIFACTS_DIR&lt;/code&gt; will look like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;
├── bootstrap
└── dist
    ├── bin
    │   ├── executable
    │   ├── java
    │   └── keytool
    ├── conf
    │   ├── net.properties
    │   └── security
    ├── legal
    │   ├── java.base
    │   └── java.net.http
    ├── lib
    │   ├── classlist
    │   ├── jexec
    │   ├── jli
    │   ├── jrt-fs.jar
    │   ├── jspawnhelper
    │   ├── jvm.cfg
    │   ├── libjava.so
    │   ├── libjimage.so
    │   ├── libjsig.so
    │   ├── libnet.so
    │   ├── libnio.so
    │   ├── libverify.so
    │   ├── libzip.so
    │   ├── modules
    │   ├── security
    │   ├── server
    │   └── tzdb.dat
    └── release&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When the function was deployed we can give it a try in Lambda console.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c15081c31a4d6f0ea43beb009be77521/d004c/lambda-function-output.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 37.14285714285714%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAC4jAAAuIwF4pT92AAABGElEQVQoz22Rx5LEIAxE/f8fOTsBB0wOBmwfepAm1FbtHl4JtYJNMwh1xW3+wbjecF8f0HGFzYSCTStj0iv3m4Z743/BedHcMygvIfUCnyxctAjZwRMlvmJyXNtaQj0L6rEx5R9yixhWN2NWI0JxjN8sUgvI+4fYGwNM7H+YDVyH+khLf/AYpJswKcEDpl+XCMVyMVb3jULeueYyXdOw/iE2xz0EL5y1QKi0xH2LtJQGCVoydn+n3qeD7HZ0e0h/+0ezn48Pi5lwuV4wzgJiemBcRoj5wb4qu7KHIXuE5OHjy9OwJcQOaVSrR/d2L4jdisEEhUVKKK2hjYYxhs85Z9RasR870/aG8zw7B1prOCh2jel5KYUf9Al3HRYl6YsobgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Lambda function output&quot;
        title=&quot;&quot;
        src=&quot;/static/c15081c31a4d6f0ea43beb009be77521/8c557/lambda-function-output.png&quot;
        srcset=&quot;/static/c15081c31a4d6f0ea43beb009be77521/4edbd/lambda-function-output.png 175w,
/static/c15081c31a4d6f0ea43beb009be77521/13ae7/lambda-function-output.png 350w,
/static/c15081c31a4d6f0ea43beb009be77521/8c557/lambda-function-output.png 700w,
/static/c15081c31a4d6f0ea43beb009be77521/e996b/lambda-function-output.png 1050w,
/static/c15081c31a4d6f0ea43beb009be77521/2cefc/lambda-function-output.png 1400w,
/static/c15081c31a4d6f0ea43beb009be77521/d004c/lambda-function-output.png 1611w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;h2&gt;Runtime&lt;/h2&gt;
&lt;p&gt;Beside initialization, custom runtime is also responsible for &lt;a href=&quot;https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html#runtimes-custom-build&quot;&gt;processing tasks&lt;/a&gt; consisting of:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Getting an event&lt;/li&gt;
&lt;li&gt;Propagating the tracing header&lt;/li&gt;
&lt;li&gt;Creating a context object&lt;/li&gt;
&lt;li&gt;Invoking the function handler&lt;/li&gt;
&lt;li&gt;Handling the response&lt;/li&gt;
&lt;li&gt;Handling errors&lt;/li&gt;
&lt;li&gt;Cleanup&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;My naive implementation meets just three of these tasks. To support all of them it would require much more development and then the maintenance of that code. But there is a better alternative to reinventing the wheel - taking advantage of very impressive &lt;a href=&quot;https://quarkus.io/guides/funqy-amazon-lambda&quot;&gt;Quarkus module&lt;/a&gt;. Except that it provides an implementation for all processing tasks it also gives the possibility to build a native image which additionally lower memory footprint and accelerates initialization times. All this can be done with small adjustments to &lt;a href=&quot;https://github.com/ajurasz/lambda-custom-runtime/blob/master/FunqyAmazonLambda/pom.xml&quot;&gt;pom.xml&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;When the function was deployed we can give it a try in Lambda console.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/1a57f36b47e77e7f875768909e73192d/12e1b/lambda-function-output-2.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 37.14285714285714%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAC4jAAAuIwF4pT92AAABHUlEQVQoz3XQ6W7DIAwA4Lz/Q3Zrl5NgsDkasiF7DksqTdp+fPIphNz161u5j7fSm3t5mEexYSkumQJpLRDNi9PaZ/svfNq200EwsjojIaNQwlekLQpdefLy3JPsdZPy9Wy2P+TPKN3iRh5Nz5gdY4IW0x4UtZjP3KJhHy07RcdOIY6ndIoFuTN+khlGcXE9WQmbFx3+ioP5EAir+GT159D6l2N+6RY/8gQD0xNYG8oxKdS6yZb1EdYHebQ964m079hnaH29X9sPjefu+N3t/SbGLrLYWVYwsqyzWG8FVEgkMQe9LQlF/Km3rFLrHbP9a9P7Fsm73hDI1GEY6jRNdVTzPLcaAKrzroYQKhFWPCBqTg1ePeXR1xhTjVuo34hWFHZBQnGHAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Lambda function output 2&quot;
        title=&quot;&quot;
        src=&quot;/static/1a57f36b47e77e7f875768909e73192d/8c557/lambda-function-output-2.png&quot;
        srcset=&quot;/static/1a57f36b47e77e7f875768909e73192d/4edbd/lambda-function-output-2.png 175w,
/static/1a57f36b47e77e7f875768909e73192d/13ae7/lambda-function-output-2.png 350w,
/static/1a57f36b47e77e7f875768909e73192d/8c557/lambda-function-output-2.png 700w,
/static/1a57f36b47e77e7f875768909e73192d/e996b/lambda-function-output-2.png 1050w,
/static/1a57f36b47e77e7f875768909e73192d/2cefc/lambda-function-output-2.png 1400w,
/static/1a57f36b47e77e7f875768909e73192d/12e1b/lambda-function-output-2.png 1607w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;Please notice time difference between these two functions, native executable is 11 times faster. If it comes to deployment package size it’s 30% smaller (24 MB instead of 34 MB).&lt;/p&gt;
&lt;p&gt;Source code can be found &lt;a href=&quot;https://github.com/ajurasz/lambda-custom-runtime&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Managing schema evolution in the serverless stack]]></title><description><![CDATA[Looking on some of the AWS efforts around RDS service it won’t be an incorrect statement to say that they want to bring the world of…]]></description><link>https://ajurasz.github.io/2020-11-17-manage-schema-evolution-in-the-serverless-stack/</link><guid isPermaLink="false">https://ajurasz.github.io/2020-11-17-manage-schema-evolution-in-the-serverless-stack/</guid><pubDate>Tue, 17 Nov 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Looking on some of the AWS efforts around RDS service it won’t be an incorrect statement to say that they want to bring the world of relational databases closer to Lambda functions. First, &lt;a href=&quot;https://aws.amazon.com/rds/aurora/serverless/&quot;&gt;Aurora Serverless&lt;/a&gt; was &lt;a href=&quot;https://aws.amazon.com/blogs/aws/aurora-serverless-ga/&quot;&gt;announced&lt;/a&gt; then less than a year later this revolutionary service was extended by &lt;a href=&quot;https://aws.amazon.com/blogs/aws/new-data-api-for-amazon-aurora-serverless/&quot;&gt;Data API&lt;/a&gt; where interaction with DB is done through API endpoint. But this is not an end, the next year has come and we got &lt;a href=&quot;https://aws.amazon.com/blogs/aws/amazon-rds-proxy-now-generally-available/&quot;&gt;RDS proxy&lt;/a&gt; whose main task is to help improve applications scalability by managing DB connections.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;All these improvements show us that relational databases are relevant for serverless applications otherwise AWS wouldn’t put such a big effort in helping developers writing more efficient Lambda functions while working with RDS service.&lt;/p&gt;
&lt;p&gt;The main purpose of this introduction was to defend the topic of this blog post - &lt;strong&gt;managing schema evolution in the serverless stack&lt;/strong&gt; - which I hope doesn’t sound too abstract now. As befits a Java developer I could not resist bringing my own toolset to face the issue. The toolset consists of Java 11, Maven and Flyway.&lt;/p&gt;
&lt;h2&gt;CloudFormation&lt;/h2&gt;
&lt;p&gt;Let’s say that on the design level it was decided that the relational database will be best suited for the job. The first thing that arises is how can we initialize the RDS database with initial schema and then manage the evolution of that schema when all we have are just single-purpose functions containing business logic. There are multiple approaches to tackle this issue, &lt;a href=&quot;https://stackoverflow.com/questions/14384849/is-there-a-way-to-run-initial-sql-when-creating-an-rds-database-instance-using-c&quot;&gt;here&lt;/a&gt; you will find some interesting suggestions. I decided to take advantage of CloudFormation(CF) &lt;a href=&quot;https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html&quot;&gt;Custom Resources&lt;/a&gt;. This has some limitation which will be mentioned later on - but do not worry I will also show how to overcome them.&lt;/p&gt;
&lt;p&gt;My main goal was to set up a single-click deployment solution so that anyone could try and run this on his own AWS account. Since I will be using CF this will be not an issue. Furthermore, the main resource will be a Lambda function, in this case, it’s advisable to use AWS Serverless Application Model (AWS SAM) a template specification which provides a simple and clean way of describing Lambda functions (together with API endpoints if needed). But the specification is not all, we additionally get the utility tool (&lt;a href=&quot;https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html&quot;&gt;SAM CLI&lt;/a&gt;) which brings building, testing and deploying Lambda functions to the next level.  &lt;/p&gt;
&lt;h2&gt;Custom Resource&lt;/h2&gt;
&lt;p&gt;While new services are introduced on AWS they not always are immediately supported in CF, for this reason, Custom Resources where created which brings back doors to AWS API so that it’s possible to interact with these new services through code. Custom Resources can be also used to provide side effects like cleanup s3 bucket while removing a stack or run schema migration against DB like it will be in our case. Defining Custom Resource is very simple, we only need to provide &lt;code class=&quot;language-text&quot;&gt;ServiceToken&lt;/code&gt; which points to Lambda function or SNS topic:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;Resources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;LambdaMigrationFunctionTrigger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Custom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;LambdaMigrationFunctionTrigger
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;ServiceToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; MigrationFunction.Arn&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Base on this information CF sends &lt;a href=&quot;https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref-requests.html&quot;&gt;request object&lt;/a&gt; any time when this resource is created, updated or deleted. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;RequestType&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Create&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;ResponseURL&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;http://pre-signed-S3-url-for-response&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;StackId&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arn:aws:cloudformation:us-west-2:123456789012:stack/stack-name/guid&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;RequestId&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;unique id for this create request&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;ResourceType&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Custom::TestResource&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;LogicalResourceId&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;MyTestResource&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
   &lt;span class=&quot;token property&quot;&gt;&quot;ResourceProperties&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;Name&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Value&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;List&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;3&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
   &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Whenever CF stack is created or delete a request will be sent to target service, but to trigger an update request one of Custome Resource property needs to be updated. For our case, this is very important because most of the time Custom Resource should be triggered while updating Lambda function with new migration scripts. This limitation can be overcome by introducing a fake property (&lt;code class=&quot;language-text&quot;&gt;DeployTimestamp&lt;/code&gt;) which the only purpose will be to hold different value whenever CF stack is updated.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;Parameters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;DeployTimestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Number
    &lt;span class=&quot;token key atrule&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;Resources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;LambdaMigrationFunctionTrigger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Custom&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;LambdaMigrationFunctionTrigger
    &lt;span class=&quot;token key atrule&quot;&gt;Properties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;ServiceToken&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!GetAtt&lt;/span&gt; MigrationFunction.Arn
      &lt;span class=&quot;token key atrule&quot;&gt;DeployTimestamp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token tag&quot;&gt;!Ref&lt;/span&gt; DeployTimestamp&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Value of this property won’t change out of the box but can be easily overridden while uploading template from CLI&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# AWS CLI&lt;/span&gt;
aws cloudformation package --template-file &lt;span class=&quot;token variable&quot;&gt;$TEMPLATE&lt;/span&gt; --s3-bucket &lt;span class=&quot;token variable&quot;&gt;$AWS_S3_BUCKET&lt;/span&gt; --output-template-file out.yml
aws cloudformation deploy --template-file out.yml --stack-name &lt;span class=&quot;token variable&quot;&gt;$STACK_NAME&lt;/span&gt; --capabilities CAPABILITY_IAM --parameter-overrides &lt;span class=&quot;token assign-left variable&quot;&gt;DeployTimestamp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt; +%s&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# SAM CLI &lt;/span&gt;
sam deploy --stack-name &lt;span class=&quot;token variable&quot;&gt;$STACK_NAME&lt;/span&gt; --capabilities CAPABILITY_IAM --parameter-overrides &lt;span class=&quot;token assign-left variable&quot;&gt;DeployTimestamp&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;date&lt;/span&gt; +%s&lt;span class=&quot;token variable&quot;&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now CF will send update requests to Lambda function every time the CF stack if updated.&lt;/p&gt;
&lt;h2&gt;Architecture&lt;/h2&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/256ae5773ad607054c4b3c169f385da7/01dae/flyless-architecture.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 103.42857142857143%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAD40lEQVQ4y21US4tcRRTu3+BvEFy40oUbVwr+iYgbdwpuhIBEUXyRIAEhGASN8RE3BiKjwowZZ4Yw0zMuJDIPkmmmp3N7uu+t+34/6r4/T1Xf7umYFBxO3bpfnfrOOV9V79rOF+AFR15x8Grm8yrvPFmZIUeDbLSLeO0yeMiQNxWtL2PzxbxX0c+njnbuZ5Ni6zqSyy+jmR52681Tt/VE5PngxGZ+QCtjtbRvtpG7Gsx/ViXjBUb8/5/JgG3HYvV4BX3lHia+ApXtw80cuKkNJzFRdIfePVnF9mgDU38sceK/m1oSU9alCJgvGAaZCzU1YN//BfzG63AGf0EnsJGa4OwBqn9XEEQMWjSFHpJFKoxIkybmRV2gJ9JsRFpEMsw8MApg7a/AvfEmzMEG9MSAmXsID9fg3HwLvquAJToFUReBhGd0QFFTU1qcF7eoEvicUiCmw9N96T1Kyecu4siDzYhFFUuMWPeycy/SrkTKt3/7Ax98ehX3dvbg5S38tCDGLUmgRl6U1IRK+pK+xTDiAn5WoiZMWbfUoFbOhZdNefvi+3j2hVdw9cuvsKWE2DyxMHRSPHRLaCGHHueUVk4KEJ1t8OfAwubQxqnAmDFUwhiEYYQp6ga9W7fv4N1Ln2Fja5sECzDDhzHVYB3sgukOmB1SE3LJuKlrEn8jD2CdiUOFicAF/esNRkOsb+7AskkiSQaFTnW3f0J98wI1Zx3MK6jgmQzYUsCAV5gGfBFsObBkePGjz/H8S6/h+jc/IqOanOkB1MM+zDsfQ1NOoNsxbeCylm1VIswryYYtsXws4HufXMFzL76Ka19/h4yko0xM3D9WsHswwNFIg2b6klHeicHnNc78TAYV68LEfCIwImXbc6BqOtI0kxtSStvRTbCJCocZiFKOkPpRmiOU+7+jJd2mVYuYmMZFhYi8YB1SKUSne1VbLnR4xEKcBTli2uCSNDgxzqsKAhEfrMMjsR+dnmEclEgoSMBLZGUtUxXsGiEbTs+Q0J0Y24qH3aGJCXX6kUosLR+al4DFJfwgRGhq2Bk56I89DO1Eykakr3Xpy5TP73KLjBZCL8Ta38e49MMeHkx8mBRUDXOUXQ1zYmOS7ozOnmjK8uNgJwWiOMMbH36PZy7cws/9CTwvwFRqrJaHilsiZdPpby6dhQ7P38OW7mQBx4vwa/8h3vl2DwdaTAw9Cc67qyfqNg0yKSVtKegc0xMXej6iooWmuZhQ/ZSxiqlmw7BCqqHo4AwTk360sKArWdKNOTdGJjA9O7Go9SEiHsBJfei+hbE2xqOpgok+gRm5VCuPUg0I12Ho5RFrj1k0w/wHRMkiKDsRN4cAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Flyless architecture&quot;
        title=&quot;&quot;
        src=&quot;/static/256ae5773ad607054c4b3c169f385da7/8c557/flyless-architecture.png&quot;
        srcset=&quot;/static/256ae5773ad607054c4b3c169f385da7/4edbd/flyless-architecture.png 175w,
/static/256ae5773ad607054c4b3c169f385da7/13ae7/flyless-architecture.png 350w,
/static/256ae5773ad607054c4b3c169f385da7/8c557/flyless-architecture.png 700w,
/static/256ae5773ad607054c4b3c169f385da7/01dae/flyless-architecture.png 721w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;The sample architecture was prepared with an emphasis on security best practices for DBs running in the AWS cloud. &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DB instance is running in private subnet without ingress traffic from the internet. &lt;/li&gt;
&lt;li&gt;Restricted security group is assigned to this instance which allows only access from &lt;code class=&quot;language-text&quot;&gt;FnSecurityGroup&lt;/code&gt; source which in turn is associated with our Lambda function (&lt;code class=&quot;language-text&quot;&gt;MigrationFunction&lt;/code&gt;). &lt;/li&gt;
&lt;li&gt;DB credentials are stored in &lt;a href=&quot;https://aws.amazon.com/secrets-manager/&quot;&gt;AWS Secrets Manager&lt;/a&gt;, this way there is no need to pass sensitive data directly to Lambda function. &lt;/li&gt;
&lt;li&gt;Execution role associated with Lambda function allows it to fetch DB credentials.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Because RDS is running in private subnet without internet access, Lambda function had to be deployed within VPC. One of the Lambda function characteristics is that it cannot have a public IP address - to meet this requirements Lambda function needs to be deployed in a private subnet.
So how can we provide internet access for functions that need to be run in VPC? There are two options, set up a NAT Gateway or create VPC Endpoint for every service you need to communicate with. As shown in the above diagram we will use the first option.&lt;/p&gt;
&lt;h2&gt;Deployment&lt;/h2&gt;
&lt;p&gt;It’s finally time to get our hands dirty and run some code. First of all clone &lt;a href=&quot;https://github.com/ajurasz/flyless&quot;&gt;repository&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;git&lt;/span&gt; clone https://github.com/ajurasz/flyless.git&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;NOTICE:&lt;/strong&gt; See &lt;a href=&quot;https://github.com/ajurasz/flyless#prerequisites&quot;&gt;Prerequisites&lt;/a&gt; section in readme file.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;then run&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./deploy.sh&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;NOTICE:&lt;/strong&gt; While running script it’s expected that AWS CLI was configured.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Few interesting things are happening inside this script.&lt;/p&gt;
&lt;h3&gt;Building&lt;/h3&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;sam build&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;will build our maven project and run integration tests. These tests run schema migration against &lt;strong&gt;real DB&lt;/strong&gt; - same version that will be used in AWS - all of this was done with the help of &lt;a href=&quot;https://www.testcontainers.org/&quot;&gt;Testcontainers&lt;/a&gt;. With this library test code can be as easy and clean as:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Testcontainers&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@ExtendWith&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;MockitoExtension&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MigrationHandlerIT&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Container&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MySQLContainer&lt;/span&gt; mysql &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MySQLContainer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DockerImageName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parse&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;mysql:5.7.31&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withDatabaseName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getenv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RDS_DB_NAME&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withUsername&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getenv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RDS_USERNAME&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withPassword&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getenv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RDS_PASSWORD&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Mock&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;CfnResponse&lt;/span&gt; cfnResponse&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@BeforeEach&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setUp&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;EnvironmentVariables&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getenv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;RDS_PORT&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; mysql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFirstMappedPort&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Test&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@DisplayName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;should run all migration scripts&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// given&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; migrationHandler &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MigrationHandler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cfnResponse&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; input &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
                &lt;span class=&quot;token string&quot;&gt;&quot;RequestType&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Create&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token string&quot;&gt;&quot;RequestId&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;RequestId&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token string&quot;&gt;&quot;ResponseURL&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;http://pre-signed-S3-url-for-response&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token string&quot;&gt;&quot;StackId&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arn:aws:cloudformation:us-east-1:123456789012:stack/MyStack/guid&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                &lt;span class=&quot;token string&quot;&gt;&quot;LogicalResourceId&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;MyTestResource&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// when&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; response &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; migrationHandler&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;handleRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DummyContext&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token comment&quot;&gt;// then&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Assert&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;assertEquals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; response&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;verify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;cfnResponse&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;eq&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;SUCCESS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;CfnEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;any&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Environment variables used in the test were setup through &lt;code class=&quot;language-text&quot;&gt;maven-failsafe-plugin&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;artifactId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;maven-failsafe-plugin&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;artifactId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;2.22.2&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;version&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;configuration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;environmentVariables&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;RDS_DB_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;db_name&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;RDS_DB_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;RDS_USERNAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;user&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;RDS_USERNAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;RDS_PASSWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;password&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;RDS_PASSWORD&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;RDS_HOST&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;localhost&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;RDS_HOST&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;DB_STAGE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;test&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;DB_STAGE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;AWS_SAM_LOCAL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;true&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;AWS_SAM_LOCAL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;environmentVariables&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;configuration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;executions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;execution&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;integration-test&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;goals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;integration-test&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;verify&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;goals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;execution&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;executions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Tests can be also run independently without SAM CLI&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;mvn -f MigrationFunction/pom.xml clean verify&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Imitating AWS Lambda service&lt;/h3&gt;
&lt;p&gt;When I wrote that SAM CLI brings testing to the next level, here is why. There is a possibility to invoke function locally with &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;sam &lt;span class=&quot;token builtin class-name&quot;&gt;local&lt;/span&gt; invoke&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Under the hood SAM CLI setup infrastructure using docker containers that imitate AWS then it deploys our code to that infrastructure and finally executes that code. To run the migration function which depends on an external database all needed containers needs to be run under a single network.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;docker network create --driver bridge sam_flyless_newtork
docker run --rm -d --name sam_flyless_mysql --network sam_flyless_newtork -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_RANDOM_ROOT_PASSWORD&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;yes -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_DATABASE&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$DB_NAME&lt;/span&gt; -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_USER&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$DB_USERNAME&lt;/span&gt; -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_PASSWORD&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$DB_PASSWORD&lt;/span&gt; mysql:5.7.31

sam &lt;span class=&quot;token builtin class-name&quot;&gt;local&lt;/span&gt; invoke --event events/create_event.json --docker-network sam_flyless_newtork --env-vars env.json&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This way Lambda function will have direct access to DB container prepared in advance.
To have better control over what event will trigger the function or which environment variables will be available in the runtime following options can be specified &lt;code class=&quot;language-text&quot;&gt;--event&lt;/code&gt; (path to JSON file containing an event) and  &lt;code class=&quot;language-text&quot;&gt;--env-vars&lt;/code&gt; (path to JSON file containing environment variables available for the Lambda function).&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;NOTICE:&lt;/strong&gt; While passing environment variables through &lt;code class=&quot;language-text&quot;&gt;--env-vars&lt;/code&gt; option, only these that are expected by the function will be passed to the environment - others will be ignored.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;Demo&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/5ea780917802f0a44d8ee533187d82af/demo.gif&quot; alt=&quot;Demo&quot;&gt;&lt;/p&gt;
&lt;h2&gt;Cleanup&lt;/h2&gt;
&lt;p&gt;CF stack can be removed with ease with a single command&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;aws cloudformation delete-stack --stack-name &lt;span class=&quot;token variable&quot;&gt;$STACK_NAME&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As mentioned before, while CF stack is deleted a delete request is sent to the target service and CF expect to receive a response. To provide Lamdba function possibility to respond to CF, NAT Gateway needs to stay operational. We can ensure that all required resources will not be deleted until it’s still needed by Lambda function with &lt;a href=&quot;https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-dependson.html&quot;&gt;DependsOn&lt;/a&gt; attribute - which helps to explicitly mark dependencies between resources.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;Resources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;MigrationFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; AWS&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Serverless&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Function
    &lt;span class=&quot;token key atrule&quot;&gt;DependsOn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; DB
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PublicRTAssociation1
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PublicRTAssociation2
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PublicRTRouteToInternet
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PrivateRTAssociation3
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PrivateRTAssociation4
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; PrivateRTRouteToNG
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; IGAttachment&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;While working with relational databases in the serverless stack I don’t see any disadvantage of maintaining schema evolution in the way it was described. I just want to alert you to a fact that we must remember - execution time of Lambda function can be up to 15 min, so if you expect that your migration could take longer then you should think about a different approach.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Continuous Deployment on Kubernetes]]></title><description><![CDATA[If you are wondering how could you set up your build pipeline to do a deployment of your application to Kubernetes cluster then you can find…]]></description><link>https://ajurasz.github.io/2020-04-12-continuous-deployment-on-kubernetes/</link><guid isPermaLink="false">https://ajurasz.github.io/2020-04-12-continuous-deployment-on-kubernetes/</guid><pubDate>Sun, 12 Apr 2020 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;If you are wondering how could you set up your build pipeline to do a deployment of your application to Kubernetes cluster then you can find this post interesting.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Disclaimer&lt;/h2&gt;
&lt;p&gt;Everything that will be presented in this blog post was only used for Test and QA environments as a way to learn more about Kubernetes. It was not used for Prod environment yet so please keep this in your mind.&lt;/p&gt;
&lt;h2&gt;Stack&lt;/h2&gt;
&lt;p&gt;Before moving to details it’s worth mentioning what I have to disposal:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes cluster&lt;/li&gt;
&lt;li&gt;Jenkins pipeline job&lt;/li&gt;
&lt;li&gt;Private Docker registry&lt;/li&gt;
&lt;li&gt;Dockerized application&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Build&lt;/h2&gt;
&lt;p&gt;Since Jenkins pipeline job is in place then the deployment is as easy as adding a new stage to an existing job pipeline. I have called mine &lt;code class=&quot;language-text&quot;&gt;Deploy&lt;/code&gt;. This stage is responsible for the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;run only on &lt;code class=&quot;language-text&quot;&gt;develop&lt;/code&gt; branch&lt;/li&gt;
&lt;li&gt;build docker image&lt;/li&gt;
&lt;li&gt;push the docker image to a repository&lt;/li&gt;
&lt;li&gt;call &lt;a href=&quot;https://jenkins.io/doc/pipeline/steps/kubernetes-cd/#kubernetes-continuous-deploy-plugin&quot;&gt;Kubernetes Continuous Deploy Plugin&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;remove docker image from Jenkins worker (just to save space)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;pipeline {
    stages {
        stage(&amp;#39;Deploy&amp;#39;) {
            when {
                branch &amp;quot;develop&amp;quot;
            }

            environment {
                DOCKER_REPOSITORY = &amp;#39;127.0.0.1:5000&amp;#39;
                IMAGE_NAME = &amp;#39;app&amp;#39;
                IMAGE_TAG = sh(script: &amp;quot;git log -1 --pretty=%h&amp;quot;, returnStdout: true).trim()
                APP_IMAGE = &amp;quot;${DOCKER_REPOSITORY}/${IMAGE_NAME}:${IMAGE_TAG}&amp;quot;
            }

            steps {
                sh &amp;quot;&amp;quot;&amp;quot;
                docker build -t ${APP_IMAGE} ./docker
                &amp;quot;&amp;quot;&amp;quot;

                sh &amp;quot;&amp;quot;&amp;quot;
                docker push ${APP_IMAGE}
                &amp;quot;&amp;quot;&amp;quot;

                kubernetesDeploy(kubeconfigId: &amp;#39;k8s-config&amp;#39;, configs: &amp;#39;**/k8s/qa/app.yml&amp;#39;)
            }

            post {
                always {
                    sh &amp;quot;&amp;quot;&amp;quot;
                    docker rmi ${APP_IMAGE}
                    &amp;quot;&amp;quot;&amp;quot;
                }
            }
        }
    }
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the above snippet, there are two important things to notice. First is the registration of environment variable with name &lt;code class=&quot;language-text&quot;&gt;APP_IMAGE&lt;/code&gt;. The second most important thing is that kubernetes-cd plugin can substitute variables in the form of &lt;code class=&quot;language-text&quot;&gt;${APP_IMAGE}&lt;/code&gt; in the configuration file (&lt;code class=&quot;language-text&quot;&gt;app.yml&lt;/code&gt;) with variables from Jenkins environment. This is the default behaviour of the plugin and can be disabled with &lt;code class=&quot;language-text&quot;&gt;enableConfigSubstitution&lt;/code&gt; set to &lt;code class=&quot;language-text&quot;&gt;false&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Kubernetes configuration consists of the standard objects needed for deploying an application to the cluster&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-qa
  labels:
    app: app-qa
    env: qa
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: app-qa
      env: qa
  template:
    metadata:
      labels:
        app: app-qa
        env: qa
    spec:
      containers:
        - name: app-qa
          image: ${APP_IMAGE}
          imagePullPolicy: &amp;quot;IfNotPresent&amp;quot;
          ports:
            - containerPort: 8080
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: qa
          resources:
            limits:
              cpu: 500m
              memory: 256Mi
            requests:
              cpu: 500m
              memory: 256Mi
---
apiVersion: v1
kind: Service
metadata:
  name: app-qa
  labels:
    app: app-qa
    env: qa
spec:
  type: NodePort
  ports:
    - port: 8080
      nodePort: 31000
  selector:
    app: app-qa
    env: qa&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When the above configuration is applied then Kubernetes only updates these object that did change. So in case of successive deployment, only &lt;code class=&quot;language-text&quot;&gt;Deployment&lt;/code&gt; object is updated which represents our application. &lt;code class=&quot;language-text&quot;&gt;revisionHistoryLimit&lt;/code&gt; is an extra configuration which keeps previous &lt;code class=&quot;language-text&quot;&gt;Deployment&lt;/code&gt; object just in case if rollback is necessary.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Accessing HTTP request data from outside of calling thread]]></title><description><![CDATA[It’s almost end of 2019 but there is still a lot of application which depends on Servlet specification - this statement is base on my…]]></description><link>https://ajurasz.github.io/2019-12-28-accessing-request-data-from-outside-of-calling-thread/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-12-28-accessing-request-data-from-outside-of-calling-thread/</guid><pubDate>Sat, 28 Dec 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;It’s almost end of 2019 but there is still a lot of application which depends on Servlet specification - this statement is base on my personal experience where I still see the majority of a new application being built using this technology. In this blog post, I will focus on a single use case where we will retrieve HTTP request data from outside of calling thread in &lt;code class=&quot;language-text&quot;&gt;Spring Framework&lt;/code&gt;.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Problem&lt;/h2&gt;
&lt;p&gt;When using &lt;code class=&quot;language-text&quot;&gt;spring-webmvc&lt;/code&gt; in a standard way - according to Servlet 2.5 specification - then every incoming request is bound to a single thread for a life of that request (calling thread). Everything is fine until you start to do some &lt;em&gt;side processing in child thread&lt;/em&gt;. This is a common case when moving to less coupled communicating between modules in an application through Spring’s event bus. &lt;/p&gt;
&lt;p&gt;Let’s consider the following scenario:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Rest controller calls service&lt;/li&gt;
&lt;li&gt;Service publish event &lt;/li&gt;
&lt;li&gt;Event is processed by the listener in a new thread&lt;/li&gt;
&lt;li&gt;The listener uses a service which at some point - in execution chain - requires data from the HTTP request&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Output from above scenario will be sucessfull response to the client from rest controller and exception in logs saying that we try to access request attributes outside of an actual web request i.e:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;java.lang.IllegalStateException: No thread-bound request found: Are you referring to request attributes outside of an actual web request, or processing a request outside of the originally receiving thread? If you are actually operating within a web request and still receive this message, your code is probably running outside of DispatcherServlet: In this case, use RequestContextListener or RequestContextFilter to expose the current request.
	at org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RequestContextHolder.java:131&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.web.context.support.WebApplicationContextUtils.currentRequestAttributes&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WebApplicationContextUtils.java:313&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.web.context.support.WebApplicationContextUtils.access&lt;span class=&quot;token variable&quot;&gt;$400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WebApplicationContextUtils.java:66&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.web.context.support.WebApplicationContextUtils&lt;span class=&quot;token variable&quot;&gt;$RequestObjectFactory&lt;/span&gt;.getObject&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WebApplicationContextUtils.java:329&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.web.context.support.WebApplicationContextUtils&lt;span class=&quot;token variable&quot;&gt;$RequestObjectFactory&lt;/span&gt;.getObject&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WebApplicationContextUtils.java:324&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.beans.factory.support.AutowireUtils&lt;span class=&quot;token variable&quot;&gt;$ObjectFactoryDelegatingInvocationHandler&lt;/span&gt;.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AutowireUtils.java:295&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-beans-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at com.sun.proxy.&lt;span class=&quot;token variable&quot;&gt;$Proxy59&lt;/span&gt;.getHeader&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Unknown Source&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at io.github.ajurasz.demo.GetUserId.userId&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;GetUserId.java:18&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;classes/:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at io.github.ajurasz.demo.MyEventListener.handleEvent&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MyEventListener.java:28&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;classes/:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at io.github.ajurasz.demo.MyEventListener.handle&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MyEventListener.java:23&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;classes/:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at io.github.ajurasz.demo.MyEventListener&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;FastClassBySpringCGLIB&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;e876a886.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;generated&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;classes/:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.cglib.proxy.MethodProxy.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;MethodProxy.java:218&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.aop.framework.CglibAopProxy&lt;span class=&quot;token variable&quot;&gt;$CglibMethodInvocation&lt;/span&gt;.invokeJoinpoint&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CglibAopProxy.java:769&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReflectiveMethodInvocation.java:163&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.aop.framework.CglibAopProxy&lt;span class=&quot;token variable&quot;&gt;$CglibMethodInvocation&lt;/span&gt;.proceed&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CglibAopProxy.java:747&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda&lt;span class=&quot;token variable&quot;&gt;$invoke&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AsyncExecutionInterceptor.java:115&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at java.base/java.util.concurrent.FutureTask.run&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$capture&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FutureTask.java:264&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at java.base/java.util.concurrent.FutureTask.run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FutureTask.java&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadPoolExecutor.java:1128&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at java.base/java.util.concurrent.ThreadPoolExecutor&lt;span class=&quot;token variable&quot;&gt;$Worker&lt;/span&gt;.run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ThreadPoolExecutor.java:628&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
	at java.base/java.lang.Thread.run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Thread.java:834&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All make sense as under the hood &lt;code class=&quot;language-text&quot;&gt;RequestContextHolder&lt;/code&gt; is used which in turn stores request attributes in &lt;code class=&quot;language-text&quot;&gt;ThreadLocal&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;Solution&lt;/h2&gt;
&lt;p&gt;To access HTTP request data from outside of calling thread we could extend &lt;code class=&quot;language-text&quot;&gt;ThreadPoolTaskExecutor&lt;/code&gt;, copy existing request attributes provided by &lt;code class=&quot;language-text&quot;&gt;RequestContextHolder#currentRequestAttributes&lt;/code&gt; and set them in a new thread through &lt;code class=&quot;language-text&quot;&gt;RequestContextHolder#setRequestAttributes&lt;/code&gt;. Below is sample implementation:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyThreadPoolTaskExecutor&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ThreadPoolTaskExecutor&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Future&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; task&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;submit&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyCallable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;task&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RequestContextHolder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;currentRequestAttributes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ListenableFuture&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;submitListenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; task&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;super&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;submitListenable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyCallable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;task&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RequestContextHolder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;currentRequestAttributes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyCallable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; callable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RequestAttributes&lt;/span&gt; requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyCallable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Callable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; callable&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RequestAttributes&lt;/span&gt; requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;callable &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; callable&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;requestAttributes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RequestAttributes&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;copy&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;RequestAttributes&lt;/span&gt; requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token comment&quot;&gt;// RequestAttributes needs to be copied as it will be garbage collected when origin request will complete.&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;T&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;RequestContextHolder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setRequestAttributes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;requestAttributes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; callable&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;call&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;finally&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token class-name&quot;&gt;RequestContextHolder&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;resetRequestAttributes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then we need to instruct spring to use our custom implementation of &lt;code class=&quot;language-text&quot;&gt;TaskExecutor&lt;/code&gt; like so:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Bean&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;TaskExecutor&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;taskExecutor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ThreadPoolTaskExecutor&lt;/span&gt; taskExecutor &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MyThreadPoolTaskExecutor&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        taskExecutor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setMaxPoolSize&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        taskExecutor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setQueueCapacity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        taskExecutor&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setThreadNamePrefix&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;my-executor-&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; taskExecutor&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Please notice that the above solution should be considered more like a workaround than a final solution. A better approach would be to extract all required data while still in the context of calling thread and then pass these data to all interested parties.&lt;/p&gt;
&lt;p&gt;The full example can be found at &lt;a href=&quot;https://github.com/ajurasz/no-thread-bound-request&quot;&gt;github&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[equals operator in Groovy]]></title><description><![CDATA[If you come from Java land and are lucky enough then you probably write your tests in  using . Then you already know that  allow overriding…]]></description><link>https://ajurasz.github.io/2019-10-27-equals-operator-in-groovy/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-10-27-equals-operator-in-groovy/</guid><pubDate>Sun, 27 Oct 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;If you come from Java land and are lucky enough then you probably write your tests in &lt;code class=&quot;language-text&quot;&gt;Spock&lt;/code&gt; using &lt;code class=&quot;language-text&quot;&gt;Groovy&lt;/code&gt;. Then you already know that &lt;code class=&quot;language-text&quot;&gt;Groovy&lt;/code&gt; allow overriding operators (you can find more about them in &lt;a href=&quot;https://groovy-lang.org/operators.html&quot;&gt;docs&lt;/a&gt;) and one of them is &lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt; which in contrast to &lt;code class=&quot;language-text&quot;&gt;Java&lt;/code&gt; does not compare objects reference but their equality through &lt;code class=&quot;language-text&quot;&gt;equals&lt;/code&gt; method.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;Let’s assume we have got following &lt;code class=&quot;language-text&quot;&gt;Java&lt;/code&gt; classes:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; timestamp &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Instant&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;now&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toEpochMilli&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;o &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt; event &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; timestamp &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timestamp&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hashCode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Objects&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestamp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;	
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;UUID&lt;/span&gt; correlationId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	
	&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;UUID&lt;/span&gt; correlationId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;correlationId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; correlationId
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;equals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;o &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt; event &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; corelationId &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; event&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;corelationId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hashCode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Objects&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;corelationId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;	
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If we would write a test for equality I would look something like this: &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;groovy&quot;&gt;&lt;pre class=&quot;language-groovy&quot;&gt;&lt;code class=&quot;language-groovy&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ApplicationEventSpec&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Specification&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token string gstring&quot;&gt;&quot;should recognize equal objects&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token spock-block&quot;&gt;given:&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; correlationId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; UUID&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;randomUUID&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		
		&lt;span class=&quot;token spock-block&quot;&gt;expect:&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;correlationId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ApplicationEvent&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;correlationId&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// true&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above test will start failing after implementing &lt;code class=&quot;language-text&quot;&gt;Comparable&lt;/code&gt; interface on &lt;code class=&quot;language-text&quot;&gt;Event&lt;/code&gt; class.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Comparable&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;compareTo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Event&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;compare&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;timestamp&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;timestamp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;	
	
	&lt;span class=&quot;token comment&quot;&gt;// rest of the code from the previous snippet stays as it was&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Unfortunately, I didn’t figure what is wrong on my own so I had to look for an explanation on the web. In the official &lt;a href=&quot;http://docs.groovy-lang.org/latest/html/documentation/#_behaviour_of_code_code&quot;&gt;documentation&lt;/a&gt; I have found the following:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In Groovy &lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt; translates to &lt;code class=&quot;language-text&quot;&gt;a.compareTo(b)==0&lt;/code&gt;, if they are &lt;code class=&quot;language-text&quot;&gt;Comparable&lt;/code&gt;, and &lt;code class=&quot;language-text&quot;&gt;a.equals(b)&lt;/code&gt; otherwise.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So there is a single exception for &lt;code class=&quot;language-text&quot;&gt;==&lt;/code&gt; operator which is useful to know. If it comes to failing test it can be fixed by explicitly calling &lt;code class=&quot;language-text&quot;&gt;equals&lt;/code&gt; method.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Micronaut, Testcontainers and Spock]]></title><description><![CDATA[Before adopting a new framework I always verify does it provide decent testing support. If you follow  principles then to test your business…]]></description><link>https://ajurasz.github.io/2019-08-25-micronaut-testcontainers-spock/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-08-25-micronaut-testcontainers-spock/</guid><pubDate>Sun, 25 Aug 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Before adopting a new framework I always verify does it provide decent testing support. If you follow &lt;code class=&quot;language-text&quot;&gt;SOLID&lt;/code&gt; principles then to test your business logic you just need a test framework like &lt;code class=&quot;language-text&quot;&gt;JUnit&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;Spock&lt;/code&gt;. Things get complicated when we want to test our code on integration level where business logic and infrastructure code are glue together and check if they behave correctly. This post focuses on writing
integration tests (IT) for &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; application.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;&lt;a href=&quot;https://micronaut.io/index.html&quot;&gt;Micronaut&lt;/a&gt; is a new kid on the block as its first GA release was less than a year ago on October 23, 2018. It has a lot of interesting features about which you can read in their official &lt;a href=&quot;https://docs.micronaut.io/latest/guide/index.html&quot;&gt;documentation&lt;/a&gt; but for this post, I will mention just one. It has blazing-fast startup time thanks to ahead of time compilation - I will explain later why this is important in case of ITs.&lt;/p&gt;
&lt;p&gt;When writing integration tests your application will probably require some third-party services to work. In most cases, this will be a database. And to be honest, nowadays this requirement can be easily achieved with the help of different CI vendors. Following is the sample configuration of the two most popular CI platforms where we mark what additional services are required for our build process:&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Travis CI&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yml&quot;&gt;&lt;pre class=&quot;language-yml&quot;&gt;&lt;code class=&quot;language-yml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;# travis.yml&lt;/span&gt;

&lt;span class=&quot;token key atrule&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; mysql &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;CircleCI&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;version: 2
jobs:
  build:
    docker:
      - image: circleci/openjdk:8-jdk
      - image: mysql

    steps:
      - setup_remote_docker&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But what if we want to run IT locally - then we need to start required docker containers before execution. I know that people often tend to use in-memory replacements for differents services but in my mind, IT
should be as close as possible to the target environment. But there is a better solution than manually taking care of running all required containers - &lt;a href=&quot;https://www.testcontainers.org/&quot;&gt;Testcontainers&lt;/a&gt; is a library that allows us to easily manage docker infrastructure from our test code. &lt;/p&gt;
&lt;h2&gt;Base structure&lt;/h2&gt;
&lt;p&gt;If it comes to testing &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;Testcontainers&lt;/code&gt; each has handy annotation which brings their functionality to life. &lt;/p&gt;
&lt;h3&gt;Micronaut&lt;/h3&gt;
&lt;p&gt;For &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; this is a &lt;code class=&quot;language-text&quot;&gt;@MicronautTest&lt;/code&gt; which starts your real application same way as you would run &lt;code class=&quot;language-text&quot;&gt;java -jar ...&lt;/code&gt; command. Usually, you would create some base class with all required configuration
and then inherit it from your IT cases. Something like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;groovy&quot;&gt;&lt;pre class=&quot;language-groovy&quot;&gt;&lt;code class=&quot;language-groovy&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// IntegrationSpecificationBase.groovy&lt;/span&gt;

&lt;span class=&quot;token annotation punctuation&quot;&gt;@MicronautTest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;environments &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string gstring&quot;&gt;&quot;it&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IntegrationSpecificationBase&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Specification&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TestPropertyProvider&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    Map&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; String&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getProperties&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// TodoControllerSpec.groovy&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TodoControllerSpec&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IntegrationSpecification&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;token string gstring&quot;&gt;&quot;should get all todos&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token comment&quot;&gt;// test body&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This setup revels one potential problem. Potential because it does not have to be a problem for every case due to the main feature of the framework mentioned at the beginning - fast startup time.
Problem is with the way how &lt;code class=&quot;language-text&quot;&gt;MicronautTest&lt;/code&gt; annotation is bound to test execution lifecycle - &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; application is built and started in &lt;code class=&quot;language-text&quot;&gt;setupSpec&lt;/code&gt;. Tear down happen in &lt;code class=&quot;language-text&quot;&gt;cleanupSpec&lt;/code&gt;. So
in the above example, &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; application will be started/stopped twice. This can be fixed simply by not using &lt;code class=&quot;language-text&quot;&gt;@MicronautTest&lt;/code&gt; annotation, i.e.:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;groovy&quot;&gt;&lt;pre class=&quot;language-groovy&quot;&gt;&lt;code class=&quot;language-groovy&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IntegrationSpecificationBase&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Specification&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;implements&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TestPropertyProvider&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token annotation punctuation&quot;&gt;@AutoCleanup&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; EmbeddedServer embeddedServer &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ApplicationContext&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
            EmbeddedServer&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; Map&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; Object&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token string gstring&quot;&gt;&quot;it&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Which approach you will choose should mostly be dictated by how long it takes for your application to start. Although &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; is fast, other libraries that you use doesn’t need to be as fast (e.g. &lt;code class=&quot;language-text&quot;&gt;micronaut-hibernate-jpa&lt;/code&gt;).&lt;/p&gt;
&lt;h3&gt;Testcontainers&lt;/h3&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;@Testcontainers&lt;/code&gt; annotation similarly to &lt;code class=&quot;language-text&quot;&gt;@MicronautTest&lt;/code&gt; is bound to the same lifecycle phases. Unfortunately, right now there is no way of defining processing order - &lt;a href=&quot;https://github.com/spockframework/spock/issues/646&quot;&gt;change request&lt;/a&gt; was already proposed on github. Because of this, I don’t see the possibility to use these two annotations together. Our desired behaviour would
be to start all required docker containers before starting &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; application. This could be achieved in two ways.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Spock global extension&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A global extension can be used to execute some code at the very start and the very end of &lt;code class=&quot;language-text&quot;&gt;Spock&lt;/code&gt; execution. There are three steps needed to create such an extension:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;META-INF/services/org.spockframework.runtime.extension.IGlobalExtension&lt;/code&gt; file&lt;/li&gt;
&lt;li&gt;Create a class that implements &lt;code class=&quot;language-text&quot;&gt;IGlobalExtension&lt;/code&gt; interface&lt;/li&gt;
&lt;li&gt;Add fully-qualified class name created in step &lt;code class=&quot;language-text&quot;&gt;2&lt;/code&gt; to file created in step &lt;code class=&quot;language-text&quot;&gt;1&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Following example shows how to start all defined containers by using global extension:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;groovy&quot;&gt;&lt;pre class=&quot;language-groovy&quot;&gt;&lt;code class=&quot;language-groovy&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DockerInfrastructureRunner&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;AbstractGlobalExtension&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; Collection&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;GenericContainer&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; containers &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
            MySqlContainer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;MY_SQL_CONTAINER
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        containers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;each &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isRunning&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;stop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        containers&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;each &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isRunning&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;Groovy &lt;code class=&quot;language-text&quot;&gt;with&lt;/code&gt; method &lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We can also take advantage of some groovy goodness and declare and start docker container in one go like:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;groovy&quot;&gt;&lt;pre class=&quot;language-groovy&quot;&gt;&lt;code class=&quot;language-groovy&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MySqlContainer&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; GenericContainer MY_SQL_CONTAINER &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;GenericContainer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string gstring&quot;&gt;&quot;mysql:8&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withEnv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string gstring&quot;&gt;&quot;MYSQL_ROOT_PASSWORD&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string gstring&quot;&gt;&quot;password&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withEnv&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string gstring&quot;&gt;&quot;MYSQL_DATABASE&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string gstring&quot;&gt;&quot;it&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withExposedPorts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3306&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;with &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                it
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;When you want to use desired tools you will have to agree on a few workarounds to make everything works as you want. The biggest surprise for me was not being able to run &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;Testcontainers&lt;/code&gt; just once out of the box together with &lt;code class=&quot;language-text&quot;&gt;Spock&lt;/code&gt;. It is also worth noticing that &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;Testcontainers&lt;/code&gt; project contains modules for &lt;code class=&quot;language-text&quot;&gt;JUnit&lt;/code&gt; where start and stop functions are done in &lt;code class=&quot;language-text&quot;&gt;BeforeAllCallback&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;AfterAllCallback&lt;/code&gt; which base on Javadoc should be
executed just once for a single extension (i.e. before and after all our tests).&lt;/p&gt;
&lt;p&gt;The complete example can be found at &lt;a href=&quot;https://github.com/ajurasz/micronaut-it&quot;&gt;github&lt;/a&gt;. There are two branches:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;develop&lt;/code&gt; where &lt;code class=&quot;language-text&quot;&gt;@MicronautTest&lt;/code&gt; annotation is used together with &lt;code class=&quot;language-text&quot;&gt;Spock&lt;/code&gt; global extension&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;shared-context&lt;/code&gt; where &lt;code class=&quot;language-text&quot;&gt;Micronaut&lt;/code&gt; is started manually and docker containers by the usage of groovy &lt;code class=&quot;language-text&quot;&gt;with&lt;/code&gt; method&lt;/li&gt;
&lt;/ol&gt;</content:encoded></item><item><title><![CDATA[NOT NULL is NOT NULL]]></title><description><![CDATA[Recently I learned that MySQL 5.6 is so “nice” that it can provide default values for columns that have  constrain when values for these…]]></description><link>https://ajurasz.github.io/2019-08-02-not-null-is-not-null/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-08-02-not-null-is-not-null/</guid><pubDate>Fri, 02 Aug 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Recently I learned that MySQL 5.6 is so “nice” that it can provide default values for columns that have &lt;code class=&quot;language-text&quot;&gt;NOT NULL&lt;/code&gt; constrain when values for these columns are missing during insertion.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;This feature is called &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.6/en/data-type-defaults.html#data-types-defaults-implicit&quot;&gt;Implicit Defaults&lt;/a&gt;. Below is a complete example which shows this feature:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; docker run --name some-mysql -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_ROOT_PASSWORD&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;root -d mysql:5.6
&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; docker &lt;span class=&quot;token builtin class-name&quot;&gt;exec&lt;/span&gt; -it some-mysql &lt;span class=&quot;token function&quot;&gt;bash&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;# mysql -u root -p&lt;/span&gt;
Enter password:

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; CREATE DATABASE &lt;span class=&quot;token builtin class-name&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Query OK, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; row affected &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.01&lt;/span&gt; sec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; use &lt;span class=&quot;token builtin class-name&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Database changed
mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; CREATE TABLE MY_DATA &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    -&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; name VARCHAR&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; NOT NULL,
    -&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; value INT NOT NULL&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Query OK, &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; rows affected &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.05&lt;/span&gt; sec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; INSERT INTO MY_DATA &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name, value&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; VALUES &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Query OK, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; row affected &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.04&lt;/span&gt; sec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; INSERT INTO MY_DATA &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; VALUES &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;c&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
Query OK, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; row affected, &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; warning &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.01&lt;/span&gt; sec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; SELECT * FROM MY_DATA&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
+----+------+-------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; value &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----+------+-------+
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; a    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;  &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; c    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;     &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;
+----+------+-------+
&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; rows &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.04&lt;/span&gt; sec&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Base on the linked documentation for implicit defaults our database server has got &lt;strong&gt;strict mode disabled by default&lt;/strong&gt;. What is strict mode? &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Strict mode controls how MySQL handles invalid or missing values in data-change statements such as INSERT or UPDATE.
Source: &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-strict#sql-mode-strict&quot;&gt;https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-strict#sql-mode-strict&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;If we will repeat above code snipped with a more recent version of MySQL like 8 were &lt;strong&gt;strict mode is enabled by default&lt;/strong&gt; then last insert command won’t work.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; docker run --name some-mysql -e &lt;span class=&quot;token assign-left variable&quot;&gt;MYSQL_ROOT_PASSWORD&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;root -d mysql:8

&lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;.

mysql&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; INSERT INTO MY_DATA &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; VALUES &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;c&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
ERROR &lt;span class=&quot;token number&quot;&gt;1364&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;HY000&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;: Field &lt;span class=&quot;token string&quot;&gt;&apos;value&apos;&lt;/span&gt; doesn&apos;t have a default value&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;When you work with MySQL and use a different version of the software make yourself a favour and check what SQL mode(s) are set on the environment with which you start to work. This can be done with single SQL command:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sql&quot;&gt;&lt;pre class=&quot;language-sql&quot;&gt;&lt;code class=&quot;language-sql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;SELECT&lt;/span&gt; @&lt;span class=&quot;token variable&quot;&gt;@GLOBAL.sql_mode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and then invest few minutest to learn how enabled modes affect the SQL syntax MySQL supports and how data validation checks are performed. You can find a full list of SQL modes &lt;a href=&quot;https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-full&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;So that you won’t have to spend a few hours figuring out why some of your e2e tests doesn’t work only on one environment!&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Spring Boot Maven Plugin and provided scope]]></title><description><![CDATA[If you come from the JavaEE world you probably did set some of your project dependencies to the scope of  if so then you can find one fact…]]></description><link>https://ajurasz.github.io/2019-07-05-spring-boot-maven-plugin-and-provided-scope/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-07-05-spring-boot-maven-plugin-and-provided-scope/</guid><pubDate>Fri, 05 Jul 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;If you come from the JavaEE world you probably did set some of your project dependencies to the scope of &lt;code class=&quot;language-text&quot;&gt;provided&lt;/code&gt; if so then you can find one fact about &lt;code class=&quot;language-text&quot;&gt;spring-boot-maven-plugin&lt;/code&gt; to be interesting.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;After adding &lt;code class=&quot;language-text&quot;&gt;provided&lt;/code&gt; scope to a dependency you expect that JDK or container (like JavaEE application server) will provide this dependency at runtime. Expected behaviour when running application without providing these dependencies will be to see &lt;code class=&quot;language-text&quot;&gt;NoClassDefFoundError&lt;/code&gt; or &lt;code class=&quot;language-text&quot;&gt;ClassNotFoundException&lt;/code&gt; all depends on how these missing classes are accessed (for more information see &lt;a href=&quot;https://dzone.com/articles/java-classnotfoundexception-vs-noclassdeffounderro&quot;&gt;this article&lt;/a&gt;). But this is not a case when using &lt;code class=&quot;language-text&quot;&gt;spring-boot-maven-plugin&lt;/code&gt; to run your application in standalone mode i.e. outside of any kind of container. After reading the explanation from Phil Webb (Pivotal) this behaviour makes sense:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The packaging of provided scoped jars is intentional. The reason for this is that many developers are used to adding things like servlet-api as provided. Since there won’t be a servlet container to actually “provide” the dependency we package it inside the JAR.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Source: &lt;a href=&quot;https://github.com/spring-projects/spring-boot/issues/413#issuecomment-36361340&quot;&gt;https://github.com/spring-projects/spring-boot/issues/413#issuecomment-36361340&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;In &lt;code class=&quot;language-text&quot;&gt;spring-boot-maven-plugin&lt;/code&gt; sources we can find how dependencies are loaded for &lt;code class=&quot;language-text&quot;&gt;run&lt;/code&gt; goal.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;AbstractRunMojo.java&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;addDependencies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;URL&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; urls&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MalformedURLException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;MojoExecutionException&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;FilterArtifacts&lt;/span&gt; filters &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;useTestClasspath &lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getFilters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getFilters&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;TestArtifactFilter&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Artifact&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; artifacts &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;filterDependencies&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;project&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getArtifacts&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; filters&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Artifact&lt;/span&gt; artifact &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; artifacts&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;artifact&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            urls&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;artifact&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getFile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toURI&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toURL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;this.project.getArtifacts()&lt;/code&gt; loads all project dependencies including transitive ones (&lt;code class=&quot;language-text&quot;&gt;provided&lt;/code&gt; scoped are loaded as well!). After, the load is done we removed dependencies based on configured filters - by default only test classes are removed. Yet it is still possible to make some exclusion in the plugin configuration.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;When your project deliverable is a war file that will be run in a container then it is very pleasant to be able to run it in standalone mode without additional tweaks when there are some &lt;code class=&quot;language-text&quot;&gt;provided&lt;/code&gt; scoped dependencies.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Build a native image with GraalVM]]></title><description><![CDATA[Last month first production-ready version of  with number  was released.  is a virtual machine capable to run application written in…]]></description><link>https://ajurasz.github.io/2019-06-08-build-native-imge-with-graalvm/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-06-08-build-native-imge-with-graalvm/</guid><pubDate>Sat, 08 Jun 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Last month first production-ready version of &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt; with number &lt;code class=&quot;language-text&quot;&gt;19.0&lt;/code&gt; was released. &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt; is a virtual machine capable to run application written in &lt;code class=&quot;language-text&quot;&gt;JavaScript&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Python&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Ruby&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;R&lt;/code&gt;, LLVM-based languages like &lt;code class=&quot;language-text&quot;&gt;C&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;C++&lt;/code&gt; and of course our beloved JVM-based languages like &lt;code class=&quot;language-text&quot;&gt;Java&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Scala&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Kotlin&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;Groovy&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;Clojure&lt;/code&gt;. &lt;!-- end --&gt; Some of the main goals for this new virtual machine are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;improve the performance of applications build with JVM-based languages&lt;/li&gt;
&lt;li&gt;reduce startup time by usage of AOT (ahead-of-time) compilation&lt;/li&gt;
&lt;li&gt;write polyglot applications&lt;/li&gt;
&lt;li&gt;compile JVM-based code to a standalone executable a.k.a. native image.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;With this post, I would like to focus on the last goal and build a native image. The assumption is very simple, take &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; library, write some &lt;code class=&quot;language-text&quot;&gt;Java&lt;/code&gt; code to interact with this library and then from terminal quickly test any &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expression you can think of, like&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s https://api.github.com/users/ajurasz &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; json_path &lt;span class=&quot;token string&quot;&gt;&quot;$.created_at&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Native image?&lt;/h2&gt;
&lt;p&gt;As already mentioned one of the main goals of &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt; is the possibility to produce native images which are executables that do not require JRE (java runtime environment) to be present on the system. At first, when I heard about this feature I thought that the code instead to be compiled to bytecode will be directly compiled to machine code but I was wrong. During the process of creating a native image, all classes of our application and their dependencies are statically analyses to know which part of that code is reachable during runtime. These static analyses take JDK code under consideration as well. When we know all classes and methods used in the runtime then &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt; compiles it ahead-of-time. To make this AOT compiled code to run we still need some runtime on which our program can be run. The produced native image includes something called &lt;code class=&quot;language-text&quot;&gt;Substrate VM&lt;/code&gt; which is an embeddable virtual machine containing components like memory management, thread scheduling, de-optimizer or even garbage collector. Having an initial idea about what native image is let’s install &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt;, &lt;code class=&quot;language-text&quot;&gt;native-image&lt;/code&gt; utility and write some code.&lt;/p&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First, let’s install &lt;code class=&quot;language-text&quot;&gt;GraalVM&lt;/code&gt; through &lt;code class=&quot;language-text&quot;&gt;sdkman&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; update
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;unzip&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;zip&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s &lt;span class=&quot;token string&quot;&gt;&quot;https://get.sdkman.io&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bash&lt;/span&gt;
&lt;span class=&quot;token builtin class-name&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/home/ubuntu/.sdkman/bin/sdkman-init.sh&quot;&lt;/span&gt;
sdk &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; java &lt;span class=&quot;token number&quot;&gt;19.0&lt;/span&gt;.0-grl&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To use &lt;code class=&quot;language-text&quot;&gt;native-image&lt;/code&gt; command beside native image utility there are some &lt;a href=&quot;https://www.graalvm.org/docs/reference-manual/aot-compilation/#prerequisites&quot;&gt;prerequisites&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;gu &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; native-image
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; build-essential
&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;apt&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; libz-dev&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Code&lt;/h2&gt;
&lt;p&gt;As shown above, we want to pipe output from &lt;code class=&quot;language-text&quot;&gt;curl&lt;/code&gt; command to our application as input. To get access to this input from application level we need to read it from &lt;code class=&quot;language-text&quot;&gt;System.in&lt;/code&gt;. &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expression will be simply passed as an argument. In the end, we just need to evaluate the expression against received json. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;BufferedReader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;io&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;InputStreamReader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;java&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;util&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;stream&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Collectors&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;token namespace&quot;&gt;com&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;jayway&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;jsonpath&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;JsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Application&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; expression &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;extractExpression&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; json &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readInput&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;out&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;evaluate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; expression&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;extractExpression&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;IllegalArgumentException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Single JsonPath expression is required.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;readInput&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;BufferedReader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InputStreamReader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;in&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;lines&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;collect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Collectors&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;joining&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;evaluate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; json&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; expression&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;JsonPath&lt;/span&gt; jsonPath &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;JsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;compile&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;expression&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; jsonPath&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;read&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Compilation&lt;/h2&gt;
&lt;p&gt;First, we need to compile our java code with &lt;code class=&quot;language-text&quot;&gt;javac&lt;/code&gt; command&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;javac -cp &lt;span class=&quot;token string&quot;&gt;&quot;libs/*&quot;&lt;/span&gt; Application.java&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;libs&lt;/code&gt; directory contains all 3rd party dependencies required for this application to run&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;tree
&lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;
├── Application.java
└── libs
    ├── accessors-smart-1.2.jar
    ├── asm-5.0.4.jar
    ├── json-path-2.4.0.jar
    ├── json-smart-2.3.jar
    ├── slf4j-api-1.7.25.jar
    └── slf4j-jdk14-1.7.25.jar

&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; directory, &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt; files&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After successful ran of compile command &lt;code class=&quot;language-text&quot;&gt;Application.class&lt;/code&gt; should be produced.&lt;/p&gt;
&lt;h2&gt;Build native image&lt;/h2&gt;
&lt;p&gt;Command to build native image is very similar to compiling java file, it requires only java class and &lt;code class=&quot;language-text&quot;&gt;-cp&lt;/code&gt; parameter in case if we use external dependencies which we do.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;native-image -cp &lt;span class=&quot;token string&quot;&gt;&quot;.:libs/*&quot;&lt;/span&gt; -H:Name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;json_path  Application &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;-H:Name&lt;/code&gt; is used just to give a name to produced executable. But running above command will fail with the following message&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;Warning: Aborting stand-alone image build. com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;String, byte&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;, int, int&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; is reachable: The declaring class of this element has been substituted, but this element is not present &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; the substitution class
To diagnose the issue, you can &lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt; the option --report-unsupported-elements-at-runtime. The unsupported element is &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; reported at run &lt;span class=&quot;token function&quot;&gt;time&lt;/span&gt; when it is accessed the first time.
Detailed message:
Trace:
        at parsing net.minidev.asm.DynamicClassLoader.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DynamicClassLoader.java:86&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Call path from entry point to net.minidev.asm.DynamicClassLoader.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;String, byte&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;:
        at net.minidev.asm.DynamicClassLoader.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DynamicClassLoader.java:81&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.asm.BeansAccessBuilder.bulid&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BeansAccessBuilder.java:313&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.asm.BeansAccess.get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BeansAccess.java:111&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.reader.BeansWriterASM.writeJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;BeansWriterASM.java:17&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.JSONValue.writeJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JSONValue.java:586&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.reader.JsonWriter&lt;span class=&quot;token variable&quot;&gt;$5&lt;/span&gt;.writeJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JsonWriter.java:113&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.reader.JsonWriter&lt;span class=&quot;token variable&quot;&gt;$5&lt;/span&gt;.writeJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JsonWriter.java:1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.JSONArray.writeJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JSONArray.java:75&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.JSONArray.toJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JSONArray.java:52&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.JSONArray.toJSONString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JSONArray.java:102&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at net.minidev.json.JSONArray.toString&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JSONArray.java:113&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at java.lang.String.valueOf&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;String.java:2994&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at java.lang.StringBuilder.append&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;StringBuilder.java:131&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.oracle.svm.core.amd64.AMD64CPUFeatureAccess.verifyHostSupportsArchitecture&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AMD64CPUFeatureAccess.java:179&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.oracle.svm.core.JavaMainWrapper.run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JavaMainWrapper.java:131&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.oracle.svm.core.code.IsolateEnterStub.JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;generated:0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Native images don’t support dynamic class loading and this is understandable due to the nature of AOT compilation where all classes and bytecodes that are ever reachable needs to be known at compile time. To see the full list of native image limitation see &lt;a href=&quot;https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md&quot;&gt;https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md&lt;/a&gt;. But we still can take advantage of the suggested solution and postpone any errors resulting from dynamic class loading to runtime by using &lt;code class=&quot;language-text&quot;&gt;--report-unsupported-elements-at-runtime&lt;/code&gt; option. Let’s make the second attempt to build a native image&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt; native-image -cp &lt;span class=&quot;token string&quot;&gt;&quot;.:libs/*&quot;&lt;/span&gt; -H:Name&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;json_path --report-unsupported-elements-at-runtime  Application&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; This time it worked and &lt;code class=&quot;language-text&quot;&gt;json_path&lt;/code&gt; executable was created. To make our life easier let’s register this executable to be accessible globally in our system&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;sudo&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;ln&lt;/span&gt; -s /home/ubuntu/app/json_path /usr/local/bin/json_path&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and let’s give it a try&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s https://api.github.com/users/ajurasz &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; json_path &lt;span class=&quot;token string&quot;&gt;&quot;$.created_at&quot;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;2013&lt;/span&gt;-03-23T12:56:53Z&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Works like a charm but what about some more complex expressions&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s https://www.anapioficeandfire.com/api/books/1 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; json_path &lt;span class=&quot;token string&quot;&gt;&quot;$.characters.length()&quot;&lt;/span&gt;

Exception &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt; thread &lt;span class=&quot;token string&quot;&gt;&quot;main&quot;&lt;/span&gt; com.jayway.jsonpath.InvalidPathException: Function of name: length cannot be created
        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathFunctionFactory.java:75&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.FunctionPathToken.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FunctionPathToken.java:38&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.PathToken.handleObjectProperty&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathToken.java:81&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.PropertyPathToken.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PropertyPathToken.java:79&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.RootPathToken.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;RootPathToken.java:62&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CompiledPath.java:53&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CompiledPath.java:61&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.JsonPath.read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JsonPath.java:181&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.JsonPath.read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JsonPath.java:345&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.JsonPath.read&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;JsonPath.java:329&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at Application.evaluate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Application.java:30&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at Application.main&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Application.java:12&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
Caused by: java.lang.InstantiationException: Type &lt;span class=&quot;token variable&quot;&gt;&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;com.jayway.jsonpath.internal.function.text.Length&lt;span class=&quot;token variable&quot;&gt;`&lt;/span&gt;&lt;/span&gt; can not be instantiated reflectively as it does not have a no-parameter constructor or the no-parameter constructor has not been added explicitly to the native image.
        at java.lang.Class.newInstance&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DynamicHub.java:740&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;PathFunctionFactory.java:73&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;. &lt;span class=&quot;token number&quot;&gt;11&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;more&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So a new instance of &lt;code class=&quot;language-text&quot;&gt;Length&lt;/code&gt; type cannot be created. Quick sneak peek on failing part (&lt;code class=&quot;language-text&quot;&gt;PathFunctionFactory.java:75&lt;/code&gt;)&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PathFunction&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;newFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InvalidPathException&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Class&lt;/span&gt; functionClazz &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; FUNCTIONS&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;functionClazz &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InvalidPathException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Function with name: &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; does not exist.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;PathFunction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;functionClazz&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;newInstance&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;InvalidPathException&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Function of name: &quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; name &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot; cannot be created&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; e&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That’s true, it looks like there is a set of predefined function which then are dynamically created. Fortunately, this can be fixed by introducing reflection configuration file. This file is used to inform &lt;code class=&quot;language-text&quot;&gt;Substrate VM&lt;/code&gt; about reflectively accessed program elements. To know more see &lt;a href=&quot;https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md&quot;&gt;https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md&lt;/a&gt;. To solve above issue we need to put one entry in &lt;code class=&quot;language-text&quot;&gt;graal.json&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;com.jayway.jsonpath.internal.function.text.Length&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;methods&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;init&gt;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token property&quot;&gt;&quot;parameterTypes&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After the rebuild of &lt;code class=&quot;language-text&quot;&gt;json_path&lt;/code&gt; executable, previous commands started to work&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s https://www.anapioficeandfire.com/api/books/1 &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; json_path &lt;span class=&quot;token string&quot;&gt;&quot;$.characters.length()&quot;&lt;/span&gt;
&lt;span class=&quot;token number&quot;&gt;434&lt;/span&gt;
        
&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; -s https://www.anapioficeandfire.com/api/books &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; json_path &lt;span class=&quot;token string&quot;&gt;&quot;$.[?(@.name == &apos;A Game of Thrones&apos;)].characters.length()&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;434&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I see the big potential in these native images one of them is light and fast docker images &lt;a href=&quot;https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b&quot;&gt;https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b&lt;/a&gt; as pointed out by Adam Warski. What he also mention is that in Scala reflection is almost unused. For me compiling a very simple program to the native image was a few hours of research and at this point, I don’t see how I could do the same with small &lt;code class=&quot;language-text&quot;&gt;Spring&lt;/code&gt; application which in contrast to Scala ecosystem use reflection heavily.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Verify your JSON]]></title><description><![CDATA[When you hear API and web client together you think , at least I do. This is because it is still one of the most popular architectural…]]></description><link>https://ajurasz.github.io/2019-06-02-verify-your-json/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-06-02-verify-your-json/</guid><pubDate>Sun, 02 Jun 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;When you hear API and web client together you think &lt;code class=&quot;language-text&quot;&gt;REST&lt;/code&gt;, at least I do. This is because it is still one of the most popular architectural paradigms for building APIs. Another approach about which I hear from time to time is &lt;code class=&quot;language-text&quot;&gt;GraphQL&lt;/code&gt;. There is one common part for these two - they talk JSON. Both specifications &lt;code class=&quot;language-text&quot;&gt;REST&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;GraphQL&lt;/code&gt; does not restrict only to this format but due to its simplicity, it is a very common choice. Every healthy software contains tests on different layers, from unit up to the end-to-end tests. So, how could we verify responses from our APIs?&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;In &lt;code class=&quot;language-text&quot;&gt;java&lt;/code&gt; world, especiality in &lt;code class=&quot;language-text&quot;&gt;Spring&lt;/code&gt; ecosystem when it comes to testing APIs you probably saw one of these:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;mockMvc&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;perform&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/hello?name=John&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;andExpect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isOk&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;andExpect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;John&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;jsonPath&lt;/code&gt; static method in the above snippet is a wrapper around great library &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt;. Together with &lt;a href=&quot;https://github.com/hamcrest/JavaHamcrest&quot;&gt;Hamcrest&lt;/a&gt; it just makes writing test against JSON a true pleasure. &lt;/p&gt;
&lt;p&gt;Note: &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; does not require &lt;code class=&quot;language-text&quot;&gt;Spring&lt;/code&gt; it just need some JSON.&lt;/p&gt;
&lt;p&gt;I have created simple &lt;a href=&quot;https://github.com/ajurasz/jsonpath-playground&quot;&gt;playground&lt;/a&gt; for testing different &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expressions. &lt;code class=&quot;language-text&quot;&gt;jsonPath&lt;/code&gt; static method is provided which expects expression, matcher and a JSON string against which expression will be executed.&lt;/p&gt;
&lt;p&gt;Let us assume that &lt;code class=&quot;language-text&quot;&gt;json&lt;/code&gt; argument in the following examples will have this structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;_id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;5cdaff5fce90bc3ddd98475b&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;guid&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;57cc1cbb-52ba-49ff-af66-4b9dde85a207&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;isActive&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;a&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;b&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;c&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;d&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token property&quot;&gt;&quot;e&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token property&quot;&gt;&quot;f&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;end&quot;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;f&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;other end&quot;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Working with JSON objects&lt;/h2&gt;
&lt;p&gt;Every &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expression starts with &lt;code class=&quot;language-text&quot;&gt;$&lt;/code&gt; symbol which represents &lt;strong&gt;root&lt;/strong&gt; element (no matter if the JSON structure is an object or array). When you want to access the specific property you have two choices - dot or bracket notation. &lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;//dot notation&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.guid&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;57cc1cbb-52ba-49ff-af66-4b9dde85a207&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.isActive&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;instanceOf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Number&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.nonExisting&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;nullValue&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.name.first&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Opal&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;//bracket notation&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$[&apos;guid&apos;]&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;57cc1cbb-52ba-49ff-af66-4b9dde85a207&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$[&apos;isActive&apos;]&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;isA&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Boolean&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$[&apos;name&apos;][&apos;first&apos;]&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Opal&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Although the second approach is noisier it is useful in situation when property name contains special characters or starts with a character other than represented by this regular expression &lt;code class=&quot;language-text&quot;&gt;/[a-zA-Z_]/&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We can also do a deep scan to access property in very nested object. To acccess &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt; property in our sample we could:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$..f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;other-end&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;// or using standard dot notation&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.a.b.c.d.e.f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice that deep scann returns array of values because depending on JSON structure it can find more properties with the name &lt;code class=&quot;language-text&quot;&gt;f&lt;/code&gt;. We can narrow down what path will be part of a deep scan by pointing to spefici property from which deep scan starts:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.a..f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;end&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Working with JSON arrays&lt;/h2&gt;
&lt;p&gt;Let us assume that &lt;code class=&quot;language-text&quot;&gt;json&lt;/code&gt; argument in the following examples will have this structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;friends&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Hester Dallai&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;age&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Lucinda Goff&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;age&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;id&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Ella Day&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;age&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;adult&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;18&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To access the single property from an object inside array you use square brackets just like in &lt;code class=&quot;language-text&quot;&gt;java&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[0].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expressions support wildcards (&lt;code class=&quot;language-text&quot;&gt;*&lt;/code&gt;) which selects all elements in both object and arrays. &lt;/p&gt;
&lt;p&gt;To verify the age of our friends we can:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[*].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When you have ever worked with &lt;code class=&quot;language-text&quot;&gt;python&lt;/code&gt; you probably came across slice notation, which in some part is supported in &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;python&quot;&gt;&lt;pre class=&quot;language-python&quot;&gt;&lt;code class=&quot;language-python&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;stop&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;     &lt;span class=&quot;token comment&quot;&gt;# from start to stop - 1&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;         &lt;span class=&quot;token comment&quot;&gt;# from start to the end of array&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;             &lt;span class=&quot;token comment&quot;&gt;# selects first n - 1 elements&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;n&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;            &lt;span class=&quot;token comment&quot;&gt;# selects last n elements&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Knowing this slice expressions would like like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[:3].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[1:2].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[:2].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[-2:].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Filter expression&lt;/h2&gt;
&lt;p&gt;Next powerful feature of &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; are filter expression &lt;code class=&quot;language-text&quot;&gt;[?(&amp;lt;expression&amp;gt;)]&lt;/code&gt; which make selection of elements more dynamic. Complete list of supported operators can be found at &lt;a href=&quot;https://github.com/json-path/JsonPath#filter-operators&quot;&gt;https://github.com/json-path/JsonPath#filter-operators&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.age &gt;= 18)].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.id == 1)].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.id != 1)].age&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;31&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;17&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.age in [31, 17])].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.name =~ /^.*Da.*$/i)].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;@&lt;/code&gt; represent the current node. In the above example this will represent friend node and for each of our friends (&lt;code class=&quot;language-text&quot;&gt;$.friends[]&lt;/code&gt;), given property will be returned when the expression evaluates to true.&lt;/p&gt;
&lt;p&gt;We can be even more dynamic by referencing to other properties:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.age &gt;= 18)].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.friends[?(@.age &gt;= $.adult)].id&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hasItems&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Functions&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; provides functions that can be added at the end of our expression. The rule is simple  - output of expression is input to the function. Complete list of build in functions can be found at &lt;a href=&quot;https://github.com/json-path/JsonPath#functions&quot;&gt;https://github.com/json-path/JsonPath#functions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Let us assume that &lt;code class=&quot;language-text&quot;&gt;json&lt;/code&gt; argument in the following examples will have this structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;range&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;7&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token number&quot;&gt;9&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then we can run functions that expects arrays as input&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.range.avg()&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4.5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.range.min()&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.range.max()&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;9.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.range.stddev()&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2.8722813232690143&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;jsonPath&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;$.range.length()&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;is&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;runAgainst&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;As you saw &lt;a href=&quot;https://github.com/json-path/JsonPath&quot;&gt;JsonPath&lt;/a&gt; expressions are very powerful, they should be able to extract whatever you want from a JSON structure. All used examples and more can be found on &lt;a href=&quot;https://github.com/ajurasz/jsonpath-playground&quot;&gt;github&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[IBM WebSphere Liberty and Spring AOP]]></title><description><![CDATA[Investigation walkthrough for an issue related to multiple  available when  application is deployed on  (). Motivation Recently I was…]]></description><link>https://ajurasz.github.io/2019-05-12-wlp-spring-aop/</link><guid isPermaLink="false">https://ajurasz.github.io/2019-05-12-wlp-spring-aop/</guid><pubDate>Sun, 12 May 2019 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Investigation walkthrough for an issue related to multiple &lt;code class=&quot;language-text&quot;&gt;classloaders&lt;/code&gt; available when &lt;code class=&quot;language-text&quot;&gt;SpringBoot&lt;/code&gt; application is deployed on &lt;code class=&quot;language-text&quot;&gt;IBM WebSphere Liberty&lt;/code&gt; (&lt;code class=&quot;language-text&quot;&gt;WSL&lt;/code&gt;).&lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Motivation&lt;/h2&gt;
&lt;p&gt;Recently I was investigating a strange issue that was present only in a production-like environment. Fortunately, my team have CI which is almost 1 to 1 with production so we were able to catch this issue before deployment. So what’s different between production and local environment you may ask. Well, the answer is very simple - we use different servlet containers. For local development, we use embedded &lt;code class=&quot;language-text&quot;&gt;Tomcat&lt;/code&gt; web server that is ship together with &lt;code class=&quot;language-text&quot;&gt;SpringBoot&lt;/code&gt;. On production, we have &lt;code class=&quot;language-text&quot;&gt;WSL&lt;/code&gt; application server. Because I wanted to know why the issue was happening only on one environment and working perfectly fine on another I had to dig a little bit. &lt;/p&gt;
&lt;h2&gt;Context&lt;/h2&gt;
&lt;p&gt;Before moving forward with the analyze let’s give some context so that what I will write next will have more sense. As always it starts with a &lt;strong&gt;simple&lt;/strong&gt; task in Jira backlog. The task was to move complex &lt;strong&gt;authorization&lt;/strong&gt; mechanism from service to web layer. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;authorization is the process of verifying that “you are permitted to do what you are trying to do”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;source: Wikipedia&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The difference on performing &lt;strong&gt;authorization&lt;/strong&gt; on these two layers is that services operate on actual objects where web controllers on identifiers of these objects. Below is pseudo code for the change that was planed.&lt;/p&gt;
&lt;p&gt;Before:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;aspect(object) {
  return allowedToAccess(object)
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;aspect(identifier) {
  const object = resolveObjectFrom(identifier)
  return allowedToAccess(object)
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For now, we know what needs to be done and how. But one more important addition to the context is about convention* we try to follow in our code base - which is - extensive usage of encapsulation which in our case is more about creating a clear interface for others who will be using these objects than just hiding information.&lt;/p&gt;
&lt;p&gt;* clarification - we follow more conventions/best practices but in the context of this post, only this single convention is important.&lt;/p&gt;
&lt;p&gt;But what this exactly mean? In simple words, we use &lt;code class=&quot;language-text&quot;&gt;public&lt;/code&gt; modifier only when it’s really required, if not then we operate mostly using only &lt;code class=&quot;language-text&quot;&gt;private&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;package protected&lt;/code&gt; modifiers. I think the above context should be enough to start analyzing a concrete example. To make analyze simpler I have created a sample application demonstrate a problem and can be found on &lt;a href=&quot;https://github.com/ajurasz/wlp-spring-aop&quot;&gt;github&lt;/a&gt;. &lt;/p&gt;
&lt;h2&gt;Analyze&lt;/h2&gt;
&lt;h3&gt;Posotive scenario&lt;/h3&gt;
&lt;p&gt;For our case, we need to focus only on three elements.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;HelloControler&lt;/code&gt; this is standard &lt;code class=&quot;language-text&quot;&gt;RestController&lt;/code&gt; to which one dependency is injected.&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HelloController&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HelloService&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token class-name&quot;&gt;HelloController&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HelloService&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;helloService &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@GetMapping&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/hello/{name}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;ResponseEntity&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@PathVariable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResponseEntity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;helloService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController&lt;/code&gt; is special because &lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController#hello&lt;/code&gt; is join point for around advice (&lt;a href=&quot;https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop&quot;&gt;AOP terminology&lt;/a&gt;)&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@RestController&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;PointcutedHelloController&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;HelloService&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token class-name&quot;&gt;PointcutedHelloController&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;HelloService&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;helloService &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; helloService&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@GetMapping&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/hello-aop/{name}&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;ResponseEntity&lt;/span&gt;&lt;span class=&quot;token generics&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@PathVariable&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ResponseEntity&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;helloService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sayHello&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;&lt;code class=&quot;language-text&quot;&gt;LoggingAspect&lt;/code&gt; which registers advice around specified pointcut&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@Aspect&lt;/span&gt;
&lt;span class=&quot;token annotation punctuation&quot;&gt;@Component&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LoggingAspect&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Logger&lt;/span&gt; LOG &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;LoggerFactory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getLogger&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;LoggingAspect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Around&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;within(com.example.demo.PointcutedHelloController)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token class-name&quot;&gt;Object&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;aroud&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;ProceedingJoinPoint&lt;/span&gt; pjp&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Throwable&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        LOG&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;pjp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getSignature&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toLongString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; pjp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;proceed&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can run tests or application itself (&lt;code class=&quot;language-text&quot;&gt;mvn spring-boot:run&lt;/code&gt;) and call &lt;code class=&quot;language-text&quot;&gt;hello&lt;/code&gt; methods - everything will work as expected. Please notice, if you will place &lt;code class=&quot;language-text&quot;&gt;breakpoint&lt;/code&gt; in &lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController#hello&lt;/code&gt; you will see that &lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController&lt;/code&gt; is wrapped with &lt;code class=&quot;language-text&quot;&gt;com.example.demo.PointcutedHelloController$$EnhancerBySpringCGLIB&lt;/code&gt; proxy.&lt;/p&gt;
&lt;h3&gt;Negative scenario&lt;/h3&gt;
&lt;p&gt;First you will have to change profile setting &lt;code class=&quot;language-text&quot;&gt;activeByDefault&lt;/code&gt; from &lt;code class=&quot;language-text&quot;&gt;false&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;true&lt;/code&gt; in &lt;code class=&quot;language-text&quot;&gt;pom.xml&lt;/code&gt; so it looks like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;wlp&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;activation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;activeByDefault&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;true&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;activeByDefault&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;activation&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then you just need to build &lt;code class=&quot;language-text&quot;&gt;war&lt;/code&gt; package (&lt;code class=&quot;language-text&quot;&gt;mvn clean package -DskipTest&lt;/code&gt;) and deploy it to &lt;code class=&quot;language-text&quot;&gt;WSL&lt;/code&gt;. After starting the server it crashes with the following message:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;Caused by: org.springframework.aop.framework.AopConfigException: Could not generate CGLIB subclass of class com.example.demo.PointcutedHelloController: Common causes of this problem include using a final class or a non-visible class&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; nested exception is org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;class com.example.demo.PointcutedHelloController&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;EnhancerBySpringCGLIB&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController
    at org.springframework.aop.framework.CglibAopProxy.getProxy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CglibAopProxy.java:208&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.ProxyFactory.getProxy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ProxyFactory.java:110&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.createProxy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutoProxyCreator.java:471&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.wrapIfNecessary&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutoProxyCreator.java:350&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.postProcessAfterInitialization&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutoProxyCreator.java:299&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsAfterInitialization&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutowireCapableBeanFactory.java:429&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutowireCapableBeanFactory.java:1782&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractAutowireCapableBeanFactory.java:593&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;. &lt;span class=&quot;token number&quot;&gt;32&lt;/span&gt; common frames omitted
Caused by: org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;class com.example.demo.PointcutedHelloController&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;EnhancerBySpringCGLIB&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController
    at org.springframework.cglib.core.ReflectUtils.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReflectUtils.java:530&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.AbstractClassGenerator.generate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractClassGenerator.java:363&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.proxy.Enhancer.generate&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Enhancer.java:582&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.AbstractClassGenerator&lt;span class=&quot;token variable&quot;&gt;$ClassLoaderData&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt;.apply&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractClassGenerator.java:110&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.AbstractClassGenerator&lt;span class=&quot;token variable&quot;&gt;$ClassLoaderData&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$3&lt;/span&gt;.apply&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractClassGenerator.java:108&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.internal.LoadingCache&lt;span class=&quot;token variable&quot;&gt;$2&lt;/span&gt;.call&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LoadingCache.java:54&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at java.util.concurrent.FutureTask.run&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;token variable&quot;&gt;$capture&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FutureTask.java:266&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at java.util.concurrent.FutureTask.run&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;FutureTask.java&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.internal.LoadingCache.createEntry&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LoadingCache.java:61&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.internal.LoadingCache.get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;LoadingCache.java:34&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.AbstractClassGenerator&lt;span class=&quot;token variable&quot;&gt;$ClassLoaderData&lt;/span&gt;.get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractClassGenerator.java:134&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.AbstractClassGenerator.create&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;AbstractClassGenerator.java:319&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.proxy.Enhancer.createHelper&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Enhancer.java:569&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.proxy.Enhancer.createClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Enhancer.java:416&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.ObjenesisCglibAopProxy.createProxyClassAndInstance&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ObjenesisCglibAopProxy.java:57&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.aop.framework.CglibAopProxy.getProxy&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;CglibAopProxy.java:205&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;. &lt;span class=&quot;token number&quot;&gt;39&lt;/span&gt; common frames omitted
Caused by: java.lang.IllegalAccessError: class com.example.demo.PointcutedHelloController&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;EnhancerBySpringCGLIB&lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt;4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController
    at java.lang.ClassLoader.defineClass1&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Native Method&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at java.lang.ClassLoader.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ClassLoader.java:763&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at sun.reflect.GeneratedMethodAccessor27.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Unknown Source&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:na&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at sun.reflect.DelegatingMethodAccessorImpl.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DelegatingMethodAccessorImpl.java:43&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at java.lang.reflect.Method.invoke&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Method.java:498&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;na:1.8.0_201&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    at org.springframework.cglib.core.ReflectUtils.defineClass&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ReflectUtils.java:527&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; ~&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;..&lt;/span&gt;. &lt;span class=&quot;token number&quot;&gt;54&lt;/span&gt; common frames omitted&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;First thing that caught my attention was &lt;code class=&quot;language-text&quot;&gt;Could not generate CGLIB subclass of ...: Common causes of this problem include using a final class or a non-visible class&lt;/code&gt; which seems to be fair enough as controller class is not public so it can be non-visible but then next question arises - why this was working locally when deployed on &lt;code class=&quot;language-text&quot;&gt;Tomcat&lt;/code&gt;? At this point removing AOP advice from &lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController#hello&lt;/code&gt; metod, fix the problem. This clearly indicates that there is something wrong when using &lt;code class=&quot;language-text&quot;&gt;Spring AOP&lt;/code&gt;. Maybe it requires classes and method to be public? Let’s see what &lt;a href=&quot;https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-introduction-proxies&quot;&gt;documentation&lt;/a&gt; says about it. Most important fragment of this documentation to my current situation is:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;With CGLIB, public and protected method calls on the proxy are intercepted (and even package-visible methods, if necessary).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;And this is true when deploying on &lt;code class=&quot;language-text&quot;&gt;Tomcat&lt;/code&gt; but not when on &lt;code class=&quot;language-text&quot;&gt;WSL&lt;/code&gt;. Because I’m not a &lt;code class=&quot;language-text&quot;&gt;WSL&lt;/code&gt; expert I had to do some googling to find out that this issue can be related to &lt;code class=&quot;language-text&quot;&gt;classloader&lt;/code&gt;s. Where one &lt;code class=&quot;language-text&quot;&gt;classloader&lt;/code&gt; is used to load all 3rd party libraries from &lt;code class=&quot;language-text&quot;&gt;/WEB-INF/lib&lt;/code&gt; and my own classes from &lt;code class=&quot;language-text&quot;&gt;/WEB-INF/classes&lt;/code&gt; and another when creating proxy for &lt;code class=&quot;language-text&quot;&gt;PointcutedHelloController&lt;/code&gt;.  &lt;/p&gt;
&lt;p&gt;After debugging session I was able to nail down which &lt;code class=&quot;language-text&quot;&gt;classloader&lt;/code&gt; is used when creating proxy.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;language-text&quot;&gt;Spring AOP&lt;/code&gt; creates its proxies through &lt;code class=&quot;language-text&quot;&gt;CglibAopProxy#getProxy(classLoader)&lt;/code&gt;. This &lt;code class=&quot;language-text&quot;&gt;ClassLoader&lt;/code&gt; object in the end is provided by &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt; which sets &lt;code class=&quot;language-text&quot;&gt;classLoader&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;Thread.currentThread().getContextClassLoader()&lt;/code&gt; during object construction. Bellow is screenshot which shows how &lt;code class=&quot;language-text&quot;&gt;classLoader&lt;/code&gt; provided by &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt; (left) differs from &lt;code class=&quot;language-text&quot;&gt;classLoader&lt;/code&gt; awaible in any other place of my application when calling &lt;code class=&quot;language-text&quot;&gt;getClass().getClassLoader()&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/bbf863545b228772548aee63cf3863d0/5f7fb/wlp-classloaders.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 41.714285714285715%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+klEQVQY032OiW6EIBRF/f8vVOpalhEdwGEbUJAqZtqmaXsSCMu7S6EmPFJ8u49KK++8y4SwpZSc5AKhBxdGKZNZ/er9sdYtDxSGjWKatbH7vqdP8tlrITBiXFhjX89fZDFFDGMl5eF3GZ84d5g7xQXBUsozM+NfxBCzeGjmslqmKYRwGsa8hXg4r3phGGprj68fyde1CP7ptI4xpu9ctSXjfSfuzGid21ydnHu6y65Iv5LFm5Z86GcICUQjpQQTjAmCiCCstP5bnNlWz+ltplP/Vg9N24G6rUBTgq5pHw/5j/hMDtYscOCI4AqQukEVeC8rWALUD0qdyR8UAsyHX1iO4gAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;wlp-classloaders&quot;
        title=&quot;&quot;
        src=&quot;/static/bbf863545b228772548aee63cf3863d0/8c557/wlp-classloaders.png&quot;
        srcset=&quot;/static/bbf863545b228772548aee63cf3863d0/4edbd/wlp-classloaders.png 175w,
/static/bbf863545b228772548aee63cf3863d0/13ae7/wlp-classloaders.png 350w,
/static/bbf863545b228772548aee63cf3863d0/8c557/wlp-classloaders.png 700w,
/static/bbf863545b228772548aee63cf3863d0/e996b/wlp-classloaders.png 1050w,
/static/bbf863545b228772548aee63cf3863d0/2cefc/wlp-classloaders.png 1400w,
/static/bbf863545b228772548aee63cf3863d0/5f7fb/wlp-classloaders.png 1889w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;It looks like the one created by &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt; is not aware of my classes so that’s the reason why application crashes on startup.&lt;/p&gt;
&lt;h3&gt;Fix&lt;/h3&gt;
&lt;p&gt;We know that everything starts in &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt; so we can register our custom &lt;code class=&quot;language-text&quot;&gt;ServletContextInitializer&lt;/code&gt; to override default &lt;code class=&quot;language-text&quot;&gt;classLoader&lt;/code&gt; created by &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt;. This can be done by extending &lt;code class=&quot;language-text&quot;&gt;SpringBootServletInitializer&lt;/code&gt; class like so:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token annotation punctuation&quot;&gt;@SpringBootApplication&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;DemoApplication&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SpringBootServletInitializer&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token class-name&quot;&gt;SpringApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DemoApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; args&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;SpringApplicationBuilder&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;SpringApplicationBuilder&lt;/span&gt; applicationBuilder&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; applicationBuilder&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sources&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DemoApplication&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;initializers&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;configurableApplicationContext &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;token class-name&quot;&gt;ClassLoader&lt;/span&gt; classLoader &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;getClass&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;DefaultResourceLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;configurableApplicationContext&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setClassLoader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;classLoader&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It is possible becouse &lt;code class=&quot;language-text&quot;&gt;configurableApplicationContext&lt;/code&gt; is instance of &lt;code class=&quot;language-text&quot;&gt;AnnotationConfigServletWebServerApplicationContext&lt;/code&gt; class which in turn is subclass of &lt;code class=&quot;language-text&quot;&gt;DefaultResourceLoader&lt;/code&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Adding deb packages to Cloud Foundry instances]]></title><description><![CDATA[This blog post presents two ways of adding additional deb packages to your Cloud Foundry (CF) instances. Buildpack Before moving forward let…]]></description><link>https://ajurasz.github.io/2018-09-09-adding-deb-packages-to-cloud-foundry-instances/</link><guid isPermaLink="false">https://ajurasz.github.io/2018-09-09-adding-deb-packages-to-cloud-foundry-instances/</guid><pubDate>Sun, 09 Sep 2018 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;This blog post presents two ways of adding additional deb packages to your &lt;a href=&quot;https://www.cloudfoundry.org/&quot;&gt;Cloud Foundry&lt;/a&gt; (CF) instances.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Buildpack&lt;/h2&gt;
&lt;p&gt;Before moving forward let’s introduce some useful buildpacks that we will be using. What is buildpack you may ask. &lt;code class=&quot;language-text&quot;&gt;&amp;quot;Buildpacks provide framework and runtime support for apps&amp;quot;&lt;/code&gt;, in other words, CF have some predefined “recipes” how to prepare instances to run your application. So if you will push your application with CLI, CF will examine your app and will use appropriate buildpack to prepare your instance. You can also be more explicit and say what buildpack you want to use. Here you can find a list of builtin buildpacks &lt;a href=&quot;https://docs.cloudfoundry.org/buildpacks/#system-buildpacks&quot;&gt;https://docs.cloudfoundry.org/buildpacks/#system-buildpacks&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We will be using:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/cloudfoundry/apt-buildpack&quot;&gt;apt-buildpack&lt;/a&gt; - allow us to list all deb packages we want to install in &lt;code class=&quot;language-text&quot;&gt;apt.yml&lt;/code&gt; file. It’s supporting custom apt repositories as well.  &lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/cloudfoundry/binary-buildpack&quot;&gt;binary-buildpack&lt;/a&gt; - this buildpack allow you to run binary web services that do not require any runtime dependencies (any of these sould be statically linked to your binary). Good buildpack just for preparing “clean” instance.  &lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/cloudfoundry/multi-buildpack&quot;&gt;multi-buildpack&lt;/a&gt; - as names suggests for running multiple buildpacks.  &lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Using multi-buildpack&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;multi-buildpack.yml&lt;/code&gt; file where you specify all buildpacks you want to run:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;buildpacks&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//github.com/cloudfoundry/apt&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;buildpack
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//github.com/cloudfoundry/java&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;buildpack&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;apt.yml&lt;/code&gt; file&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;packages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; mysql&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;client&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;manifest.yml&lt;/code&gt; file&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;applications&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; my&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;app
  &lt;span class=&quot;token key atrule&quot;&gt;buildpack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//github.com/cloudfoundry/multi&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;buildpack
  &lt;span class=&quot;token key atrule&quot;&gt;instances&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 1G&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;Push to CF&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cf push &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above command will:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;by default look for &lt;code class=&quot;language-text&quot;&gt;manifest.yml&lt;/code&gt; in the current directory (&lt;a href=&quot;https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#-how-cf-push-finds-the-manifest&quot;&gt;more&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;by default, it will recursively push all files in the current directory (&lt;a href=&quot;https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#find-app&quot;&gt;more&lt;/a&gt;)  &lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Directory structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;
├── apt.yml
├── manifest.yml
├── multi-buildpack.yml
└── my-app.jar&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;p&gt;When using multi-buildpack you cannot use builtin buildpacks which can be an issue when working on a company’s own installation of CF and its policy require from you to be using built-in (customized) buildpacks.&lt;/p&gt;
&lt;h2&gt;Pushing multiple buildpacks&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;apt.yml&lt;/code&gt; file&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;token key atrule&quot;&gt;packages&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; mysql&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;client&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;Create &lt;code class=&quot;language-text&quot;&gt;manifest.yml&lt;/code&gt; file&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;applications&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; my&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;app
  &lt;span class=&quot;token key atrule&quot;&gt;buildpack&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; https&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;//github.com/cloudfoundry/binary&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;buildpack
  &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ./my&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;app.jar
  &lt;span class=&quot;token key atrule&quot;&gt;instances&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;memory&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; 1G&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;Embed &lt;code class=&quot;language-text&quot;&gt;apt.yml&lt;/code&gt; at the root of your project&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;With maven, this can be done with the help of &lt;a href=&quot;http://maven.apache.org/plugins/maven-antrun-plugin/&quot;&gt;maven-antrun-plugin&lt;/a&gt; and by adding following to your &lt;code class=&quot;language-text&quot;&gt;pom.xml&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;xml&quot;&gt;&lt;pre class=&quot;language-xml&quot;&gt;&lt;code class=&quot;language-xml&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;artifactId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;maven-antrun-plugin&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;artifactId&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;executions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;execution&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;addCFAptAtRootLevel&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;id&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;phase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;package&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;phase&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;configuration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;zip&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;destfile&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;${project.build.directory}/${app.finalName}.jar&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;
                         &lt;span class=&quot;token attr-name&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;yes&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;compress&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;false&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;zipfileset&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;dir&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;.&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;includes&lt;/span&gt;&lt;span class=&quot;token attr-value&quot;&gt;&lt;span class=&quot;token punctuation attr-equals&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;apt.yml&lt;span class=&quot;token punctuation&quot;&gt;&quot;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;/&gt;&lt;/span&gt;&lt;/span&gt;
                    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;zip&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;target&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;configuration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;goals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
                &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;run&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;goal&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
            &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;goals&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
        &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;execution&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
    &lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;executions&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token tag&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;&amp;lt;/&lt;/span&gt;plugin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;5&quot;&gt;
&lt;li&gt;Push to CF&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cf push --no-start &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
cf push my-app -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;(1) sets up instance and do not start it&lt;br&gt;
(2) we need to specify the app name we want to update. In this case, we just update the buildpack section of deployed manifest. We can also use public and builtin buildpacks  &lt;/p&gt;
&lt;p&gt;Directory structure:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token builtin class-name&quot;&gt;.&lt;/span&gt;
├── manifest.yml
└── my-app.jar&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;p&gt;Above approach (2) is available starting from &lt;code class=&quot;language-text&quot;&gt;cf&lt;/code&gt; CLI version &lt;code class=&quot;language-text&quot;&gt;v6.38&lt;/code&gt; or later. Before you had to use a different command for pushing multiple buildpacks:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;cf v3-push -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[Kotlin + AWS Lambda + Serverless Framework]]></title><description><![CDATA[Some time ago I came across the following tweet.  There were two things that took my attention - kotlin and Rekognition. First one is a “new…]]></description><link>https://ajurasz.github.io/2017-05-28-kotlin-aws-lambda-serverless-framework/</link><guid isPermaLink="false">https://ajurasz.github.io/2017-05-28-kotlin-aws-lambda-serverless-framework/</guid><pubDate>Sun, 28 May 2017 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Some time ago I came across the following tweet.&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 581px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 47.42857142857142%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHZdqESD//EABYQAAMAAAAAAAAAAAAAAAAAABESIP/aAAgBAQABBQILX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAABIDFB/9oACAEBAAY/AtKcf//EABwQAQACAQUAAAAAAAAAAAAAAAEAEEERITFh0f/aAAgBAQABPyHTsB55gp7Qems1/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQABAwUAAAAAAAAAAAAAAAEAETFxEEFhgbH/2gAIAQEAAT8QrqOVqEgvKzdjMMlvMb9w8Gn/2Q==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;tweet_aws_kotlin&quot;
        title=&quot;&quot;
        src=&quot;/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg&quot;
        srcset=&quot;/static/e087ba82deeb3973414aa247f4b459e6/e52aa/tweet_aws_kotlin.jpg 175w,
/static/e087ba82deeb3973414aa247f4b459e6/70ebb/tweet_aws_kotlin.jpg 350w,
/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg 581w&quot;
        sizes=&quot;(max-width: 581px) 100vw, 581px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;There were two things that took my attention - kotlin and Rekognition.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;First one is a “new” (it’s relly developed by over 6 years now) JVM language created by JetBrains, company that stands behind great tooling for developers of different professions. The second is an AWS service, this is how it is described on their page&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Amazon Rekognition is a service that makes it easy to add image analysis to your applications. With Rekognition, you can detect objects, scenes faces; search and compare faces, and identify inappropriate content in images. Rekognition’s API enables you to quickly add sophisticated deep learning-based visual search and image classification to your applications.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;as we will see soon this API is very easy to use.&lt;/p&gt;
&lt;h2&gt;Why&lt;/h2&gt;
&lt;p&gt;At this point for me, it was the first contact with pretty nice and interesting example of AWS Lambda usage created by &lt;a href=&quot;https://twitter.com/VladimirBudilov&quot;&gt;Vladimir Budilov&lt;/a&gt; (here is a  &lt;a href=&quot;https://github.com/awslabs/serverless-photo-recognition&quot;&gt;github&lt;/a&gt; repository). For these who are not familiar with AWS Lambda term -  it is a new category of cloud computing services called FaaS (function as a service). It stands next to IaaS (infrastructure as a service), PaaS (platform as a service) and SaaS (software as a service) it is also referred as Serverless architecture. In short, you focus only on your business logic and don’t care about provisioning and managing servers.&lt;/p&gt;
&lt;p&gt;
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 50.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBP/EABYBAQEBAAAAAAAAAAAAAAAAAAIDBP/aAAwDAQACEAMQAAAB7Lazqq65/8QAGRAAAwADAAAAAAAAAAAAAAAAAAECEBEh/9oACAEBAAEFAt2dHNN5/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/AQyf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAQIDEP/aAAgBAgEBPwGVi5//xAAaEAACAgMAAAAAAAAAAAAAAAABMQACICEi/9oACAEBAAY/AmXD0XNWw//EABoQAQACAwEAAAAAAAAAAAAAAAEAEDFRcdH/2gAIAQEAAT8hHoQeqhqexw9r/9oADAMBAAIAAwAAABD43//EABgRAAIDAAAAAAAAAAAAAAAAAAABETFh/9oACAEDAQE/EE0Jw//EABgRAAIDAAAAAAAAAAAAAAAAAAABEVFh/9oACAECAQE/EMMh2f/EABwQAAICAgMAAAAAAAAAAAAAAAABETEhQVFx8P/aAAgBAQABPxBe4x89EqpP0zEWOiOpVg0fH2Kj/9k=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;faas_diagram&quot;
        title=&quot;&quot;
        src=&quot;/static/75f2521335608d5d448030d8d8111009/29d31/faas_diagram.jpg&quot;
        srcset=&quot;/static/75f2521335608d5d448030d8d8111009/e52aa/faas_diagram.jpg 175w,
/static/75f2521335608d5d448030d8d8111009/70ebb/faas_diagram.jpg 350w,
/static/75f2521335608d5d448030d8d8111009/29d31/faas_diagram.jpg 700w,
/static/75f2521335608d5d448030d8d8111009/d5834/faas_diagram.jpg 801w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
&lt;sub&gt;Source: Deploy microservice using Amazon Web Services S3, API Gateway, Lambda and Couchbase by Arun Gupta (&lt;a href=&quot;https://www.youtube.com/watch?v=eT4EaU2mfL0&quot;&gt;https://www.youtube.com/watch?v=eT4EaU2mfL0&lt;/a&gt;)&lt;/sub&gt;&lt;/p&gt;
&lt;p&gt;After analysing &lt;a href=&quot;https://github.com/awslabs/serverless-photo-recognition&quot;&gt;serverless-photo-recognition&lt;/a&gt; repository I felt urgent need to write something of my own. One thing that I considered not to be very concise was a setup step. The author created setup &lt;a href=&quot;https://github.com/awslabs/serverless-photo-recognition/blob/master/setup/setupEnvironment.sh&quot;&gt;script&lt;/a&gt; which is very verbose. So let’s start by making this process a lot more easier (to make and understand - for people not so familiar with AWS platform).&lt;/p&gt;
&lt;h2&gt;Serverless framework&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://serverless.com/&quot;&gt;Serverless framework&lt;/a&gt; is a cli tool that creates great abstraction over &lt;a href=&quot;https://aws.amazon.com/cloudformation/&quot;&gt;AWS CloudFormation&lt;/a&gt; and automates the whole process of setting up cloud infrastructure required by our functions. We start by installing &lt;code class=&quot;language-text&quot;&gt;serverless framework&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;npm&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt; -g serverless&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then a good idea is to create dedicated AWS user that will be used on behalf of &lt;code class=&quot;language-text&quot;&gt;serverless framework&lt;/code&gt;. Exact instruction of how to accomplish this can be found &lt;a href=&quot;https://serverless.com/framework/docs/providers/aws/guide/credentials/&quot;&gt;here&lt;/a&gt;. In my case, this user hides behind &lt;code class=&quot;language-text&quot;&gt;sless&lt;/code&gt; AWS cli profile name - &lt;a href=&quot;https://github.com/ajurasz/ascii-less-gallery/blob/58ad818d1d0d7131b4cb5ad9e027cea815197656/serverless.yml#L6&quot;&gt;see here&lt;/a&gt;. All configuration is placed in one file &lt;code class=&quot;language-text&quot;&gt;serverless.yml&lt;/code&gt;
where we first define &lt;code class=&quot;language-text&quot;&gt;provider&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;&lt;span class=&quot;token key atrule&quot;&gt;provider&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; aws
  &lt;span class=&quot;token key atrule&quot;&gt;runtime&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; java8
  &lt;span class=&quot;token key atrule&quot;&gt;profiles&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; sless
  &lt;span class=&quot;token key atrule&quot;&gt;timeout&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;60&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;environment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;DYNAMODB_USER_TABLE&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;self&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;service&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;stage&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;provider.stage&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;user
    &lt;span class=&quot;token key atrule&quot;&gt;ES_DOMAIN_NAME&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; es&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;gallery
    &lt;span class=&quot;token key atrule&quot;&gt;REDIS_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;file(serverless&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;config.yml)&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;stage&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;provider.stage&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;.RedisUrl&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;REDIS_PORT&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;file(serverless&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;config.yml)&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;stage&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;provider.stage&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;.RedisPort&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;ES_URL&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;file(serverless&lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt;config.yml)&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;opt&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;stage&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; self&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;provider.stage&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;.ElasticsearchUrl&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token key atrule&quot;&gt;iamRoleStatements&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;lambda:InvokeFunction&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;rekognition:DetectLabels&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;*&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Allow&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es:ESHttpDelete&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es:ESHttpGet&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es:ESHttpPost&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;es:ESHttpPut&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arn:aws:es:${opt:region, self:provider.region}:*:domain/${self:provider.environment.ES_DOMAIN_NAME}/*&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;Effect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Allow
      &lt;span class=&quot;token key atrule&quot;&gt;Action&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;dynamodb:GetItem&quot;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;dynamodb:PutItem&quot;&lt;/span&gt;
      &lt;span class=&quot;token key atrule&quot;&gt;Resource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_USER_TABLE}&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;this is a place where we can configure mentioned AWS cli profile, runtime environment, extend the limit of our functions execution time to 60 sec, define environment variables that will be accessible from within our functions and also we can define a security policy for a lambda role created automatically by &lt;code class=&quot;language-text&quot;&gt;serverless&lt;/code&gt;. From above snippet, we see that security statements were defined for lambda, elasticsearch, rekognition and dynamodb services, specifying what action we can execute on them.&lt;/p&gt;
&lt;h2&gt;Lambda in action&lt;/h2&gt;
&lt;p&gt;I wrote a simple CRD (no update) functions with custom authentication mechanism - probably using &lt;a href=&quot;https://aws.amazon.com/cognito/&quot;&gt;AWS Cognito&lt;/a&gt; would be a preferred way to go but I wanted to check how flexible are these lambda functions in terms of implementing own authentication. Application architecture is following&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/c345b9c56b520224ea049671d45bb9b6/a3767/architecture_aws_lambda.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 63.42857142857142%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACBUlEQVQ4y41Sy24TQRDcf+UvuCDxEAiRExLHXLhxRlzIiRwclhAngFkpmNixSRyMHezdmZ3ZeRU1Y29iohwyUql7e2qqH9tZCOEEQI+2oC1c8EXjHGELv461dxExthkP1/534n6GG8cTob+b0B4Sr/zXH0Y4OK1w2yHvZbZ2bNTyzvnGBy/nF76ajryhb4zxQghvrY25fDGc+sm8TD7f+bYGwvF7qxWMQTjTQPGq/rYD8fMzmsi2BoZxY22qolNMcDS4XHXDysN1+THBi2yj05TGEHJ4hHryAzalBRaiRtM0iXjY/43BxWL1yIf2WavxPAkqpX0ssvq1B6WXqM+OIWdnkKSq6RBq/BUNfbbP5wajaYn8ZNHOLbRdEs+ymHk2m3N+Fuf7r7BcnkN337LlfQgS9ekhdG8H0gFluUwFdY5n2N4d3yb49Krl1C7nrjkroRqIWkHQl3/GqEY98GdBSgnHmPceti6TvdHyk2xDPUWNdzEQfzkEKXpwAP3lHXScbVVSmGMYdmHeb5Hno9qm4KP/BQkuddo7x+yS1dTlX4j5BRMFVBQ0zkNdTiAH3cRpK1xrPGwFDeHS5jiXbFxKFb/7HWc/vXE6/nCfsqX79d659SJEMUs8yHCHY6zBHc/jKNil8h6R08+ZNq+1zpVpki+VygXh431AHnktd2XDx7CK04Z7/wDGsen+Gr0cggAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;architecture_aws_lambda&quot;
        title=&quot;&quot;
        src=&quot;/static/c345b9c56b520224ea049671d45bb9b6/8c557/architecture_aws_lambda.png&quot;
        srcset=&quot;/static/c345b9c56b520224ea049671d45bb9b6/4edbd/architecture_aws_lambda.png 175w,
/static/c345b9c56b520224ea049671d45bb9b6/13ae7/architecture_aws_lambda.png 350w,
/static/c345b9c56b520224ea049671d45bb9b6/8c557/architecture_aws_lambda.png 700w,
/static/c345b9c56b520224ea049671d45bb9b6/e996b/architecture_aws_lambda.png 1050w,
/static/c345b9c56b520224ea049671d45bb9b6/a3767/architecture_aws_lambda.png 1210w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;I believe that above diagram is self-explanatory so let’s dive into one of the functions. &lt;a href=&quot;https://github.com/ajurasz/ascii-less-gallery/blob/master/src/main/kotlin/ajurasz/lambda/gallery/CreateHandler.kt&quot;&gt;CreateHandler&lt;/a&gt;, the entry point is &lt;code class=&quot;language-text&quot;&gt;handleRequest&lt;/code&gt; function triggered by AWS when an HTTP POST request reaches API Gateway at &lt;code class=&quot;language-text&quot;&gt;/gallery&lt;/code&gt; path.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;handleRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Request&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; context&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; Context&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; String &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        LOG&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;debug&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;input(\n&lt;span class=&quot;token interpolation variable&quot;&gt;$input&lt;/span&gt;\n)&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;base64Image &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;base64Image &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; String&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;isBlank&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;400&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Invalid identify request: no or empty &apos;base64Image&apos; field supplied&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; imageInBytes &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;base64ToBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;base64Image&lt;span class=&quot;token operator&quot;&gt;!!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; labels &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; rekognitionService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;imageLabels&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;imageInBytes&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; galleryItem &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;createGalleryItem&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;asciiService&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; imageInBytes&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; labels&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; result &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; esService&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;principalId&lt;span class=&quot;token operator&quot;&gt;!!&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; galleryItem&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;result&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; galleryItem&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;id
            &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;response&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Failed to save image&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this function, we validate incoming request to check if base64 encoded image string exists and is not blank. Then encoded image is converted to &lt;code class=&quot;language-text&quot;&gt;byte&lt;/code&gt; array and passed to Rekognition service. This service is a wrapper around AWS Rekognition service to simplify interaction with it.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;kotlin&quot;&gt;&lt;pre class=&quot;language-kotlin&quot;&gt;&lt;code class=&quot;language-kotlin&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;imageLabels&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;image&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; ByteArray&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; List&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;String&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        LOG&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;info&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Recognize image labels&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; response &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; amazonRekognition&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;detectLabels&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;DetectLabelsRequest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withMaxLabels&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withMinConfidence&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;60f&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withImage&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;Image&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;withBytes&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ByteBuffer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;wrap&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;image&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; response&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;labels&lt;span class=&quot;token operator&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; it&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;orEmpty&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As mentioned at the beginning, using AWS Rekognition service we were able to define a sophisticated deep learning-based operation of labelling objects present on a given image just in few lines of code.
When using serverless framework we need to create a configuration for each function. Configuration for &lt;code class=&quot;language-text&quot;&gt;CreateHandler&lt;/code&gt; function is following&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;  &lt;span class=&quot;token key atrule&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ajurasz.lambda.gallery.CreateHandler
    &lt;span class=&quot;token key atrule&quot;&gt;events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; gallery
          &lt;span class=&quot;token key atrule&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; post
          &lt;span class=&quot;token key atrule&quot;&gt;integration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; lambda
          &lt;span class=&quot;token key atrule&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;passThrough&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; WHEN_NO_TEMPLATES
            &lt;span class=&quot;token key atrule&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
              &lt;span class=&quot;token key atrule&quot;&gt;image/png&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;{ &quot;operation&quot; : &quot;create&quot;, &quot;base64Image&quot; : &quot;$input.body&quot;, &quot;principalId&quot; : &quot;$context.authorizer.principalId&quot; }&apos;&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;authorizer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; auth
            &lt;span class=&quot;token key atrule&quot;&gt;resultTtlInSeconds&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;identitySource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; method.request.header.token&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;we see that this function is triggered by HTTP specific event - POST request to &lt;code class=&quot;language-text&quot;&gt;/gallery&lt;/code&gt; path. This configuration is little bit more complicated than for other functions and this is because we are not using default &lt;code class=&quot;language-text&quot;&gt;lambda-proxy&lt;/code&gt; integration (integration between API Gateway and Lambda) as we need to customize it to handle binary data. More information about handling binary data in AWS Lambda can be found &lt;a href=&quot;https://aws.amazon.com/blogs/compute/binary-support-for-api-integrations-with-amazon-api-gateway/&quot;&gt;here&lt;/a&gt;. We also secured our function with &lt;code class=&quot;language-text&quot;&gt;auth&lt;/code&gt; function that will be invoked before target function to check if supplied token is valid. &lt;code class=&quot;language-text&quot;&gt;auth&lt;/code&gt; function response is cached for 30 sec, the cache key is a &lt;code class=&quot;language-text&quot;&gt;identitySource&lt;/code&gt;. Usually when using proxy approach the whole request is forwarded to our function and configuration is as easy as&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;  &lt;span class=&quot;token key atrule&quot;&gt;list&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ajurasz.lambda.gallery.ListHandler
    &lt;span class=&quot;token key atrule&quot;&gt;events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; gallery
          &lt;span class=&quot;token key atrule&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; get&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;yaml&quot;&gt;&lt;pre class=&quot;language-yaml&quot;&gt;&lt;code class=&quot;language-yaml&quot;&gt;  &lt;span class=&quot;token key atrule&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;token key atrule&quot;&gt;handler&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; ajurasz.lambda.gallery.DeleteHandler
    &lt;span class=&quot;token key atrule&quot;&gt;events&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;token key atrule&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; gallery/&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;id&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;token key atrule&quot;&gt;method&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; delete
          &lt;span class=&quot;token key atrule&quot;&gt;authorizer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; auth
            &lt;span class=&quot;token key atrule&quot;&gt;resultTtlInSeconds&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;30&lt;/span&gt;
            &lt;span class=&quot;token key atrule&quot;&gt;identitySource&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; method.request.header.token&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;when we want to secure our endpoint.&lt;/p&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;With good encapsulation, you can test a lot. In my case, I only was not able to test Rekognition and DynamoDB services so had to use mocks. Recently (again, thank you Twitter) I found that &lt;a href=&quot;https://github.com/allegro&quot;&gt;allegro tech team&lt;/a&gt; open sourced &lt;a href=&quot;https://github.com/allegro/embedded-elasticsearch&quot;&gt;embedded-elasticsearch&lt;/a&gt; to make unit and integration testing easier and more reliable.&lt;/p&gt;
&lt;h2&gt;Deployment&lt;/h2&gt;
&lt;p&gt;This can obviously be a part of CI/CD pipeline as when everything is ready you need to execute just two commands&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./gradlew &lt;span class=&quot;token builtin class-name&quot;&gt;test&lt;/span&gt;
serverless deploy&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;this could be simplified to just one command by executing &lt;code class=&quot;language-text&quot;&gt;serverless&lt;/code&gt; command from within gradle task.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Personally, I wouldn’t consider building my whole application as functions from one simple reason - vendor locking (&lt;a href=&quot;https://startupsventurecapital.com/firebase-costs-increased-by-7-000-81dc0a27271d&quot;&gt;this article&lt;/a&gt; is kind of “lessons learned” type in terms of vendor locking). But this is a great option when you need to run some simple function triggered by different events somewhere on the web. There is still some lack in case of debugging (or I didn’t yet discover how to do it properly) these functions - at this point I will say only - &lt;em&gt;logger is your friend&lt;/em&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Homemade central heating temperature monitoring]]></title><description><![CDATA[Over the weekend I decided to once and for all resolve issue with boiling water in our central heating system. For people who don’t know…]]></description><link>https://ajurasz.github.io/2016-12-15-homemade-central-heating-temperature-monitoring/</link><guid isPermaLink="false">https://ajurasz.github.io/2016-12-15-homemade-central-heating-temperature-monitoring/</guid><pubDate>Thu, 15 Dec 2016 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Over the weekend I decided to once and for all resolve issue with boiling water in our central heating system. For people who don’t know what I’m writing about here, you will find nice &lt;a href=&quot;https://www.plumber24hours.co.uk/plumber-blog/index.php/2013/01/05/solid-fuel/&quot;&gt;ilustration&lt;/a&gt; that should make it clear. In my case the problem is that when I focus on something I forgot about the world around me and then after some time the sound of boiling water in pipes immediately pulls me out of my work and in few seconds I’m in the basement trying to resolve issue in different ways and this isn’t a pleasant operation. Please notice that this situation is very dangerous because boiling water can damage pipes and in few minutes your home can be flooded and repair costs probably will be very high.
Solution to my issue would be replacing the old furnace with new one that can automatically take care of temperature adjustments, but I have got much more cheaper and more interensting solution for this one. &lt;/p&gt;
&lt;!-- end --&gt;
&lt;h2&gt;Idea&lt;/h2&gt;
&lt;p&gt;My idea is to use &lt;a href=&quot;https://en.wikipedia.org/wiki/ESP8266&quot;&gt;ESP8266&lt;/a&gt; that will send temperature readings to &lt;a href=&quot;https://www.cloudmqtt.com/&quot;&gt;MQTT broker&lt;/a&gt; running in the cloud
and then business logic will be handled by lightweight nodejs application running on &lt;a href=&quot;https://dashboard.heroku.com/&quot;&gt;Heroku&lt;/a&gt;. Logic is simple, display the current temperature in real time one web page using WebSocket protocol, expose REST endpoint with current temperature and send a notification to registered Android devices when the temperature is over 80 Celcius degrees. Registered devices will be stored in MongoDB hosted by &lt;a href=&quot;https://mlab.com/&quot;&gt;mLab&lt;/a&gt;. Here is top level architecture diagram:&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 690px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 48.57142857142858%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACj0lEQVQoz2NgLF/Bwvz/PxNj2wEWxtJyBhhQv3OBRWxuDwdDsi8Lw7QOFoZ4Txbh6c0csjPqWUDyTCntTIy5s3gZE7uFGJN7hRiLFvIx5s1hZmBMn8TPYOojyRhSys+Yv0yQQa+ZjdtYl0fU11MIpPHOs+dNd548OXPz2YsuBtlpbPxxVSKsjAyCDGFLpJh6T/ADlQgAMTdj+0EuoIGyDIwhFZwM/KIKDHKK3IzZq8UYzFqFOOQlpLjlZGWBChnPv32/98Lbt/8PXrl5i0F9DQ+bW4w4CyeHDAOXiDSDhrkCY+hkCcacZYKMhXN4GPPnszIw5c3iZQqeJ8WUt4yPqXw2O8hVOv9/MgcAgwHEPvbju8bRL1+cbj1/aeVrMJWJr7Gai9/IAORtZpC8sE6YnLienQA8rCKBWIidSVqUgYEFJibWVs8uVFPKyoAFSM/o57D4/x9ZiAvB9GdgYHWYy86gOcGUwXgyH0xYYlIXq+Tkbk6RjgbW6FcP2Xb9/8+ScPIwu2RPK5vE5G4e2eZ6xlsPfjGC1M7adGTJrI0Hc0HsmRsPMTFM2XpbYNmhxzMXH3miCBJccPgRWKF4VxOr4rHdLBwmhgIsstKyPB4u3HKbVrACxVmqVAIZ/v//D1Z34+2X15eev18AZbMwfP7/X+rG/cf/Lz96bQMWfPmZSby5BtlLoHAVhIUZCNglFsANXH/0ws7VB87UgtjrDp5kZvgINPDizbv/z9x5ZgsSvPzkA5PUvGkMiif3MXA72aGEH2+AN4PswW3owcoNxJz//28GRyLD1Te/hG6/+rz93JPP2iD+2adfGLFFhomJCZhOSUlhA2Le5NQ0nqyECO6cWQe4jBoPSq2YXihXGefBDgACGNmIV03LbgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;esp8266_remote_temperature_diagram&quot;
        title=&quot;&quot;
        src=&quot;/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png&quot;
        srcset=&quot;/static/5e5d7d080fb98fe2e4801751713735c5/4edbd/esp8266_remote_temperature_diagram.png 175w,
/static/5e5d7d080fb98fe2e4801751713735c5/13ae7/esp8266_remote_temperature_diagram.png 350w,
/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png 690w&quot;
        sizes=&quot;(max-width: 690px) 100vw, 690px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;h2&gt;Costs&lt;/h2&gt;
&lt;p&gt;Only costs I had to bear were for physical devices:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ESP8266 bought &lt;a href=&quot;http://allegro.pl/modul-sieciowy-wifi-esp8266-sterowanie-rs232-at-i5506834559.html&quot;&gt;here&lt;/a&gt; for about 4$&lt;/li&gt;
&lt;li&gt;Converter USB UART/RS232 bought &lt;a href=&quot;http://allegro.pl/konwerter-przejsciowka-usb-uart-rs232-pl2303hx-avr-i5734968614.html&quot;&gt;here&lt;/a&gt; for about 1$&lt;/li&gt;
&lt;li&gt;DS18B20 digital temperature sensor bought &lt;a href=&quot;http://allegro.pl/czujnik-temperatury-ds18b20-wodoodprony-przewod-1m-i5460123942.html&quot;&gt;here&lt;/a&gt; for about 1,8 $&lt;/li&gt;
&lt;li&gt;Power supply bought &lt;a href=&quot;http://allegro.pl/ladowarka-zasilacz-usb-5v-2a-kabel-mikrousb-i5903646901.html&quot;&gt;here&lt;/a&gt; 4$&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Total: 10,8 $&lt;/p&gt;
&lt;p&gt;If it comes to MQTT broker, application and database hosting I’m using free plans as they are sufficient for my needs.&lt;/p&gt;
&lt;h2&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Complete project can be found on &lt;a href=&quot;https://github.com/ajurasz/RemoteTemperature&quot;&gt;github&lt;/a&gt;. In this post, I will only focus on core parts of each component. So what are the components:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ESP8226 device&lt;/li&gt;
&lt;li&gt;Nodejs application &lt;/li&gt;
&lt;li&gt;Android application&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Regarding &lt;a href=&quot;https://iot.eclipse.org/resources/white-papers/Eclipse%20IoT%20White%20Paper%20-%20The%20Three%20Software%20Stacks%20Required%20for%20IoT%20Architectures.pdf&quot;&gt;Eclipse IoT White Paper&lt;/a&gt; I would say that in my simple architecture ESP8266 act as both field device and gateway. Nodejs is an application that only performs business logic on data delivered by devices (in my case just one device). Android application is for the end user, where that user can check current temperature and be notified when the temperature is too high. &lt;/p&gt;
&lt;h3&gt;ESP8226&lt;/h3&gt;
&lt;p&gt;If it comes to ESP8266 there are two main things that you need to know when playing with this device. There are different wirings for deploying and running your program. When you want to deploy your program to the device you need to set up wirings in following way:&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/25249e1fdd8758c1dcd6545a8021fe83/f5209/ESP8266_upload.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACN0lEQVQoz32STWsTURSGZ+s/0I3uXLhSFMS9iFBx0YVYNxYEtUJBKGk3orhwVQUFNy4VlLZoG9NvmzRJk04mycxk8lGT2rQWirU0k6aaNOlHZh4nY5pGCz3wcuCee59zeM8VqoZBtWpgh2mwtJglEddQ5KidY6pCMhlH19ftK4Z13zBNW2ZT3pdAPQwT9N/bRLQ5AmEVjz9EQFLxizLT4QhJq9FRYTeyJMzEVixIlkHfPOnsGqFZGfe0yKRXxGtljzuI1z/LbGqJ4h7kCgXW8wXyW9sUyxXyv4qUd3YbYOHU5W6OnW7lfEsHaaeL+Rk/UZ+bQNCSc5CZoSG8zn5cAx959fodJ290cqLNwdmbHZy73cXx9iecaevk+rUWHI5uhJdvx3n0fIBbPT0kMl9RNY33A30MT4zg9nkZm/zChH+KzMICfZ4AF7ufceXxG1rb73LpjoMLXS+4+vApD+7fo7e398DDKc2DL+jn8ycn/R/6EAMic4kkmhIjFlfJb+gUKfFj62fdc7O+SPMfL4VqtWodWt7sbpAtfSeQFm24KzTCaHic4dAYrugo0nKUucI3NrYLfzkcgGrbrXFqEvbXXauXdyrEUwkiSoRgKEhUiSJFJEJqiMXVpcbjoyTUOpn1sQ3rP2bSGbSYRlgKo6kxlKiCrMmsrK00gM3g/5sIzYU9a+RUKoUsy4iiaH1u2QZLisTy6vIhYHNuePh/cXNzk1wuZyufz9tZ13XK5fIhQPO7SqVCqVTiD2QzC3rQ67XmAAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;ESP8266_upload&quot;
        title=&quot;&quot;
        src=&quot;/static/25249e1fdd8758c1dcd6545a8021fe83/8c557/ESP8266_upload.png&quot;
        srcset=&quot;/static/25249e1fdd8758c1dcd6545a8021fe83/4edbd/ESP8266_upload.png 175w,
/static/25249e1fdd8758c1dcd6545a8021fe83/13ae7/ESP8266_upload.png 350w,
/static/25249e1fdd8758c1dcd6545a8021fe83/8c557/ESP8266_upload.png 700w,
/static/25249e1fdd8758c1dcd6545a8021fe83/e996b/ESP8266_upload.png 1050w,
/static/25249e1fdd8758c1dcd6545a8021fe83/f5209/ESP8266_upload.png 1061w&quot;
        sizes=&quot;(max-width: 700px) 100vw, 700px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;when you want to run your program, wirings should be set up in the following way (scheme contains temperature sensor connected to ESP8266):&lt;/p&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 254px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFKElEQVRIx6WWC0yTVxTHvxlJ5jbMtgyK4txi1BCRMJ0axSDoptMtgsNA6GDKHB1DNAsCFXRE3uImVQSsQEUt47GBYCkSdDrUKkMEx0AYUoE6kJdM2sqj9PXf/T7aCTIQ6m1OvpMvp7/+z73n3FMKEyy9Xg+dTsf4EokEXC4X4eHhSExMhEaj+S/m+UVNBjR+kcfjgaIomJmZwc7ODmq1+uWAfD4f5ubmsLa2hpOT0/SBdOBoYFJyMmbNmgVLS0s4ODhANTw8Jm5KCumlVo8ABWmpDJDFYmGdoyONMk0h9DrQyR2IioP566/BiihcvmIlmtq7pqeQSVc7csIFN6thw94L1lYOLIjNc+VgX5LQGDh9YObV23jVbR/mfBUJK59DMPcMhXtcuukKc8oqMcczCHN3HISl9wFYsUPASTjzEsBrlZjvFQwLrzC8Q8ySzcWuoxmmALWMf5akTG3ZgyUBh7HAN5JJ3yU6zXSFuUThXJLyMv9ILNjGwcwPN8M1OMYQp5s6UGsAlpRXwzUwAgvYgVjkHYz3vLlgx5mg0AgsulkF593fY9V2HzhtccEq543wC4swPWUhXTbbg2Cz2hlr7G2xzNYGOznfTj9lI/AcAc5w+Q727ACs9/aDg8cu+EYmmK7w3G+VMHMLwmrucdgHJsAmIB7uR86OAxr9F5fNJQlmbNyFxX4xeNcnHNakwANP5Y0D0pcxbRMDNSNAQU4+KOslsPo6GiyvULzN3g/fxKwxwNFpv1DhadFlzHT4HAv9YhmFLNJ+HvEZo6phJC4rKwsRkRFTOZRKzP4iDA77eXDkHoNdQBzcYgXjgLwEHji+nBcrTL9SCYtPdmKTx3Z8tIMDJw8OXKP4Y1Mmn9rGOjRIGyYG6gz70qYYQElBCXjf7Aaf7GdR2S3cbmxhbm2jOsWTx0grKcXFX0STjwDjGEV3Jy4eiUevvO9/44aUfUjKKUVJqmjyEaAnQFqnqrUVuWQmpwgEEBeJUVBYCJFIxJhYXIy87Ezw839F6ZliUPTmjzWtwYhvGFJqmQwFUVGoaWiAamgIcrkcSqWSMblCgeF+BR4oARH//OQpGxetsDAmGi3t7RPGtPYbgIdPX0Os4Bpi0q8zzx/Jy/i0UsQIJIg6VYbOp0RlVwdRGI0motS4t8ZtGdlnHVqe0kDSBLNXhYBaGAZqETFbctVbsGD2/lbYuh7Fyg3+kJwSoiNXiOy4Q2hufzShQtkguepSC0FtYIeR2gqB594f8PHOeLy1aDPeXLEHTt7H4fLlQdyt+BPyinLkhIWivr4e+oEBDPb1YYic+LCyH4NyJfSKJ2jsHER+ghDUJtKbnr5B+GBbBOY6BmP5GmfM++w4Fvskw5Fc+eWJfHTkZCM7NBQ3Tp5EFzlZWX4e2gouoCEjBdKss+i+UABJlhjnT+SAWvppCNa6BWP+ei5eWRqIOWsD8Mb6Y5i3zg9r3SPQ2q1iUqqurcV9qXRMms13iqDoamJ8aY8KVbIBUJfLm0Hb1QopblY1Q3hJihTxAySn/Ywd/oeQX1iM62VlSEkmappGgBrDv686SRF6Hv7F+A1/K3Crvnd82fSrtMj/vQuXa7qReakW6eK7OFlYhfTiGojvkI6524Pi6m6U/NGL87eaybtHuFLXh59udOCeTAmKHkajjS6DQZUGyiEthklFqEmr0OVNP+kfezqkYZ6K/mF09SrQ1vkY3f8o0NnzBCqV6plC/ai2G9WEz9mzpdWo8VDWigfSJtTfq0PT/UbU1NTgX/I2rwVA5LL8AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;ESP8266_run&quot;
        title=&quot;&quot;
        src=&quot;/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png&quot;
        srcset=&quot;/static/85801ae33ce503d5e02cee5724711ac0/4edbd/ESP8266_run.png 175w,
/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png 254w&quot;
        sizes=&quot;(max-width: 254px) 100vw, 254px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;Main responsibilities of ESP8226 device are:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;establish and keep a connection to local network (to gain access to the internet) &lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;ESP8266WiFi.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;wifi_ssid &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;your ssid&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;wifi_password &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;ssid password&gt;&quot;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  WiFi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;begin&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;wifi_ssid&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; wifi_password&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WiFi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;status&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; WL_CONNECTED&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;.&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;WiFi connected&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;IP address: &quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;WiFi&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;localIP&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;read data from the temperature sensor&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;OneWire.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;DallasTemperature.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;ONE_WIRE_BUS &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;

OneWire &lt;span class=&quot;token function&quot;&gt;oneWire&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;ONE_WIRE_BUS&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
DallasTemperature &lt;span class=&quot;token function&quot;&gt;sensors&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt;oneWire&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  sensors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;requestTemperatures&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;float&lt;/span&gt; tempC &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; sensors&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getTempCByIndex&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;push readings to MQTT broker&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;ESP8266WiFi.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;PubSubClient.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;mqtt_server &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;server ip or hostname&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;mqtt_port &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;server port&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;mqtt_user &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;user name&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;mqtt_password &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;&amp;lt;user password&gt;&quot;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;&lt;span class=&quot;token directive-hash&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token directive keyword&quot;&gt;define&lt;/span&gt; &lt;span class=&quot;token expression&quot;&gt;temperature_topic &lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;temperature/home/basement&quot;&lt;/span&gt;&lt;/span&gt;

WiFiClient espClient&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
PubSubClient &lt;span class=&quot;token function&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;espClient&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setServer&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;mqtt_server&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mqtt_port&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;reconnect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Attempting MQTT connection...&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;ESP8266BasementClient&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mqtt_user&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; mqtt_password&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;connected&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;failed, rc=&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;print&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      Serial&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;println&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot; try again in 5 seconds&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;5000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;connected&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token function&quot;&gt;reconnect&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; 
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;publish&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;temperature_topic&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;80.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; true&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;// Wait 30 seconds&lt;/span&gt;
  &lt;span class=&quot;token function&quot;&gt;delay&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;30000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can run above snippets independently or combine them together. At this point I need to say that it was so easy only thanks to these great libraries (as I have basically no experience in C language):&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/esp8266/Arduino/tree/master/libraries/ESP8266WiFi&quot;&gt;ESP8266WiFi&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/knolleary/pubsubclient&quot;&gt;PubSubClient&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/milesburton/Arduino-Temperature-Control-Library&quot;&gt;DallasTemperature&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Nodejs&lt;/h3&gt;
&lt;p&gt;I wanted to have something very light on the back end and to be able to host it for free so I decided to accomplish my requirements using nodejs which will run on Heroku. Another reason to choose Nodejs was that I wanted to check it out as I heard a lot of good about it. &lt;/p&gt;
&lt;p&gt;Main responsibilities of the Nodejs application:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;expose REST endpoints to handle device registration, update and delete:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;post&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/device&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; deviceName &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;deviceName&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; deviceId   &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;deviceId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; registrationId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;registrationId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;    

    Device&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;find&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;deviceId &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; deviceId&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; devices&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;devices&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length &lt;span class=&quot;token operator&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            Device&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                deviceName&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; deviceName&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                deviceId&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; deviceId&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
                registrationId&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; registrationId
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; device&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                    res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
                res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;            
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;        
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;put&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/device&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; deviceId   &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;deviceId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; registrationId &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;body&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;registrationId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    Device&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findOneAndUpdate&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; deviceId&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; deviceId &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; registrationId&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; registrationId &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; 
        &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; device&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
                res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
            res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

app&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;delete&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;/device/:deviceId&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;req&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; res&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; deviceId   &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; req&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;params&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;deviceId&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    Device&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;findOneAndRemove&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;deviceId &lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; deviceId&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;err&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
            res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;500&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        res&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;sendStatus&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;200&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;expose WebSocket endpoint using &lt;a href=&quot;https://www.npmjs.com/package/express-ws&quot;&gt;express-ws&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;subscribe to MQTT topic and update &lt;code class=&quot;language-text&quot;&gt;lastTemp&lt;/code&gt; object with current temperature and notify registered devices if the temperature is above 80 degrees:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;javascript&quot;&gt;&lt;pre class=&quot;language-javascript&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;mqttClient&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;message&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;topic&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;received message %s %s&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; topic&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    lastTemp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;temperature &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    aWss&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;clients&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;forEach&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        client&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;stringify&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            topic&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; topic&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            temperature&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; message&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;toString&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;parseFloat&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lastTemp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;temperature&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;80.0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;var&lt;/span&gt; message &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;Warning temperature is very high &apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; lastTemp&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;temperature &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;°C&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;message&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;moment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;diff&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;lastUpdateDate&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&apos;minutes&apos;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            gcm&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;pushAll&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;message&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
                lastUpdateDate &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;moment&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;above was accomplished with &lt;a href=&quot;https://www.npmjs.com/package/mqtt&quot;&gt;MQTT&lt;/a&gt; and &lt;a href=&quot;https://www.npmjs.com/package/fcm&quot;&gt;FCM&lt;/a&gt; libraries. Documentation is very good even for Noob as I’m (in the case of Node.js) so no more explanation is required.&lt;/p&gt;
&lt;h3&gt;Android&lt;/h3&gt;
&lt;p&gt;For Android system, I created a simple widget which displays current temperature and is also able to receive messages from &lt;a href=&quot;https://firebase.google.com/docs/cloud-messaging/&quot;&gt;
Firebase Cloud Messaging&lt;/a&gt; and display them as notifications. Because this is my first experience with Android SDK and I did all the research and implementation over the weekend I beat that there are better patterns for handling my requirements. Here are two screenshots of this application:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;widget&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 346px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAIgElEQVRIx22V51eT2RaH37/k3s9TLSg4M44oKEgd+oAKShOxgEDoEAiE0AIo0kRQSmjSu46iUqSJooC9ARbAOk39+Nyd4Ky5s+7NWs/a+5x3/377nJ28K8r5onoulDbREFdAs7qIs8kn/oemz/xjL6mQFk0p/ccN9ORX062voiv3DMp4WTvjZR0M5jUwXNDEUEEjQ/kNQuP/ZfCvKPVDUj9a0sZYaTsjhc0mlNmibmaKupgt7saYz5b2MFfe/09O9n2m38SsiT4TM6W9q5QZ6UNZGp7j1eg93l57wrtrD3jZc53Fqiss1g6xWDNoYsEwZGKxZpUFI4ZhU5w3Ivm8PJ+vHkT58+MHjJ9P96f5Y+WdKX/Xd5PXhlHeNE7wpn6cV23XWO69wXKP0HXdxEr36nqlfYpXzfK8Y4plqVf++PTRZDL1aJBri6uGv1+6w/vaMd43TvK+YYJ3Et81TfLWiORvZG+leZKllkmWmyZYlvWSxNcGMfz1wTM+zK/wx7PXfHyxwofrT3lnuLpK7Spva4TqkVWqRngjLBtGeCk1L+uusmSMUveq6qqcsH6Ej41jfGoY40P9GB9rR/kkR/8oXT/UGxlfpW6cPw1C7Sq/VY3ytnKItxXDvKkY4rXwSlB+rbvCTfmZ3NDXmZjKqWMio5oJXQ2TmbWmfDy9igltNZM6A5MZBsbSq7mf38E7o0n5ZeEKK0ZOXkFZPnMOjfd+kj0CUbsHkvrzAbIDo9D6HpH9UHT+R8kKiJR1GIkugSS7BhFht5vW8Fz+rLzKcvFFVkovsVxyiaWSAZQVMdTtDiXNOwS1awD6wEgG6tvpKK6iMaeEloJTNOnLqEzMJt7OF417CDEOfrSF6/m9fJilE7+wfOKCxAu8FJSV0/3odoWi8QwmS05VFJbEmeQcymMzKFOlU3w0BX2QihpNAWVRaaS4BBFt70vrkRx+Kxvk5bFzLB0/L/E8LyRXlk71keYlV3b1R7fnMLlBUWTuDUPne5hUrxC0uw+hMY7BP5LTaj1JzgFE2O6i+VAWv5Zc5nl+Hy8L+nmR32/KlSV5ffL2hJHjc5hs70NkeoaS6RX6OR5E53FACEXrGkKaczCZHodIdg6k44ietycu8kzfI/SyaCS3B+V9xYAMU7oU9fHiRB/PC3t5dryHxWM9LBR0M5/fxVN9p4knuZ08zu7gYWYbT7I7xaCX+ZxunmZ38ySrm8eZXShvygZ4UzrA6+IBVoourg648BfTTJ4XnONZ/jkW8/rlBH0s5PbxNKdXzHp4JAYPdJ3cz+jknhFtB3fTO1Beyrf0XMSLIl4Q8VN9v5ykj0cifCjCByK8L53v6bq4K8I7Iryd3s7ttHbmjGjamDWS2sqMoDyTgS7kSWeZwWO5wqN/mIhBxn8Z/CVMaeFWSvMq6rPcVDdxM7mJ6eRGlEW9zClX5iQzeZwl89G18yCjTa7Qyt20Fm5rWphLbWY25SwzIrwloltJDdxMrGc6Ud6ueAPXTdQyFVcjhjltzGe18kTXwiNtMw/Tz3Jf08Td1EbuqBu4ra5nLqmO2UQDMwm13Iqv4WZsDdMx1dyIrmJKdZprUZVMRlYyEVGB8jSjkcfpDTzU1HM/pY67ybXcSaphLqGa2fgqZuLOcCv2NDejTzOtqmQ6qoIbkaeYOlrOZPhJxsPKGD1SytXDxQwfKkJ5oK7mXlIVdxLOMBd3mpmYCm5FnxJhuQhPcj2ijKnwUq6FlTB5pJiJw0WMHTzBSGghQyHHubL/GJeC8xkIzONigF7+U6JPciuyjOmjpdwIL2bqSBGTh04wcbCQ8dDjjB44xtWQAob35zMUnMeVQD2XAnK5uC+HX/Zmcc43k/49Onp3ZdDjo0UZDRGBdBgJymNIOgz653J5bw4Dftlc9Mvigm8W50VwbncGfSLqFVH3z2l0eWno8Eil3T2VNrcUWl3VtLioUfp9dPR5i7uXFHqm0+WeRofQ7qahzTWVVpcUWn5KodlZzVmnZJock2hwSKTePpE6uwTqdiZgsI3HYBNPrU0cSrdzKp1OKbQ7SgeHZJrtkmjcmUiDrQhsEqjdEU/N9niqreOosorljFUMp7cJW6OptIymYks0p35UUS6c3KxCabJOoN5KOmyLo3prHGcsY6ncEisFMVIQQ+kPMZQIxULRdyoKN6k4bqHimLmKAvMo8jaq0G9QkWMWTbaZGOo3RMkiiqz1kWSuj0K3LooMQbtWhWZdNCnfRqExi0H7fQKJX0aQ+HUk8V9FEifEfPkXEUR9EUmEoGRaa8mw0qIVNNvSUW/VELclmegfEkixiCV1s5rEbRkkWKYTtzWdWMs0Yiw1RG9JQ7VFQ5illgOW2YTLfviPKSjBVnEEyEyCtsWy1zIK781heH53AJfNh7EIrsHB8xghMqtDO0Vsp+WofSYRDllCJuH2OWTKzGt3+hG3PY0Ip3wUe7NAVgkwRSfzYOy+2YtLWjf1Cx8I6X/C91tVuKz3l2f7cd4oSHTdEMKOzUEcCwpgIKGQy2meeP0gV3a2CJQCwSLIxE+bgnFY64d1zgDDS7+hHn7GJptE3M324WQRjNPGQBwFZ7MgbL/35V9FkUQOXOZupys2a/xQHMz34mDu9zcWItywB2vLg/z7cB1rPbP4SdZOm4wnlGfm/iYcpc51QwBmjnvYn+BAuJM3tusDUXZu2IXtBh9szbxNbF/jic16b+zWeeH4tQuOazxM6x1rfsZ+4x5p6oujNDZis24Xzmt9cfjWX2qMN5AT2piJwWes17qRFJ6Jh5U/VmvcsDX3YctXLhzxi6cgvYytktub7xLjXVh/40F5fi1H/dVYyyGcNvmZGio71rvzN264W+1jp7kX29e5SRMPtksTly2++OwMNuW20tiIzToPfB1CcbPcJ1f1kkY+2G304T/UcJQQbYNZbgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;android_widget&quot;
        title=&quot;&quot;
        src=&quot;/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png&quot;
        srcset=&quot;/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/4edbd/android_widget.png 175w,
/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png 346w&quot;
        sizes=&quot;(max-width: 346px) 100vw, 346px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;notification&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 346px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFtElEQVRIx5WV2W9TVxDG72sViSRe493xvu9xvGRxYsdxbGdx4hClaXnggapVVaoWFWipSiXoX9YHHvtQQBA2iVTNBkFZHUL4OnPsawyi0Fr6ac4y3zfnzLF0pWAwiEgk0iYQCIDXPgbnhcPh9tjv94uxFAqFMD09jVqthrm5uXaCHDsLdK5z8StXriAejwvjTCYjTCXe9Pl8IpHN32fEifIJGM73er1IpVJtDZuyRuJK2WxWLMibvBaLxdpzPkUymRRzFrFRLpdrF+F8WS85HA5x5YWFBdjtdlitVhQKBSwtLcFisYD30+m0WOOxzWZDPp/HysoK3G63WGMjLshjqVwuo16vY3FxEZVKBdVqVZh3zjlyUY7MzMyM6Dlr5Rx5X9rb28PDhw+xvb2NnZ0dPH/+HM+ePcOLFy8EvH9wcID9/X0R5bG83rnGUTo+PsatW7ewu7uLra0tYcjmjUZDxJcvX+L//KRXr17hwYMHuHPnDu7duyfGfOLbt2/j9evXHxTz/unp6VsIw0ePHmF1dRVPnjzB06dPxZxN19fXxfX55BsbG1hbWxOR57z+3hOenJygcXSEI4L7IEe5L4eHhwKec1s48pzzWMsH6kQY7lES94rHcjzhBLqCnNh5LXlN5L2DdESP8vsff2Jnbx9rG1tY397B38RfG9s4ahyLPsn8p0dh19XWQ3AfuYccef3fHuJDSHzF+/fvC8PHjx+Lh7l7965oOv9tNjc3xSNwPKYTC9PTDxhywgE1mfvVOG7g8Iga3uB4hL39PcH+wT526Y9Mko9f+ebFq/jt259w8+KPbW4w33RyVcRfv76M61/90ObnL77HtQvfUSQo/vLlJUjTgSFUfVlBxZtBmZjypNuU3GlMulOYdL2h6BzEJPF5bhYXyss4X1zEubE5TJFWWkoVsTRYxNnkBBaZAaaAeqKABSaeF8zHmHHUiPkoxegYljNlfDpUwVKqhOVsWexLZxPjWIyPox4fw0KMiOZIQERyqEVGUQuPYo4JjbSZDQ4Lqr4M3Sr9VpTqsRzqsVEyGiWTEcyHR8hkmIQtgkMkJgJMFrP+LGaIaRIzshlT9qQgzUeGyWQItdAQibOCpjBDQsKXJmGTqjeFKokqRNk9KJhyJVFinAPU1wFIc4EMidNCOEOCacbDwkFUSVBxJ0lIkGjKNYApEpWcCUw6Eig64ija45iwxQSF/hikSiu57GwlUyIzaWeagqKtJepvigrWKPLEOGOJCMbMTaSJ/ngz0dokb4kKxs1MK9EUQU4QxqixhSGEkU70DH2XC5SYJ8aNJKTEnKHJaDsphGEdE8QQ09ckK6MNINMiraHPaI6SR/pIQJvMkJaTgpQQpIQmqRaD6oAgqZLxY4BiQsnQ55aixBMexBUBxDqIEhEFfcB7aUzJMQ19d7v9CPXQt7hFoAM/7fkIKaaLIaaLIkox0hdFmAhqw/BrQghT9Qgb9dFHX0vrtBdgtE38hJf23NoExSh8pJNcdE1HXwBOwq71o1/jhUXthknjgco1DKM1CRf1x2OIwGsgkTEGvzFOkUkgLh7FjiAdym+i/6FB6UQTh4hGlQuGHjvM0TxGFz+De6IONRUyKRxiz6QkKJop6jROJJ0OlEKDKEWtsGp8kEwqJ97F0GuHLjGJ8tIKwuWzUNFLm5VsSAVFUcqjqFfb0JWi/pVKqOXN0JNOMqrseAu1g5Jt0Gk96PKMQGGNk5kdJjUb0Z7KISJjIWOl0Q5X0EjX74de4YSkV9FA+QZNtwk6hRUGwthjoqta0NdjgeaMsVXU1i6uOWOCobsfxl46rYKL0Qn1SisZWcBRSwbnls/D74xA3U0GdKWeT7QoT8zi0sXL6KWxSc2ntUHZpcf1azdQLdag6NLBrHGIYpKOTqBvoes1I+CMwqy1o4/GXEjbY4TL6kfUnxQFmwewiv2BcAYea0DouLiRbvsPsrI+8dYHv8cAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;android_notification&quot;
        title=&quot;&quot;
        src=&quot;/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png&quot;
        srcset=&quot;/static/661067bfd7d5360baed870f1284e362d/4edbd/android_notification.png 175w,
/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png 346w&quot;
        sizes=&quot;(max-width: 346px) 100vw, 346px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;Integration with FCM was kind of tricky but &lt;a href=&quot;https://firebase.google.com/docs/cloud-messaging/android/client&quot;&gt;“Set Up a Firebase Cloud Messaging Client App on Android”&lt;/a&gt; article helped me a lot. It will take you step by step how to set up FCM client.&lt;/p&gt;
&lt;h2&gt;Future work&lt;/h2&gt;
&lt;p&gt;I will try to replace Nodejs application with application that use &lt;a href=&quot;http://vertx.io/&quot;&gt;Vert.x&lt;/a&gt; library.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Watch were you put your license headers]]></title><description><![CDATA[Recently when I was playing with creating Docker images I came across really strange error during creation of a container that doesn’t say…]]></description><link>https://ajurasz.github.io/2016-11-02-watch-were-you-put-your-license-headers/</link><guid isPermaLink="false">https://ajurasz.github.io/2016-11-02-watch-were-you-put-your-license-headers/</guid><pubDate>Wed, 02 Nov 2016 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Recently when I was playing with creating &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; images I came across really strange error during creation of a container that doesn’t say much (not to me):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;standard_init_linux.go:175: &lt;span class=&quot;token builtin class-name&quot;&gt;exec&lt;/span&gt; user process caused &lt;span class=&quot;token string&quot;&gt;&quot;exec format error&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- end --&gt;
&lt;p&gt;after some time spent on searching information about it, I started to rollback all changes done to Dockerfile one by one until I found failing part. The issue was with a shell script which was starting with license header instead of &lt;a href=&quot;https://en.wikipedia.org/wiki/Shebang_(Unix)&quot;&gt;shebang&lt;/a&gt; (i.e. &lt;code class=&quot;language-text&quot;&gt;#!/bin/sh&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;From Unix perspective this script is valid (in terms that it executes and print’s expected value on the screen):&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt; &lt;span class=&quot;token function&quot;&gt;cat&lt;/span&gt; test.sh
&lt;span class=&quot;token comment&quot;&gt;#The MIT License (MIT)&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#Copyright (c) 2016 Arek Jurasz&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without #limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following #conditions:&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;token comment&quot;&gt;#THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO #EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR #THE USE OR OTHER DEALINGS IN THE SOFTWARE.&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;#!/usr/sh (1)&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;ps&lt;/span&gt; h -p &lt;span class=&quot;token variable&quot;&gt;$$&lt;/span&gt; -o &lt;span class=&quot;token assign-left variable&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;cut&lt;/span&gt; -f1 -d&lt;span class=&quot;token string&quot;&gt;&apos; &apos;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Success&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;(1) inform OS what interpreter should be used for this script&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;(2) finds what interpreter is used to execute script&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt; &lt;span class=&quot;token function&quot;&gt;ls&lt;/span&gt; -l
total &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;
-rw-rw-r-- &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; arek arek   &lt;span class=&quot;token number&quot;&gt;90&lt;/span&gt; lis  &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;:55 Dockerfile
-rwxrwxr-x &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; arek arek &lt;span class=&quot;token number&quot;&gt;1117&lt;/span&gt; lis  &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;:56 test.sh

 ./test.sh
/bin/sh
Success&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;if we change (1) to &lt;code class=&quot;language-text&quot;&gt;#!/bin/bash&lt;/code&gt; the output is still the same:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt; ./test.sh
/bin/sh
Success&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but we were expecting:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt; ./test.sh
/bin/bash
Success&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;this is not happening because &lt;a href=&quot;https://en.wikipedia.org/wiki/Shebang_(Unix)&quot;&gt;shebang&lt;/a&gt; is not in the first line and my OS is using default interpreter.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; is more restrective if it comes to &lt;a href=&quot;https://en.wikipedia.org/wiki/Shebang_(Unix)&quot;&gt;shebang&lt;/a&gt; and it will fail to run your container if one of the scripts doesn’t starts with it. So be careful and don’t make the same mistakes I did.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Bluetooth scanner on Raspberry Pi]]></title><description><![CDATA[Do you want to know what bluetooth devices are in the range of your raspberry Pi unit and then act accordingly? Now it’s easier than ever…]]></description><link>https://ajurasz.github.io/2015-11-16-bluetooth-scanner-on-raspberry-pi/</link><guid isPermaLink="false">https://ajurasz.github.io/2015-11-16-bluetooth-scanner-on-raspberry-pi/</guid><pubDate>Mon, 16 Nov 2015 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;Do you want to know what bluetooth devices are in the range of your raspberry Pi unit and then act accordingly? Now it’s easier than ever before because with version 0.1.3 &lt;a href=&quot;https://github.com/rhiot/rhiot/blob/master/docs/readme.md&quot;&gt;rhiot&lt;/a&gt; comes with bunch of new IoT components and one of them is &lt;a href=&quot;https://rhiot.gitbooks.io/rhiotdocumentation/content/gateway/camel_components/camel_bluetooth_component.html&quot;&gt;Camel Bluetooth component&lt;/a&gt; which will allow you to list bluetooth devices working in surrounding area. There is also possibility to list services of given device if you want to know how to interact with it.&lt;/p&gt;
&lt;!-- end --&gt;
&lt;p&gt;&lt;a href=&quot;https://rhiot.gitbooks.io/rhiotdocumentation/content/gateway/camel_components/camel_bluetooth_component.html&quot;&gt;Camel Bluetooth component&lt;/a&gt; is a wrapper around &lt;a href=&quot;http://www.bluecove.org&quot;&gt;bluecove&lt;/a&gt; library. To work properly it require OS packages for handling bluetooth devices. By default it supports Ubuntu and Raspbian by installing &lt;code class=&quot;language-text&quot;&gt;libbluetooth-dev&lt;/code&gt; and &lt;code class=&quot;language-text&quot;&gt;blueman&lt;/code&gt; packages. With some configuration you can run it on OSX as well, please refer to &lt;a href=&quot;https://rhiot.gitbooks.io/rhiotdocumentation/content/gateway/camel_components/camel_bluetooth_component.html&quot;&gt;Installation section&lt;/a&gt;. You will also need to set dedicated installer (&lt;code class=&quot;language-text&quot;&gt;io.rhiot.utils.install.BrewInstaller&lt;/code&gt;) when working with OSX.&lt;/p&gt;
&lt;h2&gt;Create scanning endpoint&lt;/h2&gt;
&lt;p&gt;Following example demonstrate how easy it is to expose REST endpoint which will trigger bluetooth scanner. This code can be run on both pc and raspberry pi:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token function&quot;&gt;restConfiguration&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;netty4-http&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;host&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;0.0.0.0&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8081&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;bindingMode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;RestBindingMode&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;json&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;rest&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;/api/devices&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;route&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bluetooth://scan?serviceDiscovery=true&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In above snipped we are doing two things, configuring &lt;a href=&quot;http://camel.apache.org/netty4.html&quot;&gt;netty4 component&lt;/a&gt; by setting host, port and binding mode. With binding mode set to &lt;code class=&quot;language-text&quot;&gt;json&lt;/code&gt; there is automatic conversion of &lt;code class=&quot;language-text&quot;&gt;json&lt;/code&gt; content to and from POJOs for all incoming and outgoing messages. Then &lt;code class=&quot;language-text&quot;&gt;GET&lt;/code&gt; endpoint was created with the &lt;code class=&quot;language-text&quot;&gt;/api/devices&lt;/code&gt; URI.&lt;/p&gt;
&lt;p&gt;Run application:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;java -jar target/scanner-pc-1.0-SNAPSHOT.jar&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;&lt;span class=&quot;token function&quot;&gt;curl&lt;/span&gt; http://localhost:8081/api/devices&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and formatted response should look like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;arek&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;address&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;44D4E0AAA2B1&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;bluetoothServices&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Advanced Audio&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btl2cap://44D4E0AAA2B1:0019;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;OBEX Object Push&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btgoep://44D4E0AAA2B1:12;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Headset Gateway&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btspp://44D4E0AAA2B1:2;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Handsfree Gateway&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btspp://44D4E0AAA2B1:3;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;OBEX Phonebook Access Server&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btgoep://44D4E0AAA2B1:19;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AV Remote Control Target&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btl2cap://44D4E0AAA2B1:0017;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;AAS&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btspp://44D4E0AAA2B1:4;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;Android Network Access Point&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;url&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;btl2cap://44D4E0AAA2B1:000f;authenticate=false;encrypt=false;master=false&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;Bluetooth scanner on Raspberry Pi&lt;/h2&gt;
&lt;p&gt;Let’s get to the point and see example running on Raspberry Pi. Consider following scenario:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Each time scanning is triggered blink yellow LED to indicate that application is running.&lt;/li&gt;
&lt;li&gt;Search device by it’s name.&lt;/li&gt;
&lt;li&gt;If device if found turn on geen LED&lt;/li&gt;
&lt;li&gt;If device is not found turn red LED&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Note: for 3 and 4 only one LED can be on.&lt;/p&gt;
&lt;h4&gt;Wiring&lt;/h4&gt;
&lt;p&gt;
  &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/3b3ae090a9f39281fe6e6b20af8d57c1/aeb8d/bluetooth-scanner-witing.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
  
  &lt;span
    class=&quot;gatsby-resp-image-wrapper&quot;
    style=&quot;position: relative; display: block; margin: 15px -30px !important max-width: 651px; margin-left: auto; margin-right: auto;&quot;
  &gt;
    &lt;span
      class=&quot;gatsby-resp-image-background-image&quot;
      style=&quot;padding-bottom: 105.14285714285714%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUDAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgD/2gAMAwEAAhADEAAAAbnm1mhWZncxiZtBr//EAB4QAAEEAQUAAAAAAAAAAAAAAAMBAhESABMUMTIz/9oACAEBAAEFAn9ZWWcGfQe7TAuuwyXHopIPP//EABcRAQEBAQAAAAAAAAAAAAAAAAEAEBH/2gAIAQMBAT8B6GJF/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPwHYxH//xAAZEAADAQEBAAAAAAAAAAAAAAAAARExEDL/2gAIAQEABj8CN43KeCpQaw3n/8QAHBABAAMAAgMAAAAAAAAAAAAAAQARIUFRcYGR/9oACAEBAAE/IVTZ3H2a3AZ6KlbpPcE6jqb7wbl2lab5hA0UXP/aAAwDAQACAAMAAAAQI9dC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQAhMRH/2gAIAQMBAT8Qexh92JduC//EABgRAQEAAwAAAAAAAAAAAAAAAAEAESEx/9oACAECAQE/EEDuHMRbi//EAB0QAQEBAQABBQAAAAAAAAAAAAERACExQWGRscH/2gAIAQEAAT8QUpiGE9ynlkipWvnJ2JI+qsMq3BRIo/G60CdX83c6oAsjgZQpU88dw52HKv3v/9k=&apos;); background-size: cover; display: block;&quot;
    &gt;
      &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        style=&quot;width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;&quot;
        alt=&quot;Posts per blog&quot;
        title=&quot;&quot;
        src=&quot;/static/3b3ae090a9f39281fe6e6b20af8d57c1/aeb8d/bluetooth-scanner-witing.jpg&quot;
        srcset=&quot;/static/3b3ae090a9f39281fe6e6b20af8d57c1/e52aa/bluetooth-scanner-witing.jpg 175w,
/static/3b3ae090a9f39281fe6e6b20af8d57c1/70ebb/bluetooth-scanner-witing.jpg 350w,
/static/3b3ae090a9f39281fe6e6b20af8d57c1/aeb8d/bluetooth-scanner-witing.jpg 651w&quot;
        sizes=&quot;(max-width: 651px) 100vw, 651px&quot;
      /&gt;
    &lt;/span&gt;
  &lt;/span&gt;
  
  &lt;/a&gt;
    &lt;/p&gt;
&lt;p&gt;To assemble this schematic you will require:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1 Raspberry Pi B+ (or 2)&lt;/li&gt;
&lt;li&gt;1 Breadbord&lt;/li&gt;
&lt;li&gt;3 LEDs&lt;/li&gt;
&lt;li&gt;3 220 ohms resistors&lt;/li&gt;
&lt;li&gt;7 Wires&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And here is the code to run on Raspberry Pi:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;java&quot;&gt;&lt;pre class=&quot;language-java&quot;&gt;&lt;code class=&quot;language-java&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;ScannerRoute&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;RouteBuilder&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;

    &lt;span class=&quot;token annotation punctuation&quot;&gt;@Override&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;configure&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exception&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;bluetooth://scan?consumer.delay=1000&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pi4j-gpio://1?mode=DIGITAL_OUTPUT&amp;amp;state=LOW&amp;amp;action=BLINK&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;choice&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;deviceWithName&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DEVICE_NAME&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setHeader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DEVICE_FOUND&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;otherwise&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                    &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;p &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setHeader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DEVICE_NOT_FOUND&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;multicast&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;direct:green&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;direct:red&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;direct:green&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;exchange &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;checkHeaderAndSetAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DEVICE_FOUND&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; exchange&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pi4j-gpio://2?mode=DIGITAL_OUTPUT&amp;amp;state=LOW&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;token function&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;direct:red&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;exchange &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;checkHeaderAndSetAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;DEVICE_NOT_FOUND&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; exchange&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;pi4j-gpio://3?mode=DIGITAL_OUTPUT&amp;amp;state=LOW&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;checkHeaderAndSetAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;String&lt;/span&gt; headerKey&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;Exchange&lt;/span&gt; exchange&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;exchange&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getHeader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;headerKey&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;null&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            exchange&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setHeader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Pi4jConstants&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;CAMEL_RBPI_PIN_ACTION&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;GPIOAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;HIGH&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            exchange&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;getIn&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;setHeader&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token class-name&quot;&gt;Pi4jConstants&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;CAMEL_RBPI_PIN_ACTION&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token class-name&quot;&gt;GPIOAction&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;LOW&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With this route few &lt;a href=&quot;http://camel.apache.org/eip.html&quot;&gt;EIP&lt;/a&gt; were used but I won’t explain them here as it’s out of the scope of this post. The flow is following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Consume results of a scanning.&lt;/li&gt;
&lt;li&gt;Blink yellow LED.&lt;/li&gt;
&lt;li&gt;Using predefined &lt;code class=&quot;language-text&quot;&gt;Predicate&lt;/code&gt; check if we found device with given name.&lt;/li&gt;
&lt;li&gt;Add extra header to message if device was found.&lt;/li&gt;
&lt;li&gt;Add extra header to message if device was not found.&lt;/li&gt;
&lt;li&gt;Route message to multiple endpoints.&lt;/li&gt;
&lt;li&gt;Examine message headers and depending on what you have found change pin action.&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;Final result&lt;/h4&gt;
&lt;div class=&quot;gatsby-resp-iframe-wrapper&quot; style=&quot;padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem&quot; &gt; &lt;iframe src=&quot;https://www.youtube.com/embed/pmYk7Yg13Lg?t=35s&quot; frameborder=&quot;0&quot; allowfullscreen style=&quot; position: absolute; top: 0; left: 0; width: 100%; height: 100%; &quot;&gt;&lt;/iframe&gt; &lt;/div&gt;
&lt;p&gt;Source code can be found &lt;a href=&quot;https://github.com/ajurasz/blog-samples&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To build all modules you just need to execute from project directory&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./mvnw clean &lt;span class=&quot;token function&quot;&gt;install&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;notice that I’m writing maven pom in groovy so if you want you can convert &lt;code class=&quot;language-text&quot;&gt;pom.groovy&lt;/code&gt; to &lt;code class=&quot;language-text&quot;&gt;pom.xml&lt;/code&gt; with following command&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;bash&quot;&gt;&lt;pre class=&quot;language-bash&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;./mvnw io.takari.polyglot:polyglot-translate-plugin:translate&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content:encoded></item></channel></rss>