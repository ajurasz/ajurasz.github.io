{"data":{"site":{"siteMetadata":{"title":"Dev Blog","author":"Arek Jurasz"}},"markdownRemark":{"id":"a5f5c718-8980-536b-a62f-2cc2e1bd3293","html":"<p>Investigation walkthrough for an issue related to multiple <code class=\"language-text\">classloaders</code> available when <code class=\"language-text\">SpringBoot</code> application is deployed on <code class=\"language-text\">IBM WebSphere Liberty</code> (<code class=\"language-text\">WSL</code>).</p>\n<!-- end -->\n<h2>Motivation</h2>\n<p>Recently I was investigating a strange issue that was present only in a production-like environment. Fortunately, my team have CI which is almost 1 to 1 with production so we were able to catch this issue before deployment. So what’s different between production and local environment you may ask. Well, the answer is very simple - we use different servlet containers. For local development, we use embedded <code class=\"language-text\">Tomcat</code> web server that is ship together with <code class=\"language-text\">SpringBoot</code>. On production, we have <code class=\"language-text\">WSL</code> application server. Because I wanted to know why the issue was happening only on one environment and working perfectly fine on another I had to dig a little bit. </p>\n<h2>Context</h2>\n<p>Before moving forward with the analyze let’s give some context so that what I will write next will have more sense. As always it starts with a <strong>simple</strong> task in Jira backlog. The task was to move complex <strong>authorization</strong> mechanism from service to web layer. </p>\n<blockquote>\n<p>authorization is the process of verifying that “you are permitted to do what you are trying to do”</p>\n</blockquote>\n<blockquote>\n<p>source: Wikipedia</p>\n</blockquote>\n<p>The difference on performing <strong>authorization</strong> on these two layers is that services operate on actual objects where web controllers on identifiers of these objects. Below is pseudo code for the change that was planed.</p>\n<p>Before:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aspect(object) {\n  return allowedToAccess(object)\n}</code></pre></div>\n<p>After:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aspect(identifier) {\n  const object = resolveObjectFrom(identifier)\n  return allowedToAccess(object)\n}</code></pre></div>\n<p>For now, we know what needs to be done and how. But one more important addition to the context is about convention* we try to follow in our code base - which is - extensive usage of encapsulation which in our case is more about creating a clear interface for others who will be using these objects than just hiding information.</p>\n<p>* clarification - we follow more conventions/best practices but in the context of this post, only this single convention is important.</p>\n<p>But what this exactly mean? In simple words, we use <code class=\"language-text\">public</code> modifier only when it’s really required, if not then we operate mostly using only <code class=\"language-text\">private</code> and <code class=\"language-text\">package protected</code> modifiers. I think the above context should be enough to start analyzing a concrete example. To make analyze simpler I have created a sample application demonstrate a problem and can be found on <a href=\"https://github.com/ajurasz/wlp-spring-aop\">github</a>. </p>\n<h2>Analyze</h2>\n<h3>Posotive scenario</h3>\n<p>For our case, we need to focus only on three elements.</p>\n<ol>\n<li><code class=\"language-text\">HelloControler</code> this is standard <code class=\"language-text\">RestController</code> to which one dependency is injected.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> HelloService helloService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">HelloController</span><span class=\"token punctuation\">(</span>HelloService helloService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>helloService <span class=\"token operator\">=</span> helloService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello/{name}\"</span><span class=\"token punctuation\">)</span>\n    ResponseEntity<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>String<span class=\"token punctuation\">></span></span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span> String name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>helloService<span class=\"token punctuation\">.</span><span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li><code class=\"language-text\">PointcutedHelloController</code> is special because <code class=\"language-text\">PointcutedHelloController#hello</code> is join point for around advice (<a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop\">AOP terminology</a>)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PointcutedHelloController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> HelloService helloService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">PointcutedHelloController</span><span class=\"token punctuation\">(</span>HelloService helloService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>helloService <span class=\"token operator\">=</span> helloService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello-aop/{name}\"</span><span class=\"token punctuation\">)</span>\n    ResponseEntity<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>String<span class=\"token punctuation\">></span></span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span> String name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> ResponseEntity<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>helloService<span class=\"token punctuation\">.</span><span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"3\">\n<li><code class=\"language-text\">LoggingAspect</code> which registers advice around specified pointcut</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Aspect</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LoggingAspect</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> Logger LOG <span class=\"token operator\">=</span> LoggerFactory<span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span>LoggingAspect<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Around</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"within(com.example.demo.PointcutedHelloController)\"</span><span class=\"token punctuation\">)</span>\n    Object <span class=\"token function\">aroud</span><span class=\"token punctuation\">(</span>ProceedingJoinPoint pjp<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> Throwable <span class=\"token punctuation\">{</span>\n        LOG<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>pjp<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLongString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> pjp<span class=\"token punctuation\">.</span><span class=\"token function\">proceed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can run tests or application itself (<code class=\"language-text\">mvn spring-boot:run</code>) and call <code class=\"language-text\">hello</code> methods - everything will work as expected. Please notice, if you will place <code class=\"language-text\">breakpoint</code> in <code class=\"language-text\">PointcutedHelloController#hello</code> you will see that <code class=\"language-text\">PointcutedHelloController</code> is wrapped with <code class=\"language-text\">com.example.demo.PointcutedHelloController$$EnhancerBySpringCGLIB</code> proxy.</p>\n<h3>Negative scenario</h3>\n<p>First you will have to change profile setting <code class=\"language-text\">activeByDefault</code> from <code class=\"language-text\">false</code> to <code class=\"language-text\">true</code> in <code class=\"language-text\">pom.xml</code> so it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>wlp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activation</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activeByDefault</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>activeByDefault</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>activation</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>then you just need to build <code class=\"language-text\">war</code> package (<code class=\"language-text\">mvn clean package -DskipTest</code>) and deploy it to <code class=\"language-text\">WSL</code>. After starting the server it crashes with the following message:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Caused by: org.springframework.aop.framework.AopConfigException: Could not generate CGLIB subclass of class com.example.demo.PointcutedHelloController: Common causes of this problem include using a final class or a non-visible class<span class=\"token punctuation\">;</span> nested exception is org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--<span class=\"token operator\">></span>class com.example.demo.PointcutedHelloController$<span class=\"token variable\">$EnhancerBySpringCGLIB</span>$<span class=\"token variable\">$4f0e109d</span> cannot access its superclass com.example.demo.PointcutedHelloController\n    at org.springframework.aop.framework.CglibAopProxy.getProxy<span class=\"token punctuation\">(</span>CglibAopProxy.java:208<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.ProxyFactory.getProxy<span class=\"token punctuation\">(</span>ProxyFactory.java:110<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.createProxy<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:471<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.wrapIfNecessary<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:350<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.postProcessAfterInitialization<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:299<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsAfterInitialization<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:429<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:1782<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:593<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. 32 common frames omitted\nCaused by: org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--<span class=\"token operator\">></span>class com.example.demo.PointcutedHelloController$<span class=\"token variable\">$EnhancerBySpringCGLIB</span>$<span class=\"token variable\">$4f0e109d</span> cannot access its superclass com.example.demo.PointcutedHelloController\n    at org.springframework.cglib.core.ReflectUtils.defineClass<span class=\"token punctuation\">(</span>ReflectUtils.java:530<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator.generate<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:363<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.generate<span class=\"token punctuation\">(</span>Enhancer.java:582<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span><span class=\"token variable\">$3</span>.apply<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:110<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span><span class=\"token variable\">$3</span>.apply<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:108<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache<span class=\"token variable\">$2</span>.call<span class=\"token punctuation\">(</span>LoadingCache.java:54<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at java.util.concurrent.FutureTask.run$$<span class=\"token variable\">$capture</span><span class=\"token punctuation\">(</span>FutureTask.java:266<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.util.concurrent.FutureTask.run<span class=\"token punctuation\">(</span>FutureTask.java<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache.createEntry<span class=\"token punctuation\">(</span>LoadingCache.java:61<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache.get<span class=\"token punctuation\">(</span>LoadingCache.java:34<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span>.get<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:134<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator.create<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:319<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.createHelper<span class=\"token punctuation\">(</span>Enhancer.java:569<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.createClass<span class=\"token punctuation\">(</span>Enhancer.java:416<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.ObjenesisCglibAopProxy.createProxyClassAndInstance<span class=\"token punctuation\">(</span>ObjenesisCglibAopProxy.java:57<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.CglibAopProxy.getProxy<span class=\"token punctuation\">(</span>CglibAopProxy.java:205<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. 39 common frames omitted\nCaused by: java.lang.IllegalAccessError: class com.example.demo.PointcutedHelloController$<span class=\"token variable\">$EnhancerBySpringCGLIB</span>$<span class=\"token variable\">$4f0e109d</span> cannot access its superclass com.example.demo.PointcutedHelloController\n    at java.lang.ClassLoader.defineClass1<span class=\"token punctuation\">(</span>Native Method<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.lang.ClassLoader.defineClass<span class=\"token punctuation\">(</span>ClassLoader.java:763<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at sun.reflect.GeneratedMethodAccessor27.invoke<span class=\"token punctuation\">(</span>Unknown Source<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke<span class=\"token punctuation\">(</span>DelegatingMethodAccessorImpl.java:43<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.lang.reflect.Method.invoke<span class=\"token punctuation\">(</span>Method.java:498<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.ReflectUtils.defineClass<span class=\"token punctuation\">(</span>ReflectUtils.java:527<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. 54 common frames omitted</code></pre></div>\n<p>First thing that caught my attention was <code class=\"language-text\">Could not generate CGLIB subclass of ...: Common causes of this problem include using a final class or a non-visible class</code> which seems to be fair enough as controller class is not public so it can be non-visible but then next question arises - why this was working locally when deployed on <code class=\"language-text\">Tomcat</code>? At this point removing AOP advice from <code class=\"language-text\">PointcutedHelloController#hello</code> metod, fix the problem. This clearly indicates that there is something wrong when using <code class=\"language-text\">Spring AOP</code>. Maybe it requires classes and method to be public? Let’s see what <a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-introduction-proxies\">documentation</a> says about it. Most important fragment of this documentation to my current situation is:</p>\n<blockquote>\n<p>With CGLIB, public and protected method calls on the proxy are intercepted (and even package-visible methods, if necessary).</p>\n</blockquote>\n<p>And this is true when deploying on <code class=\"language-text\">Tomcat</code> but not when on <code class=\"language-text\">WSL</code>. Because I’m not a <code class=\"language-text\">WSL</code> expert I had to do some googling to find out that this issue can be related to <code class=\"language-text\">classloader</code>s. Where one <code class=\"language-text\">classloader</code> is used to load all 3rd party libraries from <code class=\"language-text\">/WEB-INF/lib</code> and my own classes from <code class=\"language-text\">/WEB-INF/classes</code> and another when creating proxy for <code class=\"language-text\">PointcutedHelloController</code>.  </p>\n<p>After debugging session I was able to nail down which <code class=\"language-text\">classloader</code> is used when creating proxy.</p>\n<p><code class=\"language-text\">Spring AOP</code> creates its proxies through <code class=\"language-text\">CglibAopProxy#getProxy(classLoader)</code>. This <code class=\"language-text\">ClassLoader</code> object in the end is provided by <code class=\"language-text\">DefaultResourceLoader</code> which sets <code class=\"language-text\">classLoader</code> to <code class=\"language-text\">Thread.currentThread().getContextClassLoader()</code> during object construction. Bellow is screenshot which shows how <code class=\"language-text\">classLoader</code> provided by <code class=\"language-text\">DefaultResourceLoader</code> (left) differs from <code class=\"language-text\">classLoader</code> awaible in any other place of my application when calling <code class=\"language-text\">getClass().getClassLoader()</code></p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.82106934886183%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+klEQVQY032OiW6EIBRF/f8vVOpalhEdwGEbUJAqZtqmaXsSCMu7S6EmPFJ8u49KK++8y4SwpZSc5AKhBxdGKZNZ/er9sdYtDxSGjWKatbH7vqdP8tlrITBiXFhjX89fZDFFDGMl5eF3GZ84d5g7xQXBUsozM+NfxBCzeGjmslqmKYRwGsa8hXg4r3phGGprj68fyde1CP7ptI4xpu9ctSXjfSfuzGid21ydnHu6y65Iv5LFm5Z86GcICUQjpQQTjAmCiCCstP5bnNlWz+ltplP/Vg9N24G6rUBTgq5pHw/5j/hMDtYscOCI4AqQukEVeC8rWALUD0qdyR8UAsyHX1iO4gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"wlp-classloaders\"\n        title=\"\"\n        src=\"/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-bc3ba.png\"\n        srcset=\"/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-367a5.png 175w,\n/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-cfecb.png 350w,\n/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-bc3ba.png 700w,\n/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-1b41b.png 1050w,\n/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-50f8d.png 1400w,\n/static/wlp-classloaders-bbf863545b228772548aee63cf3863d0-82085.png 1889w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>It looks like the one created by <code class=\"language-text\">DefaultResourceLoader</code> is not aware of my classes so that’s the reason why application crashes on startup.</p>\n<h3>Fix</h3>\n<p>We know that everything starts in <code class=\"language-text\">DefaultResourceLoader</code> so we can register our custom <code class=\"language-text\">ServletContextInitializer</code> to override default <code class=\"language-text\">classLoader</code> created by <code class=\"language-text\">DefaultResourceLoader</code>. This can be done by extending <code class=\"language-text\">SpringBootServletInitializer</code> class like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DemoApplication</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SpringBootServletInitializer</span>\n<span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        SpringApplication<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>DemoApplication<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> SpringApplicationBuilder <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span>SpringApplicationBuilder applicationBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> applicationBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">sources</span><span class=\"token punctuation\">(</span>DemoApplication<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">initializers</span><span class=\"token punctuation\">(</span>configurableApplicationContext <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n                    ClassLoader classLoader <span class=\"token operator\">=</span> <span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>DefaultResourceLoader<span class=\"token punctuation\">)</span>configurableApplicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setClassLoader</span><span class=\"token punctuation\">(</span>classLoader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It is possible becouse <code class=\"language-text\">configurableApplicationContext</code> is instance of <code class=\"language-text\">AnnotationConfigServletWebServerApplicationContext</code> class which in turn is subclass of <code class=\"language-text\">DefaultResourceLoader</code>.</p>","frontmatter":{"title":"IBM WebSphere Liberty and Spring AOP","date":"May 12, 2019"}}},"pageContext":{"slug":"/2019-05-12-wlp-spring-aop/","previous":{"fields":{"slug":"/2018-09-09-adding-deb-packages-to-cloud-foundry-instances/"},"excerpt":"This blog post presents two ways of adding additional deb packages to your  Cloud Foundry  (CF) instances. Buildpack Before moving forward…","frontmatter":{"title":"Adding deb packages to Cloud Foundry instances","date":"September 9, 2018"}},"next":{"fields":{"slug":"/2019-06-02-verify-your-json/"},"excerpt":"When you hear API and web client together you think  , at least I do. This is because it is still one of the most popular architectural…","frontmatter":{"title":"Verify your JSON","date":"June 2, 2019"}}}}