{"data":{"site":{"siteMetadata":{"title":"Dev Blog","author":"Arek Jurasz"}},"markdownRemark":{"id":"3692a01c-c16b-577b-afc6-d72ecdddf14e","html":"<p>This blog post presents two ways of adding additional deb packages to your <a href=\"https://www.cloudfoundry.org/\">Cloud Foundry</a> (CF) instances.</p>\n<!-- end -->\n<h2>Buildpack</h2>\n<p>Before moving forward let’s introduce some useful buildpacks that we will be using. What is buildpack you may ask. <code class=\"language-text\">&quot;Buildpacks provide framework and runtime support for apps&quot;</code>, in other words, CF have some predefined “recipes” how to prepare instances to run your application. So if you will push your application with CLI, CF will examine your app and will use appropriate buildpack to prepare your instance. You can also be more explicit and say what buildpack you want to use. Here you can find a list of builtin buildpacks <a href=\"https://docs.cloudfoundry.org/buildpacks/#system-buildpacks\">https://docs.cloudfoundry.org/buildpacks/#system-buildpacks</a>.</p>\n<p>We will be using:</p>\n<ol>\n<li><a href=\"https://github.com/cloudfoundry/apt-buildpack\">apt-buildpack</a> - allow us to list all deb packages we want to install in <code class=\"language-text\">apt.yml</code> file. It’s supporting custom apt repositories as well.  </li>\n<li><a href=\"https://github.com/cloudfoundry/binary-buildpack\">binary-buildpack</a> - this buildpack allow you to run binary web services that do not require any runtime dependencies (any of these sould be statically linked to your binary). Good buildpack just for preparing “clean” instance.  </li>\n<li><a href=\"https://github.com/cloudfoundry/multi-buildpack\">multi-buildpack</a> - as names suggests for running multiple buildpacks.  </li>\n</ol>\n<h2>Using multi-buildpack</h2>\n<ol>\n<li>Create <code class=\"language-text\">multi-buildpack.yml</code> file where you specify all buildpacks you want to run:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">buildpacks</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/apt<span class=\"token punctuation\">-</span>buildpack\n<span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/java<span class=\"token punctuation\">-</span>buildpack</code></pre></div>\n<ol start=\"2\">\n<li>Create <code class=\"language-text\">apt.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> mysql<span class=\"token punctuation\">-</span>client</code></pre></div>\n<ol start=\"3\">\n<li>Create <code class=\"language-text\">manifest.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">applications</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">buildpack</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/multi<span class=\"token punctuation\">-</span>buildpack\n  <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 1G</code></pre></div>\n<ol start=\"4\">\n<li>Push to CF</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf push </code></pre></div>\n<p>Above command will:</p>\n<ul>\n<li>by default look for <code class=\"language-text\">manifest.yml</code> in the current directory (<a href=\"https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#-how-cf-push-finds-the-manifest\">more</a>)</li>\n<li>by default, it will recursively push all files in the current directory (<a href=\"https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#find-app\">more</a>)  </li>\n</ul>\n<p>Directory structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">.</span>\n├── apt.yml\n├── manifest.yml\n├── multi-buildpack.yml\n└── my-app.jar</code></pre></div>\n<h3>Cons</h3>\n<p>When using multi-buildpack you cannot use builtin buildpacks which can be an issue when working on a company’s own installation of CF and its policy require from you to be using built-in (customized) buildpacks.</p>\n<h2>Pushing multiple buildpacks</h2>\n<ol>\n<li>Create <code class=\"language-text\">apt.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> mysql<span class=\"token punctuation\">-</span>client</code></pre></div>\n<ol start=\"3\">\n<li>Create <code class=\"language-text\">manifest.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">applications</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">buildpack</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/binary<span class=\"token punctuation\">-</span>buildpack\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ./my<span class=\"token punctuation\">-</span>app.jar\n  <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 1G</code></pre></div>\n<ol start=\"4\">\n<li>Embed <code class=\"language-text\">apt.yml</code> at the root of your project</li>\n</ol>\n<p>With maven, this can be done with the help of <a href=\"http://maven.apache.org/plugins/maven-antrun-plugin/\">maven-antrun-plugin</a> and by adding following to your <code class=\"language-text\">pom.xml</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>plugin</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>maven-antrun-plugin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>executions</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>execution</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>addCFAptAtRootLevel<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>phase</span><span class=\"token punctuation\">></span></span>package<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>phase</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span><span class=\"token punctuation\">></span></span>\n                    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>zip</span> <span class=\"token attr-name\">destfile</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>${project.build.directory}/${app.finalName}.jar<span class=\"token punctuation\">\"</span></span>\n                         <span class=\"token attr-name\">update</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>yes<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">compress</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n                        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>zipfileset</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>.<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">includes</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>apt.yml<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n                    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>zip</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goals</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goal</span><span class=\"token punctuation\">></span></span>run<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goal</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goals</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>execution</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>executions</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>plugin</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ol start=\"5\">\n<li>Push to CF</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf push --no-start <span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span>\ncf push my-app -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack <span class=\"token punctuation\">(</span>2<span class=\"token punctuation\">)</span></code></pre></div>\n<p>(1) sets up instance and do not start it<br>\n(2) we need to specify the app name we want to update. In this case, we just update the buildpack section of deployed manifest. We can also use public and builtin buildpacks  </p>\n<p>Directory structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token keyword\">.</span>\n├── manifest.yml\n└── my-app.jar</code></pre></div>\n<h3>Cons</h3>\n<p>Above approach (2) is available starting from <code class=\"language-text\">cf</code> CLI version <code class=\"language-text\">v6.38</code> or later. Before you had to use a different command for pushing multiple buildpacks:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf v3-push -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack</code></pre></div>","frontmatter":{"title":"Adding deb packages to Cloud Foundry instances","date":"September 09, 2018"}}},"pageContext":{"slug":"/2018-09-09-adding-deb-packages-to-cloud-foundry-instances/","previous":{"fields":{"slug":"/2017-05-28-kotlin-aws-lambda-serverless-framework/"},"excerpt":"Some time ago I came across the following tweet. There were two things that took my attention - kotlin and Rekognition. First one is a “new…","frontmatter":{"title":"Kotlin + AWS Lambda + Serverless Framework","date":"May 28, 2017"}},"next":{"fields":{"slug":"/2019-05-12-wlp-spring-aop/"},"excerpt":"Investigation walkthrough for an issue related to multiple   available when   application is deployed on   ( ). Motivation Recently I was…","frontmatter":{"title":"IBM WebSphere Liberty and Spring AOP","date":"May 12, 2019"}}}}