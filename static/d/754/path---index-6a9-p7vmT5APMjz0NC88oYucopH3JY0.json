{"pageContext":{"group":[{"node":{"fields":{"slug":"/2019-08-25-micronaut-testcontainers-spock/"},"html":"<p>Before adopting a new framework I always verify does it provide decent testing support. If you follow <code class=\"language-text\">SOLID</code> principles then to test your business logic you just need a test framework like <code class=\"language-text\">JUnit</code> or <code class=\"language-text\">Spock</code>. Things get complicated when we want to test our code on integration level where business logic and infrastructure code are glue together and check if they behave correctly. This post focuses on writing\nintegration tests (IT) for <code class=\"language-text\">Micronaut</code> application.</p>\n<!-- end -->\n<p><a href=\"https://micronaut.io/index.html\">Micronaut</a> is a new kid on the block as its first GA release was less than a year ago on October 23, 2018. It has a lot of interesting features about which you can read in their official <a href=\"https://docs.micronaut.io/latest/guide/index.html\">documentation</a> but for this post, I will mention just one. It has blazing-fast startup time thanks to ahead of time compilation - I will explain later why this is important in case of ITs.</p>\n<p>When writing integration tests your application will probably require some third-party services to work. In most cases, this will be a database. And to be honest, nowadays this requirement can be easily achieved with the help of different CI vendors. Following is the sample configuration of the two most popular CI platforms where we mark what additional services are required for our build process:</p>\n<p><code class=\"language-text\">Travis CI</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"># travis.yml\n\nservices:\n  - mysql </code></pre></div>\n<p><code class=\"language-text\">CircleCI</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">version: 2\njobs:\n  build:\n    docker:\n      - image: circleci/openjdk:8-jdk\n      - image: mysql\n\n    steps:\n      - setup_remote_docker</code></pre></div>\n<p>But what if we want to run IT locally - then we need to start required docker containers before execution. I know that people often tend to use in-memory replacements for differents services but in my mind, IT\nshould be as close as possible to the target environment. But there is a better solution than manually taking care of running all required containers - <a href=\"https://www.testcontainers.org/\">Testcontainers</a> is a library that allows us to easily manage docker infrastructure from our test code. </p>\n<h2>Base structure</h2>\n<p>If it comes to testing <code class=\"language-text\">Micronaut</code> and <code class=\"language-text\">Testcontainers</code> each has handy annotation which brings their functionality to life. </p>\n<h3>Micronaut</h3>\n<p>For <code class=\"language-text\">Micronaut</code> this is a <code class=\"language-text\">@MicronautTest</code> which starts your real application same way as you would run <code class=\"language-text\">java -jar ...</code> command. Usually, you would create some base class with all required configuration\nand then inherit it from your IT cases. Something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token comment\">// IntegrationSpecificationBase.groovy</span>\n\n<span class=\"token annotation punctuation\">@MicronautTest</span><span class=\"token punctuation\">(</span>environments <span class=\"token operator\">=</span> <span class=\"token string gstring\">\"it\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IntegrationSpecificationBase</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Specification</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">TestPropertyProvider</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span> <span class=\"token function\">getProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// TodoControllerSpec.groovy</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">TodoControllerSpec</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">IntegrationSpecification</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">def</span> <span class=\"token string gstring\">\"should get all todos\"</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// test body</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This setup revels one potential problem. Potential because it does not have to be a problem for every case due to the main feature of the framework mentioned at the beginning - fast startup time.\nProblem is with the way how <code class=\"language-text\">MicronautTest</code> annotation is bound to test execution lifecycle - <code class=\"language-text\">Micronaut</code> application is built and started in <code class=\"language-text\">setupSpec</code>. Tear down happen in <code class=\"language-text\">cleanupSpec</code>. So\nin the above example, <code class=\"language-text\">Micronaut</code> application will be started/stopped twice. This can be fixed simply by not using <code class=\"language-text\">@MicronautTest</code> annotation, i.e.:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IntegrationSpecificationBase</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Specification</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">TestPropertyProvider</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@AutoCleanup</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> EmbeddedServer embeddedServer <span class=\"token operator\">=</span> ApplicationContext<span class=\"token operator\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>\n            EmbeddedServer<span class=\"token punctuation\">,</span>\n            <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Object<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n            <span class=\"token string gstring\">\"it\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Which approach you will choose should mostly be dictated by how long it takes for your application to start. Although <code class=\"language-text\">Micronaut</code> is fast, other libraries that you use doesn’t need to be as fast (e.g. <code class=\"language-text\">micronaut-hibernate-jpa</code>).</p>\n<h3>Testcontainers</h3>\n<p><code class=\"language-text\">@Testcontainers</code> annotation similarly to <code class=\"language-text\">@MicronautTest</code> is bound to the same lifecycle phases. Unfortunately, right now there is no way of defining processing order - <a href=\"https://github.com/spockframework/spock/issues/646\">change request</a> was already proposed on github. Because of this, I don’t see the possibility to use these two annotations together. Our desired behaviour would\nbe to start all required docker containers before starting <code class=\"language-text\">Micronaut</code> application. This could be achieved in two ways.</p>\n<ol>\n<li>Spock global extension</li>\n</ol>\n<p>A global extension can be used to execute some code at the very start and the very end of <code class=\"language-text\">Spock</code> execution. There are three steps needed to create such an extension:</p>\n<ol>\n<li>Create <code class=\"language-text\">META-INF/services/org.spockframework.runtime.extension.IGlobalExtension</code> file</li>\n<li>Create a class that implements <code class=\"language-text\">IGlobalExtension</code> interface</li>\n<li>Add fully-qualified class name created in step <code class=\"language-text\">2</code> to file created in step <code class=\"language-text\">1</code></li>\n</ol>\n<p>Following example shows how to start all defined containers by using global extension:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">DockerInfrastructureRunner</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AbstractGlobalExtension</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> Collection<span class=\"token operator\">&lt;</span>GenericContainer<span class=\"token operator\">></span> containers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n            MySqlContainer<span class=\"token operator\">.</span>MY_SQL_CONTAINER\n    <span class=\"token punctuation\">]</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        containers<span class=\"token operator\">.</span>each <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>it<span class=\"token operator\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                it<span class=\"token operator\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        containers<span class=\"token operator\">.</span>each <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>it<span class=\"token operator\">.</span><span class=\"token function\">isRunning</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                it<span class=\"token operator\">.</span><span class=\"token function\">stop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li>Groovy <code class=\"language-text\">with</code> method </li>\n</ol>\n<p>We can also take advantage of some groovy goodness and declare and start docker container in one go like:</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MySqlContainer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> GenericContainer MY_SQL_CONTAINER <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">GenericContainer</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"mysql:8\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">.</span><span class=\"token function\">withEnv</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"MYSQL_ROOT_PASSWORD\"</span><span class=\"token punctuation\">,</span> <span class=\"token string gstring\">\"password\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">.</span><span class=\"token function\">withEnv</span><span class=\"token punctuation\">(</span><span class=\"token string gstring\">\"MYSQL_DATABASE\"</span><span class=\"token punctuation\">,</span> <span class=\"token string gstring\">\"it\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">.</span><span class=\"token function\">withExposedPorts</span><span class=\"token punctuation\">(</span><span class=\"token number\">3306</span><span class=\"token punctuation\">)</span>\n            <span class=\"token operator\">.</span>with <span class=\"token punctuation\">{</span>\n                it<span class=\"token operator\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                it\n            <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>When you want to use desired tools you will have to agree on a few workarounds to make everything works as you want. The biggest surprise for me was not being able to run <code class=\"language-text\">Micronaut</code> or <code class=\"language-text\">Testcontainers</code> just once out of the box together with <code class=\"language-text\">Spock</code>. It is also worth noticing that <code class=\"language-text\">Micronaut</code> and <code class=\"language-text\">Testcontainers</code> project contains modules for <code class=\"language-text\">JUnit</code> where start and stop functions are done in <code class=\"language-text\">BeforeAllCallback</code> and <code class=\"language-text\">AfterAllCallback</code> which base on Javadoc should be\nexecuted just once for a single extension (i.e. before and after all our tests).</p>\n<p>The complete example can be found at <a href=\"https://github.com/ajurasz/micronaut-it\">github</a>. There are two branches:</p>\n<ol>\n<li><code class=\"language-text\">develop</code> where <code class=\"language-text\">@MicronautTest</code> annotation is used together with <code class=\"language-text\">Spock</code> global extension</li>\n<li><code class=\"language-text\">shared-context</code> where <code class=\"language-text\">Micronaut</code> is started manually and docker containers by the usage of groovy <code class=\"language-text\">with</code> method</li>\n</ol>","frontmatter":{"title":"Micronaut, Testcontainers and Spock","date":"August 25, 2019"}}},{"node":{"fields":{"slug":"/2019-08-02-not-null-is-not-null/"},"html":"<p>Recently I learned that MySQL 5.6 is so “nice” that it can provide default values for columns that have <code class=\"language-text\">NOT NULL</code> constrain when values for these columns are missing during insertion.</p>\n<!-- end -->\n<p>This feature is called <a href=\"https://dev.mysql.com/doc/refman/5.6/en/data-type-defaults.html#data-types-defaults-implicit\">Implicit Defaults</a>. Below is a complete example which shows this feature:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">&gt; docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=root -d mysql:5.6\n&gt; docker exec -it some-mysql bash\n\n# mysql -u root -p\nEnter password:\n\nmysql&gt; CREATE DATABASE test;\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; use test;\nDatabase changed\nmysql&gt; CREATE TABLE MY_DATA (id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,\n    -&gt; name VARCHAR(10) NOT NULL,\n    -&gt; value INT NOT NULL);\nQuery OK, 0 rows affected (0.05 sec)\n\nmysql&gt; INSERT INTO MY_DATA (name, value) VALUES (&#39;a&#39;, 1);\nQuery OK, 1 row affected (0.04 sec)\n\nmysql&gt; INSERT INTO MY_DATA (name) VALUES (&#39;c&#39;);\nQuery OK, 1 row affected, 1 warning (0.01 sec)\n\nmysql&gt; SELECT * FROM MY_DATA;\n+----+------+-------+\n| id | name | value |\n+----+------+-------+\n|  1 | a    |     1 |\n|  2 | c    |     0 |\n+----+------+-------+\n2 rows in set (0.04 sec)</code></pre></div>\n<p>Base on the linked documentation for implicit defaults our database server has got <strong>strict mode disabled by default</strong>. What is strict mode? </p>\n<blockquote>\n<p>Strict mode controls how MySQL handles invalid or missing values in data-change statements such as INSERT or UPDATE.\nSource: <a href=\"https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-strict#sql-mode-strict\">https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-strict#sql-mode-strict</a></p>\n</blockquote>\n<p>If we will repeat above code snipped with a more recent version of MySQL like 8 were <strong>strict mode is enabled by default</strong> then last insert command won’t work.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">&gt; docker run --name some-mysql -e MYSQL_ROOT_PASSWORD=root -d mysql:8\n\n...\n\nmysql&gt; INSERT INTO MY_DATA (name) VALUES (&#39;c&#39;);\nERROR 1364 (HY000): Field &#39;value&#39; doesn&#39;t have a default value</code></pre></div>\n<h2>Conclusion</h2>\n<p>When you work with MySQL and use a different version of the software make yourself a favour and check what SQL mode(s) are set on the environment with which you start to work. This can be done with single SQL command:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> @<span class=\"token variable\">@GLOBAL.sql_mode</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>and then invest few minutest to learn how enabled modes affect the SQL syntax MySQL supports and how data validation checks are performed. You can find a full list of SQL modes <a href=\"https://dev.mysql.com/doc/refman/5.6/en/sql-mode.html#sql-mode-full\">here</a>. </p>\n<p>So that you won’t have to spend a few hours figuring out why some of your e2e tests doesn’t work only on one environment!</p>","frontmatter":{"title":"NOT NULL is NOT NULL","date":"August 2, 2019"}}},{"node":{"fields":{"slug":"/2019-07-05-spring-boot-maven-plugin-and-provided-scope/"},"html":"<p>If you come from the JavaEE world you probably did set some of your project dependencies to the scope of <code class=\"language-text\">provided</code> if so then you can find one fact about <code class=\"language-text\">spring-boot-maven-plugin</code> to be interesting.</p>\n<!-- end -->\n<p>After adding <code class=\"language-text\">provided</code> scope to a dependency you expect that JDK or container (like JavaEE application server) will provide this dependency at runtime. Expected behaviour when running application without providing these dependencies will be to see <code class=\"language-text\">NoClassDefFoundError</code> or <code class=\"language-text\">ClassNotFoundException</code> all depends on how these missing classes are accessed (for more information see <a href=\"https://dzone.com/articles/java-classnotfoundexception-vs-noclassdeffounderro\">this article</a>). But this is not a case when using <code class=\"language-text\">spring-boot-maven-plugin</code> to run your application in standalone mode i.e. outside of any kind of container. After reading the explanation from Phil Webb (Pivotal) this behaviour makes sense:</p>\n<blockquote>\n<p>The packaging of provided scoped jars is intentional. The reason for this is that many developers are used to adding things like servlet-api as provided. Since there won’t be a servlet container to actually “provide” the dependency we package it inside the JAR.</p>\n</blockquote>\n<p>Source: <a href=\"https://github.com/spring-projects/spring-boot/issues/413#issuecomment-36361340\">https://github.com/spring-projects/spring-boot/issues/413#issuecomment-36361340</a></p>\n<p>In <code class=\"language-text\">spring-boot-maven-plugin</code> sources we can find how dependencies are loaded for <code class=\"language-text\">run</code> goal.</p>\n<p><code class=\"language-text\">AbstractRunMojo.java</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">addDependencies</span><span class=\"token punctuation\">(</span>List<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>URL<span class=\"token punctuation\">></span></span> urls<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> MalformedURLException<span class=\"token punctuation\">,</span> MojoExecutionException <span class=\"token punctuation\">{</span>\n    FilterArtifacts filters <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>useTestClasspath <span class=\"token operator\">?</span> <span class=\"token function\">getFilters</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">getFilters</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TestArtifactFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Set<span class=\"token generics function\"><span class=\"token punctuation\">&lt;</span>Artifact<span class=\"token punctuation\">></span></span> artifacts <span class=\"token operator\">=</span> <span class=\"token function\">filterDependencies</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>project<span class=\"token punctuation\">.</span><span class=\"token function\">getArtifacts</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> filters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>Artifact artifact <span class=\"token operator\">:</span> artifacts<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>artifact<span class=\"token punctuation\">.</span><span class=\"token function\">getFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> null<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            urls<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>artifact<span class=\"token punctuation\">.</span><span class=\"token function\">getFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toURI</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toURL</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">this.project.getArtifacts()</code> loads all project dependencies including transitive ones (<code class=\"language-text\">provided</code> scoped are loaded as well!). After, the load is done we removed dependencies based on configured filters - by default only test classes are removed. Yet it is still possible to make some exclusion in the plugin configuration.</p>\n<h2>Conclusion</h2>\n<p>When your project deliverable is a war file that will be run in a container then it is very pleasant to be able to run it in standalone mode without additional tweaks when there are some <code class=\"language-text\">provided</code> scoped dependencies.</p>","frontmatter":{"title":"Spring Boot Maven Plugin and provided scope","date":"July 5, 2019"}}},{"node":{"fields":{"slug":"/2019-06-08-build-native-imge-with-graalvm/"},"html":"<p>Last month first production-ready version of <code class=\"language-text\">GraalVM</code> with number <code class=\"language-text\">19.0</code> was released. <code class=\"language-text\">GraalVM</code> is a virtual machine capable to run application written in <code class=\"language-text\">JavaScript</code>, <code class=\"language-text\">Python</code>, <code class=\"language-text\">Ruby</code>, <code class=\"language-text\">R</code>, LLVM-based languages like <code class=\"language-text\">C</code>, <code class=\"language-text\">C++</code> and of course our beloved JVM-based languages like <code class=\"language-text\">Java</code>, <code class=\"language-text\">Scala</code>, <code class=\"language-text\">Kotlin</code>, <code class=\"language-text\">Groovy</code> and <code class=\"language-text\">Clojure</code>. <!-- end --> Some of the main goals for this new virtual machine are:</p>\n<ul>\n<li>improve the performance of applications build with JVM-based languages</li>\n<li>reduce startup time by usage of AOT (ahead-of-time) compilation</li>\n<li>write polyglot applications</li>\n<li>compile JVM-based code to a standalone executable a.k.a. native image.</li>\n</ul>\n<p>With this post, I would like to focus on the last goal and build a native image. The assumption is very simple, take <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> library, write some <code class=\"language-text\">Java</code> code to interact with this library and then from terminal quickly test any <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expression you can think of, like</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -s https://api.github.com/users/ajurasz <span class=\"token operator\">|</span> json_path <span class=\"token string\">\"$.created_at\"</span></code></pre></div>\n<h2>Native image?</h2>\n<p>As already mentioned one of the main goals of <code class=\"language-text\">GraalVM</code> is the possibility to produce native images which are executables that do not require JRE (java runtime environment) to be present on the system. At first, when I heard about this feature I thought that the code instead to be compiled to bytecode will be directly compiled to machine code but I was wrong. During the process of creating a native image, all classes of our application and their dependencies are statically analyses to know which part of that code is reachable during runtime. These static analyses take JDK code under consideration as well. When we know all classes and methods used in the runtime then <code class=\"language-text\">GraalVM</code> compiles it ahead-of-time. To make this AOT compiled code to run we still need some runtime on which our program can be run. The produced native image includes something called <code class=\"language-text\">Substrate VM</code> which is an embeddable virtual machine containing components like memory management, thread scheduling, de-optimizer or even garbage collector. Having an initial idea about what native image is let’s install <code class=\"language-text\">GraalVM</code>, <code class=\"language-text\">native-image</code> utility and write some code.</p>\n<h2>Installation</h2>\n<p>First, let’s install <code class=\"language-text\">GraalVM</code> through <code class=\"language-text\">sdkman</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> apt update\n<span class=\"token function\">sudo</span> apt <span class=\"token function\">install</span> unzip <span class=\"token function\">zip</span>\n<span class=\"token function\">curl</span> -s <span class=\"token string\">\"https://get.sdkman.io\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">bash</span>\n<span class=\"token function\">source</span> <span class=\"token string\">\"/home/ubuntu/.sdkman/bin/sdkman-init.sh\"</span>\nsdk <span class=\"token function\">install</span> java 19.0.0-grl</code></pre></div>\n<p>To use <code class=\"language-text\">native-image</code> command beside native image utility there are some <a href=\"https://www.graalvm.org/docs/reference-manual/aot-compilation/#prerequisites\">prerequisites</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">gu <span class=\"token function\">install</span> native-image\n<span class=\"token function\">sudo</span> apt <span class=\"token function\">install</span> build-essential\n<span class=\"token function\">sudo</span> apt <span class=\"token function\">install</span> libz-dev</code></pre></div>\n<h2>Code</h2>\n<p>As shown above, we want to pipe output from <code class=\"language-text\">curl</code> command to our application as input. To get access to this input from application level we need to read it from <code class=\"language-text\">System.in</code>. <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expression will be simply passed as an argument. In the end, we just need to evaluate the expression against received json. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>BufferedReader<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>io<span class=\"token punctuation\">.</span>InputStreamReader<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">.</span>Collectors<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> com<span class=\"token punctuation\">.</span>jayway<span class=\"token punctuation\">.</span>jsonpath<span class=\"token punctuation\">.</span>JsonPath<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        String expression <span class=\"token operator\">=</span> <span class=\"token function\">extractExpression</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        String json <span class=\"token operator\">=</span> <span class=\"token function\">readInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        System<span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token function\">evaluate</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">,</span> expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> String <span class=\"token function\">extractExpression</span><span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Single JsonPath expression is required.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> String <span class=\"token function\">readInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BufferedReader</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">InputStreamReader</span><span class=\"token punctuation\">(</span>System<span class=\"token punctuation\">.</span>in<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">lines</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span>Collectors<span class=\"token punctuation\">.</span><span class=\"token function\">joining</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> String <span class=\"token function\">evaluate</span><span class=\"token punctuation\">(</span>String json<span class=\"token punctuation\">,</span> String expression<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        JsonPath jsonPath <span class=\"token operator\">=</span> JsonPath<span class=\"token punctuation\">.</span><span class=\"token function\">compile</span><span class=\"token punctuation\">(</span>expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> jsonPath<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Compilation</h2>\n<p>First, we need to compile our java code with <code class=\"language-text\">javac</code> command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">javac -cp <span class=\"token string\">\"libs/*\"</span> Application.java</code></pre></div>\n<p><code class=\"language-text\">libs</code> directory contains all 3rd party dependencies required for this application to run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">tree\n<span class=\"token keyword\">.</span>\n├── Application.java\n└── libs\n    ├── accessors-smart-1.2.jar\n    ├── asm-5.0.4.jar\n    ├── json-path-2.4.0.jar\n    ├── json-smart-2.3.jar\n    ├── slf4j-api-1.7.25.jar\n    └── slf4j-jdk14-1.7.25.jar\n\n1 directory, 8 files</code></pre></div>\n<p>After successful ran of compile command <code class=\"language-text\">Application.class</code> should be produced.</p>\n<h2>Build native image</h2>\n<p>Command to build native image is very similar to compiling java file, it requires only java class and <code class=\"language-text\">-cp</code> parameter in case if we use external dependencies which we do.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">native-image -cp <span class=\"token string\">\".:libs/*\"</span> -H:Name<span class=\"token operator\">=</span>json_path  Application </code></pre></div>\n<p><code class=\"language-text\">-H:Name</code> is used just to give a name to produced executable. But running above command will fail with the following message</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Warning: Aborting stand-alone image build. com.oracle.svm.hosted.substitute.DeletedElementException: Unsupported method java.lang.ClassLoader.defineClass<span class=\"token punctuation\">(</span>String, byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, int, int<span class=\"token punctuation\">)</span> is reachable: The declaring class of this element has been substituted, but this element is not present <span class=\"token keyword\">in</span> the substitution class\nTo diagnose the issue, you can add the option --report-unsupported-elements-at-runtime. The unsupported element is <span class=\"token keyword\">then</span> reported at run <span class=\"token function\">time</span> when it is accessed the first time.\nDetailed message:\nTrace:\n        at parsing net.minidev.asm.DynamicClassLoader.defineClass<span class=\"token punctuation\">(</span>DynamicClassLoader.java:86<span class=\"token punctuation\">)</span>\nCall path from entry point to net.minidev.asm.DynamicClassLoader.defineClass<span class=\"token punctuation\">(</span>String, byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>:\n        at net.minidev.asm.DynamicClassLoader.defineClass<span class=\"token punctuation\">(</span>DynamicClassLoader.java:81<span class=\"token punctuation\">)</span>\n        at net.minidev.asm.BeansAccessBuilder.bulid<span class=\"token punctuation\">(</span>BeansAccessBuilder.java:313<span class=\"token punctuation\">)</span>\n        at net.minidev.asm.BeansAccess.get<span class=\"token punctuation\">(</span>BeansAccess.java:111<span class=\"token punctuation\">)</span>\n        at net.minidev.json.reader.BeansWriterASM.writeJSONString<span class=\"token punctuation\">(</span>BeansWriterASM.java:17<span class=\"token punctuation\">)</span>\n        at net.minidev.json.JSONValue.writeJSONString<span class=\"token punctuation\">(</span>JSONValue.java:586<span class=\"token punctuation\">)</span>\n        at net.minidev.json.reader.JsonWriter<span class=\"token variable\">$5</span>.writeJSONString<span class=\"token punctuation\">(</span>JsonWriter.java:113<span class=\"token punctuation\">)</span>\n        at net.minidev.json.reader.JsonWriter<span class=\"token variable\">$5</span>.writeJSONString<span class=\"token punctuation\">(</span>JsonWriter.java:1<span class=\"token punctuation\">)</span>\n        at net.minidev.json.JSONArray.writeJSONString<span class=\"token punctuation\">(</span>JSONArray.java:75<span class=\"token punctuation\">)</span>\n        at net.minidev.json.JSONArray.toJSONString<span class=\"token punctuation\">(</span>JSONArray.java:52<span class=\"token punctuation\">)</span>\n        at net.minidev.json.JSONArray.toJSONString<span class=\"token punctuation\">(</span>JSONArray.java:102<span class=\"token punctuation\">)</span>\n        at net.minidev.json.JSONArray.toString<span class=\"token punctuation\">(</span>JSONArray.java:113<span class=\"token punctuation\">)</span>\n        at java.lang.String.valueOf<span class=\"token punctuation\">(</span>String.java:2994<span class=\"token punctuation\">)</span>\n        at java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:131<span class=\"token punctuation\">)</span>\n        at com.oracle.svm.core.amd64.AMD64CPUFeatureAccess.verifyHostSupportsArchitecture<span class=\"token punctuation\">(</span>AMD64CPUFeatureAccess.java:179<span class=\"token punctuation\">)</span>\n        at com.oracle.svm.core.JavaMainWrapper.run<span class=\"token punctuation\">(</span>JavaMainWrapper.java:131<span class=\"token punctuation\">)</span>\n        at com.oracle.svm.core.code.IsolateEnterStub.JavaMainWrapper_run_5087f5482cc9a6abc971913ece43acb471d2631b<span class=\"token punctuation\">(</span>generated:0<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Native images don’t support dynamic class loading and this is understandable due to the nature of AOT compilation where all classes and bytecodes that are ever reachable needs to be known at compile time. To see the full list of native image limitation see <a href=\"https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md\">https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md</a>. But we still can take advantage of the suggested solution and postpone any errors resulting from dynamic class loading to runtime by using <code class=\"language-text\">--report-unsupported-elements-at-runtime</code> option. Let’s make the second attempt to build a native image</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"> native-image -cp <span class=\"token string\">\".:libs/*\"</span> -H:Name<span class=\"token operator\">=</span>json_path --report-unsupported-elements-at-runtime  Application</code></pre></div>\n<p> This time it worked and <code class=\"language-text\">json_path</code> executable was created. To make our life easier let’s register this executable to be accessible globally in our system</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s /home/ubuntu/app/json_path /usr/local/bin/json_path</code></pre></div>\n<p>and let’s give it a try</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -s https://api.github.com/users/ajurasz <span class=\"token operator\">|</span> json_path <span class=\"token string\">\"$.created_at\"</span>\n2013-03-23T12:56:53Z</code></pre></div>\n<p>Works like a charm but what about some more complex expressions</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -s https://www.anapioficeandfire.com/api/books/1 <span class=\"token operator\">|</span> json_path <span class=\"token string\">\"$.characters.length()\"</span>\n\nException <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> com.jayway.jsonpath.InvalidPathException: Function of name: length cannot be created\n        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction<span class=\"token punctuation\">(</span>PathFunctionFactory.java:75<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.FunctionPathToken.evaluate<span class=\"token punctuation\">(</span>FunctionPathToken.java:38<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.PathToken.handleObjectProperty<span class=\"token punctuation\">(</span>PathToken.java:81<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.PropertyPathToken.evaluate<span class=\"token punctuation\">(</span>PropertyPathToken.java:79<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.RootPathToken.evaluate<span class=\"token punctuation\">(</span>RootPathToken.java:62<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate<span class=\"token punctuation\">(</span>CompiledPath.java:53<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.path.CompiledPath.evaluate<span class=\"token punctuation\">(</span>CompiledPath.java:61<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.JsonPath.read<span class=\"token punctuation\">(</span>JsonPath.java:181<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.JsonPath.read<span class=\"token punctuation\">(</span>JsonPath.java:345<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.JsonPath.read<span class=\"token punctuation\">(</span>JsonPath.java:329<span class=\"token punctuation\">)</span>\n        at Application.evaluate<span class=\"token punctuation\">(</span>Application.java:30<span class=\"token punctuation\">)</span>\n        at Application.main<span class=\"token punctuation\">(</span>Application.java:12<span class=\"token punctuation\">)</span>\nCaused by: java.lang.InstantiationException: Type <span class=\"token variable\"><span class=\"token variable\">`</span>com.jayway.jsonpath.internal.function.text.Length<span class=\"token variable\">`</span></span> can not be instantiated reflectively as it does not have a no-parameter constructor or the no-parameter constructor has not been added explicitly to the native image.\n        at java.lang.Class.newInstance<span class=\"token punctuation\">(</span>DynamicHub.java:740<span class=\"token punctuation\">)</span>\n        at com.jayway.jsonpath.internal.function.PathFunctionFactory.newFunction<span class=\"token punctuation\">(</span>PathFunctionFactory.java:73<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">..</span>. 11 <span class=\"token function\">more</span></code></pre></div>\n<p>So a new instance of <code class=\"language-text\">Length</code> type cannot be created. Quick sneak peek on failing part (<code class=\"language-text\">PathFunctionFactory.java:75</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> PathFunction <span class=\"token function\">newFunction</span><span class=\"token punctuation\">(</span>String name<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> InvalidPathException <span class=\"token punctuation\">{</span>\n    Class <span class=\"token class-name\">functionClazz</span> <span class=\"token operator\">=</span> FUNCTIONS<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>functionClazz <span class=\"token operator\">==</span> null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidPathException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Function with name: \"</span> <span class=\"token operator\">+</span> name <span class=\"token operator\">+</span> <span class=\"token string\">\" does not exist.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>PathFunction<span class=\"token punctuation\">)</span>functionClazz<span class=\"token punctuation\">.</span><span class=\"token function\">newInstance</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InvalidPathException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Function of name: \"</span> <span class=\"token operator\">+</span> name <span class=\"token operator\">+</span> <span class=\"token string\">\" cannot be created\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s true, it looks like there is a set of predefined function which then are dynamically created. Fortunately, this can be fixed by introducing reflection configuration file. This file is used to inform <code class=\"language-text\">Substrate VM</code> about reflectively accessed program elements. To know more see <a href=\"https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md\">https://github.com/oracle/graal/blob/master/substratevm/REFLECTION.md</a>. To solve above issue we need to put one entry in <code class=\"language-text\">graal.json</code></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"com.jayway.jsonpath.internal.function.text.Length\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"methods\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;init>\"</span><span class=\"token punctuation\">,</span> <span class=\"token property\">\"parameterTypes\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>After the rebuild of <code class=\"language-text\">json_path</code> executable, previous commands started to work</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -s https://www.anapioficeandfire.com/api/books/1 <span class=\"token operator\">|</span> json_path <span class=\"token string\">\"$.characters.length()\"</span>\n434\n        \n<span class=\"token function\">curl</span> -s https://www.anapioficeandfire.com/api/books <span class=\"token operator\">|</span> json_path <span class=\"token string\">\"$.[?(@.name == 'A Game of Thrones')].characters.length()\"</span>\n<span class=\"token punctuation\">[</span>434<span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>I see the big potential in these native images one of them is light and fast docker images <a href=\"https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b\">https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b</a> as pointed out by Adam Warski. What he also mention is that in Scala reflection is almost unused. For me compiling a very simple program to the native image was a few hours of research and at this point, I don’t see how I could do the same with small <code class=\"language-text\">Spring</code> application which in contrast to Scala ecosystem use reflection heavily.</p>","frontmatter":{"title":"Build a native image with GraalVM","date":"June 8, 2019"}}},{"node":{"fields":{"slug":"/2019-06-02-verify-your-json/"},"html":"<p>When you hear API and web client together you think <code class=\"language-text\">REST</code>, at least I do. This is because it is still one of the most popular architectural paradigms for building APIs. Another approach about which I hear from time to time is <code class=\"language-text\">GraphQL</code>. There is one common part for these two - they talk JSON. Both specifications <code class=\"language-text\">REST</code> and <code class=\"language-text\">GraphQL</code> does not restrict only to this format but due to its simplicity, it is a very common choice. Every healthy software contains tests on different layers, from unit up to the end-to-end tests. So, how could we verify responses from our APIs?</p>\n<!-- end -->\n<p>In <code class=\"language-text\">java</code> world, especiality in <code class=\"language-text\">Spring</code> ecosystem when it comes to testing APIs you probably saw one of these:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mockMvc<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello?name=John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.name\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">jsonPath</code> static method in the above snippet is a wrapper around great library <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a>. Together with <a href=\"https://github.com/hamcrest/JavaHamcrest\">Hamcrest</a> it just makes writing test against JSON a true pleasure. </p>\n<p>Note: <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> does not require <code class=\"language-text\">Spring</code> it just need some JSON.</p>\n<p>I have created simple <a href=\"https://github.com/ajurasz/jsonpath-playground\">playground</a> for testing different <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions. <code class=\"language-text\">jsonPath</code> static method is provided which expects expression, matcher and a JSON string against which expression will be executed.</p>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5cdaff5fce90bc3ddd98475b\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"guid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isActive\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"a\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"b\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"c\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"d\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"e\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">\"f\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"end\"</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"f\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"other end\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Working with JSON objects</h2>\n<p>Every <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expression starts with <code class=\"language-text\">$</code> symbol which represents <strong>root</strong> element (no matter if the JSON structure is an object or array). When you want to access the specific property you have two choices - dot or bracket notation. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//dot notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.guid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.isActive\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">isA</span><span class=\"token punctuation\">(</span>Boolean<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">instanceOf</span><span class=\"token punctuation\">(</span>Number<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.nonExisting\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">nullValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.name.first\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Opal\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//bracket notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['guid']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['isActive']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">isA</span><span class=\"token punctuation\">(</span>Boolean<span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['name']['first']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Opal\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Although the second approach is noisier it is useful in situation when property name contains special characters or starts with a character other than represented by this regular expression <code class=\"language-text\">/[a-zA-Z_]/</code>.</p>\n<p>We can also do a deep scan to access property in very nested object. To acccess <code class=\"language-text\">f</code> property in our sample we could:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$..f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"other-end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// or using standard dot notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.a.b.c.d.e.f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notice that deep scann returns array of values because depending on JSON structure it can find more properties with the name <code class=\"language-text\">f</code>. We can narrow down what path will be part of a deep scan by pointing to spefici property from which deep scan starts:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.a..f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Working with JSON arrays</h2>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"friends\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hester Dallai\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">31</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Lucinda Goff\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">27</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ella Day\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">17</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"adult\"</span><span class=\"token operator\">:</span> <span class=\"token number\">18</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To access the single property from an object inside array you use square brackets just like in <code class=\"language-text\">java</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[0].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions support wildcards (<code class=\"language-text\">*</code>) which selects all elements in both object and arrays. </p>\n<p>To verify the age of our friends we can:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[*].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When you have ever worked with <code class=\"language-text\">python</code> you probably came across slice notation, which in some part is supported in <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>stop<span class=\"token punctuation\">]</span>     <span class=\"token comment\"># from start to stop - 1</span>\n<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>         <span class=\"token comment\"># from start to the end of array</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>n<span class=\"token punctuation\">]</span>             <span class=\"token comment\"># selects first n - 1 elements</span>\n<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>n<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>            <span class=\"token comment\"># selects last n elements</span></code></pre></div>\n<p>Knowing this slice expressions would like like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[:3].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[1:2].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[:2].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[-2:].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Filter expression</h2>\n<p>Next powerful feature of <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> are filter expression <code class=\"language-text\">[?(&lt;expression&gt;)]</code> which make selection of elements more dynamic. Complete list of supported operators can be found at <a href=\"https://github.com/json-path/JsonPath#filter-operators\">https://github.com/json-path/JsonPath#filter-operators</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= 18)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.id == 1)].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.id != 1)].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age in [31, 17])].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.name =~ /^.*Da.*$/i)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">@</code> represent the current node. In the above example this will represent friend node and for each of our friends (<code class=\"language-text\">$.friends[]</code>), given property will be returned when the expression evaluates to true.</p>\n<p>We can be even more dynamic by referencing to other properties:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= 18)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= $.adult)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Functions</h2>\n<p><a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> provides functions that can be added at the end of our expression. The rule is simple  - output of expression is input to the function. Complete list of build in functions can be found at <a href=\"https://github.com/json-path/JsonPath#functions\">https://github.com/json-path/JsonPath#functions</a>.</p>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"range\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>then we can run functions that expects arrays as input</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.avg()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">4.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.min()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.max()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">9.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.stddev()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">2.8722813232690143</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.length()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>As you saw <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions are very powerful, they should be able to extract whatever you want from a JSON structure. All used examples and more can be found on <a href=\"https://github.com/ajurasz/jsonpath-playground\">github</a>.</p>","frontmatter":{"title":"Verify your JSON","date":"June 2, 2019"}}}],"pathPrefix":"","first":true,"last":false,"index":1,"pageCount":3,"additionalContext":{}}}