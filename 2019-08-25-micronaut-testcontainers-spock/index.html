<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/1.714e789c58edc4d97d4f.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.0.31"/><style data-styled="deuHhw dVlzdf FSiJo kfPuqG hyXYOK itGeow eXcfSN iWIxoV kGCCTl fGSVd gGIelI kVSOZg KDfzM gzoEET deWstv dgtalV ZNTDw cRzLhO jLNeCQ eBuswQ ukmsj" data-styled-version="4.3.1">
/* sc-component-id: sc-global-3325714496 */
@import url("https://fonts.googleapis.com/css?family=Roboto:400,700"); html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} *,*:before,*:after{box-sizing:inherit;} html{font-size:62.5%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box;} body{background:#f9fafc;font-family:'Open Sans',sans-serif;line-height:1.5;padding:50px 0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;} img{max-width:100%;} .gatsby-highlight{border-bottom:1px solid #e0e6ed;border-top:1px solid #e0e6ed;margin:15px -100px;padding:0;} .gatsby-highlight pre[class*="language-"]{margin:0;padding:25px 100px;} pre[class*="language-"]{background:rgba(245,245,245,1);color:rgb(65,76,94);} @media only screen and (max-width:870px){.gatsby-highlight{margin:15px -15px;}.gatsby-highlight pre[class*="language-"]{padding:25px;}}
/* sc-component-id: sc-bdVaJa */
.deuHhw{margin:0 auto;max-width:1080px;}
/* sc-component-id: sc-htpNat */
.itGeow{margin-top:15px;text-align:center;}
/* sc-component-id: sc-bxivhb */
.eXcfSN{border:1px solid #bfc8d2;border-radius:15px;color:#3e465b;display:inline-block;margin:5px;padding:5px 10px;-webkit-text-decoration:none;text-decoration:none;} .eXcfSN svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eXcfSN:hover{border-color:#3e465b;}
/* sc-component-id: sc-ifAKCX */
.FSiJo{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;}
/* sc-component-id: sc-EHOje */
.kVSOZg{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;}
/* sc-component-id: sc-bZQynM */
.hyXYOK{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;margin:0;}
/* sc-component-id: sc-gzVnrw */
.kfPuqG{color:#3498db;-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: sc-htoDjs */
.dVlzdf{margin:0 auto;max-width:650px;padding:0 50px 50px;text-align:center;}
/* sc-component-id: sc-dnqmqq */
.iWIxoV{background:#fff;border:1px solid #e0e6ed;box-shadow:0 1px 5px rgba(0,0,0,0.05);margin-bottom:30px;padding:75px 100px;} @media only screen and (max-width:870px){.iWIxoV{border-left:none;border-right:none;padding:75px 15px;}}
/* sc-component-id: sc-iwsKbI */
.gzoEET{margin-top:50px;text-align:center;}
/* sc-component-id: sc-gZMcBi */
.deWstv{border:1px solid #bfc8d2;border-radius:25px;color:#3e465b;display:inline-block;font-size:10px;font-weight:700;margin:0 10px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;text-transform:uppercase;} .deWstv:hover{border-color:#000;}
/* sc-component-id: sc-VigVT */
.kGCCTl{text-align:center;}
/* sc-component-id: sc-jTzLTM */
.fGSVd{color:#3e465b;-webkit-text-decoration:none;text-decoration:none;} .fGSVd:hover{color:#3498db;}
/* sc-component-id: sc-fjdhpX */
.gGIelI{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;}
/* sc-component-id: sc-jzJRlG */
.KDfzM{color:#666d71;display:inline-block;font-size:14px;margin-top:50px;-webkit-text-decoration:none;text-decoration:none;} .KDfzM:hover{color:#3498db;}
/* sc-component-id: sc-cSHVUG */
.ZNTDw{color:#65738c;font-size:16px;} .ZNTDw a{color:#3498db;font-weight:700;-webkit-text-decoration:none;text-decoration:none;} .ZNTDw a:hover{-webkit-text-decoration:underline;text-decoration:underline;} .ZNTDw h1{color:#3e465b;font-size:30px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h2{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h3{color:#3e465b;font-size:17px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h4{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h5,.ZNTDw h6{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw p{line-height:1.7;margin:15px 50px;} .ZNTDw blockquote{border-left:5px solid #e0e6ed;line-height:1.7;margin:15px 50px 15px 75px;padding:10px 10px 10px 15px;} .ZNTDw blockquote p{margin:0;} .ZNTDw ul,.ZNTDw ol{line-height:1.7;margin:15px 0;padding:0 50px 0 100px;} .ZNTDw ul p,.ZNTDw ol p,.ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{margin:0;} .ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{padding:0 0 0 30px;} .ZNTDw img{margin:15px 0;}
/* sc-component-id: sc-kAzzGY */
.dgtalV h1{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;} .dgtalV p{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;} .dgtalV span{background:#9c9da3;display:block;margin:50px auto;height:1px;width:150px;}
/* sc-component-id: sc-chPdSV */
.ukmsj{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kgoBCf */
.jLNeCQ{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;}
/* sc-component-id: sc-kGXeez */
.cRzLhO{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kpOJdX */
.eBuswQ{border:1px solid #bfc8d2;border-radius:15px;display:inline-block;margin:5px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;} .eBuswQ svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eBuswQ:hover{border-color:#3e465b;}</style><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#3498db"/><title data-react-helmet="true">Micronaut, Testcontainers and Spock | Arek Jurasz</title><meta data-react-helmet="true" name="description" content="Dev Blog | Software Engineer"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-e72754999b55d36dd31c.js"/><link as="script" rel="preload" href="/app-7680c8ae95fa8ed3e372.js"/><link as="script" rel="preload" href="/8-58ff8726c03efc64fed6.js"/><link as="script" rel="preload" href="/1-aa28afa334b9d14036e0.js"/><link as="script" rel="preload" href="/0-b12e9dd51b1da10d38fa.js"/><link as="script" rel="preload" href="/webpack-runtime-fa9bcecba1793cf2ac72.js"/><link rel="preload" href="/static/d/891/path---2019-08-25-micronaut-testcontainers-spock-ba-0-3cc-ffKs7Bx3kdH07XtSNrj7lxqsYw.json" as="fetch" crossOrigin="use-credentials"/><link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAADbmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmjX/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uaNf/bmTP/2pUq/9uZM//bmjT/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25o1/9ybN//alSv/25o1/+KtXP/bmDL/2pYt/9qVK//cmzb/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25o0/9qVK//YjyD/36RJ/+W1bf/25s//3J07/+CoUv/irFv/2JAh/9mUKP/bmTT/25kz/9uZM//bmTP/25k0/9qVLP/hqVT/8tq3///////pwob/8tq1/+OvYf/ksmb///////Xjyf/jsWX/2pYt/9uZM//bmTP/3Js2/9mTJ//uz6H///////DUq//eo0j/1owZ/+7Nnf/tzJr/140b/9ydPP/syJP///////ThxP/aliz/25o0/9uaNf/alSv/57t5//nv4P/25s//68eR/9ybOP/ltGv/896//9qWL//pwIP/9eLG//nw4//rx5H/2pYu/9uaNP/bmTP/25o0/9mTKP/blzH/57t4//rx5f/ty5n/3Js3//Xjyf/pwYX/+/Tq/+rDif/cnDn/2ZIl/9uZNP/bmTP/25kz/9uZM//bmjX/25kz/9iRJP/ZlCr/3Z9A/9mUKf/z38D/5bRs/9iRJf/YkST/25gx/9yaNv/bmTP/25kz/9uZM//bmTP/25kz/9uZM//cmjb/25o0/9uYMP/bmDH/3Z4//9ybOf/bmDH/3Js3/9uZNP/bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uYMP/bmDH/25k0/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><section class="sc-bdVaJa deuHhw"><header class="sc-htoDjs dVlzdf"><h1 class="sc-ifAKCX FSiJo"><a class="sc-gzVnrw kfPuqG" href="/">Arek Jurasz</a></h1><p class="sc-EHOje sc-bZQynM hyXYOK">Software Engineer</p><div class="sc-htpNat itGeow"><a href="https://twitter.com/arekjurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/ajurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/arkadiusz-jurasz/" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://ajurasz.github.io/rss.xml" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></header></section><section class="sc-bdVaJa deuHhw"><div class="sc-dnqmqq iWIxoV"><div class="sc-kAzzGY dgtalV"><h1>Micronaut, Testcontainers and Spock</h1><p>August 25, 2019</p><span></span></div><article class="sc-cSHVUG ZNTDw"><div><p>Before adopting a new framework I always verify does it provide decent testing support. If you follow <code class="language-text">SOLID</code> principles then to test your business logic you just need a test framework like <code class="language-text">JUnit</code> or <code class="language-text">Spock</code>. Things get complicated when we want to test our code on integration level where business logic and infrastructure code are glue together and check if they behave correctly. This post focuses on writing
integration tests (IT) for <code class="language-text">Micronaut</code> application.</p>
<!-- end -->
<p><a href="https://micronaut.io/index.html">Micronaut</a> is a new kid on the block as its first GA release was less than a year ago on October 23, 2018. It has a lot of interesting features about which you can read in their official <a href="https://docs.micronaut.io/latest/guide/index.html">documentation</a> but for this post, I will mention just one. It has blazing-fast startup time thanks to ahead of time compilation - I will explain later why this is important in case of ITs.</p>
<p>When writing integration tests your application will probably require some third-party services to work. In most cases, this will be a database. And to be honest, nowadays this requirement can be easily achieved with the help of different CI vendors. Following is the sample configuration of the two most popular CI platforms where we mark what additional services are required for our build process:</p>
<p><code class="language-text">Travis CI</code></p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"># travis.yml

services:
  - mysql </code></pre></div>
<p><code class="language-text">CircleCI</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">version: 2
jobs:
  build:
    docker:
      - image: circleci/openjdk:8-jdk
      - image: mysql

    steps:
      - setup_remote_docker</code></pre></div>
<p>But what if we want to run IT locally - then we need to start required docker containers before execution. I know that people often tend to use in-memory replacements for differents services but in my mind, IT
should be as close as possible to the target environment. But there is a better solution than manually taking care of running all required containers - <a href="https://www.testcontainers.org/">Testcontainers</a> is a library that allows us to easily manage docker infrastructure from our test code. </p>
<h2>Base structure</h2>
<p>If it comes to testing <code class="language-text">Micronaut</code> and <code class="language-text">Testcontainers</code> each has handy annotation which brings their functionality to life. </p>
<h3>Micronaut</h3>
<p>For <code class="language-text">Micronaut</code> this is a <code class="language-text">@MicronautTest</code> which starts your real application same way as you would run <code class="language-text">java -jar ...</code> command. Usually, you would create some base class with all required configuration
and then inherit it from your IT cases. Something like this:</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy"><span class="token comment">// IntegrationSpecificationBase.groovy</span>

<span class="token annotation punctuation">@MicronautTest</span><span class="token punctuation">(</span>environments <span class="token operator">=</span> <span class="token string gstring">"it"</span><span class="token punctuation">)</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntegrationSpecificationBase</span> <span class="token keyword">extends</span> <span class="token class-name">Specification</span> <span class="token keyword">implements</span> <span class="token class-name">TestPropertyProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// TodoControllerSpec.groovy</span>
<span class="token keyword">class</span> <span class="token class-name">TodoControllerSpec</span> <span class="token keyword">extends</span> <span class="token class-name">IntegrationSpecification</span> <span class="token punctuation">{</span>
    <span class="token keyword">def</span> <span class="token string gstring">"should get all todos"</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// test body</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This setup revels one potential problem. Potential because it does not have to be a problem for every case due to the main feature of the framework mentioned at the beginning - fast startup time.
Problem is with the way how <code class="language-text">MicronautTest</code> annotation is bound to test execution lifecycle - <code class="language-text">Micronaut</code> application is built and started in <code class="language-text">setupSpec</code>. Tear down happen in <code class="language-text">cleanupSpec</code>. So
in the above example, <code class="language-text">Micronaut</code> application will be started/stopped twice. This can be fixed simply by not using <code class="language-text">@MicronautTest</code> annotation, i.e.:</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">IntegrationSpecificationBase</span> <span class="token keyword">extends</span> <span class="token class-name">Specification</span> <span class="token keyword">implements</span> <span class="token class-name">TestPropertyProvider</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@AutoCleanup</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> EmbeddedServer embeddedServer <span class="token operator">=</span> ApplicationContext<span class="token operator">.</span><span class="token function">run</span><span class="token punctuation">(</span>
            EmbeddedServer<span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">,</span>
            <span class="token string gstring">"it"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Which approach you will choose should mostly be dictated by how long it takes for your application to start. Although <code class="language-text">Micronaut</code> is fast, other libraries that you use doesn’t need to be as fast (e.g. <code class="language-text">micronaut-hibernate-jpa</code>).</p>
<h3>Testcontainers</h3>
<p><code class="language-text">@Testcontainers</code> annotation similarly to <code class="language-text">@MicronautTest</code> is bound to the same lifecycle phases. Unfortunately, right now there is no way of defining processing order - <a href="https://github.com/spockframework/spock/issues/646">change request</a> was already proposed on github. Because of this, I don’t see the possibility to use these two annotations together. Our desired behaviour would
be to start all required docker containers before starting <code class="language-text">Micronaut</code> application. This could be achieved in two ways.</p>
<ol>
<li>Spock global extension</li>
</ol>
<p>A global extension can be used to execute some code at the very start and the very end of <code class="language-text">Spock</code> execution. There are three steps needed to create such an extension:</p>
<ol>
<li>Create <code class="language-text">META-INF/services/org.spockframework.runtime.extension.IGlobalExtension</code> file</li>
<li>Create a class that implements <code class="language-text">IGlobalExtension</code> interface</li>
<li>Add fully-qualified class name created in step <code class="language-text">2</code> to file created in step <code class="language-text">1</code></li>
</ol>
<p>Following example shows how to start all defined containers by using global extension:</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">DockerInfrastructureRunner</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGlobalExtension</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Collection<span class="token operator">&lt;</span>GenericContainer<span class="token operator">></span> containers <span class="token operator">=</span> <span class="token punctuation">[</span>
            MySqlContainer<span class="token operator">.</span>MY_SQL_CONTAINER
    <span class="token punctuation">]</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        containers<span class="token operator">.</span>each <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>it<span class="token operator">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                it<span class="token operator">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        containers<span class="token operator">.</span>each <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it<span class="token operator">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                it<span class="token operator">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<ol start="2">
<li>Groovy <code class="language-text">with</code> method </li>
</ol>
<p>We can also take advantage of some groovy goodness and declare and start docker container in one go like:</p>
<div class="gatsby-highlight" data-language="groovy"><pre class="language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">MySqlContainer</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> GenericContainer MY_SQL_CONTAINER <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericContainer</span><span class="token punctuation">(</span><span class="token string gstring">"mysql:8"</span><span class="token punctuation">)</span>
            <span class="token operator">.</span><span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token string gstring">"MYSQL_ROOT_PASSWORD"</span><span class="token punctuation">,</span> <span class="token string gstring">"password"</span><span class="token punctuation">)</span>
            <span class="token operator">.</span><span class="token function">withEnv</span><span class="token punctuation">(</span><span class="token string gstring">"MYSQL_DATABASE"</span><span class="token punctuation">,</span> <span class="token string gstring">"it"</span><span class="token punctuation">)</span>
            <span class="token operator">.</span><span class="token function">withExposedPorts</span><span class="token punctuation">(</span><span class="token number">3306</span><span class="token punctuation">)</span>
            <span class="token operator">.</span>with <span class="token punctuation">{</span>
                it<span class="token operator">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                it
            <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>Conclusion</h2>
<p>When you want to use desired tools you will have to agree on a few workarounds to make everything works as you want. The biggest surprise for me was not being able to run <code class="language-text">Micronaut</code> or <code class="language-text">Testcontainers</code> just once out of the box together with <code class="language-text">Spock</code>. It is also worth noticing that <code class="language-text">Micronaut</code> and <code class="language-text">Testcontainers</code> project contains modules for <code class="language-text">JUnit</code> where start and stop functions are done in <code class="language-text">BeforeAllCallback</code> and <code class="language-text">AfterAllCallback</code> which base on Javadoc should be
executed just once for a single extension (i.e. before and after all our tests).</p>
<p>The complete example can be found at <a href="https://github.com/ajurasz/micronaut-it">github</a>. There are two branches:</p>
<ol>
<li><code class="language-text">develop</code> where <code class="language-text">@MicronautTest</code> annotation is used together with <code class="language-text">Spock</code> global extension</li>
<li><code class="language-text">shared-context</code> where <code class="language-text">Micronaut</code> is started manually and docker containers by the usage of groovy <code class="language-text">with</code> method</li>
</ol></div></article><div class="sc-kGXeez cRzLhO"><h2 class="sc-kgoBCf jLNeCQ">Share This Post</h2><a href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank" aria-label="Share on Facebook" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a><a href="https://twitter.com/intent/tweet?text=Micronaut,%20Testcontainers%20and%20Spock&amp;url=" target="_blank" aria-label="Share on Twitter" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=&amp;title=Micronaut,%20Testcontainers%20and%20Spock" target="_blank" aria-label="Share on LinkedIn" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="mailto:?subject=Micronaut,%20Testcontainers%20and%20Spock&amp;body=" aria-label="Share by Email" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></div></div><div class="sc-chPdSV ukmsj"><a rel="prev" class="sc-gZMcBi deWstv" href="/2019-08-02-not-null-is-not-null/">← <!-- -->NOT NULL is NOT NULL</a></div></section></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-70225806-1', 'auto', {});
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2019-08-25-micronaut-testcontainers-spock-ba0","path":"/2019-08-25-micronaut-testcontainers-spock/"};window.dataPath="891/path---2019-08-25-micronaut-testcontainers-spock-ba-0-3cc-ffKs7Bx3kdH07XtSNrj7lxqsYw";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-7680c8ae95fa8ed3e372.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-70fa0028ee7496e8897a.js"],"component---src-templates-index-js":["/component---src-templates-index-js-06c9c30cff328926f332.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-e72754999b55d36dd31c.js"],"component---src-pages-404-js":["/component---src-pages-404-js-73aa4ee436ca34094f3e.js"]};/*]]>*/</script><script src="/webpack-runtime-fa9bcecba1793cf2ac72.js" async=""></script><script src="/0-b12e9dd51b1da10d38fa.js" async=""></script><script src="/1-aa28afa334b9d14036e0.js" async=""></script><script src="/8-58ff8726c03efc64fed6.js" async=""></script><script src="/app-7680c8ae95fa8ed3e372.js" async=""></script><script src="/component---src-templates-blog-post-js-e72754999b55d36dd31c.js" async=""></script></body></html>