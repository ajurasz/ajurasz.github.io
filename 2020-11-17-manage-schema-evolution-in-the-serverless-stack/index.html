<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="google-site-verification" content="CcQWHZSra56gJoiG2L4xv8GjL2z_C1txoouzKlR4ASk"/><style data-href="/styles.d16987a306a3d156a977.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.18.17"/><style data-styled="deuHhw dVlzdf FSiJo kfPuqG hyXYOK itGeow eXcfSN iWIxoV kGCCTl fGSVd gGIelI kVSOZg KDfzM gzoEET deWstv dgtalV ZNTDw cRzLhO jLNeCQ eBuswQ ukmsj" data-styled-version="4.4.1">
/* sc-component-id: sc-global-3434470545 */
@import url("https://fonts.googleapis.com/css?family=Roboto:400,700"); html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} main{display:block;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} *,*:before,*:after{box-sizing:inherit;} html{font-size:62.5%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box;} body{background:#f9fafc;font-family:'Open Sans',sans-serif;line-height:1.5;padding:50px 0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;} img{max-width:100%;} .gatsby-highlight{border-bottom:1px solid #e0e6ed;border-top:1px solid #e0e6ed;margin:15px -100px;padding:0;} .gatsby-highlight pre[class*="language-"]{margin:0;padding:25px 100px;} pre[class*="language-"]{background:rgba(245,245,245,1);color:rgb(65,76,94);} @media only screen and (max-width:870px){.gatsby-highlight{margin:15px -15px;}.gatsby-highlight pre[class*="language-"]{padding:25px;}}
/* sc-component-id: sc-bdVaJa */
.deuHhw{margin:0 auto;max-width:1080px;}
/* sc-component-id: sc-htpNat */
.itGeow{margin-top:15px;text-align:center;}
/* sc-component-id: sc-bxivhb */
.eXcfSN{border:1px solid #bfc8d2;border-radius:15px;color:#3e465b;display:inline-block;margin:5px;padding:5px 10px;-webkit-text-decoration:none;text-decoration:none;} .eXcfSN svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eXcfSN:hover{border-color:#3e465b;}
/* sc-component-id: sc-ifAKCX */
.FSiJo{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;}
/* sc-component-id: sc-EHOje */
.kVSOZg{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;}
/* sc-component-id: sc-bZQynM */
.hyXYOK{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;margin:0;}
/* sc-component-id: sc-gzVnrw */
.kfPuqG{color:#3498db;-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: sc-htoDjs */
.dVlzdf{margin:0 auto;max-width:650px;padding:0 50px 50px;text-align:center;}
/* sc-component-id: sc-dnqmqq */
.iWIxoV{background:#fff;border:1px solid #e0e6ed;box-shadow:0 1px 5px rgba(0,0,0,0.05);margin-bottom:30px;padding:75px 100px;} @media only screen and (max-width:870px){.iWIxoV{border-left:none;border-right:none;padding:75px 15px;}}
/* sc-component-id: sc-iwsKbI */
.gzoEET{margin-top:50px;text-align:center;}
/* sc-component-id: sc-gZMcBi */
.deWstv{border:1px solid #bfc8d2;border-radius:25px;color:#3e465b;display:inline-block;font-size:10px;font-weight:700;margin:0 10px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;text-transform:uppercase;} .deWstv:hover{border-color:#000;}
/* sc-component-id: sc-VigVT */
.kGCCTl{text-align:center;}
/* sc-component-id: sc-jTzLTM */
.fGSVd{color:#3e465b;-webkit-text-decoration:none;text-decoration:none;} .fGSVd:hover{color:#3498db;}
/* sc-component-id: sc-fjdhpX */
.gGIelI{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;}
/* sc-component-id: sc-jzJRlG */
.KDfzM{color:#666d71;display:inline-block;font-size:14px;margin-top:50px;-webkit-text-decoration:none;text-decoration:none;} .KDfzM:hover{color:#3498db;}
/* sc-component-id: sc-cSHVUG */
.ZNTDw{color:#65738c;font-size:16px;} .ZNTDw a{color:#3498db;font-weight:700;-webkit-text-decoration:none;text-decoration:none;} .ZNTDw a:hover{-webkit-text-decoration:underline;text-decoration:underline;} .ZNTDw h1{color:#3e465b;font-size:30px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h2{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h3{color:#3e465b;font-size:17px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h4{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h5,.ZNTDw h6{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw p{line-height:1.7;margin:15px 50px;} .ZNTDw blockquote{border-left:5px solid #e0e6ed;line-height:1.7;margin:15px 50px 15px 75px;padding:10px 10px 10px 15px;} .ZNTDw blockquote p{margin:0;} .ZNTDw ul,.ZNTDw ol{line-height:1.7;margin:15px 0;padding:0 50px 0 100px;} .ZNTDw ul p,.ZNTDw ol p,.ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{margin:0;} .ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{padding:0 0 0 30px;} .ZNTDw img{margin:15px 0;}
/* sc-component-id: sc-kAzzGY */
.dgtalV h1{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;} .dgtalV p{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;} .dgtalV span{background:#9c9da3;display:block;margin:50px auto;height:1px;width:150px;}
/* sc-component-id: sc-chPdSV */
.ukmsj{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kgoBCf */
.jLNeCQ{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;}
/* sc-component-id: sc-kGXeez */
.cRzLhO{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kpOJdX */
.eBuswQ{border:1px solid #bfc8d2;border-radius:15px;display:inline-block;margin:5px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;} .eBuswQ svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eBuswQ:hover{border-color:#3e465b;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#3498db"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><title data-react-helmet="true">Managing schema evolution in the serverless stack | Arek Jurasz</title><meta data-react-helmet="true" name="description" content="Dev Blog | Software Engineer"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/styles-4f1a9273244be790d38c.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js"/><link as="script" rel="preload" href="/commons-ed86373b90c649a8f6f2.js"/><link as="script" rel="preload" href="/app-93669a106e49c45c3abd.js"/><link as="script" rel="preload" href="/webpack-runtime-9284701b300429ba4c2b.js"/><link as="fetch" rel="preload" href="/page-data/2020-11-17-manage-schema-evolution-in-the-serverless-stack/page-data.json" crossorigin="anonymous"/><link rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAADbmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmjX/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uaNf/bmTP/2pUq/9uZM//bmjT/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25o1/9ybN//alSv/25o1/+KtXP/bmDL/2pYt/9qVK//cmzb/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25o0/9qVK//YjyD/36RJ/+W1bf/25s//3J07/+CoUv/irFv/2JAh/9mUKP/bmTT/25kz/9uZM//bmTP/25k0/9qVLP/hqVT/8tq3///////pwob/8tq1/+OvYf/ksmb///////Xjyf/jsWX/2pYt/9uZM//bmTP/3Js2/9mTJ//uz6H///////DUq//eo0j/1owZ/+7Nnf/tzJr/140b/9ydPP/syJP///////ThxP/aliz/25o0/9uaNf/alSv/57t5//nv4P/25s//68eR/9ybOP/ltGv/896//9qWL//pwIP/9eLG//nw4//rx5H/2pYu/9uaNP/bmTP/25o0/9mTKP/blzH/57t4//rx5f/ty5n/3Js3//Xjyf/pwYX/+/Tq/+rDif/cnDn/2ZIl/9uZNP/bmTP/25kz/9uZM//bmjX/25kz/9iRJP/ZlCr/3Z9A/9mUKf/z38D/5bRs/9iRJf/YkST/25gx/9yaNv/bmTP/25kz/9uZM//bmTP/25kz/9uZM//cmjb/25o0/9uYMP/bmDH/3Z4//9ybOf/bmDH/3Js3/9uZNP/bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uYMP/bmDH/25k0/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div><section class="sc-bdVaJa deuHhw"><header class="sc-htoDjs dVlzdf"><h1 class="sc-ifAKCX FSiJo"><a class="sc-gzVnrw kfPuqG" href="/">Arek Jurasz</a></h1><p class="sc-EHOje sc-bZQynM hyXYOK">Software Engineer</p><div class="sc-htpNat itGeow"><a href="https://twitter.com/arekjurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/ajurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/arkadiusz-jurasz/" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://ajurasz.github.io/rss.xml" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></header></section><section class="sc-bdVaJa deuHhw"><div class="sc-dnqmqq iWIxoV"><div class="sc-kAzzGY dgtalV"><h1>Managing schema evolution in the serverless stack</h1><p>November 17, 2020</p><span></span></div><article class="sc-cSHVUG ZNTDw"><div><p>Looking on some of the AWS efforts around RDS service it won’t be an incorrect statement to say that they want to bring the world of relational databases closer to Lambda functions. First, <a href="https://aws.amazon.com/rds/aurora/serverless/">Aurora Serverless</a> was <a href="https://aws.amazon.com/blogs/aws/aurora-serverless-ga/">announced</a> then less than a year later this revolutionary service was extended by <a href="https://aws.amazon.com/blogs/aws/new-data-api-for-amazon-aurora-serverless/">Data API</a> where interaction with DB is done through API endpoint. But this is not an end, the next year has come and we got <a href="https://aws.amazon.com/blogs/aws/amazon-rds-proxy-now-generally-available/">RDS proxy</a> whose main task is to help improve applications scalability by managing DB connections.</p>
<!-- end -->
<p>All these improvements show us that relational databases are relevant for serverless applications otherwise AWS wouldn’t put such a big effort in helping developers writing more efficient Lambda functions while working with RDS service.</p>
<p>The main purpose of this introduction was to defend the topic of this blog post - <strong>managing schema evolution in the serverless stack</strong> - which I hope doesn’t sound too abstract now. As befits a Java developer I could not resist bringing my own toolset to face the issue. The toolset consists of Java 11, Maven and Flyway.</p>
<h2>CloudFormation</h2>
<p>Let’s say that on the design level it was decided that the relational database will be best suited for the job. The first thing that arises is how can we initialize the RDS database with initial schema and then manage the evolution of that schema when all we have are just single-purpose functions containing business logic. There are multiple approaches to tackle this issue, <a href="https://stackoverflow.com/questions/14384849/is-there-a-way-to-run-initial-sql-when-creating-an-rds-database-instance-using-c">here</a> you will find some interesting suggestions. I decided to take advantage of CloudFormation(CF) <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html">Custom Resources</a>. This has some limitation which will be mentioned later on - but do not worry I will also show how to overcome them.</p>
<p>My main goal was to set up a single-click deployment solution so that anyone could try and run this on his own AWS account. Since I will be using CF this will be not an issue. Furthermore, the main resource will be a Lambda function, in this case, it’s advisable to use AWS Serverless Application Model (AWS SAM) a template specification which provides a simple and clean way of describing Lambda functions (together with API endpoints if needed). But the specification is not all, we additionally get the utility tool (<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">SAM CLI</a>) which brings building, testing and deploying Lambda functions to the next level.  </p>
<h2>Custom Resource</h2>
<p>While new services are introduced on AWS they not always are immediately supported in CF, for this reason, Custom Resources where created which brings back doors to AWS API so that it’s possible to interact with these new services through code. Custom Resources can be also used to provide side effects like cleanup s3 bucket while removing a stack or run schema migration against DB like it will be in our case. Defining Custom Resource is very simple, we only need to provide <code class="language-text">ServiceToken</code> which points to Lambda function or SNS topic:</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">LambdaMigrationFunctionTrigger</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Custom<span class="token punctuation">:</span><span class="token punctuation">:</span>LambdaMigrationFunctionTrigger
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">ServiceToken</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> MigrationFunction.Arn</code></pre></div>
<p>Base on this information CF sends <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref-requests.html">request object</a> any time when this resource is created, updated or deleted. </p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
   <span class="token property">"RequestType"</span> <span class="token operator">:</span> <span class="token string">"Create"</span><span class="token punctuation">,</span>
   <span class="token property">"ResponseURL"</span> <span class="token operator">:</span> <span class="token string">"http://pre-signed-S3-url-for-response"</span><span class="token punctuation">,</span>
   <span class="token property">"StackId"</span> <span class="token operator">:</span> <span class="token string">"arn:aws:cloudformation:us-west-2:123456789012:stack/stack-name/guid"</span><span class="token punctuation">,</span>
   <span class="token property">"RequestId"</span> <span class="token operator">:</span> <span class="token string">"unique id for this create request"</span><span class="token punctuation">,</span>
   <span class="token property">"ResourceType"</span> <span class="token operator">:</span> <span class="token string">"Custom::TestResource"</span><span class="token punctuation">,</span>
   <span class="token property">"LogicalResourceId"</span> <span class="token operator">:</span> <span class="token string">"MyTestResource"</span><span class="token punctuation">,</span>
   <span class="token property">"ResourceProperties"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"Name"</span> <span class="token operator">:</span> <span class="token string">"Value"</span><span class="token punctuation">,</span>
      <span class="token property">"List"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span> <span class="token punctuation">]</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Whenever CF stack is created or delete a request will be sent to target service, but to trigger an update request one of Custome Resource property needs to be updated. For our case, this is very important because most of the time Custom Resource should be triggered while updating Lambda function with new migration scripts. This limitation can be overcome by introducing a fake property (<code class="language-text">DeployTimestamp</code>) which the only purpose will be to hold different value whenever CF stack is updated.</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">Parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">DeployTimestamp</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Number
    <span class="token key atrule">Default</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">LambdaMigrationFunctionTrigger</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> Custom<span class="token punctuation">:</span><span class="token punctuation">:</span>LambdaMigrationFunctionTrigger
    <span class="token key atrule">Properties</span><span class="token punctuation">:</span>
      <span class="token key atrule">ServiceToken</span><span class="token punctuation">:</span> <span class="token tag">!GetAtt</span> MigrationFunction.Arn
      <span class="token key atrule">DeployTimestamp</span><span class="token punctuation">:</span> <span class="token tag">!Ref</span> DeployTimestamp</code></pre></div>
<p>Value of this property won’t change out of the box but can be easily overridden while uploading template from CLI</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># AWS CLI</span>
aws cloudformation package --template-file <span class="token variable">$TEMPLATE</span> --s3-bucket <span class="token variable">$AWS_S3_BUCKET</span> --output-template-file out.yml
aws cloudformation deploy --template-file out.yml --stack-name <span class="token variable">$STACK_NAME</span> --capabilities CAPABILITY_IAM --parameter-overrides <span class="token assign-left variable">DeployTimestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span>

<span class="token comment"># SAM CLI </span>
sam deploy --stack-name <span class="token variable">$STACK_NAME</span> --capabilities CAPABILITY_IAM --parameter-overrides <span class="token assign-left variable">DeployTimestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%s<span class="token variable">)</span></span></code></pre></div>
<p>Now CF will send update requests to Lambda function every time the CF stack if updated.</p>
<h2>Architecture</h2>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/256ae5773ad607054c4b3c169f385da7/f1d59/flyless-architecture.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 103.19001386962552%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAD40lEQVQ4y21US4tcRRTu3+BvEFy40oUbVwr+iYgbdwpuhIBEUXyRIAEhGASN8RE3BiKjwowZZ4Yw0zMuJDIPkmmmp3N7uu+t+34/6r4/T1Xf7umYFBxO3bpfnfrOOV9V79rOF+AFR15x8Grm8yrvPFmZIUeDbLSLeO0yeMiQNxWtL2PzxbxX0c+njnbuZ5Ni6zqSyy+jmR52681Tt/VE5PngxGZ+QCtjtbRvtpG7Gsx/ViXjBUb8/5/JgG3HYvV4BX3lHia+ApXtw80cuKkNJzFRdIfePVnF9mgDU38sceK/m1oSU9alCJgvGAaZCzU1YN//BfzG63AGf0EnsJGa4OwBqn9XEEQMWjSFHpJFKoxIkybmRV2gJ9JsRFpEMsw8MApg7a/AvfEmzMEG9MSAmXsID9fg3HwLvquAJToFUReBhGd0QFFTU1qcF7eoEvicUiCmw9N96T1Kyecu4siDzYhFFUuMWPeycy/SrkTKt3/7Ax98ehX3dvbg5S38tCDGLUmgRl6U1IRK+pK+xTDiAn5WoiZMWbfUoFbOhZdNefvi+3j2hVdw9cuvsKWE2DyxMHRSPHRLaCGHHueUVk4KEJ1t8OfAwubQxqnAmDFUwhiEYYQp6ga9W7fv4N1Ln2Fja5sECzDDhzHVYB3sgukOmB1SE3LJuKlrEn8jD2CdiUOFicAF/esNRkOsb+7AskkiSQaFTnW3f0J98wI1Zx3MK6jgmQzYUsCAV5gGfBFsObBkePGjz/H8S6/h+jc/IqOanOkB1MM+zDsfQ1NOoNsxbeCylm1VIswryYYtsXws4HufXMFzL76Ka19/h4yko0xM3D9WsHswwNFIg2b6klHeicHnNc78TAYV68LEfCIwImXbc6BqOtI0kxtSStvRTbCJCocZiFKOkPpRmiOU+7+jJd2mVYuYmMZFhYi8YB1SKUSne1VbLnR4xEKcBTli2uCSNDgxzqsKAhEfrMMjsR+dnmEclEgoSMBLZGUtUxXsGiEbTs+Q0J0Y24qH3aGJCXX6kUosLR+al4DFJfwgRGhq2Bk56I89DO1Eykakr3Xpy5TP73KLjBZCL8Ta38e49MMeHkx8mBRUDXOUXQ1zYmOS7ozOnmjK8uNgJwWiOMMbH36PZy7cws/9CTwvwFRqrJaHilsiZdPpby6dhQ7P38OW7mQBx4vwa/8h3vl2DwdaTAw9Cc67qyfqNg0yKSVtKegc0xMXej6iooWmuZhQ/ZSxiqlmw7BCqqHo4AwTk360sKArWdKNOTdGJjA9O7Go9SEiHsBJfei+hbE2xqOpgok+gRm5VCuPUg0I12Ho5RFrj1k0w/wHRMkiKDsRN4cAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Flyless architecture"
        title=""
        src="/static/256ae5773ad607054c4b3c169f385da7/69344/flyless-architecture.png"
        srcset="/static/256ae5773ad607054c4b3c169f385da7/17006/flyless-architecture.png 175w,
/static/256ae5773ad607054c4b3c169f385da7/d6f3f/flyless-architecture.png 350w,
/static/256ae5773ad607054c4b3c169f385da7/69344/flyless-architecture.png 700w,
/static/256ae5773ad607054c4b3c169f385da7/f1d59/flyless-architecture.png 721w"
        sizes="(max-width: 700px) 100vw, 700px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>The sample architecture was prepared with an emphasis on security best practices for DBs running in the AWS cloud. </p>
<ul>
<li>DB instance is running in private subnet without ingress traffic from the internet. </li>
<li>Restricted security group is assigned to this instance which allows only access from <code class="language-text">FnSecurityGroup</code> source which in turn is associated with our Lambda function (<code class="language-text">MigrationFunction</code>). </li>
<li>DB credentials are stored in <a href="https://aws.amazon.com/secrets-manager/">AWS Secrets Manager</a>, this way there is no need to pass sensitive data directly to Lambda function. </li>
<li>Execution role associated with Lambda function allows it to fetch DB credentials.</li>
</ul>
<p>Because RDS is running in private subnet without internet access, Lambda function had to be deployed within VPC. One of the Lambda function characteristics is that it cannot have a public IP address - to meet this requirements Lambda function needs to be deployed in a private subnet.
So how can we provide internet access for functions that need to be run in VPC? There are two options, set up a NAT Gateway or create VPC Endpoint for every service you need to communicate with. As shown in the above diagram we will use the first option.</p>
<h2>Deployment</h2>
<p>It’s finally time to get our hands dirty and run some code. First of all clone <a href="https://github.com/ajurasz/flyless">repository</a></p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/ajurasz/flyless.git</code></pre></div>
<blockquote>
<p><strong>NOTICE:</strong> See <a href="https://github.com/ajurasz/flyless#prerequisites">Prerequisites</a> section in readme file.</p>
</blockquote>
<p>then run</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">./deploy.sh</code></pre></div>
<blockquote>
<p><strong>NOTICE:</strong> While running script it’s expected that AWS CLI was configured.</p>
</blockquote>
<p>Few interesting things are happening inside this script.</p>
<h3>Building</h3>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">sam build</code></pre></div>
<p>will build our maven project and run integration tests. These tests run schema migration against <strong>real DB</strong> - same version that will be used in AWS - all of this was done with the help of <a href="https://www.testcontainers.org/">Testcontainers</a>. With this library test code can be as easy and clean as:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Testcontainers</span>
<span class="token annotation punctuation">@ExtendWith</span><span class="token punctuation">(</span><span class="token class-name">MockitoExtension</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MigrationHandlerIT</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Container</span>
    <span class="token keyword">private</span> <span class="token class-name">MySQLContainer</span> mysql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MySQLContainer</span><span class="token punctuation">(</span><span class="token class-name">DockerImageName</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"mysql:5.7.31"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withDatabaseName</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"RDS_DB_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"RDS_USERNAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">withPassword</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"RDS_PASSWORD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Mock</span>
    <span class="token keyword">private</span> <span class="token class-name">CfnResponse</span> cfnResponse<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EnvironmentVariables</span><span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"RDS_PORT"</span><span class="token punctuation">,</span> <span class="token string">""</span> <span class="token operator">+</span> mysql<span class="token punctuation">.</span><span class="token function">getFirstMappedPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@DisplayName</span><span class="token punctuation">(</span><span class="token string">"should run all migration scripts"</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// given</span>
        <span class="token keyword">var</span> migrationHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MigrationHandler</span><span class="token punctuation">(</span>cfnResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> input <span class="token operator">=</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span><span class="token function">of</span><span class="token punctuation">(</span>
                <span class="token string">"RequestType"</span><span class="token punctuation">,</span> <span class="token string">"Create"</span><span class="token punctuation">,</span>
                <span class="token string">"RequestId"</span><span class="token punctuation">,</span> <span class="token string">"RequestId"</span><span class="token punctuation">,</span>
                <span class="token string">"ResponseURL"</span><span class="token punctuation">,</span> <span class="token string">"http://pre-signed-S3-url-for-response"</span><span class="token punctuation">,</span>
                <span class="token string">"StackId"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:cloudformation:us-east-1:123456789012:stack/MyStack/guid"</span><span class="token punctuation">,</span>
                <span class="token string">"LogicalResourceId"</span><span class="token punctuation">,</span> <span class="token string">"MyTestResource"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// when</span>
        <span class="token keyword">var</span> response <span class="token operator">=</span> migrationHandler<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DummyContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// then</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">verify</span><span class="token punctuation">(</span>cfnResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">CfnEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">any</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Environment variables used in the test were setup through <code class="language-text">maven-failsafe-plugin</code></p>
<div class="gatsby-highlight" data-language="xml"><pre class="language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-failsafe-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.22.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environmentVariables</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RDS_DB_NAME</span><span class="token punctuation">></span></span>db_name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RDS_DB_NAME</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RDS_USERNAME</span><span class="token punctuation">></span></span>user<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RDS_USERNAME</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RDS_PASSWORD</span><span class="token punctuation">></span></span>password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RDS_PASSWORD</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RDS_HOST</span><span class="token punctuation">></span></span>localhost<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RDS_HOST</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DB_STAGE</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>DB_STAGE</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>AWS_SAM_LOCAL</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>AWS_SAM_LOCAL</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environmentVariables</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>integration-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>integration-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>verify<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></code></pre></div>
<p>Tests can be also run independently without SAM CLI</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">mvn -f MigrationFunction/pom.xml clean verify</code></pre></div>
<h3>Imitating AWS Lambda service</h3>
<p>When I wrote that SAM CLI brings testing to the next level, here is why. There is a possibility to invoke function locally with </p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">sam <span class="token builtin class-name">local</span> invoke</code></pre></div>
<p>Under the hood SAM CLI setup infrastructure using docker containers that imitate AWS then it deploys our code to that infrastructure and finally executes that code. To run the migration function which depends on an external database all needed containers needs to be run under a single network.</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">docker network create --driver bridge sam_flyless_newtork
docker run --rm -d --name sam_flyless_mysql --network sam_flyless_newtork -e <span class="token assign-left variable">MYSQL_RANDOM_ROOT_PASSWORD</span><span class="token operator">=</span>yes -e <span class="token assign-left variable">MYSQL_DATABASE</span><span class="token operator">=</span><span class="token variable">$DB_NAME</span> -e <span class="token assign-left variable">MYSQL_USER</span><span class="token operator">=</span><span class="token variable">$DB_USERNAME</span> -e <span class="token assign-left variable">MYSQL_PASSWORD</span><span class="token operator">=</span><span class="token variable">$DB_PASSWORD</span> mysql:5.7.31

sam <span class="token builtin class-name">local</span> invoke --event events/create_event.json --docker-network sam_flyless_newtork --env-vars env.json</code></pre></div>
<p>This way Lambda function will have direct access to DB container prepared in advance.
To have better control over what event will trigger the function or which environment variables will be available in the runtime following options can be specified <code class="language-text">--event</code> (path to JSON file containing an event) and  <code class="language-text">--env-vars</code> (path to JSON file containing environment variables available for the Lambda function).</p>
<blockquote>
<p><strong>NOTICE:</strong> While passing environment variables through <code class="language-text">--env-vars</code> option, only these that are expected by the function will be passed to the environment - others will be ignored.</p>
</blockquote>
<h2>Demo</h2>
<p><img src="/5ea780917802f0a44d8ee533187d82af/demo.gif" alt="Demo"></p>
<h2>Cleanup</h2>
<p>CF stack can be removed with ease with a single command</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">aws cloudformation delete-stack --stack-name <span class="token variable">$STACK_NAME</span></code></pre></div>
<p>As mentioned before, while CF stack is deleted a delete request is sent to the target service and CF expect to receive a response. To provide Lamdba function possibility to respond to CF, NAT Gateway needs to stay operational. We can ensure that all required resources will not be deleted until it’s still needed by Lambda function with <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-dependson.html">DependsOn</a> attribute - which helps to explicitly mark dependencies between resources.</p>
<div class="gatsby-highlight" data-language="yml"><pre class="language-yml"><code class="language-yml"><span class="token key atrule">Resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">MigrationFunction</span><span class="token punctuation">:</span>
    <span class="token key atrule">Type</span><span class="token punctuation">:</span> AWS<span class="token punctuation">:</span><span class="token punctuation">:</span>Serverless<span class="token punctuation">:</span><span class="token punctuation">:</span>Function
    <span class="token key atrule">DependsOn</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> DB
      <span class="token punctuation">-</span> PublicRTAssociation1
      <span class="token punctuation">-</span> PublicRTAssociation2
      <span class="token punctuation">-</span> PublicRTRouteToInternet
      <span class="token punctuation">-</span> PrivateRTAssociation3
      <span class="token punctuation">-</span> PrivateRTAssociation4
      <span class="token punctuation">-</span> PrivateRTRouteToNG
      <span class="token punctuation">-</span> IGAttachment</code></pre></div>
<h2>Conclusion</h2>
<p>While working with relational databases in the serverless stack I don’t see any disadvantage of maintaining schema evolution in the way it was described. I just want to alert you to a fact that we must remember - execution time of Lambda function can be up to 15 min, so if you expect that your migration could take longer then you should think about a different approach.</p></div></article><div class="sc-kGXeez cRzLhO"><h2 class="sc-kgoBCf jLNeCQ">Share This Post</h2><a href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank" aria-label="Share on Facebook" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a><a href="https://twitter.com/intent/tweet?text=Managing%20schema%20evolution%20in%20the%20serverless%20stack&amp;url=" target="_blank" aria-label="Share on Twitter" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=&amp;title=Managing%20schema%20evolution%20in%20the%20serverless%20stack" target="_blank" aria-label="Share on LinkedIn" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="mailto:?subject=Managing%20schema%20evolution%20in%20the%20serverless%20stack&amp;body=" aria-label="Share by Email" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></div></div><div class="sc-chPdSV ukmsj"><a rel="prev" class="sc-gZMcBi deWstv" href="/2020-04-12-continuous-deployment-on-kubernetes/">← <!-- -->Continuous Deployment on Kubernetes</a></div></section></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-70225806-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-11-17-manage-schema-evolution-in-the-serverless-stack/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-93669a106e49c45c3abd.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-87ef582ba388a83f73c0.js"],"component---src-templates-index-js":["/component---src-templates-index-js-01c80e7b8e10ea89c878.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c2229418bf9686809ee4.js"]};/*]]>*/</script><script src="/webpack-runtime-9284701b300429ba4c2b.js" async=""></script><script src="/app-93669a106e49c45c3abd.js" async=""></script><script src="/commons-ed86373b90c649a8f6f2.js" async=""></script><script src="/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js" async=""></script><script src="/styles-4f1a9273244be790d38c.js" async=""></script></body></html>