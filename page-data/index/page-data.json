{"componentChunkName":"component---src-templates-index-js","path":"/","result":{"pageContext":{"group":[{"node":{"fields":{"slug":"/2020-12-07-use-jdk-flight-recorder-to-log-sql-queries/"},"html":"<p>Since Java 11, <code class=\"language-text\">JDK Flight Recorder</code> (<code class=\"language-text\">JFR</code>) is getting more and more popular among developers. There are two reasons behind this fact, first, <code class=\"language-text\">JFR</code> got open-sourced and included into OpenJDK - previously it was part of a <code class=\"language-text\">JRockit JVM</code> and commercial version of Oracle JDK (see <a href=\"http://openjdk.java.net/jeps/328\">JEP 328</a> for more details.). The second fact is that it is a tool for collecting diagnostic and profiling data about running Java application - because it is so deeply embedded to JVM it provides extremely low overhead (about 1% out of the box).</p>\n<!-- end -->\n<h2>Low overhead</h2>\n<p>To get a very good and affordable explanation on how JVM engineers managed to achieve so great results, please watch part of the following video where Mikael Vidstedt explains this.</p>\n<div class=\"gatsby-resp-iframe-wrapper\" style=\"padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden; margin-bottom: 1.0725rem\" > <iframe src=\"https://www.youtube.com/embed/plYESjZ12hM?t=1\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen style=\" position: absolute; top: 0; left: 0; width: 100%; height: 100%; \"></iframe> </div>\n<blockquote>\n<p>I encourage you to watch the full presentation as it is very enlightening in terms of <code class=\"language-text\">JFR</code> topic.</p>\n</blockquote>\n<h2>JFR</h2>\n<p>If videos are not your thing and you prefer to read then I recommend following blog posts from <code class=\"language-text\">redhat</code>:</p>\n<ul>\n<li><a href=\"https://developers.redhat.com/blog/2020/08/25/get-started-with-jdk-flight-recorder-in-openjdk-8u/\">Get started with JDK Flight Recorder in OpenJDK 8u</a></li>\n<li><a href=\"https://developers.redhat.com/blog/2020/10/29/collect-jdk-flight-recorder-events-at-runtime-with-jmc-agent/\">Collect JDK Flight Recorder events at runtime with JMC Agent</a></li>\n</ul>\n<h2>Motivation</h2>\n<p>I got inspired by Gunnar Morling and his tweet</p>\n<blockquote class=\"twitter-tweet\" align=\"center\" data-dnt=\"true\"><p lang=\"en\" dir=\"ltr\">ğŸ§‘â€ğŸ’»: &quot;If we only could log SQL statements executed by <a href=\"https://twitter.com/Hibernate?ref_src=twsrc%5Etfw\">@Hibernate</a> with Flight Recorder.&quot;<br><br>JMC Agent: &quot;Hold my ğŸ·!&quot; <a href=\"https://t.co/f5S5hSf5Tj\">pic.twitter.com/f5S5hSf5Tj</a></p>&mdash; Gunnar Morling ğŸŒ (@gunnarmorling) <a href=\"https://twitter.com/gunnarmorling/status/1317552923950391301?ref_src=twsrc%5Etfw\">October 17, 2020</a></blockquote>\n\n<p>Although itâ€™s not visible on the Gunnarâ€™s screen if he logs SQL statements together with parameters I thought it would be a great exercise to see if I could do the similar thing using <code class=\"language-text\">JFR</code> and have full SQL statements that can be copy-pasted to an SQL editor.</p>\n<h2>Datasource proxy</h2>\n<p>First, to be able to get access to SQL statements and parameters passed to JDBC it would be required to intercept appropriate methods from JDBC API through a proxy around <code class=\"language-text\">java.sql.Statement</code>. To make things easier and focus mostly on creating <code class=\"language-text\">jdk.jfr.Event</code>s we will use <a href=\"https://github.com/ttddyy/datasource-proxy\">datasource-proxy</a> - library which gives easy access to what is needed.</p>\n<p>Letâ€™s start wit creating <code class=\"language-text\">javax.sql.DataSource</code> and tell HIbernate to use it.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">object</span> DB <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> sessionFactory<span class=\"token operator\">:</span> SessionFactory\n\n    <span class=\"token keyword\">init</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> registry <span class=\"token operator\">=</span> <span class=\"token function\">StandardServiceRegistryBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">applySettings</span><span class=\"token punctuation\">(</span><span class=\"token function\">runtimeSettings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        sessionFactory <span class=\"token operator\">=</span> <span class=\"token function\">MetadataSources</span><span class=\"token punctuation\">(</span>registry<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">addAnnotatedClass</span><span class=\"token punctuation\">(</span>Post<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">buildMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">buildSessionFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">runtimeSettings</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> MutableMap<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> Any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">mutableMapOf</span><span class=\"token punctuation\">(</span>\n                Environment<span class=\"token punctuation\">.</span>DATASOURCE <span class=\"token keyword\">to</span> <span class=\"token function\">dataSourceProxy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">dataSourceProxy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> ProxyDataSourceBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">listener</span><span class=\"token punctuation\">(</span><span class=\"token function\">QueryRecorder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">dataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">MysqlDataSource</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">also</span> <span class=\"token punctuation\">{</span>\n        it<span class=\"token punctuation\">.</span><span class=\"token function\">setURL</span><span class=\"token punctuation\">(</span><span class=\"token function\">dbUrl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        it<span class=\"token punctuation\">.</span>user <span class=\"token operator\">=</span> <span class=\"token function\">dbUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        it<span class=\"token punctuation\">.</span>password <span class=\"token operator\">=</span> <span class=\"token function\">dbPassword</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// rest of the code omitted for better readability    </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>Hibernate is used only to make this example more interesting. It would be possible to use raw JDBC API and work directly with <code class=\"language-text\">java.sql.Connection</code> and <code class=\"language-text\">java.sql.PreparedStatement</code>.</p>\n</blockquote>\n<p>Notice that <code class=\"language-text\">ProxyDataSourceBuilder</code> register <code class=\"language-text\">QueryRecorder</code> listener that will be executed after a call to one of the following methods <code class=\"language-text\">executeQuery, executeUpdate, execute, executeLargeUpdate</code> from <code class=\"language-text\">java.sql.Statement</code>. <code class=\"language-text\">QueryRecorder#afterQuery</code> is responsible for parsing provided arguments through the <code class=\"language-text\">Query</code> object and then commit <code class=\"language-text\">JFR</code> events.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> QueryRecorder <span class=\"token operator\">:</span> QueryExecutionListener <span class=\"token keyword\">by</span> QueryExecutionListener<span class=\"token punctuation\">.</span><span class=\"token function\">DEFAULT</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">afterQuery</span><span class=\"token punctuation\">(</span>execInfo<span class=\"token operator\">:</span> ExecutionInfo<span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> queryInfoList<span class=\"token operator\">:</span> MutableList<span class=\"token operator\">&lt;</span>QueryInfo<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolveQuery</span><span class=\"token punctuation\">(</span>queryInfoList<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token operator\">::</span>publishEvent<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">resolveQuery</span><span class=\"token punctuation\">(</span>queryInfoList<span class=\"token operator\">:</span> MutableList<span class=\"token operator\">&lt;</span>QueryInfo<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> queryInfoList\n            <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>parametersList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span> <span class=\"token punctuation\">{</span> params <span class=\"token operator\">-></span> <span class=\"token function\">Pair</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> Query<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">publishEvent</span><span class=\"token punctuation\">(</span>query<span class=\"token operator\">:</span> Query<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">QueryEvent</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">.</span><span class=\"token function\">toSql</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Collecting JFR events</h2>\n<p>There are three ways to â€œrecord flightsâ€.</p>\n<ol>\n<li>JDK Mission Control (JMC)</li>\n</ol>\n<p>The main purpose of this tool is to analyze <code class=\"language-text\">JFR</code> recordings through a graphical interface. Beside displaying these data it can interact with <code class=\"language-text\">JFR</code> to start recordings. Assuming there is a running Java application supporting <code class=\"language-text\">JFR</code>, then we can select process under which this application runs and start recording as shown below.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/940e4190af458a27a356c75ceee8677e/e0202/jmc_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 61.142857142857146%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAC4jAAAuIwF4pT92AAAB+klEQVQoz6WS22sTQRTG9+8WCoLgpTYgNvdoW4oVq29aLaJP6rukKGi21jQ2yc7eL7OXZLd8frObhGhFH1z2x5mdOXxzvnNWa9braGxvo05ajQa67XZJp9VCu9lAh+u93T3s7uyg2+nwm3R+pbuID3s9aGmSwJcx5CxHVlzif558PodmnX3F6P0xTl4+xcnRIfrPn6D/QnGIz6+eQf/wFsPhEMOzbzjVB1c4O9VhiymiKITvedDmicRY/4LN6xu4tXEN927eQKu2iebWHTTv3saD+n08PjjAo/199GhrSXdhsVbbwrs3r1EUOcLAhzabzSCTFC7VXT9AKCUitiGKE65jxhgqZ047eZ6vKIqitDm1bIwuxkhZWBQGFMwyhFyMJz/gOTYsy4LrukgomiQxYgpKXvI76jxNU1qN4DE/lhEFQ2hZxk0mjC7O8Z19UoIZL1ln9geqs7SMVwRVFQ6FhDGF5Drm7Sr+i2We6zoLwUAJZuWEjOkEtl1ZVjEMIxL+FZU3ZRGWZa4LVn0whQHHceB5bjn+Jd4K7vs+giDggKohXeYcDN+Qw5QsSsEpZ0wKadeAS0G7rNCqIm9We3Esywrkok9qiJIOhCfwcdLHSJwjpfWqwjQpLQsh4KyE1jFhmaLEZI5BixO2xzQEBqMBjj4dQx/ryNRvRsGfbQVq9y+BlR4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"JMC Start Recording\"\n        title=\"\"\n        src=\"/static/940e4190af458a27a356c75ceee8677e/8c557/jmc_1.png\"\n        srcset=\"/static/940e4190af458a27a356c75ceee8677e/4edbd/jmc_1.png 175w,\n/static/940e4190af458a27a356c75ceee8677e/13ae7/jmc_1.png 350w,\n/static/940e4190af458a27a356c75ceee8677e/8c557/jmc_1.png 700w,\n/static/940e4190af458a27a356c75ceee8677e/e996b/jmc_1.png 1050w,\n/static/940e4190af458a27a356c75ceee8677e/e0202/jmc_1.png 1395w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>There are two important things to be aware of while configuring recording (this applies to other two ways as well). First is that there are two types of recordings <code class=\"language-text\">Time fixed</code> where we define the time of recording and <code class=\"language-text\">Continuous</code> where we define the maximum size and age of these recordings. <code class=\"language-text\">Time fixed</code> is very nice to sample your Java application once for a given time and then when recording is finished <code class=\"language-text\">JMC</code> will automatically load and display collected data - for <code class=\"language-text\">Continuous</code> type you would have to manually dump recordings to a file and then load them in <code class=\"language-text\">JMC</code>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a800e86e0f352147257682043e0a76fd/82f50/jmc_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 51.42857142857144%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB60lEQVQoz11SWW7bQAzV/Q9Qp6mX2jKSK+QA7U83tEWMNtW+ebRZtjbLWqxXcmwHRQd4IIcaPj6SUt5OJpi8meCO7Gw6xZRwf/8Os9kc8/lc2oeHR4nFYgF1pWKtqlAJ6/X6AnWF5XKJx9V7KG1ToywLHI9H8MkPOfIsQ991aNuObA+MI8bziP9PR9/6/oxx6GX+qRug5IcMuvZCgQZDPyDwHGx9j4j3CCwDgalDOCb5OkLXhiCEVwjHwtY2kYUCeRKRkBQKMzuui6ZpZNX0+RPCj08YXr5SsgMv2CJJU9iOg3S3gx8EMC1L5rieB8u2UdX1VXEHhdv9o2nY7/cyKHwTm2+fkacJxDaARclRFELXdcRRBI+I2DdNE6ZhQKPc+krIY1KqqoRhaNTiQQazQwzdMhEfSggRwiFlcRxLAra+79N7Q965GPsRFWJBzKFU1LLhuCiaVhImwpMKmtMJAbV3IYxeCTlmkH8jvRHrdA+FoJZjauvLB6S/vuOc+MgoaFs2TrRhfnBpOZIETOjR3F4VErh4VVVSTNu2tJSQFqL9QG/8xOD8RrILsdk8wxMRttTyv4RsXZohz+2mTNN0FEVxXQoRtvSr8DkTRjnDXKooqxopbZdnxpZjO9qyINVMynEGb7ssy4tCGtNfFuzaGzOGL90AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"JMC Recording Results\"\n        title=\"\"\n        src=\"/static/a800e86e0f352147257682043e0a76fd/8c557/jmc_2.png\"\n        srcset=\"/static/a800e86e0f352147257682043e0a76fd/4edbd/jmc_2.png 175w,\n/static/a800e86e0f352147257682043e0a76fd/13ae7/jmc_2.png 350w,\n/static/a800e86e0f352147257682043e0a76fd/8c557/jmc_2.png 700w,\n/static/a800e86e0f352147257682043e0a76fd/e996b/jmc_2.png 1050w,\n/static/a800e86e0f352147257682043e0a76fd/2cefc/jmc_2.png 1400w,\n/static/a800e86e0f352147257682043e0a76fd/82f50/jmc_2.png 1635w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote>\n<p><strong>SQL statements provided by JFR Events</strong></p>\n</blockquote>\n<blockquote>\n<p>select next<em>val as id</em>val from hibernate_sequence for update</p>\n</blockquote>\n<blockquote>\n<p>update hibernate<em>sequence set next</em>val= 6 where next_val=5</p>\n</blockquote>\n<blockquote>\n<p>insert into Post (content, createDate, title, id) values (â€˜Some content 0dfbf216-4e93-46cd-8f2f-25999e7114bdâ€™, â€˜2020-12-342 22:12:75â€™, â€˜Post #1â€™, 1)</p>\n</blockquote>\n<blockquote>\n<p>insert into Post (content, createDate, title, id) values (â€˜Some content e23c1061-95f4-4960-a484-90e3483165e7â€™, â€˜2020-12-342 22:12:09â€™, â€˜Post #2â€™, 2)</p>\n</blockquote>\n<blockquote>\n<p>insert into Post (content, createDate, title, id) values (â€˜Some content c102d6c3-a070-466f-9ff4-44cc69bb20d0â€™, â€˜2020-12-342 22:12:14â€™, â€˜Post #3â€™, 3)</p>\n</blockquote>\n<blockquote>\n<p>insert into Post (content, createDate, title, id) values (â€˜Some content 5c7c2083-68ec-4b1d-b911-95942facddb0â€™, â€˜2020-12-342 22:12:19â€™, â€˜Post #4â€™, 4)</p>\n</blockquote>\n<blockquote>\n<p>insert into Post (content, createDate, title, id) values (â€˜Some content a8118b5b-f3d4-4fa5-b796-01a33f79bab4â€™, â€˜2020-12-342 22:12:23â€™, â€˜Post #5â€™, 5)</p>\n</blockquote>\n<p>The second important thing I mentioned that it is worth to notice is that we can define <code class=\"language-text\">Event settings</code> - file which allows customizing what events are record and how often. By default, OpenJDK 11 provides two setting files</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">jdk11\n  â”œâ”€â”€ bin\n  â”œâ”€â”€ conf\n  â”œâ”€â”€ demo\n  â”œâ”€â”€ include\n  â”œâ”€â”€ jmods\n  â”œâ”€â”€ legal\n  â”œâ”€â”€ lib\n  â”‚   â””â”€â”€ jfr\n  â”‚       â”œâ”€â”€ default.jfc\n  â”‚       â””â”€â”€ profile.jfc\n  â”œâ”€â”€ <span class=\"token function\">man</span>\n  â””â”€â”€ release</code></pre></div>\n<p><strong><code class=\"language-text\">default.jfc</code></strong> - â€œLow overhead configuration safe for continuous use in production environments, typically less than 1 % overhead.â€</p>\n<p><strong><code class=\"language-text\">profile.jfc</code></strong> - â€œLow overhead configuration for profiling, typically around 2 % overhead.â€</p>\n<p>If we would like to ignore for instance <code class=\"language-text\">QueryEvent</code> from recordings we could disable it through <code class=\"language-text\">jfc</code> file like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token comment\">&lt;!-- Rest of the file ommited for better readability --></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>event</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>io.ajurasz.QueryEvent<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>setting</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>enabled<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>false<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>setting</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>event</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span>  </code></pre></div>\n<ol start=\"2\">\n<li>JVM</li>\n</ol>\n<p>It is possible to enable recording at process startup using <code class=\"language-text\">-XX:StartFlightRecording</code> JVM option. Following command will dump recordings on exit to a file named <code class=\"language-text\">sample.jfr</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">java -XX:StartFlightRecording<span class=\"token operator\">=</span>disk<span class=\"token operator\">=</span>true,dumponexit<span class=\"token operator\">=</span>true,filename<span class=\"token operator\">=</span>sample.jfr -jar target/hibernate-logging-1.0-SNAPSHOT-jar-with-dependencies.jar</code></pre></div>\n<p>Above option is so nice that it additionally prints instruction in the console on how to dump recording to a file on demand (if we donâ€™t want to wait until process exits):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">âœ  hibernate-jfr-logging git:<span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">)</span> âœ— java -XX:StartFlightRecording<span class=\"token operator\">=</span>disk<span class=\"token operator\">=</span>true,dumponexit<span class=\"token operator\">=</span>true,filename<span class=\"token operator\">=</span>sample.jfr -jar target/hibernate-logging-1.0-SNAPSHOT-jar-with-dependencies.jar\nStarted recording <span class=\"token number\">1</span>. No limit specified, using <span class=\"token assign-left variable\">maxsize</span><span class=\"token operator\">=</span>250MB as default.\n\nUse jcmd <span class=\"token number\">24288</span> JFR.dump <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> to copy recording data to file.\nDec 07, <span class=\"token number\">2020</span> <span class=\"token number\">9</span>:26:23 PM org.hibernate.Version logVersion\nINFO: HHH000412: Hibernate ORM core version <span class=\"token punctuation\">[</span>WORKING<span class=\"token punctuation\">]</span>\nDec 07, <span class=\"token number\">2020</span> <span class=\"token number\">9</span>:26:23 PM org.hibernate.annotations.common.reflection.java.JavaReflectionManager <span class=\"token operator\">&lt;</span>clinit<span class=\"token operator\">></span>\nINFO: HCANN000001: Hibernate Commons Annotations <span class=\"token punctuation\">{</span><span class=\"token number\">5.1</span>.0.Final<span class=\"token punctuation\">}</span>\nDec 07, <span class=\"token number\">2020</span> <span class=\"token number\">9</span>:26:24 PM org.hibernate.dialect.Dialect <span class=\"token operator\">&lt;</span>init<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<ol start=\"3\">\n<li>jcmd</li>\n</ol>\n<p><code class=\"language-text\">jcmd</code> utility is used to send diagnostic command requests to the JVM. Some of the commands are designed to control <code class=\"language-text\">JFR</code> in a running process. Following commands shows how to start, dump and stop recording:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">âœ  hibernate-jfr-logging git:<span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">)</span> jcmd <span class=\"token number\">25024</span> JFR.start <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>MyRecording\nâœ  hibernate-jfr-logging git:<span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">)</span> jcmd <span class=\"token number\">25024</span> JFR.dump <span class=\"token assign-left variable\">filename</span><span class=\"token operator\">=</span>sample.jfr\nâœ  hibernate-jfr-logging git:<span class=\"token punctuation\">(</span>master<span class=\"token punctuation\">)</span> jcmd <span class=\"token number\">25024</span> JFR.stop <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>MyRecording</code></pre></div>\n<h2>Conclusion</h2>\n<p><code class=\"language-text\">JFR</code> looks to be a great tool for troubleshooting errors occurring on production, especially that it does not require to restart already running application.</p>\n<p>Source code of the sample application that logs full SQL statements can be found on <a href=\"https://github.com/ajurasz/hibernate-jfr-logging\">github</a>.</p>","frontmatter":{"title":"Use JDK Flight Recorder to log SQL queries","date":"December 7, 2020"}}},{"node":{"fields":{"slug":"/2020-11-23-aws-lambda-custom-runtime/"},"html":"<p>AWS Lambda support many <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html\">build in runtimes</a>. But we also have a possibility to create custom runtimes to run functions in a language that is not yet supported by Lambda service or when we need to do some extra optimization (i.e. reduce startup time or memory footprint of functions build for JVM). Today we will learn how to build a very simple runtime focusing mainly on steps required to do so.</p>\n<!-- end -->\n<h2>Custom runtime</h2>\n<p>Every runtime is executed on Amazon Linux or Amazon Linux 2 operating system. In case of JVM, functions need at least a Java Runtime Environment (JRE) to run a <code class=\"language-text\">jar</code> but it wonâ€™t be available out of the box on mentioned systems. Thankfully starting from Java 9 a <code class=\"language-text\">jlink</code> tool was introduced which creates a customized JRE that contains only these modules that are required by your own module - this way JRE can be part of the deployment package.</p>\n<p>To create a runtime we need a <code class=\"language-text\">bootstrap</code> file to be present in the root of a deployment package. This file is an entry point for the custom runtime and will be called by Lambda as part of <code class=\"language-text\">init</code> phase.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f60c089ea1f585cd0857a47ec3dbe386/29007/lambda-execution-environment-lifecycle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 18.857142857142858%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAx0lEQVQI1x2Ku04DMRRE9///BdGGiFRQ0CAR0YAikrAgwq7j+HFt34fXNg6jU5wZzTAHmDwoi8ZDDFNKltBSOl/pQoGSIuxVs5CPcrakIE7gXUrD3fh+fxgft3H3cdSH26SfG77SvOq0uG10XPQ6/q6re2gN9z+yeZo2u/Hm7eXTm8EIGmZlGEIsrEr2dYHgvju1e0EKJ2e+CuvWCnKdLzgqfQKHWYZFck+IAYk5V5I+VOuj9YmlsCwQSVugq2f5f+qLSQlZ5A8imOChMNa4bwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Lambda execution environment lifecycle\"\n        title=\"\"\n        src=\"/static/f60c089ea1f585cd0857a47ec3dbe386/8c557/lambda-execution-environment-lifecycle.png\"\n        srcset=\"/static/f60c089ea1f585cd0857a47ec3dbe386/4edbd/lambda-execution-environment-lifecycle.png 175w,\n/static/f60c089ea1f585cd0857a47ec3dbe386/13ae7/lambda-execution-environment-lifecycle.png 350w,\n/static/f60c089ea1f585cd0857a47ec3dbe386/8c557/lambda-execution-environment-lifecycle.png 700w,\n/static/f60c089ea1f585cd0857a47ec3dbe386/e996b/lambda-execution-environment-lifecycle.png 1050w,\n/static/f60c089ea1f585cd0857a47ec3dbe386/2cefc/lambda-execution-environment-lifecycle.png 1400w,\n/static/f60c089ea1f585cd0857a47ec3dbe386/29007/lambda-execution-environment-lifecycle.png 1600w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote>\n<p>Source: <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-context.html\">https://docs.aws.amazon.com/lambda/latest/dg/runtimes-context.html</a></p>\n</blockquote>\n<h2>Deployment package</h2>\n<p>So far we know that custom runtime will require a <code class=\"language-text\">bootstrap</code> file and custom JRE. Since we will be working with (<a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html\">SAM CLI</a>) we can use the possibility to customize <code class=\"language-text\">build</code> command. This can be done by providing <code class=\"language-text\">Metadata</code> resource attribute with a <code class=\"language-text\">BuildMethod: makefile</code> entry</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">NaiveJavaRuntimeFunction</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Serverless<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Function\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CodeUri</span><span class=\"token punctuation\">:</span> NaiveJavaRuntime\n      <span class=\"token key atrule\">Handler</span><span class=\"token punctuation\">:</span> do.not.apply\n      <span class=\"token key atrule\">Runtime</span><span class=\"token punctuation\">:</span> provided\n      <span class=\"token key atrule\">MemorySize</span><span class=\"token punctuation\">:</span> <span class=\"token number\">128</span>\n    <span class=\"token key atrule\">Metadata</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">BuildMethod</span><span class=\"token punctuation\">:</span> makefile</code></pre></div>\n<p>By convention <code class=\"language-text\">sam build</code> will look for <code class=\"language-text\">build-NaiveJavaRuntimeFunction</code> target in a <code class=\"language-text\">Makefile</code>. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">build-NaiveJavaRuntimeFunction:\n  @ mvn clean package\n  @ chmod +x ./target/classes/bootstrap\n  @ cp -rf ./target/classes/bootstrap $(ARTIFACTS_DIR)\n  @ jlink --module-path ./target/naive-java-runtime.jar:$(JAVA_HOME)/jmods \\\n         --add-modules  naive.java.runtime \\\n         --output ./target/dist \\\n         --launcher executable=naive.java.runtime/io.github.ajurasz.naivejavaruntime.Bootstrap \\\n         --compress 2 --no-header-files --no-man-pages --strip-debug\n  @ cp -rf ./target/dist $(ARTIFACTS_DIR)</code></pre></div>\n<p>Hereâ€™s what is happening:</p>\n<ol>\n<li>Build package using maven</li>\n<li>Change <code class=\"language-text\">bootstrap</code> file permission</li>\n<li>Copy <code class=\"language-text\">bootstrap</code> file (which is part of project resources) to <code class=\"language-text\">ARTIFACTS_DIR</code></li>\n<li>Build custom JRE. Notice <code class=\"language-text\">--launcher</code> option which will create an executable file (<code class=\"language-text\">dist/bin/executable</code>) which when called will run the main method</li>\n<li>Copy output created by <code class=\"language-text\">jlink</code> to <code class=\"language-text\">ARTIFACTS_DIR</code></li>\n</ol>\n<p>At the end <code class=\"language-text\">ARTIFACTS_DIR</code> will look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">.</span>\nâ”œâ”€â”€ bootstrap\nâ””â”€â”€ dist\n    â”œâ”€â”€ bin\n    â”‚   â”œâ”€â”€ executable\n    â”‚   â”œâ”€â”€ java\n    â”‚   â””â”€â”€ keytool\n    â”œâ”€â”€ conf\n    â”‚   â”œâ”€â”€ net.properties\n    â”‚   â””â”€â”€ security\n    â”œâ”€â”€ legal\n    â”‚   â”œâ”€â”€ java.base\n    â”‚   â””â”€â”€ java.net.http\n    â”œâ”€â”€ lib\n    â”‚   â”œâ”€â”€ classlist\n    â”‚   â”œâ”€â”€ jexec\n    â”‚   â”œâ”€â”€ jli\n    â”‚   â”œâ”€â”€ jrt-fs.jar\n    â”‚   â”œâ”€â”€ jspawnhelper\n    â”‚   â”œâ”€â”€ jvm.cfg\n    â”‚   â”œâ”€â”€ libjava.so\n    â”‚   â”œâ”€â”€ libjimage.so\n    â”‚   â”œâ”€â”€ libjsig.so\n    â”‚   â”œâ”€â”€ libnet.so\n    â”‚   â”œâ”€â”€ libnio.so\n    â”‚   â”œâ”€â”€ libverify.so\n    â”‚   â”œâ”€â”€ libzip.so\n    â”‚   â”œâ”€â”€ modules\n    â”‚   â”œâ”€â”€ security\n    â”‚   â”œâ”€â”€ server\n    â”‚   â””â”€â”€ tzdb.dat\n    â””â”€â”€ release</code></pre></div>\n<p>When the function was deployed we can give it a try in Lambda console.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c15081c31a4d6f0ea43beb009be77521/d004c/lambda-function-output.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.14285714285714%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAC4jAAAuIwF4pT92AAABGElEQVQoz22Rx5LEIAxE/f8fOTsBB0wOBmwfepAm1FbtHl4JtYJNMwh1xW3+wbjecF8f0HGFzYSCTStj0iv3m4Z743/BedHcMygvIfUCnyxctAjZwRMlvmJyXNtaQj0L6rEx5R9yixhWN2NWI0JxjN8sUgvI+4fYGwNM7H+YDVyH+khLf/AYpJswKcEDpl+XCMVyMVb3jULeueYyXdOw/iE2xz0EL5y1QKi0xH2LtJQGCVoydn+n3qeD7HZ0e0h/+0ezn48Pi5lwuV4wzgJiemBcRoj5wb4qu7KHIXuE5OHjy9OwJcQOaVSrR/d2L4jdisEEhUVKKK2hjYYxhs85Z9RasR870/aG8zw7B1prOCh2jel5KYUf9Al3HRYl6YsobgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Lambda function output\"\n        title=\"\"\n        src=\"/static/c15081c31a4d6f0ea43beb009be77521/8c557/lambda-function-output.png\"\n        srcset=\"/static/c15081c31a4d6f0ea43beb009be77521/4edbd/lambda-function-output.png 175w,\n/static/c15081c31a4d6f0ea43beb009be77521/13ae7/lambda-function-output.png 350w,\n/static/c15081c31a4d6f0ea43beb009be77521/8c557/lambda-function-output.png 700w,\n/static/c15081c31a4d6f0ea43beb009be77521/e996b/lambda-function-output.png 1050w,\n/static/c15081c31a4d6f0ea43beb009be77521/2cefc/lambda-function-output.png 1400w,\n/static/c15081c31a4d6f0ea43beb009be77521/d004c/lambda-function-output.png 1611w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>Runtime</h2>\n<p>Beside initialization, custom runtime is also responsible for <a href=\"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html#runtimes-custom-build\">processing tasks</a> consisting of:</p>\n<ol>\n<li>Getting an event</li>\n<li>Propagating the tracing header</li>\n<li>Creating a context object</li>\n<li>Invoking the function handler</li>\n<li>Handling the response</li>\n<li>Handling errors</li>\n<li>Cleanup</li>\n</ol>\n<p>My naive implementation meets just three of these tasks. To support all of them it would require much more development and then the maintenance of that code. But there is a better alternative to reinventing the wheel - taking advantage of very impressive <a href=\"https://quarkus.io/guides/funqy-amazon-lambda\">Quarkus module</a>. Except that it provides an implementation for all processing tasks it also gives the possibility to build a native image which additionally lower memory footprint and accelerates initialization times. All this can be done with small adjustments to <a href=\"https://github.com/ajurasz/lambda-custom-runtime/blob/master/FunqyAmazonLambda/pom.xml\">pom.xml</a>. </p>\n<p>When the function was deployed we can give it a try in Lambda console.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1a57f36b47e77e7f875768909e73192d/12e1b/lambda-function-output-2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 37.14285714285714%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAC4jAAAuIwF4pT92AAABHUlEQVQoz3XQ6W7DIAwA4Lz/Q3Zrl5NgsDkasiF7DksqTdp+fPIphNz161u5j7fSm3t5mEexYSkumQJpLRDNi9PaZ/svfNq200EwsjojIaNQwlekLQpdefLy3JPsdZPy9Wy2P+TPKN3iRh5Nz5gdY4IW0x4UtZjP3KJhHy07RcdOIY6ndIoFuTN+khlGcXE9WQmbFx3+ioP5EAir+GT159D6l2N+6RY/8gQD0xNYG8oxKdS6yZb1EdYHebQ964m079hnaH29X9sPjefu+N3t/SbGLrLYWVYwsqyzWG8FVEgkMQe9LQlF/Km3rFLrHbP9a9P7Fsm73hDI1GEY6jRNdVTzPLcaAKrzroYQKhFWPCBqTg1ePeXR1xhTjVuo34hWFHZBQnGHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Lambda function output 2\"\n        title=\"\"\n        src=\"/static/1a57f36b47e77e7f875768909e73192d/8c557/lambda-function-output-2.png\"\n        srcset=\"/static/1a57f36b47e77e7f875768909e73192d/4edbd/lambda-function-output-2.png 175w,\n/static/1a57f36b47e77e7f875768909e73192d/13ae7/lambda-function-output-2.png 350w,\n/static/1a57f36b47e77e7f875768909e73192d/8c557/lambda-function-output-2.png 700w,\n/static/1a57f36b47e77e7f875768909e73192d/e996b/lambda-function-output-2.png 1050w,\n/static/1a57f36b47e77e7f875768909e73192d/2cefc/lambda-function-output-2.png 1400w,\n/static/1a57f36b47e77e7f875768909e73192d/12e1b/lambda-function-output-2.png 1607w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Please notice time difference between these two functions, native executable is 11 times faster. If it comes to deployment package size itâ€™s 30% smaller (24 MB instead of 34 MB).</p>\n<p>Source code can be found <a href=\"https://github.com/ajurasz/lambda-custom-runtime\">here</a>.</p>","frontmatter":{"title":"AWS Lambda custom runtime","date":"November 23, 2020"}}},{"node":{"fields":{"slug":"/2020-11-17-manage-schema-evolution-in-the-serverless-stack/"},"html":"<p>Looking on some of the AWS efforts around RDS service it wonâ€™t be an incorrect statement to say that they want to bring the world of relational databases closer to Lambda functions. First, <a href=\"https://aws.amazon.com/rds/aurora/serverless/\">Aurora Serverless</a> was <a href=\"https://aws.amazon.com/blogs/aws/aurora-serverless-ga/\">announced</a> then less than a year later this revolutionary service was extended by <a href=\"https://aws.amazon.com/blogs/aws/new-data-api-for-amazon-aurora-serverless/\">Data API</a> where interaction with DB is done through API endpoint. But this is not an end, the next year has come and we got <a href=\"https://aws.amazon.com/blogs/aws/amazon-rds-proxy-now-generally-available/\">RDS proxy</a> whose main task is to help improve applications scalability by managing DB connections.</p>\n<!-- end -->\n<p>All these improvements show us that relational databases are relevant for serverless applications otherwise AWS wouldnâ€™t put such a big effort in helping developers writing more efficient Lambda functions while working with RDS service.</p>\n<p>The main purpose of this introduction was to defend the topic of this blog post - <strong>managing schema evolution in the serverless stack</strong> - which I hope doesnâ€™t sound too abstract now. As befits a Java developer I could not resist bringing my own toolset to face the issue. The toolset consists of Java 11, Maven and Flyway.</p>\n<h2>CloudFormation</h2>\n<p>Letâ€™s say that on the design level it was decided that the relational database will be best suited for the job. The first thing that arises is how can we initialize the RDS database with initial schema and then manage the evolution of that schema when all we have are just single-purpose functions containing business logic. There are multiple approaches to tackle this issue, <a href=\"https://stackoverflow.com/questions/14384849/is-there-a-way-to-run-initial-sql-when-creating-an-rds-database-instance-using-c\">here</a> you will find some interesting suggestions. I decided to take advantage of CloudFormation(CF) <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html\">Custom Resources</a>. This has some limitation which will be mentioned later on - but do not worry I will also show how to overcome them.</p>\n<p>My main goal was to set up a single-click deployment solution so that anyone could try and run this on his own AWS account. Since I will be using CF this will be not an issue. Furthermore, the main resource will be a Lambda function, in this case, itâ€™s advisable to use AWS Serverless Application Model (AWS SAM) a template specification which provides a simple and clean way of describing Lambda functions (together with API endpoints if needed). But the specification is not all, we additionally get the utility tool (<a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html\">SAM CLI</a>) which brings building, testing and deploying Lambda functions to the next level.  </p>\n<h2>Custom Resource</h2>\n<p>While new services are introduced on AWS they not always are immediately supported in CF, for this reason, Custom Resources where created which brings back doors to AWS API so that itâ€™s possible to interact with these new services through code. Custom Resources can be also used to provide side effects like cleanup s3 bucket while removing a stack or run schema migration against DB like it will be in our case. Defining Custom Resource is very simple, we only need to provide <code class=\"language-text\">ServiceToken</code> which points to Lambda function or SNS topic:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">LambdaMigrationFunctionTrigger</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> Custom<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>LambdaMigrationFunctionTrigger\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ServiceToken</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> MigrationFunction.Arn</code></pre></div>\n<p>Base on this information CF sends <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/crpg-ref-requests.html\">request object</a> any time when this resource is created, updated or deleted. </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n   <span class=\"token property\">\"RequestType\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Create\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"ResponseURL\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"http://pre-signed-S3-url-for-response\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"StackId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:cloudformation:us-west-2:123456789012:stack/stack-name/guid\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"RequestId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"unique id for this create request\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"ResourceType\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Custom::TestResource\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"LogicalResourceId\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"MyTestResource\"</span><span class=\"token punctuation\">,</span>\n   <span class=\"token property\">\"ResourceProperties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Value\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"List\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3\"</span> <span class=\"token punctuation\">]</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Whenever CF stack is created or delete a request will be sent to target service, but to trigger an update request one of Custome Resource property needs to be updated. For our case, this is very important because most of the time Custom Resource should be triggered while updating Lambda function with new migration scripts. This limitation can be overcome by introducing a fake property (<code class=\"language-text\">DeployTimestamp</code>) which the only purpose will be to hold different value whenever CF stack is updated.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Parameters</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">DeployTimestamp</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> Number\n    <span class=\"token key atrule\">Default</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n<span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">LambdaMigrationFunctionTrigger</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> Custom<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>LambdaMigrationFunctionTrigger\n    <span class=\"token key atrule\">Properties</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ServiceToken</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!GetAtt</span> MigrationFunction.Arn\n      <span class=\"token key atrule\">DeployTimestamp</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!Ref</span> DeployTimestamp</code></pre></div>\n<p>Value of this property wonâ€™t change out of the box but can be easily overridden while uploading template from CLI</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># AWS CLI</span>\naws cloudformation package --template-file <span class=\"token variable\">$TEMPLATE</span> --s3-bucket <span class=\"token variable\">$AWS_S3_BUCKET</span> --output-template-file out.yml\naws cloudformation deploy --template-file out.yml --stack-name <span class=\"token variable\">$STACK_NAME</span> --capabilities CAPABILITY_IAM --parameter-overrides <span class=\"token assign-left variable\">DeployTimestamp</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%s<span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># SAM CLI </span>\nsam deploy --stack-name <span class=\"token variable\">$STACK_NAME</span> --capabilities CAPABILITY_IAM --parameter-overrides <span class=\"token assign-left variable\">DeployTimestamp</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%s<span class=\"token variable\">)</span></span></code></pre></div>\n<p>Now CF will send update requests to Lambda function every time the CF stack if updated.</p>\n<h2>Architecture</h2>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/256ae5773ad607054c4b3c169f385da7/01dae/flyless-architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 103.42857142857143%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsSAAALEgHS3X78AAAD40lEQVQ4y21US4tcRRTu3+BvEFy40oUbVwr+iYgbdwpuhIBEUXyRIAEhGASN8RE3BiKjwowZZ4Yw0zMuJDIPkmmmp3N7uu+t+34/6r4/T1Xf7umYFBxO3bpfnfrOOV9V79rOF+AFR15x8Grm8yrvPFmZIUeDbLSLeO0yeMiQNxWtL2PzxbxX0c+njnbuZ5Ni6zqSyy+jmR52681Tt/VE5PngxGZ+QCtjtbRvtpG7Gsx/ViXjBUb8/5/JgG3HYvV4BX3lHia+ApXtw80cuKkNJzFRdIfePVnF9mgDU38sceK/m1oSU9alCJgvGAaZCzU1YN//BfzG63AGf0EnsJGa4OwBqn9XEEQMWjSFHpJFKoxIkybmRV2gJ9JsRFpEMsw8MApg7a/AvfEmzMEG9MSAmXsID9fg3HwLvquAJToFUReBhGd0QFFTU1qcF7eoEvicUiCmw9N96T1Kyecu4siDzYhFFUuMWPeycy/SrkTKt3/7Ax98ehX3dvbg5S38tCDGLUmgRl6U1IRK+pK+xTDiAn5WoiZMWbfUoFbOhZdNefvi+3j2hVdw9cuvsKWE2DyxMHRSPHRLaCGHHueUVk4KEJ1t8OfAwubQxqnAmDFUwhiEYYQp6ga9W7fv4N1Ln2Fja5sECzDDhzHVYB3sgukOmB1SE3LJuKlrEn8jD2CdiUOFicAF/esNRkOsb+7AskkiSQaFTnW3f0J98wI1Zx3MK6jgmQzYUsCAV5gGfBFsObBkePGjz/H8S6/h+jc/IqOanOkB1MM+zDsfQ1NOoNsxbeCylm1VIswryYYtsXws4HufXMFzL76Ka19/h4yko0xM3D9WsHswwNFIg2b6klHeicHnNc78TAYV68LEfCIwImXbc6BqOtI0kxtSStvRTbCJCocZiFKOkPpRmiOU+7+jJd2mVYuYmMZFhYi8YB1SKUSne1VbLnR4xEKcBTli2uCSNDgxzqsKAhEfrMMjsR+dnmEclEgoSMBLZGUtUxXsGiEbTs+Q0J0Y24qH3aGJCXX6kUosLR+al4DFJfwgRGhq2Bk56I89DO1Eykakr3Xpy5TP73KLjBZCL8Ta38e49MMeHkx8mBRUDXOUXQ1zYmOS7ozOnmjK8uNgJwWiOMMbH36PZy7cws/9CTwvwFRqrJaHilsiZdPpby6dhQ7P38OW7mQBx4vwa/8h3vl2DwdaTAw9Cc67qyfqNg0yKSVtKegc0xMXej6iooWmuZhQ/ZSxiqlmw7BCqqHo4AwTk360sKArWdKNOTdGJjA9O7Go9SEiHsBJfei+hbE2xqOpgok+gRm5VCuPUg0I12Ho5RFrj1k0w/wHRMkiKDsRN4cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Flyless architecture\"\n        title=\"\"\n        src=\"/static/256ae5773ad607054c4b3c169f385da7/8c557/flyless-architecture.png\"\n        srcset=\"/static/256ae5773ad607054c4b3c169f385da7/4edbd/flyless-architecture.png 175w,\n/static/256ae5773ad607054c4b3c169f385da7/13ae7/flyless-architecture.png 350w,\n/static/256ae5773ad607054c4b3c169f385da7/8c557/flyless-architecture.png 700w,\n/static/256ae5773ad607054c4b3c169f385da7/01dae/flyless-architecture.png 721w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>The sample architecture was prepared with an emphasis on security best practices for DBs running in the AWS cloud. </p>\n<ul>\n<li>DB instance is running in private subnet without ingress traffic from the internet. </li>\n<li>Restricted security group is assigned to this instance which allows only access from <code class=\"language-text\">FnSecurityGroup</code> source which in turn is associated with our Lambda function (<code class=\"language-text\">MigrationFunction</code>). </li>\n<li>DB credentials are stored in <a href=\"https://aws.amazon.com/secrets-manager/\">AWS Secrets Manager</a>, this way there is no need to pass sensitive data directly to Lambda function. </li>\n<li>Execution role associated with Lambda function allows it to fetch DB credentials.</li>\n</ul>\n<p>Because RDS is running in private subnet without internet access, Lambda function had to be deployed within VPC. One of the Lambda function characteristics is that it cannot have a public IP address - to meet this requirements Lambda function needs to be deployed in a private subnet.\nSo how can we provide internet access for functions that need to be run in VPC? There are two options, set up a NAT Gateway or create VPC Endpoint for every service you need to communicate with. As shown in the above diagram we will use the first option.</p>\n<h2>Deployment</h2>\n<p>Itâ€™s finally time to get our hands dirty and run some code. First of all clone <a href=\"https://github.com/ajurasz/flyless\">repository</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/ajurasz/flyless.git</code></pre></div>\n<blockquote>\n<p><strong>NOTICE:</strong> See <a href=\"https://github.com/ajurasz/flyless#prerequisites\">Prerequisites</a> section in readme file.</p>\n</blockquote>\n<p>then run</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./deploy.sh</code></pre></div>\n<blockquote>\n<p><strong>NOTICE:</strong> While running script itâ€™s expected that AWS CLI was configured.</p>\n</blockquote>\n<p>Few interesting things are happening inside this script.</p>\n<h3>Building</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sam build</code></pre></div>\n<p>will build our maven project and run integration tests. These tests run schema migration against <strong>real DB</strong> - same version that will be used in AWS - all of this was done with the help of <a href=\"https://www.testcontainers.org/\">Testcontainers</a>. With this library test code can be as easy and clean as:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Testcontainers</span>\n<span class=\"token annotation punctuation\">@ExtendWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MockitoExtension</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MigrationHandlerIT</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Container</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MySQLContainer</span> mysql <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MySQLContainer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DockerImageName</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mysql:5.7.31\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withDatabaseName</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RDS_DB_NAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withUsername</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RDS_USERNAME\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">withPassword</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RDS_PASSWORD\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Mock</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">CfnResponse</span> cfnResponse<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">EnvironmentVariables</span><span class=\"token punctuation\">.</span><span class=\"token function\">getenv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RDS_PORT\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">+</span> mysql<span class=\"token punctuation\">.</span><span class=\"token function\">getFirstMappedPort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should run all migration scripts\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token keyword\">var</span> migrationHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MigrationHandler</span><span class=\"token punctuation\">(</span>cfnResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> input <span class=\"token operator\">=</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">.</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"RequestType\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Create\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"RequestId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RequestId\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"ResponseURL\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://pre-signed-S3-url-for-response\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"StackId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"arn:aws:cloudformation:us-east-1:123456789012:stack/MyStack/guid\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"LogicalResourceId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MyTestResource\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// when</span>\n        <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> migrationHandler<span class=\"token punctuation\">.</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DummyContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token class-name\">Assert</span><span class=\"token punctuation\">.</span><span class=\"token function\">assertEquals</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>cfnResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>SUCCESS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CfnEvent</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">any</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Environment variables used in the test were setup through <code class=\"language-text\">maven-failsafe-plugin</code></p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>plugin</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>maven-failsafe-plugin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>2.22.2<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>environmentVariables</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RDS_DB_NAME</span><span class=\"token punctuation\">></span></span>db_name<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RDS_DB_NAME</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RDS_USERNAME</span><span class=\"token punctuation\">></span></span>user<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RDS_USERNAME</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RDS_PASSWORD</span><span class=\"token punctuation\">></span></span>password<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RDS_PASSWORD</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RDS_HOST</span><span class=\"token punctuation\">></span></span>localhost<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RDS_HOST</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>DB_STAGE</span><span class=\"token punctuation\">></span></span>test<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>DB_STAGE</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AWS_SAM_LOCAL</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AWS_SAM_LOCAL</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>environmentVariables</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>executions</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>execution</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>integration-test<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goals</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goal</span><span class=\"token punctuation\">></span></span>integration-test<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goal</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goal</span><span class=\"token punctuation\">></span></span>verify<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goal</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goals</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>execution</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>executions</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>plugin</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Tests can be also run independently without SAM CLI</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mvn -f MigrationFunction/pom.xml clean verify</code></pre></div>\n<h3>Imitating AWS Lambda service</h3>\n<p>When I wrote that SAM CLI brings testing to the next level, here is why. There is a possibility to invoke function locally with </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sam <span class=\"token builtin class-name\">local</span> invoke</code></pre></div>\n<p>Under the hood SAM CLI setup infrastructure using docker containers that imitate AWS then it deploys our code to that infrastructure and finally executes that code. To run the migration function which depends on an external database all needed containers needs to be run under a single network.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker network create --driver bridge sam_flyless_newtork\ndocker run --rm -d --name sam_flyless_mysql --network sam_flyless_newtork -e <span class=\"token assign-left variable\">MYSQL_RANDOM_ROOT_PASSWORD</span><span class=\"token operator\">=</span>yes -e <span class=\"token assign-left variable\">MYSQL_DATABASE</span><span class=\"token operator\">=</span><span class=\"token variable\">$DB_NAME</span> -e <span class=\"token assign-left variable\">MYSQL_USER</span><span class=\"token operator\">=</span><span class=\"token variable\">$DB_USERNAME</span> -e <span class=\"token assign-left variable\">MYSQL_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\">$DB_PASSWORD</span> mysql:5.7.31\n\nsam <span class=\"token builtin class-name\">local</span> invoke --event events/create_event.json --docker-network sam_flyless_newtork --env-vars env.json</code></pre></div>\n<p>This way Lambda function will have direct access to DB container prepared in advance.\nTo have better control over what event will trigger the function or which environment variables will be available in the runtime following options can be specified <code class=\"language-text\">--event</code> (path to JSON file containing an event) and  <code class=\"language-text\">--env-vars</code> (path to JSON file containing environment variables available for the Lambda function).</p>\n<blockquote>\n<p><strong>NOTICE:</strong> While passing environment variables through <code class=\"language-text\">--env-vars</code> option, only these that are expected by the function will be passed to the environment - others will be ignored.</p>\n</blockquote>\n<h2>Demo</h2>\n<p><img src=\"/5ea780917802f0a44d8ee533187d82af/demo.gif\" alt=\"Demo\"></p>\n<h2>Cleanup</h2>\n<p>CF stack can be removed with ease with a single command</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws cloudformation delete-stack --stack-name <span class=\"token variable\">$STACK_NAME</span></code></pre></div>\n<p>As mentioned before, while CF stack is deleted a delete request is sent to the target service and CF expect to receive a response. To provide Lamdba function possibility to respond to CF, NAT Gateway needs to stay operational. We can ensure that all required resources will not be deleted until itâ€™s still needed by Lambda function with <a href=\"https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-dependson.html\">DependsOn</a> attribute - which helps to explicitly mark dependencies between resources.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">Resources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">MigrationFunction</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">Type</span><span class=\"token punctuation\">:</span> AWS<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Serverless<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>Function\n    <span class=\"token key atrule\">DependsOn</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> DB\n      <span class=\"token punctuation\">-</span> PublicRTAssociation1\n      <span class=\"token punctuation\">-</span> PublicRTAssociation2\n      <span class=\"token punctuation\">-</span> PublicRTRouteToInternet\n      <span class=\"token punctuation\">-</span> PrivateRTAssociation3\n      <span class=\"token punctuation\">-</span> PrivateRTAssociation4\n      <span class=\"token punctuation\">-</span> PrivateRTRouteToNG\n      <span class=\"token punctuation\">-</span> IGAttachment</code></pre></div>\n<h2>Conclusion</h2>\n<p>While working with relational databases in the serverless stack I donâ€™t see any disadvantage of maintaining schema evolution in the way it was described. I just want to alert you to a fact that we must remember - execution time of Lambda function can be up to 15 min, so if you expect that your migration could take longer then you should think about a different approach.</p>","frontmatter":{"title":"Managing schema evolution in the serverless stack","date":"November 17, 2020"}}},{"node":{"fields":{"slug":"/2020-04-12-continuous-deployment-on-kubernetes/"},"html":"<p>If you are wondering how could you set up your build pipeline to do a deployment of your application to Kubernetes cluster then you can find this post interesting.</p>\n<!-- end -->\n<h2>Disclaimer</h2>\n<p>Everything that will be presented in this blog post was only used for Test and QA environments as a way to learn more about Kubernetes. It was not used for Prod environment yet so please keep this in your mind.</p>\n<h2>Stack</h2>\n<p>Before moving to details itâ€™s worth mentioning what I have to disposal:</p>\n<ul>\n<li>Kubernetes cluster</li>\n<li>Jenkins pipeline job</li>\n<li>Private Docker registry</li>\n<li>Dockerized application</li>\n</ul>\n<h2>Build</h2>\n<p>Since Jenkins pipeline job is in place then the deployment is as easy as adding a new stage to an existing job pipeline. I have called mine <code class=\"language-text\">Deploy</code>. This stage is responsible for the following:</p>\n<ul>\n<li>run only on <code class=\"language-text\">develop</code> branch</li>\n<li>build docker image</li>\n<li>push the docker image to a repository</li>\n<li>call <a href=\"https://jenkins.io/doc/pipeline/steps/kubernetes-cd/#kubernetes-continuous-deploy-plugin\">Kubernetes Continuous Deploy Plugin</a></li>\n<li>remove docker image from Jenkins worker (just to save space)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pipeline {\n    stages {\n        stage(&#39;Deploy&#39;) {\n            when {\n                branch &quot;develop&quot;\n            }\n\n            environment {\n                DOCKER_REPOSITORY = &#39;127.0.0.1:5000&#39;\n                IMAGE_NAME = &#39;app&#39;\n                IMAGE_TAG = sh(script: &quot;git log -1 --pretty=%h&quot;, returnStdout: true).trim()\n                APP_IMAGE = &quot;${DOCKER_REPOSITORY}/${IMAGE_NAME}:${IMAGE_TAG}&quot;\n            }\n\n            steps {\n                sh &quot;&quot;&quot;\n                docker build -t ${APP_IMAGE} ./docker\n                &quot;&quot;&quot;\n\n                sh &quot;&quot;&quot;\n                docker push ${APP_IMAGE}\n                &quot;&quot;&quot;\n\n                kubernetesDeploy(kubeconfigId: &#39;k8s-config&#39;, configs: &#39;**/k8s/qa/app.yml&#39;)\n            }\n\n            post {\n                always {\n                    sh &quot;&quot;&quot;\n                    docker rmi ${APP_IMAGE}\n                    &quot;&quot;&quot;\n                }\n            }\n        }\n    }\n}</code></pre></div>\n<p>In the above snippet, there are two important things to notice. First is the registration of environment variable with name <code class=\"language-text\">APP_IMAGE</code>. The second most important thing is that kubernetes-cd plugin can substitute variables in the form of <code class=\"language-text\">${APP_IMAGE}</code> in the configuration file (<code class=\"language-text\">app.yml</code>) with variables from Jenkins environment. This is the default behaviour of the plugin and can be disabled with <code class=\"language-text\">enableConfigSubstitution</code> set to <code class=\"language-text\">false</code>.</p>\n<p>Kubernetes configuration consists of the standard objects needed for deploying an application to the cluster</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: app-qa\n  labels:\n    app: app-qa\n    env: qa\nspec:\n  replicas: 1\n  revisionHistoryLimit: 1\n  selector:\n    matchLabels:\n      app: app-qa\n      env: qa\n  template:\n    metadata:\n      labels:\n        app: app-qa\n        env: qa\n    spec:\n      containers:\n        - name: app-qa\n          image: ${APP_IMAGE}\n          imagePullPolicy: &quot;IfNotPresent&quot;\n          ports:\n            - containerPort: 8080\n          env:\n            - name: SPRING_PROFILES_ACTIVE\n              value: qa\n          resources:\n            limits:\n              cpu: 500m\n              memory: 256Mi\n            requests:\n              cpu: 500m\n              memory: 256Mi\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: app-qa\n  labels:\n    app: app-qa\n    env: qa\nspec:\n  type: NodePort\n  ports:\n    - port: 8080\n      nodePort: 31000\n  selector:\n    app: app-qa\n    env: qa</code></pre></div>\n<p>When the above configuration is applied then Kubernetes only updates these object that did change. So in case of successive deployment, only <code class=\"language-text\">Deployment</code> object is updated which represents our application. <code class=\"language-text\">revisionHistoryLimit</code> is an extra configuration which keeps previous <code class=\"language-text\">Deployment</code> object just in case if rollback is necessary.</p>","frontmatter":{"title":"Continuous Deployment on Kubernetes","date":"April 12, 2020"}}},{"node":{"fields":{"slug":"/2019-12-28-accessing-request-data-from-outside-of-calling-thread/"},"html":"<p>Itâ€™s almost end of 2019 but there is still a lot of application which depends on Servlet specification - this statement is base on my personal experience where I still see the majority of a new application being built using this technology. In this blog post, I will focus on a single use case where we will retrieve HTTP request data from outside of calling thread in <code class=\"language-text\">Spring Framework</code>.</p>\n<!-- end -->\n<h2>Problem</h2>\n<p>When using <code class=\"language-text\">spring-webmvc</code> in a standard way - according to Servlet 2.5 specification - then every incoming request is bound to a single thread for a life of that request (calling thread). Everything is fine until you start to do some <em>side processing in child thread</em>. This is a common case when moving to less coupled communicating between modules in an application through Springâ€™s event bus. </p>\n<p>Letâ€™s consider the following scenario:</p>\n<ol>\n<li>Rest controller calls service</li>\n<li>Service publish event </li>\n<li>Event is processed by the listener in a new thread</li>\n<li>The listener uses a service which at some point - in execution chain - requires data from the HTTP request</li>\n</ol>\n<p>Output from above scenario will be sucessfull response to the client from rest controller and exception in logs saying that we try to access request attributes outside of an actual web request i.e:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">java.lang.IllegalStateException: No thread-bound request found: Are you referring to request attributes outside of an actual web request, or processing a request outside of the originally receiving thread? If you are actually operating within a web request and still receive this message, your code is probably running outside of DispatcherServlet: In this case, use RequestContextListener or RequestContextFilter to expose the current request.\n\tat org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes<span class=\"token punctuation\">(</span>RequestContextHolder.java:131<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.web.context.support.WebApplicationContextUtils.currentRequestAttributes<span class=\"token punctuation\">(</span>WebApplicationContextUtils.java:313<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.web.context.support.WebApplicationContextUtils.access<span class=\"token variable\">$400</span><span class=\"token punctuation\">(</span>WebApplicationContextUtils.java:66<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.web.context.support.WebApplicationContextUtils<span class=\"token variable\">$RequestObjectFactory</span>.getObject<span class=\"token punctuation\">(</span>WebApplicationContextUtils.java:329<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.web.context.support.WebApplicationContextUtils<span class=\"token variable\">$RequestObjectFactory</span>.getObject<span class=\"token punctuation\">(</span>WebApplicationContextUtils.java:324<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.beans.factory.support.AutowireUtils<span class=\"token variable\">$ObjectFactoryDelegatingInvocationHandler</span>.invoke<span class=\"token punctuation\">(</span>AutowireUtils.java:295<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat com.sun.proxy.<span class=\"token variable\">$Proxy59</span>.getHeader<span class=\"token punctuation\">(</span>Unknown Source<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n\tat io.github.ajurasz.demo.GetUserId.userId<span class=\"token punctuation\">(</span>GetUserId.java:18<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>classes/:na<span class=\"token punctuation\">]</span>\n\tat io.github.ajurasz.demo.MyEventListener.handleEvent<span class=\"token punctuation\">(</span>MyEventListener.java:28<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>classes/:na<span class=\"token punctuation\">]</span>\n\tat io.github.ajurasz.demo.MyEventListener.handle<span class=\"token punctuation\">(</span>MyEventListener.java:23<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>classes/:na<span class=\"token punctuation\">]</span>\n\tat io.github.ajurasz.demo.MyEventListener<span class=\"token variable\">$$</span>FastClassBySpringCGLIB<span class=\"token variable\">$$</span>e876a886.invoke<span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>generated<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>classes/:na<span class=\"token punctuation\">]</span>\n\tat org.springframework.cglib.proxy.MethodProxy.invoke<span class=\"token punctuation\">(</span>MethodProxy.java:218<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.aop.framework.CglibAopProxy<span class=\"token variable\">$CglibMethodInvocation</span>.invokeJoinpoint<span class=\"token punctuation\">(</span>CglibAopProxy.java:769<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed<span class=\"token punctuation\">(</span>ReflectiveMethodInvocation.java:163<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.aop.framework.CglibAopProxy<span class=\"token variable\">$CglibMethodInvocation</span>.proceed<span class=\"token punctuation\">(</span>CglibAopProxy.java:747<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda<span class=\"token variable\">$invoke</span><span class=\"token variable\">$0</span><span class=\"token punctuation\">(</span>AsyncExecutionInterceptor.java:115<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class=\"token punctuation\">]</span>\n\tat java.base/java.util.concurrent.FutureTask.run<span class=\"token variable\">$$</span><span class=\"token variable\">$capture</span><span class=\"token punctuation\">(</span>FutureTask.java:264<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n\tat java.base/java.util.concurrent.FutureTask.run<span class=\"token punctuation\">(</span>FutureTask.java<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker<span class=\"token punctuation\">(</span>ThreadPoolExecutor.java:1128<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n\tat java.base/java.util.concurrent.ThreadPoolExecutor<span class=\"token variable\">$Worker</span>.run<span class=\"token punctuation\">(</span>ThreadPoolExecutor.java:628<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n\tat java.base/java.lang.Thread.run<span class=\"token punctuation\">(</span>Thread.java:834<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span></code></pre></div>\n<p>All make sense as under the hood <code class=\"language-text\">RequestContextHolder</code> is used which in turn stores request attributes in <code class=\"language-text\">ThreadLocal</code>.</p>\n<h2>Solution</h2>\n<p>To access HTTP request data from outside of calling thread we could extend <code class=\"language-text\">ThreadPoolTaskExecutor</code>, copy existing request attributes provided by <code class=\"language-text\">RequestContextHolder#currentRequestAttributes</code> and set them in a new thread through <code class=\"language-text\">RequestContextHolder#setRequestAttributes</code>. Below is sample implementation:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyThreadPoolTaskExecutor</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ThreadPoolTaskExecutor</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Future</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">submit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">MyCallable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">ListenableFuture</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">submitListenable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">submitListenable</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">MyCallable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">currentRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyCallable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> callable<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RequestAttributes</span> requestAttributes<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">MyCallable</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Callable</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> callable<span class=\"token punctuation\">,</span> <span class=\"token class-name\">RequestAttributes</span> requestAttributes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>callable <span class=\"token operator\">=</span> callable<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>requestAttributes <span class=\"token operator\">=</span> <span class=\"token function\">copy</span><span class=\"token punctuation\">(</span>requestAttributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">RequestAttributes</span> <span class=\"token function\">copy</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RequestAttributes</span> requestAttributes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// RequestAttributes needs to be copied as it will be garbage collected when origin request will complete.</span>\n            <span class=\"token keyword\">return</span> requestAttributes<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">setRequestAttributes</span><span class=\"token punctuation\">(</span>requestAttributes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> callable<span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">RequestContextHolder</span><span class=\"token punctuation\">.</span><span class=\"token function\">resetRequestAttributes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then we need to instruct spring to use our custom implementation of <code class=\"language-text\">TaskExecutor</code> like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token class-name\">TaskExecutor</span> <span class=\"token function\">taskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ThreadPoolTaskExecutor</span> taskExecutor <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyThreadPoolTaskExecutor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        taskExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setMaxPoolSize</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        taskExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setQueueCapacity</span><span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        taskExecutor<span class=\"token punctuation\">.</span><span class=\"token function\">setThreadNamePrefix</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"my-executor-\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> taskExecutor<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>Please notice that the above solution should be considered more like a workaround than a final solution. A better approach would be to extract all required data while still in the context of calling thread and then pass these data to all interested parties.</p>\n<p>The full example can be found at <a href=\"https://github.com/ajurasz/no-thread-bound-request\">github</a>.</p>","frontmatter":{"title":"Accessing HTTP request data from outside of calling thread","date":"December 28, 2019"}}}],"pathPrefix":"","first":true,"last":false,"index":1,"pageCount":4,"additionalContext":{}}},"staticQueryHashes":[]}