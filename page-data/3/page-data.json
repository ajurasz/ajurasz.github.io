{"componentChunkName":"component---src-templates-index-js","path":"/3","result":{"pageContext":{"group":[{"node":{"fields":{"slug":"/2019-06-02-verify-your-json/"},"html":"<p>When you hear API and web client together you think <code class=\"language-text\">REST</code>, at least I do. This is because it is still one of the most popular architectural paradigms for building APIs. Another approach about which I hear from time to time is <code class=\"language-text\">GraphQL</code>. There is one common part for these two - they talk JSON. Both specifications <code class=\"language-text\">REST</code> and <code class=\"language-text\">GraphQL</code> does not restrict only to this format but due to its simplicity, it is a very common choice. Every healthy software contains tests on different layers, from unit up to the end-to-end tests. So, how could we verify responses from our APIs?</p>\n<!-- end -->\n<p>In <code class=\"language-text\">java</code> world, especiality in <code class=\"language-text\">Spring</code> ecosystem when it comes to testing APIs you probably saw one of these:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mockMvc<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello?name=John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.name\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"John\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">jsonPath</code> static method in the above snippet is a wrapper around great library <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a>. Together with <a href=\"https://github.com/hamcrest/JavaHamcrest\">Hamcrest</a> it just makes writing test against JSON a true pleasure. </p>\n<p>Note: <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> does not require <code class=\"language-text\">Spring</code> it just need some JSON.</p>\n<p>I have created simple <a href=\"https://github.com/ajurasz/jsonpath-playground\">playground</a> for testing different <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions. <code class=\"language-text\">jsonPath</code> static method is provided which expects expression, matcher and a JSON string against which expression will be executed.</p>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"_id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5cdaff5fce90bc3ddd98475b\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"guid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"isActive\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"a\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"b\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"c\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"d\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token property\">\"e\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token property\">\"f\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"end\"</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"f\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"other end\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Working with JSON objects</h2>\n<p>Every <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expression starts with <code class=\"language-text\">$</code> symbol which represents <strong>root</strong> element (no matter if the JSON structure is an object or array). When you want to access the specific property you have two choices - dot or bracket notation. </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">//dot notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.guid\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.isActive\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">isA</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">instanceOf</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Number</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.nonExisting\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">nullValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.name.first\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Opal\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//bracket notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['guid']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"57cc1cbb-52ba-49ff-af66-4b9dde85a207\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['isActive']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">isA</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$['name']['first']\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Opal\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Although the second approach is noisier it is useful in situation when property name contains special characters or starts with a character other than represented by this regular expression <code class=\"language-text\">/[a-zA-Z_]/</code>.</p>\n<p>We can also do a deep scan to access property in very nested object. To acccess <code class=\"language-text\">f</code> property in our sample we could:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$..f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"other-end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// or using standard dot notation</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.a.b.c.d.e.f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Notice that deep scann returns array of values because depending on JSON structure it can find more properties with the name <code class=\"language-text\">f</code>. We can narrow down what path will be part of a deep scan by pointing to spefici property from which deep scan starts:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.a..f\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Working with JSON arrays</h2>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"friends\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Hester Dallai\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">31</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Lucinda Goff\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">27</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Ella Day\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">17</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"adult\"</span><span class=\"token operator\">:</span> <span class=\"token number\">18</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To access the single property from an object inside array you use square brackets just like in <code class=\"language-text\">java</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[0].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions support wildcards (<code class=\"language-text\">*</code>) which selects all elements in both object and arrays. </p>\n<p>To verify the age of our friends we can:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[*].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When you have ever worked with <code class=\"language-text\">python</code> you probably came across slice notation, which in some part is supported in <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span>stop<span class=\"token punctuation\">]</span>     <span class=\"token comment\"># from start to stop - 1</span>\n<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>         <span class=\"token comment\"># from start to the end of array</span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>n<span class=\"token punctuation\">]</span>             <span class=\"token comment\"># selects first n - 1 elements</span>\n<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>n<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>            <span class=\"token comment\"># selects last n elements</span></code></pre></div>\n<p>Knowing this slice expressions would like like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[:3].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[1:2].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[:2].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[-2:].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">17</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Filter expression</h2>\n<p>Next powerful feature of <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> are filter expression <code class=\"language-text\">[?(&lt;expression&gt;)]</code> which make selection of elements more dynamic. Complete list of supported operators can be found at <a href=\"https://github.com/json-path/JsonPath#filter-operators\">https://github.com/json-path/JsonPath#filter-operators</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= 18)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.id == 1)].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">27</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.id != 1)].age\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span> <span class=\"token number\">17</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age in [31, 17])].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.name =~ /^.*Da.*$/i)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">@</code> represent the current node. In the above example this will represent friend node and for each of our friends (<code class=\"language-text\">$.friends[]</code>), given property will be returned when the expression evaluates to true.</p>\n<p>We can be even more dynamic by referencing to other properties:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= 18)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.friends[?(@.age >= $.adult)].id\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">hasItems</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Functions</h2>\n<p><a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> provides functions that can be added at the end of our expression. The rule is simple  - output of expression is input to the function. Complete list of build in functions can be found at <a href=\"https://github.com/json-path/JsonPath#functions\">https://github.com/json-path/JsonPath#functions</a>.</p>\n<p>Let us assume that <code class=\"language-text\">json</code> argument in the following examples will have this structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"range\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">7</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n    <span class=\"token number\">9</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>then we can run functions that expects arrays as input</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.avg()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">4.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.min()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.max()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">9.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.stddev()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">2.8722813232690143</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">jsonPath</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"$.range.length()\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">is</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">runAgainst</span><span class=\"token punctuation\">(</span>json<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>As you saw <a href=\"https://github.com/json-path/JsonPath\">JsonPath</a> expressions are very powerful, they should be able to extract whatever you want from a JSON structure. All used examples and more can be found on <a href=\"https://github.com/ajurasz/jsonpath-playground\">github</a>.</p>","frontmatter":{"title":"Verify your JSON","date":"June 2, 2019"}}},{"node":{"fields":{"slug":"/2019-05-12-wlp-spring-aop/"},"html":"<p>Investigation walkthrough for an issue related to multiple <code class=\"language-text\">classloaders</code> available when <code class=\"language-text\">SpringBoot</code> application is deployed on <code class=\"language-text\">IBM WebSphere Liberty</code> (<code class=\"language-text\">WSL</code>).</p>\n<!-- end -->\n<h2>Motivation</h2>\n<p>Recently I was investigating a strange issue that was present only in a production-like environment. Fortunately, my team have CI which is almost 1 to 1 with production so we were able to catch this issue before deployment. So what’s different between production and local environment you may ask. Well, the answer is very simple - we use different servlet containers. For local development, we use embedded <code class=\"language-text\">Tomcat</code> web server that is ship together with <code class=\"language-text\">SpringBoot</code>. On production, we have <code class=\"language-text\">WSL</code> application server. Because I wanted to know why the issue was happening only on one environment and working perfectly fine on another I had to dig a little bit. </p>\n<h2>Context</h2>\n<p>Before moving forward with the analyze let’s give some context so that what I will write next will have more sense. As always it starts with a <strong>simple</strong> task in Jira backlog. The task was to move complex <strong>authorization</strong> mechanism from service to web layer. </p>\n<blockquote>\n<p>authorization is the process of verifying that “you are permitted to do what you are trying to do”</p>\n</blockquote>\n<blockquote>\n<p>source: Wikipedia</p>\n</blockquote>\n<p>The difference on performing <strong>authorization</strong> on these two layers is that services operate on actual objects where web controllers on identifiers of these objects. Below is pseudo code for the change that was planed.</p>\n<p>Before:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aspect(object) {\n  return allowedToAccess(object)\n}</code></pre></div>\n<p>After:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aspect(identifier) {\n  const object = resolveObjectFrom(identifier)\n  return allowedToAccess(object)\n}</code></pre></div>\n<p>For now, we know what needs to be done and how. But one more important addition to the context is about convention* we try to follow in our code base - which is - extensive usage of encapsulation which in our case is more about creating a clear interface for others who will be using these objects than just hiding information.</p>\n<p>* clarification - we follow more conventions/best practices but in the context of this post, only this single convention is important.</p>\n<p>But what this exactly mean? In simple words, we use <code class=\"language-text\">public</code> modifier only when it’s really required, if not then we operate mostly using only <code class=\"language-text\">private</code> and <code class=\"language-text\">package protected</code> modifiers. I think the above context should be enough to start analyzing a concrete example. To make analyze simpler I have created a sample application demonstrate a problem and can be found on <a href=\"https://github.com/ajurasz/wlp-spring-aop\">github</a>. </p>\n<h2>Analyze</h2>\n<h3>Posotive scenario</h3>\n<p>For our case, we need to focus only on three elements.</p>\n<ol>\n<li><code class=\"language-text\">HelloControler</code> this is standard <code class=\"language-text\">RestController</code> to which one dependency is injected.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HelloController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">HelloService</span> helloService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">HelloController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HelloService</span> helloService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>helloService <span class=\"token operator\">=</span> helloService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello/{name}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>helloService<span class=\"token punctuation\">.</span><span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li><code class=\"language-text\">PointcutedHelloController</code> is special because <code class=\"language-text\">PointcutedHelloController#hello</code> is join point for around advice (<a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop\">AOP terminology</a>)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PointcutedHelloController</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">HelloService</span> helloService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">PointcutedHelloController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HelloService</span> helloService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>helloService <span class=\"token operator\">=</span> helloService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@GetMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/hello-aop/{name}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">hello</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>helloService<span class=\"token punctuation\">.</span><span class=\"token function\">sayHello</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"3\">\n<li><code class=\"language-text\">LoggingAspect</code> which registers advice around specified pointcut</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Aspect</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LoggingAspect</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Logger</span> LOG <span class=\"token operator\">=</span> <span class=\"token class-name\">LoggerFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogger</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LoggingAspect</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Around</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"within(com.example.demo.PointcutedHelloController)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">Object</span> <span class=\"token function\">aroud</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ProceedingJoinPoint</span> pjp<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Throwable</span> <span class=\"token punctuation\">{</span>\n        LOG<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>pjp<span class=\"token punctuation\">.</span><span class=\"token function\">getSignature</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLongString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> pjp<span class=\"token punctuation\">.</span><span class=\"token function\">proceed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can run tests or application itself (<code class=\"language-text\">mvn spring-boot:run</code>) and call <code class=\"language-text\">hello</code> methods - everything will work as expected. Please notice, if you will place <code class=\"language-text\">breakpoint</code> in <code class=\"language-text\">PointcutedHelloController#hello</code> you will see that <code class=\"language-text\">PointcutedHelloController</code> is wrapped with <code class=\"language-text\">com.example.demo.PointcutedHelloController$$EnhancerBySpringCGLIB</code> proxy.</p>\n<h3>Negative scenario</h3>\n<p>First you will have to change profile setting <code class=\"language-text\">activeByDefault</code> from <code class=\"language-text\">false</code> to <code class=\"language-text\">true</code> in <code class=\"language-text\">pom.xml</code> so it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>wlp<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activation</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>activeByDefault</span><span class=\"token punctuation\">></span></span>true<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>activeByDefault</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>activation</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>then you just need to build <code class=\"language-text\">war</code> package (<code class=\"language-text\">mvn clean package -DskipTest</code>) and deploy it to <code class=\"language-text\">WSL</code>. After starting the server it crashes with the following message:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">Caused by: org.springframework.aop.framework.AopConfigException: Could not generate CGLIB subclass of class com.example.demo.PointcutedHelloController: Common causes of this problem include using a final class or a non-visible class<span class=\"token punctuation\">;</span> nested exception is org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--<span class=\"token operator\">></span>class com.example.demo.PointcutedHelloController<span class=\"token variable\">$$</span>EnhancerBySpringCGLIB<span class=\"token variable\">$$</span>4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController\n    at org.springframework.aop.framework.CglibAopProxy.getProxy<span class=\"token punctuation\">(</span>CglibAopProxy.java:208<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.ProxyFactory.getProxy<span class=\"token punctuation\">(</span>ProxyFactory.java:110<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.createProxy<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:471<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.wrapIfNecessary<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:350<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.autoproxy.AbstractAutoProxyCreator.postProcessAfterInitialization<span class=\"token punctuation\">(</span>AbstractAutoProxyCreator.java:299<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsAfterInitialization<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:429<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:1782<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean<span class=\"token punctuation\">(</span>AbstractAutowireCapableBeanFactory.java:593<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-beans-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. <span class=\"token number\">32</span> common frames omitted\nCaused by: org.springframework.cglib.core.CodeGenerationException: java.lang.IllegalAccessError--<span class=\"token operator\">></span>class com.example.demo.PointcutedHelloController<span class=\"token variable\">$$</span>EnhancerBySpringCGLIB<span class=\"token variable\">$$</span>4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController\n    at org.springframework.cglib.core.ReflectUtils.defineClass<span class=\"token punctuation\">(</span>ReflectUtils.java:530<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator.generate<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:363<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.generate<span class=\"token punctuation\">(</span>Enhancer.java:582<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span><span class=\"token variable\">$3</span>.apply<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:110<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span><span class=\"token variable\">$3</span>.apply<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:108<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache<span class=\"token variable\">$2</span>.call<span class=\"token punctuation\">(</span>LoadingCache.java:54<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at java.util.concurrent.FutureTask.run<span class=\"token variable\">$$</span><span class=\"token variable\">$capture</span><span class=\"token punctuation\">(</span>FutureTask.java:266<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.util.concurrent.FutureTask.run<span class=\"token punctuation\">(</span>FutureTask.java<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache.createEntry<span class=\"token punctuation\">(</span>LoadingCache.java:61<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.internal.LoadingCache.get<span class=\"token punctuation\">(</span>LoadingCache.java:34<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator<span class=\"token variable\">$ClassLoaderData</span>.get<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:134<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.AbstractClassGenerator.create<span class=\"token punctuation\">(</span>AbstractClassGenerator.java:319<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.createHelper<span class=\"token punctuation\">(</span>Enhancer.java:569<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.proxy.Enhancer.createClass<span class=\"token punctuation\">(</span>Enhancer.java:416<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.ObjenesisCglibAopProxy.createProxyClassAndInstance<span class=\"token punctuation\">(</span>ObjenesisCglibAopProxy.java:57<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    at org.springframework.aop.framework.CglibAopProxy.getProxy<span class=\"token punctuation\">(</span>CglibAopProxy.java:205<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-aop-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. <span class=\"token number\">39</span> common frames omitted\nCaused by: java.lang.IllegalAccessError: class com.example.demo.PointcutedHelloController<span class=\"token variable\">$$</span>EnhancerBySpringCGLIB<span class=\"token variable\">$$</span>4f0e109d cannot access its superclass com.example.demo.PointcutedHelloController\n    at java.lang.ClassLoader.defineClass1<span class=\"token punctuation\">(</span>Native Method<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.lang.ClassLoader.defineClass<span class=\"token punctuation\">(</span>ClassLoader.java:763<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at sun.reflect.GeneratedMethodAccessor27.invoke<span class=\"token punctuation\">(</span>Unknown Source<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:na<span class=\"token punctuation\">]</span>\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke<span class=\"token punctuation\">(</span>DelegatingMethodAccessorImpl.java:43<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at java.lang.reflect.Method.invoke<span class=\"token punctuation\">(</span>Method.java:498<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>na:1.8.0_201<span class=\"token punctuation\">]</span>\n    at org.springframework.cglib.core.ReflectUtils.defineClass<span class=\"token punctuation\">(</span>ReflectUtils.java:527<span class=\"token punctuation\">)</span> ~<span class=\"token punctuation\">[</span>spring-core-5.1.6.RELEASE.jar:5.1.6.RELEASE<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">..</span>. <span class=\"token number\">54</span> common frames omitted</code></pre></div>\n<p>First thing that caught my attention was <code class=\"language-text\">Could not generate CGLIB subclass of ...: Common causes of this problem include using a final class or a non-visible class</code> which seems to be fair enough as controller class is not public so it can be non-visible but then next question arises - why this was working locally when deployed on <code class=\"language-text\">Tomcat</code>? At this point removing AOP advice from <code class=\"language-text\">PointcutedHelloController#hello</code> metod, fix the problem. This clearly indicates that there is something wrong when using <code class=\"language-text\">Spring AOP</code>. Maybe it requires classes and method to be public? Let’s see what <a href=\"https://docs.spring.io/spring/docs/current/spring-framework-reference/core.html#aop-introduction-proxies\">documentation</a> says about it. Most important fragment of this documentation to my current situation is:</p>\n<blockquote>\n<p>With CGLIB, public and protected method calls on the proxy are intercepted (and even package-visible methods, if necessary).</p>\n</blockquote>\n<p>And this is true when deploying on <code class=\"language-text\">Tomcat</code> but not when on <code class=\"language-text\">WSL</code>. Because I’m not a <code class=\"language-text\">WSL</code> expert I had to do some googling to find out that this issue can be related to <code class=\"language-text\">classloader</code>s. Where one <code class=\"language-text\">classloader</code> is used to load all 3rd party libraries from <code class=\"language-text\">/WEB-INF/lib</code> and my own classes from <code class=\"language-text\">/WEB-INF/classes</code> and another when creating proxy for <code class=\"language-text\">PointcutedHelloController</code>.  </p>\n<p>After debugging session I was able to nail down which <code class=\"language-text\">classloader</code> is used when creating proxy.</p>\n<p><code class=\"language-text\">Spring AOP</code> creates its proxies through <code class=\"language-text\">CglibAopProxy#getProxy(classLoader)</code>. This <code class=\"language-text\">ClassLoader</code> object in the end is provided by <code class=\"language-text\">DefaultResourceLoader</code> which sets <code class=\"language-text\">classLoader</code> to <code class=\"language-text\">Thread.currentThread().getContextClassLoader()</code> during object construction. Bellow is screenshot which shows how <code class=\"language-text\">classLoader</code> provided by <code class=\"language-text\">DefaultResourceLoader</code> (left) differs from <code class=\"language-text\">classLoader</code> awaible in any other place of my application when calling <code class=\"language-text\">getClass().getClassLoader()</code></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bbf863545b228772548aee63cf3863d0/5f7fb/wlp-classloaders.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.714285714285715%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA+klEQVQY032OiW6EIBRF/f8vVOpalhEdwGEbUJAqZtqmaXsSCMu7S6EmPFJ8u49KK++8y4SwpZSc5AKhBxdGKZNZ/er9sdYtDxSGjWKatbH7vqdP8tlrITBiXFhjX89fZDFFDGMl5eF3GZ84d5g7xQXBUsozM+NfxBCzeGjmslqmKYRwGsa8hXg4r3phGGprj68fyde1CP7ptI4xpu9ctSXjfSfuzGid21ydnHu6y65Iv5LFm5Z86GcICUQjpQQTjAmCiCCstP5bnNlWz+ltplP/Vg9N24G6rUBTgq5pHw/5j/hMDtYscOCI4AqQukEVeC8rWALUD0qdyR8UAsyHX1iO4gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"wlp-classloaders\"\n        title=\"\"\n        src=\"/static/bbf863545b228772548aee63cf3863d0/8c557/wlp-classloaders.png\"\n        srcset=\"/static/bbf863545b228772548aee63cf3863d0/4edbd/wlp-classloaders.png 175w,\n/static/bbf863545b228772548aee63cf3863d0/13ae7/wlp-classloaders.png 350w,\n/static/bbf863545b228772548aee63cf3863d0/8c557/wlp-classloaders.png 700w,\n/static/bbf863545b228772548aee63cf3863d0/e996b/wlp-classloaders.png 1050w,\n/static/bbf863545b228772548aee63cf3863d0/2cefc/wlp-classloaders.png 1400w,\n/static/bbf863545b228772548aee63cf3863d0/5f7fb/wlp-classloaders.png 1889w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>It looks like the one created by <code class=\"language-text\">DefaultResourceLoader</code> is not aware of my classes so that’s the reason why application crashes on startup.</p>\n<h3>Fix</h3>\n<p>We know that everything starts in <code class=\"language-text\">DefaultResourceLoader</code> so we can register our custom <code class=\"language-text\">ServletContextInitializer</code> to override default <code class=\"language-text\">classLoader</code> created by <code class=\"language-text\">DefaultResourceLoader</code>. This can be done by extending <code class=\"language-text\">SpringBootServletInitializer</code> class like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootApplication</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DemoApplication</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SpringBootServletInitializer</span>\n<span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">SpringApplication</span><span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DemoApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token class-name\">SpringApplicationBuilder</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SpringApplicationBuilder</span> applicationBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> applicationBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">sources</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DemoApplication</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">initializers</span><span class=\"token punctuation\">(</span>configurableApplicationContext <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token class-name\">ClassLoader</span> classLoader <span class=\"token operator\">=</span> <span class=\"token function\">getClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getClassLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DefaultResourceLoader</span><span class=\"token punctuation\">)</span>configurableApplicationContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">setClassLoader</span><span class=\"token punctuation\">(</span>classLoader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>It is possible becouse <code class=\"language-text\">configurableApplicationContext</code> is instance of <code class=\"language-text\">AnnotationConfigServletWebServerApplicationContext</code> class which in turn is subclass of <code class=\"language-text\">DefaultResourceLoader</code>.</p>","frontmatter":{"title":"IBM WebSphere Liberty and Spring AOP","date":"May 12, 2019"}}},{"node":{"fields":{"slug":"/2018-09-09-adding-deb-packages-to-cloud-foundry-instances/"},"html":"<p>This blog post presents two ways of adding additional deb packages to your <a href=\"https://www.cloudfoundry.org/\">Cloud Foundry</a> (CF) instances.</p>\n<!-- end -->\n<h2>Buildpack</h2>\n<p>Before moving forward let’s introduce some useful buildpacks that we will be using. What is buildpack you may ask. <code class=\"language-text\">&quot;Buildpacks provide framework and runtime support for apps&quot;</code>, in other words, CF have some predefined “recipes” how to prepare instances to run your application. So if you will push your application with CLI, CF will examine your app and will use appropriate buildpack to prepare your instance. You can also be more explicit and say what buildpack you want to use. Here you can find a list of builtin buildpacks <a href=\"https://docs.cloudfoundry.org/buildpacks/#system-buildpacks\">https://docs.cloudfoundry.org/buildpacks/#system-buildpacks</a>.</p>\n<p>We will be using:</p>\n<ol>\n<li><a href=\"https://github.com/cloudfoundry/apt-buildpack\">apt-buildpack</a> - allow us to list all deb packages we want to install in <code class=\"language-text\">apt.yml</code> file. It’s supporting custom apt repositories as well.  </li>\n<li><a href=\"https://github.com/cloudfoundry/binary-buildpack\">binary-buildpack</a> - this buildpack allow you to run binary web services that do not require any runtime dependencies (any of these sould be statically linked to your binary). Good buildpack just for preparing “clean” instance.  </li>\n<li><a href=\"https://github.com/cloudfoundry/multi-buildpack\">multi-buildpack</a> - as names suggests for running multiple buildpacks.  </li>\n</ol>\n<h2>Using multi-buildpack</h2>\n<ol>\n<li>Create <code class=\"language-text\">multi-buildpack.yml</code> file where you specify all buildpacks you want to run:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">buildpacks</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/apt<span class=\"token punctuation\">-</span>buildpack\n<span class=\"token punctuation\">-</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/java<span class=\"token punctuation\">-</span>buildpack</code></pre></div>\n<ol start=\"2\">\n<li>Create <code class=\"language-text\">apt.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> mysql<span class=\"token punctuation\">-</span>client</code></pre></div>\n<ol start=\"3\">\n<li>Create <code class=\"language-text\">manifest.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">applications</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">buildpack</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/multi<span class=\"token punctuation\">-</span>buildpack\n  <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 1G</code></pre></div>\n<ol start=\"4\">\n<li>Push to CF</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf push </code></pre></div>\n<p>Above command will:</p>\n<ul>\n<li>by default look for <code class=\"language-text\">manifest.yml</code> in the current directory (<a href=\"https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#-how-cf-push-finds-the-manifest\">more</a>)</li>\n<li>by default, it will recursively push all files in the current directory (<a href=\"https://docs.cloudfoundry.org/devguide/deploy-apps/manifest.html#find-app\">more</a>)  </li>\n</ul>\n<p>Directory structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">.</span>\n├── apt.yml\n├── manifest.yml\n├── multi-buildpack.yml\n└── my-app.jar</code></pre></div>\n<h3>Cons</h3>\n<p>When using multi-buildpack you cannot use builtin buildpacks which can be an issue when working on a company’s own installation of CF and its policy require from you to be using built-in (customized) buildpacks.</p>\n<h2>Pushing multiple buildpacks</h2>\n<ol>\n<li>Create <code class=\"language-text\">apt.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">packages</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> mysql<span class=\"token punctuation\">-</span>client</code></pre></div>\n<ol start=\"3\">\n<li>Create <code class=\"language-text\">manifest.yml</code> file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">applications</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> my<span class=\"token punctuation\">-</span>app\n  <span class=\"token key atrule\">buildpack</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/cloudfoundry/binary<span class=\"token punctuation\">-</span>buildpack\n  <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> ./my<span class=\"token punctuation\">-</span>app.jar\n  <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n  <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 1G</code></pre></div>\n<ol start=\"4\">\n<li>Embed <code class=\"language-text\">apt.yml</code> at the root of your project</li>\n</ol>\n<p>With maven, this can be done with the help of <a href=\"http://maven.apache.org/plugins/maven-antrun-plugin/\">maven-antrun-plugin</a> and by adding following to your <code class=\"language-text\">pom.xml</code> file:</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>plugin</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>maven-antrun-plugin<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>executions</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>execution</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>id</span><span class=\"token punctuation\">></span></span>addCFAptAtRootLevel<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>id</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>phase</span><span class=\"token punctuation\">></span></span>package<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>phase</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>target</span><span class=\"token punctuation\">></span></span>\n                    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>zip</span> <span class=\"token attr-name\">destfile</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${project.build.directory}/${app.finalName}.jar<span class=\"token punctuation\">\"</span></span>\n                         <span class=\"token attr-name\">update</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>yes<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">compress</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">></span></span>\n                        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>zipfileset</span> <span class=\"token attr-name\">dir</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>.<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">includes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>apt.yml<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">/></span></span>\n                    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>zip</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>target</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goals</span><span class=\"token punctuation\">></span></span>\n                <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>goal</span><span class=\"token punctuation\">></span></span>run<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goal</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>goals</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>execution</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>executions</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>plugin</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<ol start=\"5\">\n<li>Push to CF</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf push --no-start <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\ncf push my-app -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack <span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>(1) sets up instance and do not start it<br>\n(2) we need to specify the app name we want to update. In this case, we just update the buildpack section of deployed manifest. We can also use public and builtin buildpacks  </p>\n<p>Directory structure:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">.</span>\n├── manifest.yml\n└── my-app.jar</code></pre></div>\n<h3>Cons</h3>\n<p>Above approach (2) is available starting from <code class=\"language-text\">cf</code> CLI version <code class=\"language-text\">v6.38</code> or later. Before you had to use a different command for pushing multiple buildpacks:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">cf v3-push -b https://github.com/cloudfoundry/apt-buildpack -b java_buildpack</code></pre></div>","frontmatter":{"title":"Adding deb packages to Cloud Foundry instances","date":"September 9, 2018"}}},{"node":{"fields":{"slug":"/2017-05-28-kotlin-aws-lambda-serverless-framework/"},"html":"<p>Some time ago I came across the following tweet.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 581px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 47.42857142857142%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHZdqESD//EABYQAAMAAAAAAAAAAAAAAAAAABESIP/aAAgBAQABBQILX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAABIDFB/9oACAEBAAY/AtKcf//EABwQAQACAQUAAAAAAAAAAAAAAAEAEEERITFh0f/aAAgBAQABPyHTsB55gp7Qems1/9oADAMBAAIAAwAAABDDz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQABAwUAAAAAAAAAAAAAAAEAETFxEEFhgbH/2gAIAQEAAT8QrqOVqEgvKzdjMMlvMb9w8Gn/2Q=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"tweet_aws_kotlin\"\n        title=\"\"\n        src=\"/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg\"\n        srcset=\"/static/e087ba82deeb3973414aa247f4b459e6/e52aa/tweet_aws_kotlin.jpg 175w,\n/static/e087ba82deeb3973414aa247f4b459e6/70ebb/tweet_aws_kotlin.jpg 350w,\n/static/e087ba82deeb3973414aa247f4b459e6/f0d01/tweet_aws_kotlin.jpg 581w\"\n        sizes=\"(max-width: 581px) 100vw, 581px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>There were two things that took my attention - kotlin and Rekognition.</p>\n<!-- end -->\n<p>First one is a “new” (it’s relly developed by over 6 years now) JVM language created by JetBrains, company that stands behind great tooling for developers of different professions. The second is an AWS service, this is how it is described on their page</p>\n<blockquote>\n<p>Amazon Rekognition is a service that makes it easy to add image analysis to your applications. With Rekognition, you can detect objects, scenes faces; search and compare faces, and identify inappropriate content in images. Rekognition’s API enables you to quickly add sophisticated deep learning-based visual search and image classification to your applications.</p>\n</blockquote>\n<p>as we will see soon this API is very easy to use.</p>\n<h2>Why</h2>\n<p>At this point for me, it was the first contact with pretty nice and interesting example of AWS Lambda usage created by <a href=\"https://twitter.com/VladimirBudilov\">Vladimir Budilov</a> (here is a  <a href=\"https://github.com/awslabs/serverless-photo-recognition\">github</a> repository). For these who are not familiar with AWS Lambda term -  it is a new category of cloud computing services called FaaS (function as a service). It stands next to IaaS (infrastructure as a service), PaaS (platform as a service) and SaaS (software as a service) it is also referred as Serverless architecture. In short, you focus only on your business logic and don’t care about provisioning and managing servers.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.28571428571429%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMBBP/EABYBAQEBAAAAAAAAAAAAAAAAAAIDBP/aAAwDAQACEAMQAAAB7Lazqq65/8QAGRAAAwADAAAAAAAAAAAAAAAAAAECEBEh/9oACAEBAAEFAt2dHNN5/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/AQyf/8QAFxEBAAMAAAAAAAAAAAAAAAAAAQIDEP/aAAgBAgEBPwGVi5//xAAaEAACAgMAAAAAAAAAAAAAAAABMQACICEi/9oACAEBAAY/AmXD0XNWw//EABoQAQACAwEAAAAAAAAAAAAAAAEAEDFRcdH/2gAIAQEAAT8hHoQeqhqexw9r/9oADAMBAAIAAwAAABD43//EABgRAAIDAAAAAAAAAAAAAAAAAAABETFh/9oACAEDAQE/EE0Jw//EABgRAAIDAAAAAAAAAAAAAAAAAAABEVFh/9oACAECAQE/EMMh2f/EABwQAAICAgMAAAAAAAAAAAAAAAABETEhQVFx8P/aAAgBAQABPxBe4x89EqpP0zEWOiOpVg0fH2Kj/9k='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"faas_diagram\"\n        title=\"\"\n        src=\"/static/75f2521335608d5d448030d8d8111009/29d31/faas_diagram.jpg\"\n        srcset=\"/static/75f2521335608d5d448030d8d8111009/e52aa/faas_diagram.jpg 175w,\n/static/75f2521335608d5d448030d8d8111009/70ebb/faas_diagram.jpg 350w,\n/static/75f2521335608d5d448030d8d8111009/29d31/faas_diagram.jpg 700w,\n/static/75f2521335608d5d448030d8d8111009/d5834/faas_diagram.jpg 801w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n<sub>Source: Deploy microservice using Amazon Web Services S3, API Gateway, Lambda and Couchbase by Arun Gupta (<a href=\"https://www.youtube.com/watch?v=eT4EaU2mfL0\">https://www.youtube.com/watch?v=eT4EaU2mfL0</a>)</sub></p>\n<p>After analysing <a href=\"https://github.com/awslabs/serverless-photo-recognition\">serverless-photo-recognition</a> repository I felt urgent need to write something of my own. One thing that I considered not to be very concise was a setup step. The author created setup <a href=\"https://github.com/awslabs/serverless-photo-recognition/blob/master/setup/setupEnvironment.sh\">script</a> which is very verbose. So let’s start by making this process a lot more easier (to make and understand - for people not so familiar with AWS platform).</p>\n<h2>Serverless framework</h2>\n<p><a href=\"https://serverless.com/\">Serverless framework</a> is a cli tool that creates great abstraction over <a href=\"https://aws.amazon.com/cloudformation/\">AWS CloudFormation</a> and automates the whole process of setting up cloud infrastructure required by our functions. We start by installing <code class=\"language-text\">serverless framework</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> -g serverless</code></pre></div>\n<p>then a good idea is to create dedicated AWS user that will be used on behalf of <code class=\"language-text\">serverless framework</code>. Exact instruction of how to accomplish this can be found <a href=\"https://serverless.com/framework/docs/providers/aws/guide/credentials/\">here</a>. In my case, this user hides behind <code class=\"language-text\">sless</code> AWS cli profile name - <a href=\"https://github.com/ajurasz/ascii-less-gallery/blob/58ad818d1d0d7131b4cb5ad9e027cea815197656/serverless.yml#L6\">see here</a>. All configuration is placed in one file <code class=\"language-text\">serverless.yml</code>\nwhere we first define <code class=\"language-text\">provider</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> aws\n  <span class=\"token key atrule\">runtime</span><span class=\"token punctuation\">:</span> java8\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span> sless\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span>\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">DYNAMODB_USER_TABLE</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">:</span>service<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">-</span>user\n    <span class=\"token key atrule\">ES_DOMAIN_NAME</span><span class=\"token punctuation\">:</span> es<span class=\"token punctuation\">-</span>gallery\n    <span class=\"token key atrule\">REDIS_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(serverless<span class=\"token punctuation\">-</span>config.yml)<span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span>.RedisUrl<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">REDIS_PORT</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(serverless<span class=\"token punctuation\">-</span>config.yml)<span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span>.RedisPort<span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">ES_URL</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>file(serverless<span class=\"token punctuation\">-</span>config.yml)<span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span>opt<span class=\"token punctuation\">:</span>stage<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">:</span>provider.stage<span class=\"token punctuation\">}</span>.ElasticsearchUrl<span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">iamRoleStatements</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"lambda:InvokeFunction\"</span>\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"rekognition:DetectLabels\"</span>\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"*\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Allow\"</span>\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"es:ESHttpDelete\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"es:ESHttpGet\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"es:ESHttpPost\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"es:ESHttpPut\"</span>\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"arn:aws:es:${opt:region, self:provider.region}:*:domain/${self:provider.environment.ES_DOMAIN_NAME}/*\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">Effect</span><span class=\"token punctuation\">:</span> Allow\n      <span class=\"token key atrule\">Action</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"dynamodb:GetItem\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token string\">\"dynamodb:PutItem\"</span>\n      <span class=\"token key atrule\">Resource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.DYNAMODB_USER_TABLE}\"</span></code></pre></div>\n<p>this is a place where we can configure mentioned AWS cli profile, runtime environment, extend the limit of our functions execution time to 60 sec, define environment variables that will be accessible from within our functions and also we can define a security policy for a lambda role created automatically by <code class=\"language-text\">serverless</code>. From above snippet, we see that security statements were defined for lambda, elasticsearch, rekognition and dynamodb services, specifying what action we can execute on them.</p>\n<h2>Lambda in action</h2>\n<p>I wrote a simple CRD (no update) functions with custom authentication mechanism - probably using <a href=\"https://aws.amazon.com/cognito/\">AWS Cognito</a> would be a preferred way to go but I wanted to check how flexible are these lambda functions in terms of implementing own authentication. Application architecture is following</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c345b9c56b520224ea049671d45bb9b6/a3767/architecture_aws_lambda.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 63.42857142857142%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACBUlEQVQ4y41Sy24TQRDcf+UvuCDxEAiRExLHXLhxRlzIiRwclhAngFkpmNixSRyMHezdmZ3ZeRU1Y29iohwyUql7e2qqH9tZCOEEQI+2oC1c8EXjHGELv461dxExthkP1/534n6GG8cTob+b0B4Sr/zXH0Y4OK1w2yHvZbZ2bNTyzvnGBy/nF76ajryhb4zxQghvrY25fDGc+sm8TD7f+bYGwvF7qxWMQTjTQPGq/rYD8fMzmsi2BoZxY22qolNMcDS4XHXDysN1+THBi2yj05TGEHJ4hHryAzalBRaiRtM0iXjY/43BxWL1yIf2WavxPAkqpX0ssvq1B6WXqM+OIWdnkKSq6RBq/BUNfbbP5wajaYn8ZNHOLbRdEs+ymHk2m3N+Fuf7r7BcnkN337LlfQgS9ekhdG8H0gFluUwFdY5n2N4d3yb49Krl1C7nrjkroRqIWkHQl3/GqEY98GdBSgnHmPceti6TvdHyk2xDPUWNdzEQfzkEKXpwAP3lHXScbVVSmGMYdmHeb5Hno9qm4KP/BQkuddo7x+yS1dTlX4j5BRMFVBQ0zkNdTiAH3cRpK1xrPGwFDeHS5jiXbFxKFb/7HWc/vXE6/nCfsqX79d659SJEMUs8yHCHY6zBHc/jKNil8h6R08+ZNq+1zpVpki+VygXh431AHnktd2XDx7CK04Z7/wDGsen+Gr0cggAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"architecture_aws_lambda\"\n        title=\"\"\n        src=\"/static/c345b9c56b520224ea049671d45bb9b6/8c557/architecture_aws_lambda.png\"\n        srcset=\"/static/c345b9c56b520224ea049671d45bb9b6/4edbd/architecture_aws_lambda.png 175w,\n/static/c345b9c56b520224ea049671d45bb9b6/13ae7/architecture_aws_lambda.png 350w,\n/static/c345b9c56b520224ea049671d45bb9b6/8c557/architecture_aws_lambda.png 700w,\n/static/c345b9c56b520224ea049671d45bb9b6/e996b/architecture_aws_lambda.png 1050w,\n/static/c345b9c56b520224ea049671d45bb9b6/a3767/architecture_aws_lambda.png 1210w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>I believe that above diagram is self-explanatory so let’s dive into one of the functions. <a href=\"https://github.com/ajurasz/ascii-less-gallery/blob/master/src/main/kotlin/ajurasz/lambda/gallery/CreateHandler.kt\">CreateHandler</a>, the entry point is <code class=\"language-text\">handleRequest</code> function triggered by AWS when an HTTP POST request reaches API Gateway at <code class=\"language-text\">/gallery</code> path.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>input<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n        LOG<span class=\"token punctuation\">.</span><span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"input(\\n<span class=\"token interpolation variable\">$input</span>\\n)\"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>base64Image <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>base64Image <span class=\"token keyword\">as</span> String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isBlank</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">response</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Invalid identify request: no or empty 'base64Image' field supplied\"</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> imageInBytes <span class=\"token operator\">=</span> <span class=\"token function\">base64ToBytes</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>base64Image<span class=\"token operator\">!!</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> labels <span class=\"token operator\">=</span> rekognitionService<span class=\"token punctuation\">.</span><span class=\"token function\">imageLabels</span><span class=\"token punctuation\">(</span>imageInBytes<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> galleryItem <span class=\"token operator\">=</span> <span class=\"token function\">createGalleryItem</span><span class=\"token punctuation\">(</span>asciiService<span class=\"token punctuation\">,</span> imageInBytes<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> esService<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>principalId<span class=\"token operator\">!!</span><span class=\"token punctuation\">,</span> galleryItem<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token boolean\">true</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">return</span> galleryItem<span class=\"token punctuation\">.</span>id\n            <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">return</span> <span class=\"token function\">response</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Failed to save image\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this function, we validate incoming request to check if base64 encoded image string exists and is not blank. Then encoded image is converted to <code class=\"language-text\">byte</code> array and passed to Rekognition service. This service is a wrapper around AWS Rekognition service to simplify interaction with it.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">    <span class=\"token keyword\">fun</span> <span class=\"token function\">imageLabels</span><span class=\"token punctuation\">(</span>image<span class=\"token operator\">:</span> ByteArray<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        LOG<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Recognize image labels\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> response <span class=\"token operator\">=</span> amazonRekognition<span class=\"token punctuation\">.</span><span class=\"token function\">detectLabels</span><span class=\"token punctuation\">(</span><span class=\"token function\">DetectLabelsRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withMaxLabels</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withMinConfidence</span><span class=\"token punctuation\">(</span><span class=\"token number\">60f</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">withImage</span><span class=\"token punctuation\">(</span><span class=\"token function\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">withBytes</span><span class=\"token punctuation\">(</span>ByteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> response<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>labels<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">orEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>As mentioned at the beginning, using AWS Rekognition service we were able to define a sophisticated deep learning-based operation of labelling objects present on a given image just in few lines of code.\nWhen using serverless framework we need to create a configuration for each function. Configuration for <code class=\"language-text\">CreateHandler</code> function is following</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> ajurasz.lambda.gallery.CreateHandler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> gallery\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> post\n          <span class=\"token key atrule\">integration</span><span class=\"token punctuation\">:</span> lambda\n          <span class=\"token key atrule\">request</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">passThrough</span><span class=\"token punctuation\">:</span> WHEN_NO_TEMPLATES\n            <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">image/png</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'{ \"operation\" : \"create\", \"base64Image\" : \"$input.body\", \"principalId\" : \"$context.authorizer.principalId\" }'</span>\n          <span class=\"token key atrule\">authorizer</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> auth\n            <span class=\"token key atrule\">resultTtlInSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n            <span class=\"token key atrule\">identitySource</span><span class=\"token punctuation\">:</span> method.request.header.token</code></pre></div>\n<p>we see that this function is triggered by HTTP specific event - POST request to <code class=\"language-text\">/gallery</code> path. This configuration is little bit more complicated than for other functions and this is because we are not using default <code class=\"language-text\">lambda-proxy</code> integration (integration between API Gateway and Lambda) as we need to customize it to handle binary data. More information about handling binary data in AWS Lambda can be found <a href=\"https://aws.amazon.com/blogs/compute/binary-support-for-api-integrations-with-amazon-api-gateway/\">here</a>. We also secured our function with <code class=\"language-text\">auth</code> function that will be invoked before target function to check if supplied token is valid. <code class=\"language-text\">auth</code> function response is cached for 30 sec, the cache key is a <code class=\"language-text\">identitySource</code>. Usually when using proxy approach the whole request is forwarded to our function and configuration is as easy as</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">list</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> ajurasz.lambda.gallery.ListHandler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> gallery\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> get</code></pre></div>\n<p>or</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">  <span class=\"token key atrule\">delete</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">handler</span><span class=\"token punctuation\">:</span> ajurasz.lambda.gallery.DeleteHandler\n    <span class=\"token key atrule\">events</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> gallery/<span class=\"token punctuation\">{</span>id<span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> delete\n          <span class=\"token key atrule\">authorizer</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> auth\n            <span class=\"token key atrule\">resultTtlInSeconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n            <span class=\"token key atrule\">identitySource</span><span class=\"token punctuation\">:</span> method.request.header.token</code></pre></div>\n<p>when we want to secure our endpoint.</p>\n<h2>Testing</h2>\n<p>With good encapsulation, you can test a lot. In my case, I only was not able to test Rekognition and DynamoDB services so had to use mocks. Recently (again, thank you Twitter) I found that <a href=\"https://github.com/allegro\">allegro tech team</a> open sourced <a href=\"https://github.com/allegro/embedded-elasticsearch\">embedded-elasticsearch</a> to make unit and integration testing easier and more reliable.</p>\n<h2>Deployment</h2>\n<p>This can obviously be a part of CI/CD pipeline as when everything is ready you need to execute just two commands</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">./gradlew <span class=\"token builtin class-name\">test</span>\nserverless deploy</code></pre></div>\n<p>this could be simplified to just one command by executing <code class=\"language-text\">serverless</code> command from within gradle task.</p>\n<h2>Conclusion</h2>\n<p>Personally, I wouldn’t consider building my whole application as functions from one simple reason - vendor locking (<a href=\"https://startupsventurecapital.com/firebase-costs-increased-by-7-000-81dc0a27271d\">this article</a> is kind of “lessons learned” type in terms of vendor locking). But this is a great option when you need to run some simple function triggered by different events somewhere on the web. There is still some lack in case of debugging (or I didn’t yet discover how to do it properly) these functions - at this point I will say only - <em>logger is your friend</em>.</p>","frontmatter":{"title":"Kotlin + AWS Lambda + Serverless Framework","date":"May 28, 2017"}}},{"node":{"fields":{"slug":"/2016-12-15-homemade-central-heating-temperature-monitoring/"},"html":"<p>Over the weekend I decided to once and for all resolve issue with boiling water in our central heating system. For people who don’t know what I’m writing about here, you will find nice <a href=\"https://www.plumber24hours.co.uk/plumber-blog/index.php/2013/01/05/solid-fuel/\">ilustration</a> that should make it clear. In my case the problem is that when I focus on something I forgot about the world around me and then after some time the sound of boiling water in pipes immediately pulls me out of my work and in few seconds I’m in the basement trying to resolve issue in different ways and this isn’t a pleasant operation. Please notice that this situation is very dangerous because boiling water can damage pipes and in few minutes your home can be flooded and repair costs probably will be very high.\nSolution to my issue would be replacing the old furnace with new one that can automatically take care of temperature adjustments, but I have got much more cheaper and more interensting solution for this one. </p>\n<!-- end -->\n<h2>Idea</h2>\n<p>My idea is to use <a href=\"https://en.wikipedia.org/wiki/ESP8266\">ESP8266</a> that will send temperature readings to <a href=\"https://www.cloudmqtt.com/\">MQTT broker</a> running in the cloud\nand then business logic will be handled by lightweight nodejs application running on <a href=\"https://dashboard.heroku.com/\">Heroku</a>. Logic is simple, display the current temperature in real time one web page using WebSocket protocol, expose REST endpoint with current temperature and send a notification to registered Android devices when the temperature is over 80 Celcius degrees. Registered devices will be stored in MongoDB hosted by <a href=\"https://mlab.com/\">mLab</a>. Here is top level architecture diagram:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 690px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 48.57142857142858%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACj0lEQVQoz2NgLF/Bwvz/PxNj2wEWxtJyBhhQv3OBRWxuDwdDsi8Lw7QOFoZ4Txbh6c0csjPqWUDyTCntTIy5s3gZE7uFGJN7hRiLFvIx5s1hZmBMn8TPYOojyRhSys+Yv0yQQa+ZjdtYl0fU11MIpPHOs+dNd548OXPz2YsuBtlpbPxxVSKsjAyCDGFLpJh6T/ADlQgAMTdj+0EuoIGyDIwhFZwM/KIKDHKK3IzZq8UYzFqFOOQlpLjlZGWBChnPv32/98Lbt/8PXrl5i0F9DQ+bW4w4CyeHDAOXiDSDhrkCY+hkCcacZYKMhXN4GPPnszIw5c3iZQqeJ8WUt4yPqXw2O8hVOv9/MgcAgwHEPvbju8bRL1+cbj1/aeVrMJWJr7Gai9/IAORtZpC8sE6YnLienQA8rCKBWIidSVqUgYEFJibWVs8uVFPKyoAFSM/o57D4/x9ZiAvB9GdgYHWYy86gOcGUwXgyH0xYYlIXq+Tkbk6RjgbW6FcP2Xb9/8+ScPIwu2RPK5vE5G4e2eZ6xlsPfjGC1M7adGTJrI0Hc0HsmRsPMTFM2XpbYNmhxzMXH3miCBJccPgRWKF4VxOr4rHdLBwmhgIsstKyPB4u3HKbVrACxVmqVAIZ/v//D1Z34+2X15eev18AZbMwfP7/X+rG/cf/Lz96bQMWfPmZSby5BtlLoHAVhIUZCNglFsANXH/0ws7VB87UgtjrDp5kZvgINPDizbv/z9x5ZgsSvPzkA5PUvGkMiif3MXA72aGEH2+AN4PswW3owcoNxJz//28GRyLD1Te/hG6/+rz93JPP2iD+2adfGLFFhomJCZhOSUlhA2Le5NQ0nqyECO6cWQe4jBoPSq2YXihXGefBDgACGNmIV03LbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"esp8266_remote_temperature_diagram\"\n        title=\"\"\n        src=\"/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png\"\n        srcset=\"/static/5e5d7d080fb98fe2e4801751713735c5/4edbd/esp8266_remote_temperature_diagram.png 175w,\n/static/5e5d7d080fb98fe2e4801751713735c5/13ae7/esp8266_remote_temperature_diagram.png 350w,\n/static/5e5d7d080fb98fe2e4801751713735c5/1e043/esp8266_remote_temperature_diagram.png 690w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>Costs</h2>\n<p>Only costs I had to bear were for physical devices:</p>\n<ul>\n<li>ESP8266 bought <a href=\"http://allegro.pl/modul-sieciowy-wifi-esp8266-sterowanie-rs232-at-i5506834559.html\">here</a> for about 4$</li>\n<li>Converter USB UART/RS232 bought <a href=\"http://allegro.pl/konwerter-przejsciowka-usb-uart-rs232-pl2303hx-avr-i5734968614.html\">here</a> for about 1$</li>\n<li>DS18B20 digital temperature sensor bought <a href=\"http://allegro.pl/czujnik-temperatury-ds18b20-wodoodprony-przewod-1m-i5460123942.html\">here</a> for about 1,8 $</li>\n<li>Power supply bought <a href=\"http://allegro.pl/ladowarka-zasilacz-usb-5v-2a-kabel-mikrousb-i5903646901.html\">here</a> 4$</li>\n</ul>\n<p>Total: 10,8 $</p>\n<p>If it comes to MQTT broker, application and database hosting I’m using free plans as they are sufficient for my needs.</p>\n<h2>Implementation</h2>\n<p>Complete project can be found on <a href=\"https://github.com/ajurasz/RemoteTemperature\">github</a>. In this post, I will only focus on core parts of each component. So what are the components:</p>\n<ul>\n<li>ESP8226 device</li>\n<li>Nodejs application </li>\n<li>Android application</li>\n</ul>\n<p>Regarding <a href=\"https://iot.eclipse.org/resources/white-papers/Eclipse%20IoT%20White%20Paper%20-%20The%20Three%20Software%20Stacks%20Required%20for%20IoT%20Architectures.pdf\">Eclipse IoT White Paper</a> I would say that in my simple architecture ESP8266 act as both field device and gateway. Nodejs is an application that only performs business logic on data delivered by devices (in my case just one device). Android application is for the end user, where that user can check current temperature and be notified when the temperature is too high. </p>\n<h3>ESP8226</h3>\n<p>If it comes to ESP8266 there are two main things that you need to know when playing with this device. There are different wirings for deploying and running your program. When you want to deploy your program to the device you need to set up wirings in following way:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25249e1fdd8758c1dcd6545a8021fe83/f5209/ESP8266_upload.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACN0lEQVQoz32STWsTURSGZ+s/0I3uXLhSFMS9iFBx0YVYNxYEtUJBKGk3orhwVQUFNy4VlLZoG9NvmzRJk04mycxk8lGT2rQWirU0k6aaNOlHZh4nY5pGCz3wcuCee59zeM8VqoZBtWpgh2mwtJglEddQ5KidY6pCMhlH19ftK4Z13zBNW2ZT3pdAPQwT9N/bRLQ5AmEVjz9EQFLxizLT4QhJq9FRYTeyJMzEVixIlkHfPOnsGqFZGfe0yKRXxGtljzuI1z/LbGqJ4h7kCgXW8wXyW9sUyxXyv4qUd3YbYOHU5W6OnW7lfEsHaaeL+Rk/UZ+bQNCSc5CZoSG8zn5cAx959fodJ290cqLNwdmbHZy73cXx9iecaevk+rUWHI5uhJdvx3n0fIBbPT0kMl9RNY33A30MT4zg9nkZm/zChH+KzMICfZ4AF7ufceXxG1rb73LpjoMLXS+4+vApD+7fo7e398DDKc2DL+jn8ycn/R/6EAMic4kkmhIjFlfJb+gUKfFj62fdc7O+SPMfL4VqtWodWt7sbpAtfSeQFm24KzTCaHic4dAYrugo0nKUucI3NrYLfzkcgGrbrXFqEvbXXauXdyrEUwkiSoRgKEhUiSJFJEJqiMXVpcbjoyTUOpn1sQ3rP2bSGbSYRlgKo6kxlKiCrMmsrK00gM3g/5sIzYU9a+RUKoUsy4iiaH1u2QZLisTy6vIhYHNuePh/cXNzk1wuZyufz9tZ13XK5fIhQPO7SqVCqVTiD2QzC3rQ67XmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ESP8266_upload\"\n        title=\"\"\n        src=\"/static/25249e1fdd8758c1dcd6545a8021fe83/8c557/ESP8266_upload.png\"\n        srcset=\"/static/25249e1fdd8758c1dcd6545a8021fe83/4edbd/ESP8266_upload.png 175w,\n/static/25249e1fdd8758c1dcd6545a8021fe83/13ae7/ESP8266_upload.png 350w,\n/static/25249e1fdd8758c1dcd6545a8021fe83/8c557/ESP8266_upload.png 700w,\n/static/25249e1fdd8758c1dcd6545a8021fe83/e996b/ESP8266_upload.png 1050w,\n/static/25249e1fdd8758c1dcd6545a8021fe83/f5209/ESP8266_upload.png 1061w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>when you want to run your program, wirings should be set up in the following way (scheme contains temperature sensor connected to ESP8266):</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 254px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFKElEQVRIx6WWC0yTVxTHvxlJ5jbMtgyK4txi1BCRMJ0axSDoptMtgsNA6GDKHB1DNAsCFXRE3uImVQSsQEUt47GBYCkSdDrUKkMEx0AYUoE6kJdM2sqj9PXf/T7aCTIQ6m1OvpMvp7/+z73n3FMKEyy9Xg+dTsf4EokEXC4X4eHhSExMhEaj+S/m+UVNBjR+kcfjgaIomJmZwc7ODmq1+uWAfD4f5ubmsLa2hpOT0/SBdOBoYFJyMmbNmgVLS0s4ODhANTw8Jm5KCumlVo8ABWmpDJDFYmGdoyONMk0h9DrQyR2IioP566/BiihcvmIlmtq7pqeQSVc7csIFN6thw94L1lYOLIjNc+VgX5LQGDh9YObV23jVbR/mfBUJK59DMPcMhXtcuukKc8oqMcczCHN3HISl9wFYsUPASTjzEsBrlZjvFQwLrzC8Q8ySzcWuoxmmALWMf5akTG3ZgyUBh7HAN5JJ3yU6zXSFuUThXJLyMv9ILNjGwcwPN8M1OMYQp5s6UGsAlpRXwzUwAgvYgVjkHYz3vLlgx5mg0AgsulkF593fY9V2HzhtccEq543wC4swPWUhXTbbg2Cz2hlr7G2xzNYGOznfTj9lI/AcAc5w+Q727ACs9/aDg8cu+EYmmK7w3G+VMHMLwmrucdgHJsAmIB7uR86OAxr9F5fNJQlmbNyFxX4xeNcnHNakwANP5Y0D0pcxbRMDNSNAQU4+KOslsPo6GiyvULzN3g/fxKwxwNFpv1DhadFlzHT4HAv9YhmFLNJ+HvEZo6phJC4rKwsRkRFTOZRKzP4iDA77eXDkHoNdQBzcYgXjgLwEHji+nBcrTL9SCYtPdmKTx3Z8tIMDJw8OXKP4Y1Mmn9rGOjRIGyYG6gz70qYYQElBCXjf7Aaf7GdR2S3cbmxhbm2jOsWTx0grKcXFX0STjwDjGEV3Jy4eiUevvO9/44aUfUjKKUVJqmjyEaAnQFqnqrUVuWQmpwgEEBeJUVBYCJFIxJhYXIy87Ezw839F6ZliUPTmjzWtwYhvGFJqmQwFUVGoaWiAamgIcrkcSqWSMblCgeF+BR4oARH//OQpGxetsDAmGi3t7RPGtPYbgIdPX0Os4Bpi0q8zzx/Jy/i0UsQIJIg6VYbOp0RlVwdRGI0motS4t8ZtGdlnHVqe0kDSBLNXhYBaGAZqETFbctVbsGD2/lbYuh7Fyg3+kJwSoiNXiOy4Q2hufzShQtkguepSC0FtYIeR2gqB594f8PHOeLy1aDPeXLEHTt7H4fLlQdyt+BPyinLkhIWivr4e+oEBDPb1YYic+LCyH4NyJfSKJ2jsHER+ghDUJtKbnr5B+GBbBOY6BmP5GmfM++w4Fvskw5Fc+eWJfHTkZCM7NBQ3Tp5EFzlZWX4e2gouoCEjBdKss+i+UABJlhjnT+SAWvppCNa6BWP+ei5eWRqIOWsD8Mb6Y5i3zg9r3SPQ2q1iUqqurcV9qXRMms13iqDoamJ8aY8KVbIBUJfLm0Hb1QopblY1Q3hJihTxAySn/Ywd/oeQX1iM62VlSEkmappGgBrDv686SRF6Hv7F+A1/K3Crvnd82fSrtMj/vQuXa7qReakW6eK7OFlYhfTiGojvkI6524Pi6m6U/NGL87eaybtHuFLXh59udOCeTAmKHkajjS6DQZUGyiEthklFqEmr0OVNP+kfezqkYZ6K/mF09SrQ1vkY3f8o0NnzBCqV6plC/ai2G9WEz9mzpdWo8VDWigfSJtTfq0PT/UbU1NTgX/I2rwVA5LL8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ESP8266_run\"\n        title=\"\"\n        src=\"/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png\"\n        srcset=\"/static/85801ae33ce503d5e02cee5724711ac0/4edbd/ESP8266_run.png 175w,\n/static/85801ae33ce503d5e02cee5724711ac0/6a91e/ESP8266_run.png 254w\"\n        sizes=\"(max-width: 254px) 100vw, 254px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Main responsibilities of ESP8226 device are:</p>\n<ol>\n<li>establish and keep a connection to local network (to gain access to the internet) </li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ESP8266WiFi.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">wifi_ssid </span><span class=\"token string\">\"&lt;your ssid>\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">wifi_password </span><span class=\"token string\">\"&lt;ssid password>\"</span></span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span>wifi_ssid<span class=\"token punctuation\">,</span> wifi_password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> WL_CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"WiFi connected\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"IP address: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">localIP</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"2\">\n<li>read data from the temperature sensor</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;OneWire.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;DallasTemperature.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">ONE_WIRE_BUS <span class=\"token number\">2</span></span></span>\n\nOneWire <span class=\"token function\">oneWire</span><span class=\"token punctuation\">(</span>ONE_WIRE_BUS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nDallasTemperature <span class=\"token function\">sensors</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>oneWire<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  sensors<span class=\"token punctuation\">.</span><span class=\"token function\">requestTemperatures</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">float</span> tempC <span class=\"token operator\">=</span> sensors<span class=\"token punctuation\">.</span><span class=\"token function\">getTempCByIndex</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"3\">\n<li>push readings to MQTT broker</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ESP8266WiFi.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;PubSubClient.h></span></span>\n\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">mqtt_server </span><span class=\"token string\">\"&lt;server ip or hostname>\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">mqtt_port </span><span class=\"token string\">\"&lt;server port>\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">mqtt_user </span><span class=\"token string\">\"&lt;user name>\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">mqtt_password </span><span class=\"token string\">\"&lt;user password>\"</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token expression\">temperature_topic </span><span class=\"token string\">\"temperature/home/basement\"</span></span>\n\nWiFiClient espClient<span class=\"token punctuation\">;</span>\nPubSubClient <span class=\"token function\">client</span><span class=\"token punctuation\">(</span>espClient<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">setServer</span><span class=\"token punctuation\">(</span>mqtt_server<span class=\"token punctuation\">,</span> mqtt_port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">reconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Attempting MQTT connection...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ESP8266BasementClient\"</span><span class=\"token punctuation\">,</span> mqtt_user<span class=\"token punctuation\">,</span> mqtt_password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"connected\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"failed, rc=\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">state</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" try again in 5 seconds\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">5000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">reconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n  <span class=\"token punctuation\">}</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span>temperature_topic<span class=\"token punctuation\">,</span> <span class=\"token string\">\"80.0\"</span><span class=\"token punctuation\">,</span> true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Wait 30 seconds</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">30000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can run above snippets independently or combine them together. At this point I need to say that it was so easy only thanks to these great libraries (as I have basically no experience in C language):</p>\n<p><a href=\"https://github.com/esp8266/Arduino/tree/master/libraries/ESP8266WiFi\">ESP8266WiFi</a></p>\n<p><a href=\"https://github.com/knolleary/pubsubclient\">PubSubClient</a></p>\n<p><a href=\"https://github.com/milesburton/Arduino-Temperature-Control-Library\">DallasTemperature</a></p>\n<h3>Nodejs</h3>\n<p>I wanted to have something very light on the back end and to be able to host it for free so I decided to accomplish my requirements using nodejs which will run on Heroku. Another reason to choose Nodejs was that I wanted to check it out as I heard a lot of good about it. </p>\n<p>Main responsibilities of the Nodejs application:</p>\n<ol>\n<li>expose REST endpoints to handle device registration, update and delete:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/device'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> deviceName <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>deviceName<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> deviceId   <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>deviceId<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> registrationId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>registrationId<span class=\"token punctuation\">;</span>    \n\n    Device<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>deviceId <span class=\"token operator\">:</span> deviceId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> devices</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>devices<span class=\"token punctuation\">.</span>length <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Device<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                deviceName<span class=\"token operator\">:</span> deviceName<span class=\"token punctuation\">,</span>\n                deviceId<span class=\"token operator\">:</span> deviceId<span class=\"token punctuation\">,</span>\n                registrationId<span class=\"token operator\">:</span> registrationId\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> device</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>            \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>        \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/device'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> deviceId   <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>deviceId<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> registrationId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>registrationId<span class=\"token punctuation\">;</span>\n\n    Device<span class=\"token punctuation\">.</span><span class=\"token function\">findOneAndUpdate</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">{</span> deviceId<span class=\"token operator\">:</span> deviceId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> \n        <span class=\"token punctuation\">{</span> registrationId<span class=\"token operator\">:</span> registrationId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> \n        <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> device</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/device/:deviceId'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> deviceId   <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>deviceId<span class=\"token punctuation\">;</span>\n    Device<span class=\"token punctuation\">.</span><span class=\"token function\">findOneAndRemove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>deviceId <span class=\"token operator\">:</span> deviceId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">sendStatus</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol start=\"2\">\n<li>expose WebSocket endpoint using <a href=\"https://www.npmjs.com/package/express-ws\">express-ws</a></li>\n<li>subscribe to MQTT topic and update <code class=\"language-text\">lastTemp</code> object with current temperature and notify registered devices if the temperature is above 80 degrees:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">mqttClient<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">topic<span class=\"token punctuation\">,</span> message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'received message %s %s'</span><span class=\"token punctuation\">,</span> topic<span class=\"token punctuation\">,</span> message<span class=\"token punctuation\">)</span>\n    lastTemp<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    aWss<span class=\"token punctuation\">.</span>clients<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">client</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        client<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n            topic<span class=\"token operator\">:</span> topic<span class=\"token punctuation\">,</span>\n            temperature<span class=\"token operator\">:</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">parseFloat</span><span class=\"token punctuation\">(</span>lastTemp<span class=\"token punctuation\">.</span>temperature<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">80.0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> message <span class=\"token operator\">=</span> <span class=\"token string\">'Warning temperature is very high '</span> <span class=\"token operator\">+</span> lastTemp<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">+</span> <span class=\"token string\">'°C'</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">moment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">diff</span><span class=\"token punctuation\">(</span>lastUpdateDate<span class=\"token punctuation\">,</span> <span class=\"token string\">'minutes'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            gcm<span class=\"token punctuation\">.</span><span class=\"token function\">pushAll</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                lastUpdateDate <span class=\"token operator\">=</span> <span class=\"token function\">moment</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>above was accomplished with <a href=\"https://www.npmjs.com/package/mqtt\">MQTT</a> and <a href=\"https://www.npmjs.com/package/fcm\">FCM</a> libraries. Documentation is very good even for Noob as I’m (in the case of Node.js) so no more explanation is required.</p>\n<h3>Android</h3>\n<p>For Android system, I created a simple widget which displays current temperature and is also able to receive messages from <a href=\"https://firebase.google.com/docs/cloud-messaging/\">\nFirebase Cloud Messaging</a> and display them as notifications. Because this is my first experience with Android SDK and I did all the research and implementation over the weekend I beat that there are better patterns for handling my requirements. Here are two screenshots of this application:</p>\n<ol>\n<li>widget</li>\n</ol>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 346px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAIgElEQVRIx22V51eT2RaH37/k3s9TLSg4M44oKEgd+oAKShOxgEDoEAiE0AIo0kRQSmjSu46iUqSJooC9ARbAOk39+Nyd4Ky5s+7NWs/a+5x3/377nJ28K8r5onoulDbREFdAs7qIs8kn/oemz/xjL6mQFk0p/ccN9ORX062voiv3DMp4WTvjZR0M5jUwXNDEUEEjQ/kNQuP/ZfCvKPVDUj9a0sZYaTsjhc0mlNmibmaKupgt7saYz5b2MFfe/09O9n2m38SsiT4TM6W9q5QZ6UNZGp7j1eg93l57wrtrD3jZc53Fqiss1g6xWDNoYsEwZGKxZpUFI4ZhU5w3Ivm8PJ+vHkT58+MHjJ9P96f5Y+WdKX/Xd5PXhlHeNE7wpn6cV23XWO69wXKP0HXdxEr36nqlfYpXzfK8Y4plqVf++PTRZDL1aJBri6uGv1+6w/vaMd43TvK+YYJ3Et81TfLWiORvZG+leZKllkmWmyZYlvWSxNcGMfz1wTM+zK/wx7PXfHyxwofrT3lnuLpK7Spva4TqkVWqRngjLBtGeCk1L+uusmSMUveq6qqcsH6Ej41jfGoY40P9GB9rR/kkR/8oXT/UGxlfpW6cPw1C7Sq/VY3ytnKItxXDvKkY4rXwSlB+rbvCTfmZ3NDXmZjKqWMio5oJXQ2TmbWmfDy9igltNZM6A5MZBsbSq7mf38E7o0n5ZeEKK0ZOXkFZPnMOjfd+kj0CUbsHkvrzAbIDo9D6HpH9UHT+R8kKiJR1GIkugSS7BhFht5vW8Fz+rLzKcvFFVkovsVxyiaWSAZQVMdTtDiXNOwS1awD6wEgG6tvpKK6iMaeEloJTNOnLqEzMJt7OF417CDEOfrSF6/m9fJilE7+wfOKCxAu8FJSV0/3odoWi8QwmS05VFJbEmeQcymMzKFOlU3w0BX2QihpNAWVRaaS4BBFt70vrkRx+Kxvk5bFzLB0/L/E8LyRXlk71keYlV3b1R7fnMLlBUWTuDUPne5hUrxC0uw+hMY7BP5LTaj1JzgFE2O6i+VAWv5Zc5nl+Hy8L+nmR32/KlSV5ffL2hJHjc5hs70NkeoaS6RX6OR5E53FACEXrGkKaczCZHodIdg6k44ietycu8kzfI/SyaCS3B+V9xYAMU7oU9fHiRB/PC3t5dryHxWM9LBR0M5/fxVN9p4knuZ08zu7gYWYbT7I7xaCX+ZxunmZ38ySrm8eZXShvygZ4UzrA6+IBVoourg648BfTTJ4XnONZ/jkW8/rlBH0s5PbxNKdXzHp4JAYPdJ3cz+jknhFtB3fTO1Beyrf0XMSLIl4Q8VN9v5ykj0cifCjCByK8L53v6bq4K8I7Iryd3s7ttHbmjGjamDWS2sqMoDyTgS7kSWeZwWO5wqN/mIhBxn8Z/CVMaeFWSvMq6rPcVDdxM7mJ6eRGlEW9zClX5iQzeZwl89G18yCjTa7Qyt20Fm5rWphLbWY25SwzIrwloltJDdxMrGc6Ud6ueAPXTdQyFVcjhjltzGe18kTXwiNtMw/Tz3Jf08Td1EbuqBu4ra5nLqmO2UQDMwm13Iqv4WZsDdMx1dyIrmJKdZprUZVMRlYyEVGB8jSjkcfpDTzU1HM/pY67ybXcSaphLqGa2fgqZuLOcCv2NDejTzOtqmQ6qoIbkaeYOlrOZPhJxsPKGD1SytXDxQwfKkJ5oK7mXlIVdxLOMBd3mpmYCm5FnxJhuQhPcj2ijKnwUq6FlTB5pJiJw0WMHTzBSGghQyHHubL/GJeC8xkIzONigF7+U6JPciuyjOmjpdwIL2bqSBGTh04wcbCQ8dDjjB44xtWQAob35zMUnMeVQD2XAnK5uC+HX/Zmcc43k/49Onp3ZdDjo0UZDRGBdBgJymNIOgz653J5bw4Dftlc9Mvigm8W50VwbncGfSLqFVH3z2l0eWno8Eil3T2VNrcUWl3VtLioUfp9dPR5i7uXFHqm0+WeRofQ7qahzTWVVpcUWn5KodlZzVmnZJock2hwSKTePpE6uwTqdiZgsI3HYBNPrU0cSrdzKp1OKbQ7SgeHZJrtkmjcmUiDrQhsEqjdEU/N9niqreOosorljFUMp7cJW6OptIymYks0p35UUS6c3KxCabJOoN5KOmyLo3prHGcsY6ncEisFMVIQQ+kPMZQIxULRdyoKN6k4bqHimLmKAvMo8jaq0G9QkWMWTbaZGOo3RMkiiqz1kWSuj0K3LooMQbtWhWZdNCnfRqExi0H7fQKJX0aQ+HUk8V9FEifEfPkXEUR9EUmEoGRaa8mw0qIVNNvSUW/VELclmegfEkixiCV1s5rEbRkkWKYTtzWdWMs0Yiw1RG9JQ7VFQ5illgOW2YTLfviPKSjBVnEEyEyCtsWy1zIK781heH53AJfNh7EIrsHB8xghMqtDO0Vsp+WofSYRDllCJuH2OWTKzGt3+hG3PY0Ip3wUe7NAVgkwRSfzYOy+2YtLWjf1Cx8I6X/C91tVuKz3l2f7cd4oSHTdEMKOzUEcCwpgIKGQy2meeP0gV3a2CJQCwSLIxE+bgnFY64d1zgDDS7+hHn7GJptE3M324WQRjNPGQBwFZ7MgbL/35V9FkUQOXOZupys2a/xQHMz34mDu9zcWItywB2vLg/z7cB1rPbP4SdZOm4wnlGfm/iYcpc51QwBmjnvYn+BAuJM3tusDUXZu2IXtBh9szbxNbF/jic16b+zWeeH4tQuOazxM6x1rfsZ+4x5p6oujNDZis24Xzmt9cfjWX2qMN5AT2piJwWes17qRFJ6Jh5U/VmvcsDX3YctXLhzxi6cgvYytktub7xLjXVh/40F5fi1H/dVYyyGcNvmZGio71rvzN264W+1jp7kX29e5SRMPtksTly2++OwMNuW20tiIzToPfB1CcbPcJ1f1kkY+2G304T/UcJQQbYNZbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"android_widget\"\n        title=\"\"\n        src=\"/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png\"\n        srcset=\"/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/4edbd/android_widget.png 175w,\n/static/e9e73577e9a8e2aaa4f0b1e1eab4f702/8f77f/android_widget.png 346w\"\n        sizes=\"(max-width: 346px) 100vw, 346px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<ol start=\"2\">\n<li>notification</li>\n</ol>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin: 15px -30px !important max-width: 346px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 177.7142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAFtElEQVRIx5WV2W9TVxDG72sViSRe493xvu9xvGRxYsdxbGdx4hClaXnggapVVaoWFWipSiXoX9YHHvtQQBA2iVTNBkFZHUL4OnPsawyi0Fr6ac4y3zfnzLF0pWAwiEgk0iYQCIDXPgbnhcPh9tjv94uxFAqFMD09jVqthrm5uXaCHDsLdK5z8StXriAejwvjTCYjTCXe9Pl8IpHN32fEifIJGM73er1IpVJtDZuyRuJK2WxWLMibvBaLxdpzPkUymRRzFrFRLpdrF+F8WS85HA5x5YWFBdjtdlitVhQKBSwtLcFisYD30+m0WOOxzWZDPp/HysoK3G63WGMjLshjqVwuo16vY3FxEZVKBdVqVZh3zjlyUY7MzMyM6Dlr5Rx5X9rb28PDhw+xvb2NnZ0dPH/+HM+ePcOLFy8EvH9wcID9/X0R5bG83rnGUTo+PsatW7ewu7uLra0tYcjmjUZDxJcvX+L//KRXr17hwYMHuHPnDu7duyfGfOLbt2/j9evXHxTz/unp6VsIw0ePHmF1dRVPnjzB06dPxZxN19fXxfX55BsbG1hbWxOR57z+3hOenJygcXSEI4L7IEe5L4eHhwKec1s48pzzWMsH6kQY7lES94rHcjzhBLqCnNh5LXlN5L2DdESP8vsff2Jnbx9rG1tY397B38RfG9s4ahyLPsn8p0dh19XWQ3AfuYccef3fHuJDSHzF+/fvC8PHjx+Lh7l7965oOv9tNjc3xSNwPKYTC9PTDxhywgE1mfvVOG7g8Iga3uB4hL39PcH+wT526Y9Mko9f+ebFq/jt259w8+KPbW4w33RyVcRfv76M61/90ObnL77HtQvfUSQo/vLlJUjTgSFUfVlBxZtBmZjypNuU3GlMulOYdL2h6BzEJPF5bhYXyss4X1zEubE5TJFWWkoVsTRYxNnkBBaZAaaAeqKABSaeF8zHmHHUiPkoxegYljNlfDpUwVKqhOVsWexLZxPjWIyPox4fw0KMiOZIQERyqEVGUQuPYo4JjbSZDQ4Lqr4M3Sr9VpTqsRzqsVEyGiWTEcyHR8hkmIQtgkMkJgJMFrP+LGaIaRIzshlT9qQgzUeGyWQItdAQibOCpjBDQsKXJmGTqjeFKokqRNk9KJhyJVFinAPU1wFIc4EMidNCOEOCacbDwkFUSVBxJ0lIkGjKNYApEpWcCUw6Eig64ija45iwxQSF/hikSiu57GwlUyIzaWeagqKtJepvigrWKPLEOGOJCMbMTaSJ/ngz0dokb4kKxs1MK9EUQU4QxqixhSGEkU70DH2XC5SYJ8aNJKTEnKHJaDsphGEdE8QQ09ckK6MNINMiraHPaI6SR/pIQJvMkJaTgpQQpIQmqRaD6oAgqZLxY4BiQsnQ55aixBMexBUBxDqIEhEFfcB7aUzJMQ19d7v9CPXQt7hFoAM/7fkIKaaLIaaLIkox0hdFmAhqw/BrQghT9Qgb9dFHX0vrtBdgtE38hJf23NoExSh8pJNcdE1HXwBOwq71o1/jhUXthknjgco1DKM1CRf1x2OIwGsgkTEGvzFOkUkgLh7FjiAdym+i/6FB6UQTh4hGlQuGHjvM0TxGFz+De6IONRUyKRxiz6QkKJop6jROJJ0OlEKDKEWtsGp8kEwqJ97F0GuHLjGJ8tIKwuWzUNFLm5VsSAVFUcqjqFfb0JWi/pVKqOXN0JNOMqrseAu1g5Jt0Gk96PKMQGGNk5kdJjUb0Z7KISJjIWOl0Q5X0EjX74de4YSkV9FA+QZNtwk6hRUGwthjoqta0NdjgeaMsVXU1i6uOWOCobsfxl46rYKL0Qn1SisZWcBRSwbnls/D74xA3U0GdKWeT7QoT8zi0sXL6KWxSc2ntUHZpcf1azdQLdag6NLBrHGIYpKOTqBvoes1I+CMwqy1o4/GXEjbY4TL6kfUnxQFmwewiv2BcAYea0DouLiRbvsPsrI+8dYHv8cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"android_notification\"\n        title=\"\"\n        src=\"/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png\"\n        srcset=\"/static/661067bfd7d5360baed870f1284e362d/4edbd/android_notification.png 175w,\n/static/661067bfd7d5360baed870f1284e362d/8f77f/android_notification.png 346w\"\n        sizes=\"(max-width: 346px) 100vw, 346px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Integration with FCM was kind of tricky but <a href=\"https://firebase.google.com/docs/cloud-messaging/android/client\">“Set Up a Firebase Cloud Messaging Client App on Android”</a> article helped me a lot. It will take you step by step how to set up FCM client.</p>\n<h2>Future work</h2>\n<p>I will try to replace Nodejs application with application that use <a href=\"http://vertx.io/\">Vert.x</a> library.</p>","frontmatter":{"title":"Homemade central heating temperature monitoring","date":"December 15, 2016"}}}],"pathPrefix":"","first":false,"last":false,"index":3,"pageCount":4,"additionalContext":{}}},"staticQueryHashes":[]}