<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d16987a306a3d156a977.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.18.17"/><style data-styled="deuHhw dVlzdf FSiJo kfPuqG hyXYOK itGeow eXcfSN iWIxoV kGCCTl fGSVd gGIelI kVSOZg KDfzM gzoEET deWstv dgtalV ZNTDw cRzLhO jLNeCQ eBuswQ ukmsj" data-styled-version="4.4.1">
/* sc-component-id: sc-global-3434470545 */
@import url("https://fonts.googleapis.com/css?family=Roboto:400,700"); html{line-height:1.15;-webkit-text-size-adjust:100%;} body{margin:0;} main{display:block;} h1{font-size:2em;margin:0.67em 0;} hr{box-sizing:content-box;height:0;overflow:visible;} pre{font-family:monospace,monospace;font-size:1em;} a{background-color:transparent;} abbr[title]{border-bottom:none;-webkit-text-decoration:underline;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;} b,strong{font-weight:bolder;} code,kbd,samp{font-family:monospace,monospace;font-size:1em;} small{font-size:80%;} sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline;} sub{bottom:-0.25em;} sup{top:-0.5em;} img{border-style:none;} button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0;} button,input{overflow:visible;} button,select{text-transform:none;} button,[type="button"],[type="reset"],[type="submit"]{-webkit-appearance:button;} button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner{border-style:none;padding:0;} button:-moz-focusring,[type="button"]:-moz-focusring,[type="reset"]:-moz-focusring,[type="submit"]:-moz-focusring{outline:1px dotted ButtonText;} fieldset{padding:0.35em 0.75em 0.625em;} legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal;} progress{vertical-align:baseline;} textarea{overflow:auto;} [type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;} [type="number"]::-webkit-inner-spin-button,[type="number"]::-webkit-outer-spin-button{height:auto;} [type="search"]{-webkit-appearance:textfield;outline-offset:-2px;} [type="search"]::-webkit-search-decoration{-webkit-appearance:none;} ::-webkit-file-upload-button{-webkit-appearance:button;font:inherit;} details{display:block;} summary{display:list-item;} template{display:none;} [hidden]{display:none;} *,*:before,*:after{box-sizing:inherit;} html{font-size:62.5%;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;box-sizing:border-box;} body{background:#f9fafc;font-family:'Open Sans',sans-serif;line-height:1.5;padding:50px 0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;} img{max-width:100%;} .gatsby-highlight{border-bottom:1px solid #e0e6ed;border-top:1px solid #e0e6ed;margin:15px -100px;padding:0;} .gatsby-highlight pre[class*="language-"]{margin:0;padding:25px 100px;} pre[class*="language-"]{background:rgba(245,245,245,1);color:rgb(65,76,94);} @media only screen and (max-width:870px){.gatsby-highlight{margin:15px -15px;}.gatsby-highlight pre[class*="language-"]{padding:25px;}}
/* sc-component-id: sc-bdVaJa */
.deuHhw{margin:0 auto;max-width:1080px;}
/* sc-component-id: sc-htpNat */
.itGeow{margin-top:15px;text-align:center;}
/* sc-component-id: sc-bxivhb */
.eXcfSN{border:1px solid #bfc8d2;border-radius:15px;color:#3e465b;display:inline-block;margin:5px;padding:5px 10px;-webkit-text-decoration:none;text-decoration:none;} .eXcfSN svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eXcfSN:hover{border-color:#3e465b;}
/* sc-component-id: sc-ifAKCX */
.FSiJo{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;}
/* sc-component-id: sc-EHOje */
.kVSOZg{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;}
/* sc-component-id: sc-bZQynM */
.hyXYOK{color:#666d71;display:block;font-size:1.6em;margin:50px 0 0 0;text-align:center;margin:0;}
/* sc-component-id: sc-gzVnrw */
.kfPuqG{color:#3498db;-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: sc-htoDjs */
.dVlzdf{margin:0 auto;max-width:650px;padding:0 50px 50px;text-align:center;}
/* sc-component-id: sc-dnqmqq */
.iWIxoV{background:#fff;border:1px solid #e0e6ed;box-shadow:0 1px 5px rgba(0,0,0,0.05);margin-bottom:30px;padding:75px 100px;} @media only screen and (max-width:870px){.iWIxoV{border-left:none;border-right:none;padding:75px 15px;}}
/* sc-component-id: sc-iwsKbI */
.gzoEET{margin-top:50px;text-align:center;}
/* sc-component-id: sc-gZMcBi */
.deWstv{border:1px solid #bfc8d2;border-radius:25px;color:#3e465b;display:inline-block;font-size:10px;font-weight:700;margin:0 10px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;text-transform:uppercase;} .deWstv:hover{border-color:#000;}
/* sc-component-id: sc-VigVT */
.kGCCTl{text-align:center;}
/* sc-component-id: sc-jTzLTM */
.fGSVd{color:#3e465b;-webkit-text-decoration:none;text-decoration:none;} .fGSVd:hover{color:#3498db;}
/* sc-component-id: sc-fjdhpX */
.gGIelI{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;}
/* sc-component-id: sc-jzJRlG */
.KDfzM{color:#666d71;display:inline-block;font-size:14px;margin-top:50px;-webkit-text-decoration:none;text-decoration:none;} .KDfzM:hover{color:#3498db;}
/* sc-component-id: sc-cSHVUG */
.ZNTDw{color:#65738c;font-size:16px;} .ZNTDw a{color:#3498db;font-weight:700;-webkit-text-decoration:none;text-decoration:none;} .ZNTDw a:hover{-webkit-text-decoration:underline;text-decoration:underline;} .ZNTDw h1{color:#3e465b;font-size:30px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h2{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h3{color:#3e465b;font-size:17px;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h4{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw h5,.ZNTDw h6{color:#3e465b;font-weight:700;line-height:1.5;margin:25px 50px 15px;} .ZNTDw p{line-height:1.7;margin:15px 50px;} .ZNTDw blockquote{border-left:5px solid #e0e6ed;line-height:1.7;margin:15px 50px 15px 75px;padding:10px 10px 10px 15px;} .ZNTDw blockquote p{margin:0;} .ZNTDw ul,.ZNTDw ol{line-height:1.7;margin:15px 0;padding:0 50px 0 100px;} .ZNTDw ul p,.ZNTDw ol p,.ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{margin:0;} .ZNTDw ul ul,.ZNTDw ol ul,.ZNTDw ul ol,.ZNTDw ol ol{padding:0 0 0 30px;} .ZNTDw img{margin:15px 0;}
/* sc-component-id: sc-kAzzGY */
.dgtalV h1{color:#3e465b;font-size:35px;line-height:1.5;margin:0;padding:0 30px;text-align:center;} .dgtalV p{color:#666d71;display:block;font-size:1.6em;margin:0;text-align:center;} .dgtalV span{background:#9c9da3;display:block;margin:50px auto;height:1px;width:150px;}
/* sc-component-id: sc-chPdSV */
.ukmsj{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kgoBCf */
.jLNeCQ{color:#3e465b;font-size:22px;font-weight:700;line-height:1.5;margin:25px 50px 15px;}
/* sc-component-id: sc-kGXeez */
.cRzLhO{margin-top:50px;text-align:center;}
/* sc-component-id: sc-kpOJdX */
.eBuswQ{border:1px solid #bfc8d2;border-radius:15px;display:inline-block;margin:5px;padding:5px 15px;-webkit-text-decoration:none;text-decoration:none;} .eBuswQ svg{display:inline-block;height:20px;stroke:#6e849c;vertical-align:middle;width:20px;} .eBuswQ:hover{border-color:#3e465b;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#3498db"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=d2916fe6b5dacda567acef0c52c2ae9f"/><title data-react-helmet="true">Accessing HTTP request data from outside of calling thread | Arek Jurasz</title><meta data-react-helmet="true" name="description" content="Dev Blog | Software Engineer"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/styles-4f1a9273244be790d38c.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js"/><link as="script" rel="preload" href="/commons-ed86373b90c649a8f6f2.js"/><link as="script" rel="preload" href="/app-93669a106e49c45c3abd.js"/><link as="script" rel="preload" href="/webpack-runtime-9284701b300429ba4c2b.js"/><link as="fetch" rel="preload" href="/page-data/2019-12-28-accessing-request-data-from-outside-of-calling-thread/page-data.json" crossorigin="anonymous"/><link rel="shortcut icon" href="data:image/vnd.microsoft.icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAADbmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmjX/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uaNf/bmTP/2pUq/9uZM//bmjT/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25o1/9ybN//alSv/25o1/+KtXP/bmDL/2pYt/9qVK//cmzb/25o1/9uZM//bmTP/25kz/9uZM//bmTP/25o0/9qVK//YjyD/36RJ/+W1bf/25s//3J07/+CoUv/irFv/2JAh/9mUKP/bmTT/25kz/9uZM//bmTP/25k0/9qVLP/hqVT/8tq3///////pwob/8tq1/+OvYf/ksmb///////Xjyf/jsWX/2pYt/9uZM//bmTP/3Js2/9mTJ//uz6H///////DUq//eo0j/1owZ/+7Nnf/tzJr/140b/9ydPP/syJP///////ThxP/aliz/25o0/9uaNf/alSv/57t5//nv4P/25s//68eR/9ybOP/ltGv/896//9qWL//pwIP/9eLG//nw4//rx5H/2pYu/9uaNP/bmTP/25o0/9mTKP/blzH/57t4//rx5f/ty5n/3Js3//Xjyf/pwYX/+/Tq/+rDif/cnDn/2ZIl/9uZNP/bmTP/25kz/9uZM//bmjX/25kz/9iRJP/ZlCr/3Z9A/9mUKf/z38D/5bRs/9iRJf/YkST/25gx/9yaNv/bmTP/25kz/9uZM//bmTP/25kz/9uZM//cmjb/25o0/9uYMP/bmDH/3Z4//9ybOf/bmDH/3Js3/9uZNP/bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uYMP/bmDH/25k0/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTT/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/25kz/9uZM//bmTP/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div><section class="sc-bdVaJa deuHhw"><header class="sc-htoDjs dVlzdf"><h1 class="sc-ifAKCX FSiJo"><a class="sc-gzVnrw kfPuqG" href="/">Arek Jurasz</a></h1><p class="sc-EHOje sc-bZQynM hyXYOK">Software Engineer</p><div class="sc-htpNat itGeow"><a href="https://twitter.com/arekjurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/ajurasz" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="https://www.linkedin.com/in/arkadiusz-jurasz/" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://ajurasz.github.io/rss.xml" target="_blank" rel="noopener" class="sc-bxivhb eXcfSN"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></header></section><section class="sc-bdVaJa deuHhw"><div class="sc-dnqmqq iWIxoV"><div class="sc-kAzzGY dgtalV"><h1>Accessing HTTP request data from outside of calling thread</h1><p>December 28, 2019</p><span></span></div><article class="sc-cSHVUG ZNTDw"><div><p>It’s almost end of 2019 but there is still a lot of application which depends on Servlet specification - this statement is base on my personal experience where I still see the majority of a new application being built using this technology. In this blog post, I will focus on a single use case where we will retrieve HTTP request data from outside of calling thread in <code class="language-text">Spring Framework</code>.</p>
<!-- end -->
<h2>Problem</h2>
<p>When using <code class="language-text">spring-webmvc</code> in a standard way - according to Servlet 2.5 specification - then every incoming request is bound to a single thread for a life of that request (calling thread). Everything is fine until you start to do some <em>side processing in child thread</em>. This is a common case when moving to less coupled communicating between modules in an application through Spring’s event bus. </p>
<p>Let’s consider the following scenario:</p>
<ol>
<li>Rest controller calls service</li>
<li>Service publish event </li>
<li>Event is processed by the listener in a new thread</li>
<li>The listener uses a service which at some point - in execution chain - requires data from the HTTP request</li>
</ol>
<p>Output from above scenario will be sucessfull response to the client from rest controller and exception in logs saying that we try to access request attributes outside of an actual web request i.e:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">java.lang.IllegalStateException: No thread-bound request found: Are you referring to request attributes outside of an actual web request, or processing a request outside of the originally receiving thread? If you are actually operating within a web request and still receive this message, your code is probably running outside of DispatcherServlet: In this case, use RequestContextListener or RequestContextFilter to expose the current request.
	at org.springframework.web.context.request.RequestContextHolder.currentRequestAttributes<span class="token punctuation">(</span>RequestContextHolder.java:131<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.web.context.support.WebApplicationContextUtils.currentRequestAttributes<span class="token punctuation">(</span>WebApplicationContextUtils.java:313<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.web.context.support.WebApplicationContextUtils.access<span class="token variable">$400</span><span class="token punctuation">(</span>WebApplicationContextUtils.java:66<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.web.context.support.WebApplicationContextUtils<span class="token variable">$RequestObjectFactory</span>.getObject<span class="token punctuation">(</span>WebApplicationContextUtils.java:329<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.web.context.support.WebApplicationContextUtils<span class="token variable">$RequestObjectFactory</span>.getObject<span class="token punctuation">(</span>WebApplicationContextUtils.java:324<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-web-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.beans.factory.support.AutowireUtils<span class="token variable">$ObjectFactoryDelegatingInvocationHandler</span>.invoke<span class="token punctuation">(</span>AutowireUtils.java:295<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at com.sun.proxy.<span class="token variable">$Proxy59</span>.getHeader<span class="token punctuation">(</span>Unknown Source<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at io.github.ajurasz.demo.GetUserId.userId<span class="token punctuation">(</span>GetUserId.java:18<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at io.github.ajurasz.demo.MyEventListener.handleEvent<span class="token punctuation">(</span>MyEventListener.java:28<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at io.github.ajurasz.demo.MyEventListener.handle<span class="token punctuation">(</span>MyEventListener.java:23<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at io.github.ajurasz.demo.MyEventListener<span class="token variable">$$</span>FastClassBySpringCGLIB<span class="token variable">$$</span>e876a886.invoke<span class="token punctuation">(</span><span class="token operator">&lt;</span>generated<span class="token operator">></span><span class="token punctuation">)</span> ~<span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span>
	at org.springframework.cglib.proxy.MethodProxy.invoke<span class="token punctuation">(</span>MethodProxy.java:218<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-core-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.framework.CglibAopProxy<span class="token variable">$CglibMethodInvocation</span>.invokeJoinpoint<span class="token punctuation">(</span>CglibAopProxy.java:769<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed<span class="token punctuation">(</span>ReflectiveMethodInvocation.java:163<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.framework.CglibAopProxy<span class="token variable">$CglibMethodInvocation</span>.proceed<span class="token punctuation">(</span>CglibAopProxy.java:747<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at org.springframework.aop.interceptor.AsyncExecutionInterceptor.lambda<span class="token variable">$invoke</span><span class="token variable">$0</span><span class="token punctuation">(</span>AsyncExecutionInterceptor.java:115<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-aop-5.2.2.RELEASE.jar:5.2.2.RELEASE<span class="token punctuation">]</span>
	at java.base/java.util.concurrent.FutureTask.run<span class="token variable">$$</span><span class="token variable">$capture</span><span class="token punctuation">(</span>FutureTask.java:264<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at java.base/java.util.concurrent.FutureTask.run<span class="token punctuation">(</span>FutureTask.java<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker<span class="token punctuation">(</span>ThreadPoolExecutor.java:1128<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at java.base/java.util.concurrent.ThreadPoolExecutor<span class="token variable">$Worker</span>.run<span class="token punctuation">(</span>ThreadPoolExecutor.java:628<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span>
	at java.base/java.lang.Thread.run<span class="token punctuation">(</span>Thread.java:834<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:na<span class="token punctuation">]</span></code></pre></div>
<p>All make sense as under the hood <code class="language-text">RequestContextHolder</code> is used which in turn stores request attributes in <code class="language-text">ThreadLocal</code>.</p>
<h2>Solution</h2>
<p>To access HTTP request data from outside of calling thread we could extend <code class="language-text">ThreadPoolTaskExecutor</code>, copy existing request attributes provided by <code class="language-text">RequestContextHolder#currentRequestAttributes</code> and set them in a new thread through <code class="language-text">RequestContextHolder#setRequestAttributes</code>. Below is sample implementation:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">MyThreadPoolTaskExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadPoolTaskExecutor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">currentRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">submitListenable</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">submitListenable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">currentRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyCallable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> callable<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RequestAttributes</span> requestAttributes<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token class-name">MyCallable</span><span class="token punctuation">(</span><span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> callable<span class="token punctuation">,</span> <span class="token class-name">RequestAttributes</span> requestAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>callable <span class="token operator">=</span> callable<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestAttributes <span class="token operator">=</span> <span class="token function">copy</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token class-name">RequestAttributes</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token class-name">RequestAttributes</span> requestAttributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// RequestAttributes needs to be copied as it will be garbage collected when origin request will complete.</span>
            <span class="token keyword">return</span> requestAttributes<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">resetRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then we need to instruct spring to use our custom implementation of <code class="language-text">TaskExecutor</code> like so:</p>
<div class="gatsby-highlight" data-language="java"><pre class="language-java"><code class="language-java">    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">TaskExecutor</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> taskExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"my-executor-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> taskExecutor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre></div>
<p>Please notice that the above solution should be considered more like a workaround than a final solution. A better approach would be to extract all required data while still in the context of calling thread and then pass these data to all interested parties.</p>
<p>The full example can be found at <a href="https://github.com/ajurasz/no-thread-bound-request">github</a>.</p></div></article><div class="sc-kGXeez cRzLhO"><h2 class="sc-kgoBCf jLNeCQ">Share This Post</h2><a href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank" aria-label="Share on Facebook" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg></a><a href="https://twitter.com/intent/tweet?text=Accessing%20HTTP%20request%20data%20from%20outside%20of%20calling%20thread&amp;url=" target="_blank" aria-label="Share on Twitter" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=&amp;title=Accessing%20HTTP%20request%20data%20from%20outside%20of%20calling%20thread" target="_blank" aria-label="Share on LinkedIn" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="mailto:?subject=Accessing%20HTTP%20request%20data%20from%20outside%20of%20calling%20thread&amp;body=" aria-label="Share by Email" rel="noopener" class="sc-kpOJdX eBuswQ"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a></div></div><div class="sc-chPdSV ukmsj"><a rel="prev" class="sc-gZMcBi deWstv" href="/2019-10-27-equals-operator-in-groovy/">← <!-- -->equals operator in Groovy</a><a rel="next" class="sc-gZMcBi deWstv" href="/2020-04-12-continuous-deployment-on-kubernetes/">Continuous Deployment on Kubernetes<!-- --> →</a></div></section></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-70225806-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2019-12-28-accessing-request-data-from-outside-of-calling-thread/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-93669a106e49c45c3abd.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-87ef582ba388a83f73c0.js"],"component---src-templates-index-js":["/component---src-templates-index-js-01c80e7b8e10ea89c878.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c2229418bf9686809ee4.js"]};/*]]>*/</script><script src="/webpack-runtime-9284701b300429ba4c2b.js" async=""></script><script src="/app-93669a106e49c45c3abd.js" async=""></script><script src="/commons-ed86373b90c649a8f6f2.js" async=""></script><script src="/component---src-templates-blog-post-js-5b7367f18a5d03a38dca.js" async=""></script><script src="/styles-4f1a9273244be790d38c.js" async=""></script></body></html>